<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover" />
    
    <!-- ‚úÖ CACHE BUSTING: Force browser to reload new versions -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />

    <title>JODO - Group Buying</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üçÖ</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    
    <!-- ‚úÖ FIREBASE INITIALIZATION -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import {
        getFirestore,
        doc,
        setDoc,
        getDoc,
        getDocs,
        updateDoc,
        onSnapshot,
        collection,
        runTransaction,
        serverTimestamp,
        query,
        where,
        increment,
        Timestamp
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyAHsRiYhNea5tFpKVSU7YA9nsR6qINtQdA",
        authDomain: "jodo-prod-v2.firebaseapp.com",
        projectId: "jodo-prod-v2",
        storageBucket: "jodo-prod-v2.firebasestorage.app",
        messagingSenderId: "577075664016",
        appId: "1:577075664016:web:dcf613e7650217cc94b415"
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      window.db = db;
      window.auth = auth;
      window.appId = "jodo-prod-v2"; 
      
      window.fs = {
        doc, setDoc, getDoc, getDocs, updateDoc, onSnapshot,
        collection, runTransaction, serverTimestamp, query, where, increment, Timestamp
      };
      
      console.log("üöÄ JODO v13.5 - 2 Person Group Update");

      const initAuth = async () => {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
            try { await signInWithCustomToken(auth, __initial_auth_token); } 
            catch (e) { console.warn("Auth failed", e); await signInAnonymously(auth); }
        } else { await signInAnonymously(auth); }
      };
      initAuth().catch(console.error);
    </script>

    <script>
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            if (msg.includes("ResizeObserver")) return;
            const appEl = document.getElementById('app');
            if (appEl) {
                appEl.innerHTML = `<div style="padding:20px;color:#DC2626;text-align:center;"><h2 style="font-weight:bold;">Error</h2><p>${msg}</p><button onclick="window.location.reload()" style="margin-top:20px;padding:10px 20px;background:#333;color:#fff;">Retry</button></div>`;
            }
            return false;
        };
        tailwind.config = { theme: { extend: { colors: { jodo: { ctaPrimary: '#15803D', danger: '#DC2626' }, gray: { 50:'#F9FAFB', 100:'#F3F4F6', 200:'#E5E7EB', 500:'#6B7280', 600:'#4B5563', 800:'#1F2937', 900:'#111827' } }, fontFamily: { sans: ['-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'sans-serif'] }, animation: { 'fade-in-up': 'fadeInUp 0.5s ease-out', 'slide-up': 'slideUp 0.3s ease-out forwards', 'pop': 'popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)' }, keyframes: { fadeInUp: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } }, slideUp: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } }, popIn: { '0%': { opacity: '0', transform: 'scale(0.9)' }, '100%': { opacity: '1', transform: 'scale(1)' } } } } } }
    </script>
    
    <style>
        body { background: #F3F4F6; color: #111827; -webkit-tap-highlight-color: transparent; min-height: 100dvh; display: flex; justify-content: center; margin: 0; overscroll-behavior-y: none; }
        #app { width: 100%; max-width: 448px; background: #FFFFFF; min-height: 100dvh; position: relative; overflow-y: auto; display: flex; flex-direction: column; box-shadow: 0 0 20px rgba(0,0,0,0.05); }
        .btn-press { transition: transform 0.1s; cursor: pointer; user-select: none; }
        .btn-press:active:not(:disabled) { transform: scale(0.97); opacity: 0.9; }
        .glass-header { background: rgba(255, 255, 255, 0.98); border-bottom: 1px solid #E5E7EB; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .pt-safe { padding-top: env(safe-area-inset-top); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .spinner-fallback { width: 32px; height: 32px; border: 3px solid #E5E7EB; border-top: 3px solid #15803D; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="antialiased">

    <div id="app">
        <div style="height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #fff; color: #333;">
            <div class="spinner-fallback"></div>
            <div style="margin-top: 16px; font-family: sans-serif; font-size: 14px; font-weight: 600;">JODO v13.5</div>
        </div>
    </div>

    <!-- MODAL -->
    <div id="modal-overlay" class="fixed inset-0 bg-black/60 hidden z-[60] flex items-end justify-center backdrop-blur-sm transition-opacity duration-300">
        <div id="modal-content" class="bg-white w-full max-w-[448px] rounded-t-[1.5rem] shadow-2xl transform transition-transform duration-300 translate-y-full max-h-[95dvh] flex flex-col overflow-hidden pb-safe"></div>
    </div>

    <!-- TOAST -->
    <div id="toast" class="fixed top-24 left-1/2 -translate-x-1/2 bg-gray-900 text-white px-6 py-3 rounded-full text-sm font-medium shadow-xl hidden z-[90] flex items-center gap-2 pointer-events-none pt-safe text-center w-max max-w-[90%]"></div>

    <script type="module">
        // ==========================================
        // 1. CONSTANTS
        // ==========================================
        const CONSTANTS = {
            PUBLIC_SHARE_URL: "https://satyanarayanagaraga.github.io/jodo-mvp/",
            MIN_GROUP_SIZE: 2, // ‚úÖ UPDATED: Changed from 3 to 2
            GROUP_MAX_KG: 1000, 
            GROUPS_STORAGE_KEY: 'jodo_groups_joined_v12',
            CUTOFF_HOUR: 23, 
            PRODUCTS: [
                { id: 'tomato', name: 'Fresh Tomatoes', nameTe: '‡∞ü‡∞Æ‡∞æ‡∞ü‡∞æ‡∞≤‡±Å', unit: '1kg', step: 0.5, imageSrc: 'https://images.unsplash.com/photo-1592924357228-91a4daadcfea?auto=format&fit=crop&w=800&q=80' }
            ],
            PRODUCT_LIMITS: { tomato: 10 },
            PRICE_LADDERS: {
                tomato: [
                    { min: 1, price: 60 },   // ‚úÖ UPDATED: SOLO PRICE
                    { min: 2, price: 40 }    // ‚úÖ UPDATED: GROUP PRICE (2 People)
                ]
            }
        };

        // ==========================================
        // 2. STORE
        // ==========================================
        const Store = {
            state: {
                view: null, 
                currentGroupId: null,
                isInviteOnly: false, // üîí HARD FLAG
                groups: {},
                members: {},
                user: { name: '', phone: '', address: { flat: '', street: '' }, joinedGroupIds: [] }, 
                cart: {},
                invitingGroup: null,
                pendingJoinId: null,
                isAppInitialized: false
            },
            update(key, value) {
                this.state[key] = value;
                if(key === 'view' || key === 'groups' || key === 'members' || key === 'cart') UI.scheduleRender();
            },
            updateUser(field, value) {
                this.state.user[field] = value;
                if (field === 'joinedGroupIds') localStorage.setItem(CONSTANTS.GROUPS_STORAGE_KEY, JSON.stringify(value));
                else if (field === 'name') localStorage.setItem('jodo_user_name', value);
                else if (field === 'phone') localStorage.setItem('jodo_user_phone', value);
                else if (field === 'address') localStorage.setItem('jodo_user_address', JSON.stringify(value));
            },
            loadFromStorage() {
                try {
                    this.state.user.name = localStorage.getItem('jodo_user_name') || '';
                    this.state.user.phone = localStorage.getItem('jodo_user_phone') || '';
                    
                    const savedAddr = localStorage.getItem('jodo_user_address');
                    this.state.user.address = savedAddr ? JSON.parse(savedAddr) : { flat: '', street: '' };

                    const savedGroups = localStorage.getItem(CONSTANTS.GROUPS_STORAGE_KEY);
                    this.state.user.joinedGroupIds = savedGroups ? JSON.parse(savedGroups) : [];
                } catch(e) { console.error("Storage Error", e); }
            }
        };

        // ==========================================
        // 3. UTILITIES
        // ==========================================
        const Utils = {
            Time: {
                getCutoffTimestamp() {
                    const now = new Date();
                    const utcNow = now.getTime();
                    const istOffset = 5.5 * 60 * 60 * 1000;
                    const istTime = new Date(utcNow + istOffset);
                    istTime.setUTCHours(CONSTANTS.CUTOFF_HOUR, 59, 59, 999);
                    return istTime.getTime() - istOffset;
                },
                isPastCutoff() { return Date.now() > this.getCutoffTimestamp(); },
                isTimestampPast(ts) {
                    return Date.now() > this.getMillis(ts);
                },
                calculateInitialCutoff() {
                    const now = new Date();
                    const utcNow = now.getTime();
                    const istOffset = 5.5 * 60 * 60 * 1000;
                    const istTime = new Date(utcNow + istOffset);
                    istTime.setUTCHours(CONSTANTS.CUTOFF_HOUR, 59, 59, 999);
                    return window.fs.Timestamp.fromMillis(istTime.getTime() - istOffset);
                },
                getMillis(ts) {
                    if (!ts) return 0;
                    if (typeof ts.toMillis === 'function') return ts.toMillis();
                    if (ts instanceof Date) return ts.getTime();
                    if (typeof ts === 'number') return ts;
                    if (ts.seconds) return ts.seconds * 1000;
                    return 0;
                }
            },
            Pricing: {
                formatQty(qty) { return qty < 1 ? (qty * 1000).toFixed(0) + 'g' : qty + 'kg'; },
                getGroupPrice(productId, memberCount) {
                    const ladder = CONSTANTS.PRICE_LADDERS[productId];
                    if (!ladder) return null;
                    let applicable = ladder[0];
                    for (const tier of ladder) {
                        if (memberCount >= tier.min) applicable = tier;
                    }
                    return applicable.price;
                },
                getNextTier(productId, memberCount) {
                    const ladder = CONSTANTS.PRICE_LADDERS[productId];
                    if (!ladder) return null;
                    return ladder.find(t => t.min > memberCount) || null;
                }
            }
        };

        // ==========================================
        // 4. SERVER
        // ==========================================
        const BackendSimulation = {
            async call(functionName, data) {
                console.log(`[BACKEND] Invoked: ${functionName}`, data);
                await new Promise(r => setTimeout(r, 600));
                
                const context = {
                    auth: window.auth.currentUser ? { uid: window.auth.currentUser.uid } : null
                };

                try {
                    if (functionName === 'joinGroup') return await this.joinGroup(data, context);
                    throw new Error("Unknown function");
                } catch (e) {
                    console.error(`[BACKEND] Error:`, e);
                    throw e; 
                }
            },

            async joinGroup({ name, phone, address, cart, joinGroupId, isManual }, context) {
                if (!context.auth && !isManual) throw new Error("Unauthenticated");
                if (!name || !phone) throw new Error("Invalid input");
                if (isManual && !joinGroupId) throw new Error("Manual entry needs group ID");

                if (!joinGroupId) { // Creating a new group
                    const q = window.fs.query(
                        window.fs.collection(window.db, 'artifacts', window.appId, 'public', 'data', "groups"),
                        window.fs.where('ownerPhone', '==', phone)
                    );
                    const snap = await window.fs.getDocs(q);
                    let hasActive = false;
                    snap.forEach(doc => {
                        const d = doc.data();
                        const isExpired = Utils.Time.isTimestampPast(d.expiresAt);
                        if ((d.status === 'FORMING' || d.status === 'VALID') && !isExpired) {
                            hasActive = true;
                        }
                    });
                    if (hasActive) throw "You already have an active group. Finish it first.";
                }

                const groupId = joinGroupId || window.fs.doc(window.fs.collection(window.db, 'artifacts', window.appId, 'public', 'data', "groups")).id;
                const groupRef = window.fs.doc(window.db, 'artifacts', window.appId, 'public', 'data', "groups", groupId);
                
                await window.fs.runTransaction(window.db, async (transaction) => {
                    // 1. ALL READS FIRST
                    const groupSnap = await transaction.get(groupRef);
                    const memberRef = window.fs.doc(window.db, 'artifacts', window.appId, 'public', 'data', "groups", groupId, "members", phone);
                    const memberSnap = await transaction.get(memberRef);

                    // 2. LOGIC
                    let gData;
                    let isNewGroup = false;

                    if (!groupSnap.exists()) {
                        if (joinGroupId) throw "Group not found";
                        isNewGroup = true;
                        const cutoffTime = Utils.Time.calculateInitialCutoff();
                        gData = { 
                            id: groupId, ownerName: name, ownerPhone: phone, 
                            ownerId: context.auth.uid, 
                            expiresAt: cutoffTime, 
                            createdAt: window.fs.serverTimestamp(), 
                            type: 'multi', maxKg: CONSTANTS.GROUP_MAX_KG, 
                            memberCount: 0, status: 'FORMING' 
                        };
                    } else {
                        gData = groupSnap.data();
                    }

                    if (isManual && gData.ownerId && gData.ownerId !== context.auth.uid) {
                        // Security check placeholder
                    }

                    if (Utils.Time.isTimestampPast(gData.expiresAt)) throw "Event has ended. Orders closed.";
                    if (gData.status === 'CANCELLED') throw "Group is closed.";

                    const memberData = memberSnap.exists() ? memberSnap.data() : {};
                    
                    const isNewMember = !memberSnap.exists();
                    const wasCounted = !!memberData.hasJoined;
                    
                    const willBeCounted = true; 

                    let newMemberCount = gData.memberCount || 0;
                    if (!wasCounted && willBeCounted) newMemberCount += 1;

                    // 3. ALL WRITES LAST
                    if (isNewGroup) {
                         gData.memberCount = newMemberCount;
                         transaction.set(groupRef, gData);
                    } else {
                         transaction.update(groupRef, { memberCount: newMemberCount });
                    }

                    transaction.set(memberRef, { 
                        memberId: phone, name, phone, address, cart,
                        joinedAt: memberSnap.exists() ? memberData.joinedAt : window.fs.serverTimestamp(), 
                        location: null, 
                        isManualEntry: isManual, hasJoined: willBeCounted,
                        isLeader: (!joinGroupId && isNewMember) || (gData.ownerPhone === phone) 
                    });
                });

                this.triggerBackgroundTasks(groupId);
                return { success: true, groupId };
            },

            async triggerBackgroundTasks(gid) {
                try {
                    const groupRef = window.fs.doc(window.db, 'artifacts', window.appId, 'public', 'data', "groups", gid);
                    const snap = await window.fs.getDoc(groupRef);
                    if (!snap.exists()) return;
                    
                    const g = snap.data();
                    if (g.status === 'FORMING' && g.memberCount >= CONSTANTS.MIN_GROUP_SIZE) {
                        if (!Utils.Time.isTimestampPast(g.expiresAt)) {
                            setTimeout(async () => {
                                await window.fs.updateDoc(groupRef, { status: 'VALID' });
                            }, 500); 
                        }
                    }
                } catch(e) { console.warn("Background Trigger Error", e); }
            }
        };

        // ==========================================
        // 5. CLIENT SERVICES
        // ==========================================
        const Services = {
            Data: {
                getGroupRef(gid) { return window.fs.doc(window.db, 'artifacts', window.appId, 'public', 'data', "groups", gid); },
                getMembersCol(gid) { return window.fs.collection(window.db, 'artifacts', window.appId, 'public', 'data', "groups", gid, "members"); },
                listenToGroup(gid) {
                    window.fs.onSnapshot(this.getGroupRef(gid), (snap) => {
                        if (snap.exists()) Store.update('groups', { ...Store.state.groups, [gid]: snap.data() });
                    });
                    window.fs.onSnapshot(this.getMembersCol(gid), (snap) => {
                        const mList = [];
                        snap.forEach(d => mList.push({ ...d.data(), id: d.id }));
                        mList.sort((a,b) => Utils.Time.getMillis(a.joinedAt) - Utils.Time.getMillis(b.joinedAt));
                        Store.update('members', { ...Store.state.members, [gid]: mList });
                    });
                }
            },
            Status: {
                getGroupStatus(group) {
                    if (!group) return 'UNKNOWN';
                    if (group.status === 'CANCELLED') return 'CANCELLED'; 
                    if (group.status === 'VALID') return 'VALID'; 
                    if (Utils.Time.isTimestampPast(group.expiresAt) && group.memberCount < CONSTANTS.MIN_GROUP_SIZE) return 'CANCELLED';
                    return 'FORMING';
                }
            }
        };

        const Actions = {
            initApp() {
                if (Store.state.isAppInitialized) return;
                Store.update('isAppInitialized', true);
                Store.loadFromStorage();
                
                const params = new URLSearchParams(window.location.search);
                const gid = params.get('group');
                Store.state.user.joinedGroupIds.forEach(id => Services.Data.listenToGroup(id));

                if (gid) {
                    // üîí HARD LOCK: Enforce invite only mode immediately
                    Store.update('isInviteOnly', true);
                    this.fetchInviteGroup(gid);
                } else {
                    Store.update('view', 'home');
                }

                window.addEventListener('popstate', () => {
                    const p = new URLSearchParams(location.search);
                    const g = p.get('group');
                    if (g) this.navigateToGroup(g); else this.navigateToHome();
                });
            },

            async fetchInviteGroup(gid) {
                try {
                    const snap = await window.fs.getDoc(Services.Data.getGroupRef(gid));
                    if (snap.exists()) {
                        Store.update('groups', { ...Store.state.groups, [gid]: snap.data() });
                        Services.Data.listenToGroup(gid);
                        this.navigateToGroup(gid);
                    } else {
                        UI.toast("Group not found", "alert-circle");
                        this.navigateToHome();
                    }
                } catch(e) { console.error(e); this.navigateToHome(); }
            },

            updateCart(productId, delta) {
                if (Utils.Time.isPastCutoff()) { UI.toast("Event ended.", "clock"); return; }
                const currentQty = Store.state.cart[productId] || 0;
                let newQty = Math.round((currentQty + delta) * 100) / 100;
                if (newQty < 0) newQty = 0;
                if (newQty > (CONSTANTS.PRODUCT_LIMITS[productId] || 99)) { UI.toast(`Limit reached`, "alert-circle"); return; }
                const newCart = { ...Store.state.cart };
                if (newQty === 0) delete newCart[productId]; else newCart[productId] = newQty;
                Store.update('cart', newCart);
                UI.triggerVibration();
            },

            navigateToGroup(gid) {
                if (!gid) return;
                Store.update('cart', {});
                try { history.pushState({}, '', `?group=${gid}`); } catch(e) {}
                Store.update('currentGroupId', gid);
                Store.update('view', 'group');
                Services.Data.listenToGroup(gid);
            },

            navigateToHome() {
                // üîí GUARD: Invite users are not allowed to go home
                if (Store.state.isInviteOnly) return;
                
                try { history.pushState({}, '', window.location.pathname); } catch(e) {}
                Store.update('currentGroupId', null);
                Store.update('view', 'home');
                Store.update('invitingGroup', null);
            },

            async submitOrder(name, phone, address, joinGroupId, isManual = false) { 
                if (!name || !/^[6-9]\d{9}$/.test(phone)) { UI.toast('Enter valid details', 'alert-circle'); return false; }
                if (!address || !address.street) { UI.toast('Address required', 'map-pin'); return false; } 

                if (!isManual) {
                    Store.updateUser('name', name);
                    Store.updateUser('phone', phone);
                    if (address) Store.updateUser('address', address); 
                }
                
                const cart = { ...Store.state.cart };

                try {
                    const result = await BackendSimulation.call('joinGroup', {
                        name, phone, address, cart, joinGroupId, isManual
                    });

                    const finalGroupId = result.groupId;
                    if (joinGroupId && !isManual) { Store.update('pendingJoinId', null); Store.update('invitingGroup', null); }
                    if (!isManual) {
                        const joined = [...Store.state.user.joinedGroupIds];
                        if(!joined.includes(finalGroupId)) {
                            joined.push(finalGroupId);
                            Store.updateUser('joinedGroupIds', joined);
                        }
                        Actions.navigateToGroup(finalGroupId);
                    } else { UI.toast("Manual order added", "user-plus"); }
                    
                    Store.update('cart', {});
                    if (!isManual) UI.toast("Joined!", "users");
                    return true;

                } catch (e) { 
                    const errMsg = typeof e === 'object' ? (e.message || JSON.stringify(e)) : String(e);
                    console.error("Order Error", errMsg);
                    UI.toast(errMsg.includes('closed') ? "Group is closed." : "Request failed.", "alert-triangle"); 
                    return false; 
                }
            }
        };

        // ==========================================
        // 6. UI RENDERER
        // ==========================================
        const UI = {
            renderScheduled: false,
            scheduleRender() {
                if (this.renderScheduled) return;
                this.renderScheduled = true;
                requestAnimationFrame(() => { this.render(); this.renderScheduled = false; });
            },
            render() {
                const app = document.getElementById('app');
                if (!app) return;

                // üö® ABSOLUTE BLOCK: invite users must NEVER see home
                if (Store.state.isInviteOnly) {
                    if (Store.state.view !== 'group') return;
                }

                const { view } = Store.state;
                if (view === 'home') this.renderHome(app);
                else if (view === 'group') this.renderGroup(app);
                if (window.lucide) window.lucide.createIcons();
            },
            renderHome(container) {
                const { user, groups } = Store.state;
                if (Utils.Time.isPastCutoff()) {
                    container.innerHTML = `<div class="h-screen flex flex-col items-center justify-center bg-gray-50 px-6 text-center"><h1 class="text-3xl font-black text-gray-900 mb-2">Event Ended</h1><p class="text-gray-500">Come back on Wednesday.</p></div>`; return;
                }

                const activeGroups = user.joinedGroupIds.map(gid => groups[gid]).filter(g => {
                    if (!g) return false;
                    const s = Services.Status.getGroupStatus(g);
                    return s === 'FORMING' || s === 'VALID';
                });
                
                const hasActiveGroup = activeGroups.length > 0;

                let startAction = "window.JodoApp.UI.openCheckoutModal(null)";
                let startClasses = "bg-gradient-to-br from-jodo-ctaPrimary to-green-600 rounded-2xl p-6 mb-4 shadow-lg text-white btn-press";
                let startTitle = "Start New Group";
                let startDesc = "Be the first, invite others.";

                if (hasActiveGroup) {
                    startAction = "window.JodoApp.UI.toast('You already have an active group', 'alert-circle')";
                    startClasses = "bg-gray-100 border border-gray-200 rounded-2xl p-6 mb-4 text-gray-400 cursor-not-allowed";
                    startTitle = "Active Group in Progress";
                    startDesc = "Finish your current group to start a new one.";
                }

                let activeGroupsHtml = '';
                if (activeGroups.length > 0) {
                    activeGroupsHtml = activeGroups.map(g => {
                        const status = Services.Status.getGroupStatus(g);
                        const isConfirmed = status === 'VALID';
                        const progress = Math.min(100, (g.memberCount / CONSTANTS.MIN_GROUP_SIZE) * 100);
                        const members = Store.state.members[g.id] || [];
                        const totalKg = members.reduce((sum, m) => sum + Object.values(m.cart||{}).reduce((a,b)=>a+b,0), 0);
                        return `
                        <div onclick="window.JodoApp.Actions.navigateToGroup('${g.id}')" class="bg-white rounded-2xl p-5 mb-4 border border-gray-200 shadow-sm btn-press relative overflow-hidden">
                            <div class="flex justify-between items-start mb-3">
                                <div><div class="font-bold text-lg text-gray-900">Group #${g.id.substr(-4)}</div><div class="text-sm text-gray-500">${g.memberCount} people joined</div></div>
                                <div class="bg-${isConfirmed?'green':'orange'}-100 text-${isConfirmed?'green':'orange'}-800 text-xs font-bold px-2 py-1 rounded-lg">${isConfirmed ? 'CONFIRMED' : 'WAITING'}</div>
                            </div>
                            <div class="mb-4">
                                <div class="flex justify-between text-xs font-bold text-gray-600 mb-1"><span>Progress</span><span>${g.memberCount}/${CONSTANTS.MIN_GROUP_SIZE} people</span></div>
                                <div class="w-full bg-gray-100 rounded-full h-3 overflow-hidden"><div class="bg-${isConfirmed?'green':'orange'}-500 h-3 transition-all duration-500" style="width:${progress}%"></div></div>
                                <div class="text-xs text-gray-400 mt-1 text-right">Target: ${totalKg.toFixed(1)}kg ordered</div>
                            </div>
                            <button class="w-full py-3 bg-gray-900 text-white font-bold rounded-xl text-sm">Open Group View</button>
                        </div>`;
                    }).join('');
                }

                container.innerHTML = `
                <div class="pb-32 fade-in bg-gray-50 min-h-screen">
                    <div class="glass-header sticky top-0 z-40 px-4 pt-safe pb-3 flex justify-between items-center">
                        <h1 class="font-black text-2xl text-jodo-ctaPrimary">JODO</h1>
                        <div id="home-timer" class="text-xs font-black text-red-600 bg-red-50 px-2 py-1 rounded border border-red-100">Loading...</div>
                    </div>
                    <div class="px-4 mt-6">
                        <h2 class="text-sm font-bold text-gray-500 uppercase tracking-wide mb-3">Actions</h2>
                        <div onclick="${startAction}" class="${startClasses}">
                            <div class="flex items-center gap-4 mb-3">
                                <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center"><i data-lucide="${hasActiveGroup ? 'lock' : 'plus'}" size="24" class="${hasActiveGroup ? 'text-gray-400' : 'text-white'}"></i></div>
                                <div><div class="font-black text-xl ${hasActiveGroup ? 'text-gray-500' : ''}">${startTitle}</div><div class="${hasActiveGroup ? 'text-gray-400' : 'text-green-100'} text-sm">${startDesc}</div></div>
                            </div>
                            ${!hasActiveGroup ? '<div class="mt-4 bg-white/10 rounded-xl p-3 text-xs font-medium text-green-50">Create a group ‚Üí Select items ‚Üí Invite neighbors to unlock wholesale prices.</div>' : ''}
                        </div>
                    </div>
                    <div class="px-4 mt-2">
                        <h2 class="text-sm font-bold text-gray-500 uppercase tracking-wide mb-3">Your Active Groups</h2>
                        ${activeGroupsHtml || '<div class="text-center py-8 text-gray-400 text-sm">No active groups yet. Start one!</div>'}
                    </div>
                </div>`;
                this.startTimer(document.getElementById('home-timer'), null);
            },

            // ==========================================
            // ‚úÖ DUAL MODE RENDERER (JOINER vs MEMBER)
            // ==========================================
            renderGroup(container) {
                const { currentGroupId, groups, members, user } = Store.state;
                const g = groups[currentGroupId];
                if (!g) return;

                const memberList = members[currentGroupId] || [];
                // Check if user is actually in the group
                const hasJoined = user.phone && memberList.some(m => m.phone === user.phone);

                if (!hasJoined) {
                    this.renderJoinerSalesPage(container, g);
                } else {
                    this.renderMemberDashboard(container, g, memberList);
                }
            },

            // ==========================================
            // üß© JOINER UI (SALES PAGE - DECISION FOCUS)
            // ==========================================
            renderJoinerSalesPage(container, g) {
                const remaining = Math.max(0, CONSTANTS.MIN_GROUP_SIZE - g.memberCount);
                // Hardcoded to Tomato as per prompt logic
                const p = CONSTANTS.PRODUCTS[0]; 
                const price = Utils.Pricing.getGroupPrice(p.id, g.memberCount);

                container.innerHTML = `
                <div class="fade-in bg-gray-50 min-h-screen flex flex-col font-sans">
                    <div class="flex-1 px-4 pt-8 pb-safe overflow-y-auto">
                        
                        <!-- 1Ô∏è‚É£ HERO CARD -->
                        <div class="bg-gradient-to-br from-green-600 to-green-500 text-white rounded-2xl p-6 mb-6 text-center shadow-lg relative overflow-hidden">
                            <div class="absolute top-0 left-0 w-full h-1 bg-white/20"></div>
                            <div class="text-xs font-bold uppercase tracking-wide opacity-90 mb-1">Group Buying</div>
                            <h1 class="text-2xl font-black mb-2 leading-tight">Join ${g.ownerName}‚Äôs<br>Vegetable Group</h1>
                            <p class="text-sm opacity-90 font-medium">Join before tonight to unlock wholesale prices</p>
                        </div>

                        <!-- 2Ô∏è‚É£ SIMPLE PROGRESS -->
                        <div class="bg-white rounded-xl border border-gray-200 p-5 mb-6 text-center shadow-sm">
                            <div class="text-sm font-bold text-gray-700 mb-3">
                                ${g.memberCount} of ${CONSTANTS.MIN_GROUP_SIZE} people joined
                            </div>
                            <div class="w-full bg-gray-100 h-3 rounded-full overflow-hidden mb-3">
                                <div class="bg-green-500 h-3" style="width:${(g.memberCount / CONSTANTS.MIN_GROUP_SIZE) * 100}%"></div>
                            </div>
                            <div class="text-xs text-red-600 font-bold bg-red-50 inline-block px-3 py-1 rounded-full border border-red-100">
                                ${remaining > 0 ? `Needs ${remaining} more to confirm order` : 'Group goal reached!'}
                            </div>
                        </div>

                        <!-- 3Ô∏è‚É£ ONE PRODUCT, ONE PRICE -->
                        <div class="bg-white border border-gray-200 rounded-xl p-4 mb-8 shadow-sm">
                             <div class="flex items-center gap-4">
                                <div class="w-20 h-20 bg-gray-50 rounded-lg shrink-0 border border-gray-100 overflow-hidden">
                                    <img src="${p.imageSrc}" class="w-full h-full object-cover">
                                </div>
                                <div class="flex-1">
                                    <div class="font-bold text-lg text-gray-900 leading-tight">${p.name}</div>
                                    <div class="text-xs text-gray-500 mb-1">Fresh from farm</div>
                                    <div class="text-sm text-gray-500">Current group price</div>
                                </div>
                                <div class="text-right">
                                    <div class="text-3xl font-black text-green-700 tracking-tighter">‚Çπ${price}</div>
                                    <div class="text-[10px] text-gray-400 font-bold uppercase">PER KG</div>
                                </div>
                             </div>
                        </div>

                        <!-- 4Ô∏è‚É£ MASSIVE PRIMARY CTA -->
                        <button onclick="window.JodoApp.UI.openCheckoutModal('${g.id}')" class="w-full bg-green-600 text-white h-[64px] rounded-2xl font-black text-lg shadow-xl active:scale-95 transition-transform flex items-center justify-center gap-2 mb-3">
                            <span>JOIN & CONFIRM ORDER</span>
                            <i data-lucide="arrow-right" size="20"></i>
                        </button>

                        <!-- 5Ô∏è‚É£ TRUST FOOTNOTE -->
                        <div class="text-center text-[11px] text-gray-500 font-medium">
                            <i data-lucide="shield-check" size="10" class="inline mb-[2px]"></i> No payment now ‚Ä¢ Order confirmed only if group completes
                        </div>

                        <div class="h-10"></div>
                    </div>
                </div>`;

                setTimeout(() => {
                    if (!window._hasAutoOpenedJoinModal) {
                        window.JodoApp.UI.openCheckoutModal(g.id);
                        window._hasAutoOpenedJoinModal = true;
                    }
                }, 300);
            },

            // ==========================================
            // üß© MEMBER UI (DASHBOARD - MANAGEMENT FOCUS)
            // ==========================================
            renderMemberDashboard(container, g, memberList) {
                const status = Services.Status.getGroupStatus(g);
                const remaining = Math.max(0, CONSTANTS.MIN_GROUP_SIZE - g.memberCount);
                const isConfirmed = status === 'VALID';
                
                // --- Status Block ---
                const headerGradient = isConfirmed ? 'bg-gradient-to-r from-green-600 to-green-500' : 'bg-gradient-to-r from-red-600 to-orange-600 animate-pulse';
                const statusText = isConfirmed ? '‚úÖ GROUP ORDER CONFIRMED' : `‚ö†Ô∏è GROUP WILL CANCEL IF ${remaining} DON‚ÄôT JOIN`;
                const statusBlockHtml = `
                <div class="flex flex-col items-center w-full max-w-[85%] mx-auto mb-6 filter drop-shadow-md">
                    <div class="${headerGradient} text-white text-[11px] font-black py-2 px-3 rounded-t-xl w-full text-center tracking-wider uppercase border-b border-white/20">${statusText}</div>
                    <div class="bg-gray-900 w-full rounded-b-xl py-2 px-3 flex items-center justify-center gap-3">
                        <div class="w-1.5 h-1.5 rounded-full bg-red-500 animate-[ping_1.5s_infinite]"></div>
                        <div id="cutoff-timer" class="text-white font-mono text-sm font-bold tracking-widest tabular-nums">‚è≥ Calculating...</div>
                    </div>
                </div>`;

                // --- People Slots ---
                const peopleSlotsHtml = `
                <div class="flex justify-center gap-4 mt-2 mb-4">
                  ${Array.from({ length: CONSTANTS.MIN_GROUP_SIZE }).map((_, i) => {
                    const m = memberList[i];
                    if (m) {
                        const isMe = Store.state.user.phone === m.phone;
                        const initial = m.name ? m.name[0].toUpperCase() : '?';
                        const myQty = m.cart && m.cart['tomato'] ? m.cart['tomato'] : 0;
                        const isLocked = status === 'VALID';
                        if (isMe) {
                            return `
                            <div class="flex flex-col items-center gap-1 cursor-pointer" onclick="${!isLocked ? `window.JodoApp.UI.openCheckoutModal('${g.id}', false)` : ''}">
                                <div class="w-16 h-16 rounded-full bg-green-100 border-2 border-green-500 flex items-center justify-center text-sm font-black text-green-800 shadow-sm relative">YOU
                                    ${m.isLeader ? '<span class="absolute -top-2 text-xs bg-yellow-300 px-1 rounded shadow-sm border border-yellow-400">üëë</span>' : ''}
                                    ${!isLocked ? '<div class="absolute -bottom-1 -right-1 bg-white rounded-full p-1 border border-gray-200 shadow-sm"><i data-lucide="pencil" size="10" class="text-gray-500"></i></div>' : ''}
                                </div>
                                <div class="text-[10px] font-bold text-gray-700 bg-white border border-gray-200 px-1.5 py-0.5 rounded shadow-sm flex items-center gap-1">${Utils.Pricing.formatQty(myQty)}${!isLocked ? '<span class="text-[8px] text-blue-600 underline uppercase ml-0.5">Edit</span>' : ''}</div>
                            </div>`;
                        } else {
                            return `
                            <div class="flex flex-col items-center gap-1">
                                <div class="w-16 h-16 rounded-full bg-green-100 border-2 border-green-500 flex items-center justify-center text-sm font-black text-green-800 shadow-sm relative">${initial}${m.isLeader ? '<span class="absolute -top-2 text-xs bg-yellow-300 px-1 rounded shadow-sm border border-yellow-400">üëë</span>' : ''}</div>
                                <div class="text-[10px] font-bold text-gray-700 bg-white border border-gray-200 px-1.5 py-0.5 rounded shadow-sm">${Utils.Pricing.formatQty(myQty)}</div>
                            </div>`;
                        }
                    }
                    return `<div class="w-16 h-16 rounded-full bg-red-50 border-2 border-dashed border-red-400 flex items-center justify-center text-red-400 font-black text-2xl animate-pulse shadow-inner">+</div>`;
                  }).join('')}
                </div>
                <div class="text-center text-xs font-bold text-red-600 mb-6">${status === 'VALID' ? 'Group complete & Confirmed!' : `Waiting for ${remaining} more ${remaining === 1 ? 'person' : 'people'}`}</div>`;

                // --- Price Ladder ---
                const ladderHtml = CONSTANTS.PRODUCTS.map(p => {
                    const price = Utils.Pricing.getGroupPrice(p.id, g.memberCount);
                    const ladder = CONSTANTS.PRICE_LADDERS[p.id];
                    const nextTier = ladder.find(t => t.min > g.memberCount);
                    let nextUnlockHtml = '';
                    if (nextTier) {
                        const remainingPeople = nextTier.min - g.memberCount;
                        nextUnlockHtml = `<div class="mt-3 text-xs font-bold bg-orange-50 text-orange-600 border-orange-100 px-3 py-2 rounded-lg text-center border">‚ö†Ô∏è Just ${remainingPeople} more ‚Üí price drops to ‚Çπ${nextTier.price}<button onclick="event.stopPropagation(); window.JodoApp.UI.shareGroup('${g.id}', false)" class="mt-2 w-full bg-green-600 text-white text-xs font-black py-2 rounded-lg shadow-sm active:scale-95 transition-transform uppercase tracking-wide">Invite Now</button></div>`;
                    } else {
                        nextUnlockHtml = `<div class="mt-3 text-xs font-bold text-green-700 bg-green-50 px-3 py-2 rounded-lg text-center border border-green-100">üéâ Lowest price unlocked</div>`;
                    }
                    return `
                    <div class="bg-white border border-gray-200 rounded-2xl p-4 mb-2 shadow-sm">
                        <div class="flex gap-4">
                            <div class="w-20 h-20 bg-gray-50 rounded-xl shrink-0 overflow-hidden shadow-inner"><img src="${p.imageSrc}" class="w-full h-full object-cover"></div>
                            <div class="flex-1">
                                <div class="flex justify-between items-start">
                                    <div><div class="font-bold text-gray-900 text-lg">${p.name}</div><div class="text-xs text-gray-500">${p.nameTe}</div></div>
                                    <div class="text-right"><div class="text-2xl font-black text-green-700 tracking-tight">‚Çπ${price}</div><div class="text-[10px] text-gray-400 font-medium uppercase">${status === 'VALID' ? 'Final Price' : 'Price if confirmed'}</div></div>
                                </div>
                            </div>
                        </div>
                        <div class="mt-3 mb-0 bg-white rounded-xl border border-gray-200 p-0 overflow-hidden">
                            <div class="bg-gray-50 px-3 py-2 border-b border-gray-100 flex justify-between items-center"><span class="text-[10px] font-bold text-gray-500 uppercase tracking-wide">Unlock Lower Prices</span><i data-lucide="trending-down" size="14" class="text-gray-400"></i></div>
                            <div class="p-3">
                                <div class="space-y-2">${ladder.map(tier => {
                                    const isReached = g.memberCount >= tier.min;
                                    return `<div class="flex justify-between items-center text-xs ${isReached ? 'opacity-100' : 'opacity-60'}"><div class="flex items-center gap-2 ${isReached ? 'text-green-700 font-black' : 'text-gray-500 font-medium'}"><span class="w-4">${isReached ? '‚úÖ' : '‚óã'}</span><span>${tier.min} ${tier.min === 1 ? 'Person' : 'People'}</span></div><span class="font-mono text-sm ${isReached ? 'text-green-700 font-black' : 'text-gray-500 font-medium'}">‚Çπ${tier.price}</span></div>`;
                                }).join('')}</div>
                                ${nextUnlockHtml}
                            </div>
                        </div>
                    </div>`;
                }).join('');

                // --- Members List ---
                const membersHTML = memberList.map((m, idx) => {
                    const isMe = Store.state.user.phone === m.phone;
                    const parts = Object.entries(m.cart || {}).map(([pid, qty]) => { const p = CONSTANTS.PRODUCTS.find(x => x.id === pid); return p ? `${Utils.Pricing.formatQty(qty)} ${p.name}` : null; }).filter(Boolean);
                    let subText = status === 'VALID' ? `<div class="text-[10px] text-blue-700 font-bold mt-0.5">Order Placed</div>` : (isMe ? `<div class="text-[10px] text-red-600 font-black mt-0.5 animate-pulse">‚ö†Ô∏è Group fails if ${remaining} don‚Äôt join</div>` : `<div class="text-[10px] text-gray-500 font-medium mt-0.5">Waiting...</div>`);
                    return `<div class="bg-white border ${isMe ? 'border-green-300 ring-1 ring-green-100' : 'border-gray-100'} p-3 rounded-xl flex flex-col justify-between w-[280px] shrink-0"><div><div class="flex justify-between items-start w-full"><div class="text-xs font-bold text-gray-900 flex items-center gap-1">${isMe ? 'You (Your order)' : m.name} ${m.isLeader ? 'üëë' : ''}</div></div><div class="text-[11px] text-gray-500 mt-0.5">${parts.join(", ")}</div>${subText}</div></div>`;
                }).join('');

                // --- Footer ---
                const addManualBtn = `<button onclick="window.JodoApp.UI.openCheckoutModal('${g.id}', true)" class="w-[30%] bg-white text-gray-700 border border-gray-300 h-[52px] rounded-xl font-bold text-xs tracking-wide shadow-sm flex flex-col items-center justify-center leading-none active:bg-gray-50"><i data-lucide="user-plus" size="16" class="mb-1"></i><span>Add Manual</span></button>`;
                let footerHTML = '';
                if (status === 'VALID') {
                    footerHTML = `<div class="flex gap-2 justify-between w-full">${addManualBtn}<button onclick="window.JodoApp.UI.shareGroup('${g.id}', true)" class="w-[68%] bg-blue-600 text-white h-[52px] flex items-center justify-center rounded-xl font-black text-sm tracking-wide gap-2 shadow-lg">SHARE LINK</button></div>`;
                } else {
                    const inviteText = remaining === 1 ? "1 MORE TO CONFIRM" : `INVITE ${remaining} TO CONFIRM`;
                    footerHTML = `<div class="flex gap-2 justify-between w-full">${addManualBtn}<button onclick="window.JodoApp.UI.shareGroup('${g.id}', false)" class="w-[68%] bg-jodo-ctaPrimary text-white h-[52px] flex items-center justify-center rounded-xl font-black text-sm tracking-wide gap-2 shadow-lg">${inviteText}</button></div>`;
                }

                container.innerHTML = `
                <div class="fade-in bg-gray-50 h-[100dvh] flex flex-col font-sans overflow-hidden relative">
                    <div class="absolute top-0 left-0 w-full z-50 flex justify-between p-4 pointer-events-none">
                        <button onclick="window.JodoApp.Actions.navigateToHome()" class="pointer-events-auto w-10 h-10 bg-white/90 backdrop-blur rounded-full flex items-center justify-center shadow-md border border-gray-100 text-gray-700 active:scale-95 transition-transform"><i data-lucide="arrow-left" size="20"></i></button>
                    </div>
                    <div class="flex-1 overflow-y-auto no-scrollbar pt-16">
                        <div class="px-4 pb-4">
                            <div class="text-center mb-3"><h1 class="text-xl font-black text-gray-900 tracking-tight leading-tight">${g.ownerName}'s JODO</h1></div>
                            ${statusBlockHtml}
                            ${peopleSlotsHtml}
                            <div class="mt-4"><div class="mb-2 px-1 text-center"><h3 class="text-[11px] font-black text-gray-400 uppercase tracking-widest">PEOPLE WHO JOINED</h3></div><div class="flex gap-3 overflow-x-auto pb-2 px-1 no-scrollbar">${membersHTML}</div></div>
                            <div class="mt-6 opacity-100 transition-all"><div class="flex items-center justify-between px-1 mb-2"><div class="text-[11px] font-black text-gray-700 uppercase tracking-wide">PRICE TIERS</div></div>${ladderHtml}</div>
                            <div class="h-24"></div>
                        </div>
                    </div>
                    <div class="shrink-0 fixed bottom-0 left-0 right-0 bg-white border-t border-gray-100 p-3 pb-safe z-50 shadow-[0_-4px_12px_rgba(0,0,0,0.06)]">${footerHTML}</div>
                </div>`;
                this.startTimer(document.getElementById('cutoff-timer'), g.expiresAt);
            },

            openCheckoutModal(joinGroupId = null, isManual = false) {
                // ‚úÖ FIX 2: SAFETY OVERRIDE
                if (Store.state.currentGroupId && joinGroupId === null) {
                    joinGroupId = Store.state.currentGroupId;
                }

                const { user, members, cart } = Store.state;
                let activeCart = isManual ? {} : { ...cart }; 
                
                let activeAddress = isManual ? { flat: '', street: '' } : { ...user.address };

                let isEditing = false;
                if (joinGroupId && !isManual) {
                      const me = (members[joinGroupId] || []).find(m => m.phone === user.phone);
                      if (me) { 
                          activeCart = { ...(me.cart || {}) }; 
                          Store.update('cart', activeCart); 
                          if (me.address) activeAddress = { ...me.address }; 
                          isEditing = true; 
                      }
                }
                
                const title = isManual
                  ? 'Manual Entry'
                  : isEditing
                    ? 'Update Order'
                    : joinGroupId
                      ? 'Join Group'
                      : 'Start New Group';

                const modalHtml = `
                <div class="flex flex-col h-[60vh] bg-white relative rounded-t-[1.5rem] overflow-hidden font-sans">
                    <div class="bg-white px-5 py-4 flex items-center justify-between border-b border-gray-100 shrink-0 z-20">
                        <div class="flex items-center gap-2 text-gray-800"><h3 class="font-black text-xl tracking-tight">${title}</h3></div>
                        <button id="close-modal" class="p-2 bg-gray-50 rounded-full text-gray-500"><i data-lucide="x" size="20"></i></button>
                    </div>
                    <div class="p-5 overflow-y-auto flex-1 relative bg-gray-50/30">
                        <div class="bg-white border border-gray-200 rounded-xl p-4 mb-6 shadow-sm">
                            <div class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Order</div>
                            <div id="modal-items-container"></div>
                        </div>
                        <div class="space-y-4 mb-8">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Your Details</label>
                                <input id="inp-name" value="${isManual?'':user.name}" class="w-full bg-white border border-gray-300 py-3 px-4 rounded-lg outline-none font-medium text-gray-900 mb-2" placeholder="Your Name">
                                <input id="inp-phone" value="${isManual?'':user.phone}" type="tel" class="w-full bg-white border border-gray-300 py-3 px-4 rounded-lg outline-none font-medium text-gray-900" placeholder="Mobile Number">
                            </div>
                            
                            <div>
                                <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Delivery Location</label>
                                
                                <div id="address-preview" class="hidden mb-3 p-3 bg-green-50 border border-green-100 rounded-lg flex items-start gap-2">
                                    <i data-lucide="map-pin" size="16" class="text-green-600 mt-0.5 shrink-0"></i>
                                    <div>
                                        <div class="text-[10px] font-bold text-green-600 uppercase tracking-wider mb-0.5">DETECTED LOCATION</div>
                                        <div id="addr-text" class="text-xs text-green-900 font-medium leading-relaxed"></div>
                                    </div>
                                </div>

                                <button id="btn-locate" class="w-full py-3 bg-blue-50 text-blue-700 font-bold text-sm rounded-xl border border-blue-100 flex items-center justify-center gap-2 active:scale-95 transition-transform">
                                    <i data-lucide="crosshair" size="16"></i> 
                                    <span>One-Click Auto Address</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white border-t border-gray-100 p-4 shrink-0 pb-safe z-20">
                        <button id="action-btn" class="w-full bg-jodo-ctaPrimary text-white h-[56px] rounded-xl font-black text-lg shadow-lg flex items-center justify-center gap-2 transition-all btn-press opacity-50"><span>${isManual ? "Add Manual Order" : "Confirm Joining"}</span></button>
                    </div>
                </div>`;
                const node = this.createNode(modalHtml);
                this.showModal(node);
                
                const nameInp = node.querySelector('#inp-name');
                const phoneInp = node.querySelector('#inp-phone');
                const actionBtn = node.querySelector('#action-btn');
                const locateBtn = node.querySelector('#btn-locate'); 
                const addrPreview = node.querySelector('#address-preview');
                const addrText = node.querySelector('#addr-text');

                let detectedAddress = { 
                    flat: activeAddress.flat || '', 
                    street: activeAddress.street || '',
                    lat: activeAddress.lat || null,
                    lng: activeAddress.lng || null,
                    url: activeAddress.url || null
                };

                const renderAddress = () => {
                    if (detectedAddress.street) {
                        addrPreview.classList.remove('hidden');
                        
                        let html = `
                            <div class="text-[10px] font-bold text-green-600 uppercase tracking-wider mb-0.5">DETECTED LOCATION</div>
                            <div class="text-xs text-green-900 font-medium leading-relaxed mb-1">
                                ${detectedAddress.flat ? detectedAddress.flat + ', ' : ''}${detectedAddress.street}
                            </div>
                        `;
                        
                        if (detectedAddress.url) {
                            html += `<a href="${detectedAddress.url}" target="_blank" class="text-[10px] font-bold text-blue-600 underline flex items-center gap-1">
                                <i data-lucide="external-link" size="10"></i> Check on Google Maps
                            </a>`;
                        }
                        
                        addrText.innerHTML = html;

                        locateBtn.innerHTML = `<i data-lucide="refresh-cw" size="14"></i><span>Update Location</span>`;
                        locateBtn.classList.remove('bg-blue-50', 'text-blue-700', 'border-blue-100');
                        locateBtn.classList.add('bg-white', 'text-gray-500', 'border-gray-200', 'text-xs', 'py-2');
                    } else {
                        addrPreview.classList.add('hidden');
                        locateBtn.innerHTML = `<i data-lucide="crosshair" size="16"></i><span>One-Click Auto Address</span>`;
                        locateBtn.classList.add('bg-blue-50', 'text-blue-700', 'border-blue-100', 'text-sm', 'py-3');
                        locateBtn.classList.remove('bg-white', 'text-gray-500', 'border-gray-200', 'text-xs', 'py-2');
                    }
                    if(window.lucide) window.lucide.createIcons();
                };
                renderAddress();

                const updateModalUI = () => {
                    const currentCart = Store.state.cart;
                    const itemsHtml = CONSTANTS.PRODUCTS.map(p => {
                        const qty = currentCart[p.id] || 0;
                        return `<div class="flex items-center justify-between py-3 border-b border-gray-50 last:border-0"><div class="flex items-center gap-3"><div class="w-12 h-12 bg-gray-50 rounded-lg overflow-hidden border border-gray-200 shrink-0"><img src="${p.imageSrc}" class="w-full h-full object-cover"></div><div class="flex flex-col"><div class="font-bold text-gray-800 text-sm">${p.name}</div></div></div><div class="flex items-center gap-3 bg-white border border-gray-200 rounded-lg p-1 shadow-sm"><button class="btn-minus w-8 h-8 flex items-center justify-center bg-white text-gray-600" data-id="${p.id}" data-delta="-${p.step}"><i data-lucide="minus" size="14"></i></button><span class="w-10 text-center text-sm font-bold text-gray-800 tabular-nums">${qty > 0 ? Utils.Pricing.formatQty(qty) : '0'}</span><button class="btn-plus w-8 h-8 flex items-center justify-center bg-jodo-ctaPrimary text-white rounded-md shadow-sm" data-id="${p.id}" data-delta="${p.step}"><i data-lucide="plus" size="14"></i></button></div></div>`;
                    }).join('');
                    node.querySelector('#modal-items-container').innerHTML = itemsHtml;
                    if(window.lucide) window.lucide.createIcons();
                    node.querySelectorAll('.btn-minus, .btn-plus').forEach(btn => { btn.onclick = () => { Actions.updateCart(btn.dataset.id, parseFloat(btn.dataset.delta)); updateModalUI(); } });
                };
                updateModalUI();

                const validate = () => {
                    const n = nameInp.value.trim();
                    const p = phoneInp.value.trim();
                    
                    const isNameValid = n.length > 0;
                    const isPhoneValid = /^\d{10}$/.test(p);
                    const hasAddress = detectedAddress.street && detectedAddress.street.length > 0;

                    const valid = isNameValid && isPhoneValid && hasAddress;
                    
                    actionBtn.disabled = !valid;
                    actionBtn.style.opacity = valid ? '1' : '0.5';
                    actionBtn.style.cursor = valid ? 'pointer' : 'not-allowed';

                    if (!valid) {
                        const btnText = node.querySelector('#action-btn span');
                        if (!isNameValid) btnText.innerText = "Enter Name";
                        else if (!isPhoneValid) btnText.innerText = "Enter 10-digit Phone";
                        else if (!hasAddress) btnText.innerText = "Detect Location";
                    } else {
                        const btnText = node.querySelector('#action-btn span');
                        btnText.innerText = isManual ? "Add Manual Order" : "Confirm Joining";
                    }
                };
                nameInp.addEventListener('input', validate);
                phoneInp.addEventListener('input', validate);
                validate(); 

                // ‚úÖ LOCATION LOGIC
                locateBtn.onclick = () => {
                    if (!navigator.geolocation) {
                        this.toast("Geolocation not supported", "alert-circle");
                        return;
                    }

                    locateBtn.disabled = true;
                    locateBtn.innerHTML = `<span class="animate-spin">‚åõ</span> Locating...`;

                    navigator.geolocation.getCurrentPosition(async (pos) => {
                        try {
                            const { latitude, longitude } = pos.coords;
                            locateBtn.innerHTML = `Fetching address...`;
                            
                            const googleMapsUrl = `https://www.google.com/maps?q=${latitude},${longitude}`;

                            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`);
                            const data = await response.json();
                            
                            if (data && (data.address || data.display_name)) {
                                const addr = data.address || {};
                                const parts = [
                                    addr.road,
                                    addr.suburb,
                                    addr.neighbourhood,
                                    addr.residential,
                                    addr.city_district,
                                    addr.city,
                                    addr.postcode
                                ].filter(Boolean);
                                
                                const uniqueParts = [...new Set(parts)];
                                let streetVal = uniqueParts.join(', ');
                                
                                if (!streetVal) {
                                    streetVal = data.display_name || "Unknown Location";
                                }

                                const houseVal = addr.house_number || '';

                                detectedAddress = { 
                                    flat: houseVal, 
                                    street: streetVal,
                                    lat: latitude,
                                    lng: longitude,
                                    url: googleMapsUrl
                                };
                                
                                renderAddress();
                                validate(); 
                                
                                this.toast("Location captured!", "check");
                                this.triggerVibration();
                            } else {
                                this.toast("Address not found", "help-circle");
                            }
                        } catch (e) {
                            console.error(e);
                            this.toast("Could not fetch address", "alert-triangle");
                        } finally {
                            locateBtn.disabled = false;
                            if (!detectedAddress.street) renderAddress(); 
                        }
                    }, (err) => {
                        console.error(err);
                        this.toast("Location permission denied", "lock");
                        locateBtn.disabled = false;
                        renderAddress(); 
                    }, { enableHighAccuracy: true, timeout: 10000 });
                };

                node.querySelector('#close-modal').onclick = this.closeModal;
                actionBtn.onclick = async () => {
                    if(actionBtn.disabled) return;
                    if (Object.keys(Store.state.cart).length === 0) { this.toast("Select at least one item", "shopping-bag"); return; }
                    
                    const name = nameInp.value.trim();
                    const phone = phoneInp.value.trim();
                    
                    actionBtn.disabled = true; actionBtn.innerHTML = 'Joining...';
                    
                    const success = await Actions.submitOrder(name, phone, detectedAddress, joinGroupId, isManual);
                    
                    if (!success) { actionBtn.disabled = false; actionBtn.innerHTML = `<span>Try Again</span>`; } else { this.closeModal(); }
                };
            },
            
            toast(msg, icon) {
                const t = document.getElementById('toast');
                t.innerHTML = `<i data-lucide="${icon}" size="16" class="text-white"></i> ${msg}`;
                t.classList.remove('hidden');
                if(window.lucide) window.lucide.createIcons();
                setTimeout(() => t.classList.add('hidden'), 4000);
            },

            shareGroup(groupId, isValid) {
                const currentUrl = `${CONSTANTS.PUBLIC_SHARE_URL}?group=${groupId}`;
                const text = isValid ? `‚úÖ Group Order Placed. Join to increase volume and lower final price:` : `üö® My vegetable order will be CANCELLED tonight if ${CONSTANTS.MIN_GROUP_SIZE} people don't join. Help me confirm this group:`;
                window.open(`https://wa.me/?text=${encodeURIComponent(text + "\n\nüëâ " + currentUrl)}`, '_blank');
            },

            createNode(html) { const t = document.createElement('template'); t.innerHTML = html.trim(); return t.content.firstElementChild; },
            showModal(node) { const o = document.getElementById('modal-overlay'), c = document.getElementById('modal-content'); c.innerHTML=''; c.appendChild(node); o.classList.remove('hidden'); setTimeout(()=> { o.classList.remove('opacity-0'); c.classList.remove('translate-y-full'); }, 10); },
            closeModal() { const o = document.getElementById('modal-overlay'), c = document.getElementById('modal-content'); c.classList.add('translate-y-full'); o.classList.add('opacity-0'); setTimeout(()=> { o.classList.add('hidden'); c.innerHTML=''; }, 300); },
            triggerVibration() { if (navigator.vibrate) navigator.vibrate(10); },
            
            _timerInterval: null,
            startTimer(el, targetTime) {
                if (!el) return;
                if (this._timerInterval) clearInterval(this._timerInterval);
                const tick = () => {
                    const target = targetTime ? Utils.Time.getMillis(targetTime) : Utils.Time.getCutoffTimestamp();
                    const rem = target - Date.now();
                    if (rem <= 0) { el.textContent = "ENDED"; return; }
                    const h = Math.floor(rem/3600000);
                    const m = Math.floor((rem%3600000)/60000);
                    const s = Math.floor((rem%60000)/1000);
                    el.textContent = `${h}h ${m}m ${s}s left`;
                };
                tick();
                this._timerInterval = setInterval(tick, 1000);
            }
        };

        window.JodoApp = { Actions, UI };
        function bootstrap() { Actions.initApp(); }
        document.addEventListener('DOMContentLoaded', () => { bootstrap(); });
    </script>
</body>
</html>
