<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover" />
    <title>JODO</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üçÖ</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        jodo: {
                            base: '#FFFFFF',
                            textPrimary: '#111827',
                            textSecondary: '#4B5563',
                            ctaPrimary: '#15803D',
                            ctaSuccess: '#15803D',   
                            bonus: '#F3F4F6',        
                            bonusText: '#374151',   
                            urgency: '#4B5563',     
                            border: '#E5E7EB',       
                            error: '#DC2626',        
                        }
                    },
                    fontFamily: {
                        sans: ['-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'sans-serif'],
                    },
                    animation: {
                        'pop': 'pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)',
                        'fade-in-up': 'fadeInUp 0.5s ease-out'
                    },
                    keyframes: {
                        pop: { '0%': { transform: 'scale(0.95)' }, '100%': { transform: 'scale(1)' } },
                        fadeInUp: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } }
                    }
                }
            }
        }
    </script>
    <style>
        body { background: #FFFFFF; color: #111827; -webkit-tap-highlight-color: transparent; min-height: 100dvh; display: flex; justify-content: center; margin: 0; overscroll-behavior-y: none; }
        #app { width: 100%; max-width: 448px; background: #FFFFFF; min-height: 100dvh; position: relative; overflow-y: auto; display: flex; flex-direction: column; box-shadow: 0 0 20px rgba(0,0,0,0.05); }
        .btn-press { transition: transform 0.1s; cursor: pointer; user-select: none; }
        .btn-press:active:not(:disabled) { transform: scale(0.96); }
        .card-modern { background: #FFFFFF; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid #E5E7EB; }
        .glass-header { background: rgba(255, 255, 255, 0.98); border-bottom: 1px solid #E5E7EB; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .pt-safe { padding-top: env(safe-area-inset-top); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .fade-in { animation: fadeInUp 0.5s ease-out forwards; }
        .tilt-card { transition: transform 0.15s ease-out; transform-style: preserve-3d; }
        .price-anchor { color: #15803D; font-weight: 700; letter-spacing: -0.01em; }
        
        /* Loading skeleton shimmer */
        .skeleton {
            background: linear-gradient(90deg, #f3f4f6 25%, #e5e7eb 50%, #f3f4f6 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    </style>
</head>
<body class="antialiased">

    <div id="app"></div>

    <div id="modal-overlay" class="fixed inset-0 bg-black/60 hidden z-[60] flex items-end justify-center backdrop-blur-sm transition-opacity duration-300">
        <div id="modal-content" class="bg-white w-full max-w-[448px] rounded-t-[1.5rem] shadow-2xl transform transition-transform duration-300 translate-y-full max-h-[95dvh] flex flex-col overflow-hidden pb-safe"></div>
    </div>

    <div id="toast" class="fixed top-24 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-full text-sm font-medium shadow-xl hidden z-[90] flex items-center gap-2 pointer-events-none animate-pop pt-safe text-center w-max max-w-[90%]"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
          getFirestore,
          doc,
          setDoc,
          getDoc, 
          getDocs, 
          updateDoc,
          onSnapshot,
          collection,
          runTransaction
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const firebaseConfig = {
          apiKey: "",
          authDomain: "jodo-prod-e7788.firebaseapp.com",
          projectId: "jodo-prod-e7788",
          storageBucket: "jodo-prod-e7788.firebasestorage.app",
          messagingSenderId: "535883967600",
          appId: "1:535883967600:web:aa0b73a70ca506ad4fd8b5"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        window.db = db;
        window.fs = { doc, setDoc, getDoc, getDocs, updateDoc, onSnapshot, collection, runTransaction };
        
        console.log("üî• FIREBASE PROJECT:", window.db._databaseId ? window.db._databaseId.projectId : "Unknown");

        window.dispatchEvent(new Event('firebase-ready'));
    </script>
    
    <script>
        // --- CONSTANTS & CONFIG ---
        const COMPANY_PHONE = "918500742671"; 
        const BASE_URL = 'https://satyanarayanagaraga.github.io/jodo-mvp';
        const MIN_GROUP_SIZE = 2; 

        // üî• LOGIC: STRICT INVENTORY
        const HARD_LIMIT_KG = 5; 
        
        // üî• DATA: TOMATOES (Updated per Spec)
        const PRODUCTS = [
            { 
                id: 'tomato', 
                name: 'Fresh Tomatoes', 
                nameTe: '‡∞ü‡∞Æ‡∞æ‡∞ü‡∞æ‡∞≤‡±Å', 
                unit: '1kg', 
                baseWeight: 1, 
                weightUnit: 'kg', 
                price1: 40, // üî• UPDATED: Solo Price 40
                price5: 20, // Group Price
                mandiPrice: 35, 
                remainingStock: 50, 
                icon: 'circle-dot', 
                imageColor: 'bg-red-50 text-red-600', 
                location: 'Duvva Fields', 
                imageSrc: 'https://images.unsplash.com/photo-1592924357228-91a4daadcfea?auto=format&fit=crop&w=800&q=80' 
            }
        ];

        const GROUPS_KEY = 'jodo_groups_joined_v1';
        
        // --- HELPER FOR CUTOFF (9 PM TODAY) ---
        function getTodayCutoffTimestamp() {
          const now = new Date();
          now.setHours(21, 0, 0, 0); // Hard set to 9:00 PM
          return now.getTime();
        }
        
        function isPastCutoff() {
            return Date.now() > getTodayCutoffTimestamp();
        }

        // üî• REQ: TIMER STATE & HELPERS
        let cutoffTimerInterval = null;

        function formatRemaining(ms) {
            if (ms <= 0) return "Closed";
            
            const totalSeconds = Math.floor(ms / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;

            if (hours > 0) {
                return `${hours}h ${minutes}m left`;
            }
            return `${minutes}m ${seconds}s left`;
        }

        function startCutoffTimer(updateFn) {
            if (cutoffTimerInterval) clearInterval(cutoffTimerInterval);

            const tick = () => {
                const remaining = getTodayCutoffTimestamp() - Date.now();
                updateFn(remaining);

                if (remaining <= 0 && cutoffTimerInterval) {
                    clearInterval(cutoffTimerInterval);
                }
            };
            
            // Run immediately so we don't wait 1s for first render
            tick();

            cutoffTimerInterval = setInterval(tick, 1000);
        }

        const state = { 
            view: 'home', 
            currentGroupId: null, 
            groups: {}, 
            members: {}, 
            user: { name: '', phone: '', joinedGroupIds: [] }, 
            timerInterval: null, 
            lastMemberCount: 0,
            unsubGroup: null,
            unsubMembers: null,
            homeListeners: [] 
        };

        let JODO_INITIALIZED = false;
        let renderScheduled = false;
        let IS_JOIN_LINK = false;
        let JOIN_SESSION_PHONE = null;
        let AUTO_JOIN_TRIGGERED = false;

        function isJoinLinkVisitor() {
            return IS_JOIN_LINK && !JOIN_SESSION_PHONE;
        }

        function loadData() {
            try {
                state.user.name = localStorage.getItem('jodo_user_name') || '';
                state.user.phone = localStorage.getItem('jodo_user_phone') || '';
                const savedGroups = localStorage.getItem(GROUPS_KEY);
                state.user.joinedGroupIds = savedGroups ? JSON.parse(savedGroups) : [];
                
                if (state.user.phone) JOIN_SESSION_PHONE = state.user.phone;
            } catch(e) { console.error("Load Error", e); }
        }

        function saveUser(name, phone) {
            state.user.name = name;
            state.user.phone = phone;
            localStorage.setItem('jodo_user_name', name);
            localStorage.setItem('jodo_user_phone', phone);
            JOIN_SESSION_PHONE = phone;
        }

        window.logout = function() {
            localStorage.removeItem('jodo_user_name');
            localStorage.removeItem('jodo_user_phone');
            state.user = { name: '', phone: '', joinedGroupIds: [] };
            JOIN_SESSION_PHONE = null;
            window.location.reload();
        }

        function saveJoinedGroup(gid) {
            if (!state.user.joinedGroupIds.includes(gid)) {
                state.user.joinedGroupIds.push(gid);
                localStorage.setItem(GROUPS_KEY, JSON.stringify(state.user.joinedGroupIds));
                listenToGroupForHome(gid);
            }
        }

        function toast(msg, icon) { 
            const t = document.getElementById('toast'); 
            const iconColor = icon === 'alert-circle' || icon === 'alert-triangle' || icon === 'wifi-off' || icon === 'lock' || icon === 'share-2' ? 'text-white' : 'text-green-400';
            // Specific style for the share toast
            if (icon === 'share-2') {
                t.className = "fixed top-24 left-1/2 -translate-x-1/2 bg-blue-600 text-white px-6 py-3 rounded-full text-sm font-bold shadow-xl hidden z-[90] flex items-center gap-2 pointer-events-none animate-pop pt-safe";
            } else {
                t.className = "fixed top-24 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-full text-sm font-medium shadow-xl hidden z-[90] flex items-center gap-2 pointer-events-none animate-pop pt-safe";
            }
            
            t.innerHTML = `<i data-lucide="${icon}" size="16" class="${iconColor}"></i> ${msg}`; 
            t.classList.remove('hidden'); 
            if(window.lucide) window.lucide.createIcons(); 
            setTimeout(() => t.classList.add('hidden'), 4000); 
        }

        function triggerVibration() { 
            if (navigator.vibrate) navigator.vibrate(10); 
        }

        function resetActionButton(btn, html) {
            if(!btn) return;
            btn.disabled = false;
            btn.innerHTML = html;
            btn.classList.remove('opacity-75', 'cursor-not-allowed');
        }

        function createNodeFromHTML(html) { 
            const t = document.createElement('template'); 
            t.innerHTML = html.trim(); 
            return t.content.firstElementChild; 
        }
        
        function showModalNode(node) { 
            const overlay = document.getElementById('modal-overlay');
            const content = document.getElementById('modal-content');
            content.innerHTML = ''; content.appendChild(node); 
            overlay.classList.remove('hidden'); 
            setTimeout(() => { 
                overlay.classList.remove('opacity-0'); 
                content.classList.remove('translate-y-full'); 
            }, 10);
            if(node.querySelector('input')) node.querySelector('input').focus(); 
            if(window.lucide) window.lucide.createIcons(); 
        }

        window.closeModal = () => {
            const overlay = document.getElementById('modal-overlay');
            const content = document.getElementById('modal-content');
            content.classList.add('translate-y-full');
            overlay.classList.add('opacity-0');
            setTimeout(() => { 
                overlay.classList.add('hidden'); 
                content.innerHTML = ''; 
            }, 300);
        };

        function safeVal(el) { return (el && el.value) ? el.value.trim() : ''; }

        function initCardTilt() {
            if (window.matchMedia("(pointer: coarse)").matches) return;
            const cards = document.querySelectorAll('.tilt-card');
            cards.forEach(card => {
                card.addEventListener('mousemove', (e) => {
                    const rect = card.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    const centerX = rect.width / 2;
                    const centerY = rect.height / 2;
                    const rotateX = ((y - centerY) / centerY) * -3; 
                    const rotateY = ((x - centerX) / centerX) * 3;
                    card.style.transform = `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg) scale3d(1.01, 1.01, 1.01)`;
                });
                card.addEventListener('mouseleave', () => {
                    card.style.transform = `perspective(1000px) rotateX(0deg) rotateY(0deg) scale3d(1, 1, 1)`;
                });
            });
        }

        window.openSupportOptions = function() {
            window.open("https://wa.me/" + COMPANY_PHONE, "_blank");
        };

        // üî• REQ: Conditional Invite Message (No Absolute Price)
        function generateInviteLink(groupId, isUnlocked) {
            const currentUrl = `${BASE_URL}?group=${groupId}`;
            
            let inviteMsg;
            if (!isUnlocked) {
                const remaining = Math.max(1, MIN_GROUP_SIZE - 1);
                // üîê LOCKED SHARE (BEFORE UNLOCK)
                inviteMsg = `‡∞à‡∞∞‡±ã‡∞ú‡±Å ‡∞ü‡∞Æ‡∞æ‡∞ü‡∞æ‡∞≤ ‡∞°‡±Ä‡∞≤‡±ç ‡∞≤‡±à‡∞µ‡±ç‚Äå‡∞≤‡±ã ‡∞â‡∞Ç‡∞¶‡∞ø

‡∞á‡∞Ç‡∞ï‡∞æ ${remaining} ‡∞Æ‡∞Ç‡∞¶‡∞ø ‡∞ú‡∞æ‡∞Ø‡∞ø‡∞®‡±ç ‡∞Ö‡∞Ø‡∞ø‡∞§‡±á
‡∞π‡±ã‡∞≤‡±ç‚Äå‡∞∏‡±á‡∞≤‡±ç ‡∞∞‡±á‡∞ü‡±ç ‡∞ì‡∞™‡±Ü‡∞®‡±ç ‡∞Ö‡∞µ‡±Å‡∞§‡±Å‡∞Ç‡∞¶‡∞ø

‡∞®‡±á‡∞®‡±Å ‡∞Æ‡±ä‡∞¶‡∞≤‡±Å‡∞™‡±Ü‡∞ü‡±ç‡∞ü‡∞æ‡∞®‡±Å  
‡∞®‡±Å‡∞µ‡±ç‡∞µ‡±Å ‡∞ú‡∞æ‡∞Ø‡∞ø‡∞®‡±ç ‡∞Ö‡∞Ø‡∞ø‡∞§‡±á ‡∞Ö‡∞Ç‡∞¶‡∞∞‡∞ø‡∞ï‡±Ä ‡∞≤‡∞æ‡∞≠‡∞Ç

‡∞∞‡∞æ‡∞§‡±ç‡∞∞‡∞ø 9 ‡∞§‡∞∞‡±ç‡∞µ‡∞æ‡∞§ ‡∞ï‡±ç‡∞≤‡±ã‡∞ú‡±ç

üëâ ${currentUrl}`;
            } else {
                // üîì UNLOCKED SHARE (THIS IS WHERE VIRALITY HAPPENS)
                inviteMsg = `‡∞à‡∞∞‡±ã‡∞ú‡±Å ‡∞ü‡∞Æ‡∞æ‡∞ü‡∞æ‡∞≤ ‡∞π‡±ã‡∞≤‡±ç‚Äå‡∞∏‡±á‡∞≤‡±ç ‡∞°‡±Ä‡∞≤‡±ç ‡∞Ö‡∞®‡±ç‚Äå‡∞≤‡∞æ‡∞ï‡±ç ‡∞Ö‡∞Ø‡±ç‡∞Ø‡∞ø‡∞Ç‡∞¶‡∞ø ‚úÖ

‡∞Æ‡∞æ ‡∞ó‡±ç‡∞∞‡±Ç‡∞™‡±ç‚Äå‡∞≤‡±ã ‡∞Ö‡∞Ç‡∞¶‡∞∞‡±Ç ‡∞§‡∞ï‡±ç‡∞ï‡±Å‡∞µ ‡∞ß‡∞∞‡∞ï‡±á ‡∞ï‡±ä‡∞Ç‡∞ü‡±Å‡∞®‡±ç‡∞®‡∞æ‡∞∞‡±Å  
‡∞á‡∞™‡±ç‡∞™‡±Å‡∞°‡±á ‡∞ú‡∞æ‡∞Ø‡∞ø‡∞®‡±ç ‡∞Ö‡∞Ø‡∞ø‡∞§‡±á ‡∞®‡±Ä‡∞ï‡±Ç ‡∞Ö‡∞¶‡±á ‡∞∞‡±á‡∞ü‡±ç

‡∞∞‡∞æ‡∞§‡±ç‡∞∞‡∞ø 9 ‡∞≤‡±ã‡∞™‡±Å ‡∞Æ‡∞æ‡∞§‡±ç‡∞∞‡∞Æ‡±á  
‡∞§‡∞∞‡±ç‡∞µ‡∞æ‡∞§ ‡∞∑‡∞æ‡∞™‡±Å ‡∞ß‡∞∞‡∞ï‡±á

üëâ ${currentUrl}`;
            }
            
            return `https://wa.me/?text=${encodeURIComponent(inviteMsg)}`;
        }

        // --- GLOBAL FUNCTIONS ---
        
        // üî• WISHLIST FUNCTION
        window.addToWishlist = async function(productId, quantity, phone, name = null, groupId = null) {
            if (!window.db || !window.fs || !phone) return;

            try {
                const ref = window.fs.doc(
                    window.db,
                    "wishlists",
                    `${productId}_${phone}_${Date.now()}`
                );

                await window.fs.setDoc(ref, {
                    productId,
                    groupId: groupId || null,
                    name: name || state.user.name || null,
                    phone,
                    quantity,
                    createdAt: Date.now(),
                    status: "pending"
                });

                console.log("üìå Added to wishlist (Stock Full)", productId, phone);
            } catch (e) {
                console.error("Wishlist add failed", e);
            }
        };
        
        // üî• FIXED JOIN FLOW
        window.openJoinFlow = function(gid) {
            if (IS_JOIN_LINK) {
                state.user.name = '';
                state.user.phone = '';
                JOIN_SESSION_PHONE = null; 
            }

            const g = state.groups[gid];

            if (!g) {
                toast("Loading order details...", "loader");
                return;
            }
            
            if (isPastCutoff()) {
                toast("Orders closed for today", "clock");
                return;
            }

            window.openStartModal(g.productId, gid);
        };

        // üî• FIXED MODAL
        window.openStartModal = function(productOrId, joinGroupId = null) {
            
            if (isPastCutoff()) {
                toast("Orders closed. Please try tomorrow.", "clock");
                return;
            }
            
            let p;
            
            if (typeof productOrId === 'string') {
                p = PRODUCTS.find(x => x.id === productOrId);
            } else {
                p = productOrId;
            }

            if (!p) {
                toast("Product Unavailable", "alert-circle");
                return;
            }
            
            const pid = p.id;
            const user = state.user;
            
            let qty = 0.25;
            let isGroupMode = true;
            
            // üî• LOGIC: Calculate remaining stock visually
            let remainingKg = 0;
            if (joinGroupId && state.groups[joinGroupId]) {
                const g = state.groups[joinGroupId];
                const max = g.maxKg !== undefined ? g.maxKg : 0; 
                const used = g.usedKg || 0;
                remainingKg = Math.max(0, max - used);
            } else if (!joinGroupId) {
                remainingKg = HARD_LIMIT_KG; 
            }

            if (joinGroupId && remainingKg <= 0) {
                 toast("Stock finished. Join wishlist only.", "lock");
            }
            
            const title = joinGroupId ? "Join Order" : "Start Order";
            const btnText = "Join Order";

            // üî• CHECK UNLOCK STATUS FOR MODAL (Req 2)
            let isGroupUnlockedForModal = false;
            if (joinGroupId && state.members[joinGroupId]) {
                 isGroupUnlockedForModal = state.members[joinGroupId].length >= MIN_GROUP_SIZE;
            }
            // If creating a new group (joinGroupId is null), it's not unlocked yet but we show the target price.
            // If joining an existing group, we hide the price if not unlocked.

            const node = createNodeFromHTML(`
                <div class="flex flex-col h-[90vh] bg-white relative rounded-t-[1.5rem] overflow-hidden font-sans">
                    <div class="bg-white px-5 py-4 flex items-center justify-between border-b border-gray-100 shrink-0 z-20">
                        <div class="flex items-center gap-2"><h3 class="font-bold text-lg text-gray-800">${title}</h3></div>
                        <button id="close-modal" class="p-2 bg-gray-50 rounded-full text-gray-500 hover:bg-gray-100 transition-colors"><i data-lucide="x" size="20"></i></button>
                    </div>
                    <div class="p-5 overflow-y-auto flex-1 relative">
                        <div class="flex gap-4 mb-6 items-center">
                            <div class="w-24 h-24 rounded-xl bg-gray-50 border border-gray-100 relative overflow-hidden shrink-0 shadow-sm">
                                <img src="${p.imageSrc}" class="w-full h-full object-cover" alt="${p.name}">
                            </div>
                            <div class="flex-1 flex flex-col justify-center"><h4 class="font-bold text-2xl text-gray-900 leading-none mb-1">${p.name}</h4><div class="text-base text-gray-500 mb-1">${p.nameTe}</div><div class="text-xs text-green-700 font-bold bg-green-50 px-2 py-1 rounded-full w-fit">${joinGroupId ? remainingKg + ' kg left' : 'Fresh Stock'}</div></div>
                        </div>
                        
                        ${!joinGroupId ? `
                        <div class="grid grid-cols-2 gap-3 mb-2">
                            <div id="mode-solo" class="relative p-4 rounded-xl border bg-white cursor-pointer active:scale-95 transition-all flex flex-col h-full">
                                <div class="font-bold text-gray-900 text-lg mb-1">Solo Buy</div>
                                <div class="text-xs text-gray-500 leading-tight mb-1">Same price as nearby shops</div>
                                <div class="text-[10px] text-gray-400">No sharing needed</div>
                                <div class="mt-auto pt-3 font-bold text-gray-900 price-text">‚Çπ${p.price1} / ${p.unit}</div>
                            </div>
                            
                            <div id="mode-group" class="relative p-4 rounded-xl border bg-green-50/30 cursor-pointer active:scale-95 transition-all flex flex-col h-full">
                                <div class="font-bold text-gray-900 text-lg leading-tight mb-1">Group Buy <span class="text-sm font-medium text-gray-500">(Smart Price)</span></div>
                                <div class="text-xs text-gray-600 leading-tight mb-1">Wholesale rate ‚Ä¢ Order with others</div>
                                <div class="mt-auto pt-3 flex flex-wrap items-center gap-2">
                                    <span class="font-bold text-green-700 price-text">‚Çπ${p.price5} / ${p.unit}</span>
                                    <span class="text-[9px] bg-green-100 text-green-700 border border-green-200 px-1.5 py-0.5 rounded-full font-bold whitespace-nowrap">üí° Smart choice</span>
                                </div>
                            </div>
                        </div>
                        <div class="text-center text-[10px] text-gray-400 mb-6 mt-1 font-medium">Same quality ‚Ä¢ Same pickup ‚Ä¢ Only price differs</div>
                        ` : ''}

                        <div class="bg-white p-3 rounded-xl border border-gray-200 mb-6 flex items-center justify-between">
                            <div class="pl-1"><div class="text-xs font-bold text-gray-500 uppercase tracking-wide">Quantity</div><div class="text-[10px] text-gray-400">Min 250 g</div></div>
                            <div class="flex items-center gap-3 bg-gray-50 p-1 rounded-lg border border-gray-200"><button id="btn-minus" class="w-10 h-10 rounded-md bg-white border border-gray-200 text-gray-500 flex items-center justify-center active:scale-90 transition-all"><i data-lucide="minus" size="18"></i></button><div class="text-lg font-bold text-gray-800 w-20 text-center leading-none tabular-nums" id="qty-display">250 g</div><button id="btn-plus" class="w-10 h-10 rounded-md bg-jodo-ctaPrimary text-white shadow-sm flex items-center justify-center active:scale-90 transition-all"><i data-lucide="plus" size="18"></i></button></div>
                        </div>
                        <div class="space-y-4 mb-8">
                            <div class="relative group"><div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-gray-400"><i data-lucide="user" size="18"></i></div><input id="inp-name" value="${user.name}" class="w-full bg-white border border-gray-300 py-3 pl-12 pr-4 rounded-lg font-medium text-gray-900 outline-none focus:border-green-600 focus:ring-1 focus:ring-green-600 transition-all placeholder-gray-400" placeholder="Your Name"></div>
                            <div class="relative group"><div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-gray-400"><i data-lucide="phone" size="18"></i></div><input id="inp-phone" value="${user.phone}" type="tel" class="w-full bg-white border border-gray-300 py-3 pl-12 pr-4 rounded-lg font-medium text-gray-900 outline-none focus:border-green-600 focus:ring-1 focus:ring-green-600 transition-all placeholder-gray-400" placeholder="Mobile Number"></div>
                        </div>
                    </div>
                    <div class="bg-white border-t border-gray-100 p-4 shrink-0 pb-safe shadow-[0_-4px_10px_rgba(0,0,0,0.02)] z-20">
                        <div class="flex justify-between items-end mb-3 px-1"><div><div class="text-[10px] text-gray-500 font-bold uppercase">Total</div><div class="text-3xl font-bold text-gray-900 leading-none" id="footer-total">‚Çπ0</div></div></div>
                        <div class="text-center text-[11px] text-gray-500 font-medium mb-2">No payment now ‚Ä¢ Pay on delivery</div>
                        <button id="action-btn" class="w-full bg-jodo-ctaPrimary text-white h-[56px] rounded-xl font-bold text-lg shadow-sm flex items-center justify-center gap-2 cursor-pointer active:scale-[0.99] transition-all btn-press">
                            <span id="btn-text-action">${btnText}</span>
                        </button>
                    </div>
                </div>
            `);
            showModalNode(node);

            const modeSoloEl = node.querySelector('#mode-solo');
            const modeGroupEl = node.querySelector('#mode-group');
            const footerTotalEl = node.querySelector('#footer-total');
            const btnTextEl = node.querySelector('#btn-text-action');
            const actionBtn = node.querySelector('#action-btn');

            const renderMode = () => {
                const t1 = Math.round(p.price1 * qty);
                const t5 = Math.round(p.price5 * qty);
                
                if (!joinGroupId) {
                    modeSoloEl.className = `relative p-4 rounded-xl border cursor-pointer transition-all flex flex-col h-full active:scale-95 ${!isGroupMode ? 'border-gray-400 bg-gray-50 ring-1 ring-gray-200' : 'border-gray-200 bg-white'}`;
                    modeGroupEl.className = `relative p-4 rounded-xl border cursor-pointer transition-all flex flex-col h-full active:scale-95 ${isGroupMode ? 'border-green-500 bg-green-50/50 ring-1 ring-green-200' : 'border-gray-200 bg-white'}`;
                    
                    modeSoloEl.querySelector('.price-text').innerText = `‚Çπ${t1}`;
                    modeGroupEl.querySelector('.price-text').innerText = `‚Çπ${t5}`;
                }

                let qtyText;
                if (qty < 1) {
                    qtyText = (qty * 1000).toFixed(0) + ' g';
                } else {
                    qtyText = qty + ' kg';
                }
                node.querySelector('#qty-display').innerText = qtyText;
                
                if (isGroupMode) { 
                    btnTextEl.innerText = joinGroupId ? "Confirm Join" : "Confirm Order"; 
                } else { 
                    btnTextEl.innerText = "Confirm Order"; 
                }

                // üî• CRITICAL FIX: PREVENT PRICE LEAK IN LOCKED STATE
                // Do not calculate total at all if locked. Prevents reverse-engineering price.
                if (joinGroupId && !isGroupUnlockedForModal) {
                     footerTotalEl.innerHTML = `<span class="text-gray-400 text-xl flex items-center gap-1"><i data-lucide="lock" size="18"></i> Locked</span>`;
                     return;
                }
                
                const effectivePrice = (isGroupMode ? p.price5 : p.price1);
                const total = Math.round(effectivePrice * qty);
                footerTotalEl.innerText = `‚Çπ${total}`;
            };

            if (!joinGroupId) {
                modeSoloEl.onclick = () => { isGroupMode = false; renderMode(); };
                modeGroupEl.onclick = () => { isGroupMode = true; renderMode(); };
            }
            
            const btnMinus = node.querySelector('#btn-minus'); 
            if (btnMinus) btnMinus.onclick = () => { 
                if (qty <= 0.25) { 
                    toast("Minimum quantity reached", 'alert-triangle'); 
                    triggerVibration(); 
                    return;
                }
                
                if (qty <= 0.5) qty = 0.25;
                else if (qty <= 1.0) qty = 0.5;
                else qty -= 0.5;

                renderMode(); 
            }; 
            
            const btnPlus = node.querySelector('#btn-plus'); 
            if (btnPlus) btnPlus.onclick = () => { 
                let nextQty;
                if (qty < 0.5) nextQty = 0.5;
                else if (qty < 1.0) nextQty = 1.0;
                else nextQty = qty + 0.5;

                if (!joinGroupId) {
                    if (nextQty * p.baseWeight > HARD_LIMIT_KG) {
                          toast("Max order size is " + HARD_LIMIT_KG + "kg", "alert-circle");
                          return;
                    }
                } 
                else {
                    if (nextQty * p.baseWeight > remainingKg) {
                          toast("Max available stock reached", "alert-circle");
                          return;
                    }
                }
                
                qty = nextQty;
                renderMode(); 
            };

            renderMode(); 
            node.querySelector('#close-modal').addEventListener('click', window.closeModal);
            
            // --- SUBMIT ACTION ---
            const triggerAction = async () => {
                if (!navigator.onLine) {
                    toast("No internet connection", "wifi-off");
                    return;
                }
                
                if (isPastCutoff()) {
                    toast("Order time ended (9 PM cutoff)", "clock");
                    window.location.reload();
                    return;
                }

                if (actionBtn.disabled) return; 
                actionBtn.disabled = true;
                const originalText = actionBtn.innerHTML; 
                actionBtn.innerHTML = `<div class="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>`; 
                actionBtn.classList.add('opacity-75', 'cursor-not-allowed');
                
                const name = safeVal(node.querySelector('#inp-name')); 
                const phone = safeVal(node.querySelector('#inp-phone')); 
                
                if (!name || !/^[6-9]\d{9}$/.test(phone)) { 
                    resetActionButton(actionBtn, originalText);
                    toast('Please enter name and mobile number', 'alert-circle'); 
                    return; 
                }
                
                triggerVibration(); 
                saveUser(name, phone); 
                
                const memberId = phone; 
                const finalGroupId = joinGroupId || ('g-' + Date.now().toString(36) + Math.random().toString(36).slice(2, 6));

                if (!window.fs || !window.db) {
                      toast("Connecting...", "wifi");
                      await new Promise(r => setTimeout(r, 1000));
                }

                let committedQty = 0; 
                let currentMemberCount = 1;

                // üî• 1. START GROUP FLOW (CREATE)
                if (!joinGroupId) {
                    try {
                        const requestedKg = qty * p.baseWeight;
                        if (requestedKg > HARD_LIMIT_KG) throw new Error("CREATOR_QTY_EXCEEDS_STOCK");

                        const groupData = { 
                            id: finalGroupId, 
                            productId: pid, 
                            productSnapshot: { ...p },
                            ownerName: name, 
                            expiresAt: getTodayCutoffTimestamp(), 
                            deliveryDay: getTodayCutoffTimestamp(), 
                            createdAt: Date.now(), 
                            type: isGroupMode ? 'group' : 'solo',
                            maxKg: HARD_LIMIT_KG,
                            usedKg: requestedKg
                        };
                        
                        const memberData = { 
                            memberId, 
                            groupId: finalGroupId, 
                            name, 
                            phone, 
                            isLeader: true, 
                            quantity: qty, 
                            joinedAt: Date.now() 
                        };
                        
                        await window.fs.setDoc(window.fs.doc(window.db, "groups", finalGroupId), groupData);
                        await window.fs.setDoc(window.fs.doc(window.db, "groups", finalGroupId, "members", memberId), memberData);
                        
                        saveJoinedGroup(finalGroupId);
                        JOIN_SESSION_PHONE = phone;
                        committedQty = qty; 
                        
                        // üî• MANDATORY CHECK: FORCE SHARE IF GROUP MODE & < MIN_MEMBERS
                        // Creator starts with 1 member. 1 < 2. Always hits.
                        if (isGroupMode) {
                            const inviteLink = generateInviteLink(finalGroupId, false); // Locked initially
                            window.open(inviteLink, '_blank');
                            toast("Invite 1 more person to unlock group price", "share-2");
                            
                            // DO NOT Show Success Modal. Direct to Group View to see "Locked" state.
                            window.closeModal();
                            window.openGroup(finalGroupId);
                            return;
                        }

                        // Solo mode or other fallbacks
                        setTimeout(() => { 
                            window.closeModal(); 
                            if (isGroupMode) window.openGroup(finalGroupId); 
                            else { 
                                toast("Order Confirmed", "check-circle"); 
                                render(); 
                            } 
                        }, 500);

                    } catch(e) {
                         console.error(e);
                         resetActionButton(actionBtn, originalText);
                         toast("Error creating group", "alert-triangle");
                    }
                    return;
                }

                // üî• 2. JOIN GROUP FLOW
                try {
                    await window.fs.runTransaction(window.db, async (transaction) => {
                        const groupRef = window.fs.doc(window.db, "groups", finalGroupId);
                        const groupSnap = await transaction.get(groupRef);

                        if (!groupSnap.exists()) {
                            throw "GROUP_NOT_FOUND";
                        }
                        
                        const { maxKg, usedKg } = groupSnap.data();
                        const currentMax = maxKg !== undefined ? maxKg : HARD_LIMIT_KG;
                        const currentUsed = usedKg || 0;
                        const remaining = currentMax - currentUsed;
                        const requested = qty * p.baseWeight;

                        if (remaining < requested) throw "INSUFFICIENT_STOCK";
                        
                        // Get current member count approx (can't do exact in transaction efficiently without counter, assumes UI handles it mostly)
                        // But we will handle visual unlock in the success part.

                        const memberRef = window.fs.doc(window.db, "groups", finalGroupId, "members", memberId);
                        const memberSnap = await transaction.get(memberRef);
                        if (memberSnap.exists()) throw "ALREADY_JOINED";

                        transaction.set(memberRef, {
                            memberId: phone,
                            name,
                            phone,
                            groupId: finalGroupId,
                            quantity: qty,
                            joinedAt: Date.now(),
                            isLeader: false
                        });

                        transaction.update(groupRef, {
                             usedKg: currentUsed + requested
                        });
                        
                        committedQty = qty;
                    });

                    saveJoinedGroup(finalGroupId);
                    JOIN_SESSION_PHONE = phone;
                    IS_JOIN_LINK = false; 
                    AUTO_JOIN_TRIGGERED = true;

                    if (state.groups[finalGroupId]) {
                        state.groups[finalGroupId].usedKg = (state.groups[finalGroupId].usedKg || 0) + (committedQty * p.baseWeight);
                    }
                    
                    // üî• REMOVED RACE CONDITION LOGIC (Req 3)
                    // We simply close modal and open group. Group view handles lock logic.

                    window.closeModal();
                    window.openGroup(finalGroupId);

                } catch (e) {
                    console.error("Transaction Failed:", e);
                    if (e === "INSUFFICIENT_STOCK") {
                        await window.addToWishlist(pid, qty, phone, name, finalGroupId);
                        resetActionButton(actionBtn, originalText);
                        window.closeModal();
                        toast("Stock finished. Added to wishlist.", "clock");
                    } else if (e === "ALREADY_JOINED") {
                        saveJoinedGroup(finalGroupId);
                        window.closeModal();
                        window.openGroup(finalGroupId);
                        toast("Already joined!", "check-circle");
                    } else if (e === "GROUP_NOT_FOUND") {
                         resetActionButton(actionBtn, originalText);
                         toast("Group not found", "alert-circle");
                    } else {
                        resetActionButton(actionBtn, originalText);
                        toast("Transaction failed. Try again.", "alert-triangle");
                    }
                }
            };
            actionBtn.onclick = triggerAction;
        };

        window.openEditMemberModal = function() {
            toast("Order is final. No edits allowed.", "lock");
            return;
        };

        function renderHome(el) {
            // Cleanup timer before rendering new view
            if (cutoffTimerInterval) { clearInterval(cutoffTimerInterval); cutoffTimerInterval = null; }

            const activeUserGroups = [];
            state.user.joinedGroupIds.forEach(gid => {
                if (state.groups[gid]) activeUserGroups.push(state.groups[gid]);
            });
            activeUserGroups.sort((a, b) => b.createdAt - a.createdAt);
            
            const userActiveGroupIds = {};
            activeUserGroups.forEach(g => { userActiveGroupIds[g.productId] = g.id; });
            
            const sortedProducts = [...PRODUCTS].sort((a, b) => { 
                const aActive = !!userActiveGroupIds[a.id]; 
                const bActive = !!userActiveGroupIds[b.id]; 
                if (aActive && !bActive) return -1; 
                if (!aActive && bActive) return 1; 
                return 0; 
            });

            let heroContent = '';
            if (activeUserGroups.length > 0) {
                const cardsHtml = activeUserGroups.map(g => {
                    const p = g.productSnapshot || PRODUCTS.find(x => x.id === g.productId);
                    if (!p) return '';
                    
                    const members = state.members[g.id] || []; 
                    const count = members.length;
                    
                    const isUnlocked = count >= MIN_GROUP_SIZE;
                    const statusLabel = isUnlocked ? 'Active' : `${Math.max(0, MIN_GROUP_SIZE - count)} more`;
                    const statusClass = isUnlocked ? 'text-green-700 bg-green-50 border-green-200' : 'text-gray-600 bg-gray-50 border-gray-200';
                    
                    return `<div onclick="openGroup('${g.id}')" class="shrink-0 w-[85%] max-w-[280px] snap-center cursor-pointer card-modern tilt-card">
                        <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-200 relative overflow-hidden h-full flex flex-col justify-between">
                            <div class="flex items-center gap-3 mb-3 relative z-10 mt-2">
                                <div class="w-12 h-12 bg-gray-50 border border-gray-100 rounded-lg flex items-center justify-center text-gray-700 shadow-sm shrink-0"><i data-lucide="${p.icon}" size="24"></i></div>
                                <div class="flex-1 min-w-0"><h3 class="font-bold text-gray-900 text-base leading-none mb-2 truncate">${p.name}</h3>
                                    <div class="flex items-center justify-between gap-2">
                                        <div class="${statusClass} text-[9px] font-bold px-2 py-0.5 rounded border uppercase tracking-wider whitespace-nowrap">${statusLabel}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>`;
                }).join('');
                heroContent = `<div class="mt-6 mb-4"><div class="px-4 flex gap-3 overflow-x-auto snap-x snap-mandatory no-scrollbar pb-2">${cardsHtml}</div></div>`;
            }
            
            const isClosedGlobally = isPastCutoff();

            el.innerHTML = `
                <div class="pb-safe fade-in bg-white">
                    <div class="glass-header sticky top-0 z-40 shadow-sm border-b-0">
                        <div class="pt-safe px-4 pb-3 flex justify-between items-end min-h-[88px]">
                            <div class="flex flex-col justify-end pb-0.5">
                                <h1 class="font-black text-2xl tracking-tight text-jodo-ctaPrimary leading-none mb-1">JODO</h1>
                                <span class="text-[10px] text-gray-500 font-bold tracking-wide">Group up and save more</span>
                                <div id="home-timer" class="text-[10px] font-bold text-red-600 mt-1">Loading‚Ä¶</div>
                            </div>
                            <!-- REMOVED SUPPORT BUTTON FROM HEADER (REQ 7) -->
                        </div>
                    </div>

                    <div class="px-4 mt-4">
                        <div class="bg-gray-50 border border-gray-100 rounded-xl p-3 flex items-center justify-center gap-2">
                             <i data-lucide="home" size="16" class="text-gray-400"></i>
                             <div class="font-bold text-gray-700 text-sm">For households in Duvva Village</div>
                        </div>
                    </div>
                    
                    ${heroContent}
                    
                    <div class="px-4 space-y-3 mt-2 pb-32">
                        <div class="flex items-center justify-between mb-2 mt-6">
                            <h2 class="text-xs font-bold text-gray-500 uppercase tracking-widest">Open Orders</h2>
                        </div>
                        
                        ${sortedProducts.map(p => {
                            const activeGid = userActiveGroupIds[p.id];
                            
                            const actionAttr = activeGid 
                                ? `onclick="openGroup('${activeGid}')"` 
                                : `onclick="openStartModal('${p.id}')"`;
                            
                            const price5_1kg = Math.round(p.price5);
                            
                            // üî• REQ 1: HOME PAGE PRICE LOCKING
                            // Only show Price if Active Group Exists AND Unlocked
                            let isUnlocked = false;
                            if (activeGid && state.members[activeGid]) {
                                isUnlocked = state.members[activeGid].length >= MIN_GROUP_SIZE;
                            }
                            
                            const priceDisplay = isUnlocked 
                                ? `<div class="text-xl font-bold text-green-700">‚Çπ${price5_1kg}</div><div class="text-[9px] text-green-600 font-medium">/ kg</div>`
                                : `<div class="flex flex-col items-end"><div class="text-sm font-bold text-gray-400 flex items-center gap-1"><i data-lucide="lock" size="12"></i> LOCKED</div><div class="text-[9px] text-gray-400">Join to unlock</div></div>`;

                            return `
                            <div class="bg-white p-3 rounded-2xl flex gap-4 shadow-[0_2px_12px_rgba(0,0,0,0.04)] border border-gray-100 relative overflow-hidden active:scale-[0.99] transition-all duration-200 cursor-pointer ${isClosedGlobally ? 'opacity-70 grayscale-[0.5]' : ''}" ${actionAttr}>
                                <div class="w-28 h-28 bg-gray-50 rounded-xl shrink-0 relative overflow-hidden border border-gray-100">
                                    <img src="${p.imageSrc}" class="w-full h-full object-cover" alt="${p.name}" loading="lazy">
                                    ${isClosedGlobally 
                                      ? '<div class="absolute inset-0 bg-black/40 flex items-center justify-center"><span class="text-white font-bold text-xs bg-black/50 px-2 py-1 rounded">CLOSED</span></div>' 
                                      : '<div class="absolute bottom-0 left-0 right-0 bg-white/90 backdrop-blur-sm p-1 border-t border-gray-100"><div class="text-gray-800 text-[9px] font-bold text-center leading-none">Fresh Stock</div></div>'
                                    }
                                </div>

                                <div class="flex-1 flex flex-col justify-between py-0.5 min-w-0">
                                    <div>
                                        <h3 class="font-bold text-xl text-gray-900 leading-tight mb-1 line-clamp-1">${p.name}</h3>
                                        <p class="text-xs font-medium text-gray-500">${p.nameTe} ‚Ä¢ Fresh daily</p>
                                    </div>
                                    
                                    <div class="mt-auto">
                                        <div class="bg-green-50 border border-green-100 rounded-xl p-2.5 flex items-center justify-between">
                                            <div class="flex flex-col">
                                                <div class="flex items-center gap-1.5 mb-0.5">
                                                    <span class="text-[10px] font-black text-green-800 uppercase tracking-wide">Group Buy</span>
                                                    <span class="bg-white text-green-700 text-[8px] font-bold px-1.5 py-0.5 rounded border border-green-200 shadow-sm">SMART</span>
                                                </div>
                                                <div class="text-[9px] text-green-600 font-medium">Wholesale price</div>
                                            </div>
                                            <div class="text-right leading-none">
                                                ${priceDisplay}
                                                <div class="text-[9px] text-gray-500 font-bold mt-1">
                                                    ${state.members[activeGid]?.length || 0} people buying today
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>`;
                        }).join('')}
                    </div>
                </div>
            `;
            initCardTilt();

            // üî• START HOME TIMER
            const homeTimer = document.getElementById('home-timer');
            if (homeTimer) {
                startCutoffTimer((remaining) => {
                    homeTimer.textContent =
                      remaining > 0
                        ? `‚è∞ ${formatRemaining(remaining)} left ‚Äî miss it & price doubles tomorrow`
                        : "‚õî Missed today ‚Äî price is back to normal";
                });
            }
        }

        function renderGroup(el) {
            // Cleanup legacy timer state if exists, and global timer
            if (state.timerInterval) { clearInterval(state.timerInterval); state.timerInterval = null; }
            if (cutoffTimerInterval) { clearInterval(cutoffTimerInterval); cutoffTimerInterval = null; }
            
            const g = state.groups[state.currentGroupId]; 
            if (!g) {
                el.innerHTML = `
                <div class="min-h-screen bg-white p-6 pt-24 space-y-6">
                    <div class="w-2/3 h-8 bg-gray-100 rounded-lg skeleton mx-auto"></div>
                    <div class="w-1/2 h-4 bg-gray-100 rounded-lg skeleton mx-auto"></div>
                    <div class="w-full h-64 bg-gray-100 rounded-xl skeleton mt-8"></div>
                </div>`;
                return;
            }
            
            const p = g.productSnapshot || PRODUCTS.find(x => x.id === g.productId); 
            if (!p) { 
                toast('Product data missing', 'alert-circle'); 
                return;
            }
            
            const isExpired = Date.now() > g.expiresAt || isPastCutoff();
            
            const members = state.members[g.id] || []; 
            const count = members.length;
            
            // üî• REQ 1: GROUP PRICE LOCK LOGIC
            const isUnlocked = count >= MIN_GROUP_SIZE;
            
            const usedKg = g.usedKg || 0;
            const maxKg = g.maxKg !== undefined ? g.maxKg : HARD_LIMIT_KG;
            const isFull = usedKg >= maxKg;
            
            // üî• REQ 4: VISUAL INVENTORY PROGRESS BAR - REMOVED PER REQUEST
            
            const hasJoinedThisGroup = !IS_JOIN_LINK && JOIN_SESSION_PHONE && members.some(m => m.phone === JOIN_SESSION_PHONE);
            const isCreator = JOIN_SESSION_PHONE && g.ownerName && members.some(m => m.phone === JOIN_SESSION_PHONE && m.isLeader === true);

            state.lastMemberCount = count;
            const inviteLink = generateInviteLink(g.id, isUnlocked);
            
            el.innerHTML = `
                <div class="fade-in bg-white min-h-screen pb-40 font-sans">
                    <div class="glass-header h-[60px] sticky top-0 z-50 px-4 flex justify-between items-center bg-white shadow-sm border-b border-gray-100">
                        <div class="flex items-center gap-3 cursor-pointer pt-safe" onclick="goHome()">
                            <i data-lucide="arrow-left" size="24" class="text-gray-700"></i>
                            <span class="font-bold text-base tracking-wide text-gray-800">Back</span>
                        </div>
                    </div>
                    
                    <div class="p-4">
                        <div class="flex flex-col items-center mb-4 mt-2 animate-in fade-in-up duration-300">
                            <div class="w-28 h-28 rounded-full border-4 border-white shadow-lg overflow-hidden mb-4 relative z-10 bg-gray-100">
                                <img src="${p.imageSrc}" class="w-full h-full object-cover" alt="${p.name}">
                            </div>
                            <h1 class="text-2xl font-black text-gray-900 leading-none mb-1 tracking-tight text-center">${p.name}</h1>
                            <p class="text-sm font-medium text-gray-500 mb-2">${p.nameTe}</p>
                            <div id="cutoff-timer" class="text-xs font-bold text-red-600 text-center mb-3">Loading‚Ä¶</div>
                        </div>

                        ${isCreator && g.type !== 'solo' ? `
                        <div class="bg-green-50 border border-green-200 p-4 rounded-xl text-center mb-6">
                            <div class="flex justify-center items-center gap-2 mb-1">
                                <i data-lucide="crown" class="text-green-700" size="20"></i>
                                <span class="font-black text-green-900 text-sm uppercase tracking-wide">You started today‚Äôs deal</span>
                            </div>
                            <p class="text-xs text-green-800 font-semibold mb-1">
                                ${isUnlocked ? 'Because of you, everyone pays less today' : 'You started today‚Äôs deal'}
                            </p>
                            <p class="text-xs text-green-700">Share link & manage the order</p>
                        </div>` : ''}

                        ${isExpired ? `
                        <div class="bg-red-50 text-red-700 p-4 mb-6 rounded-xl text-center border border-red-100 flex flex-col items-center justify-center gap-1">
                            <div class="flex items-center gap-2">
                                <i data-lucide="lock" size="18"></i>
                                <div class="font-bold text-sm uppercase">Order Closed</div>
                            </div>
                            <div class="text-xs font-medium">‡∞Ü‡∞∞‡±ç‡∞°‡∞∞‡±ç ‡∞ï‡±ç‡∞≤‡±ã‡∞ú‡±ç ‡∞Ö‡∞Ø‡∞ø‡∞Ç‡∞¶‡∞ø ‚Äì ‡∞∞‡±á‡∞™‡∞ü‡∞ø ‡∞ó‡±ç‡∞∞‡±Ç‡∞™‡±ç ‡∞ï‡±ã‡∞∏‡∞Ç ‡∞µ‡±á‡∞ö‡∞ø ‡∞â‡∞Ç‡∞°‡∞Ç‡∞°‡∞ø</div>
                        </div>` : ''}

                        <div class="bg-white border border-gray-200 rounded-xl p-4 mb-6 shadow-sm">
                            <div class="space-y-4 mb-6">
                                <div class="flex justify-between items-center transition-all px-2">
                                    <span class="text-sm font-medium text-gray-500">Single Price</span>
                                    <span class="text-base font-bold text-gray-900">‚Çπ${p.price1}</span>
                                </div>
                                <div class="flex justify-between items-center transition-all p-3 -mx-3 rounded-lg ${isUnlocked ? 'bg-green-50 border border-green-100' : 'bg-gray-50 border border-gray-200'}">
                                    <div class="flex items-center gap-3">
                                        <div class="w-6 h-6 rounded-full ${isUnlocked ? 'bg-green-600 text-white' : 'bg-gray-300 text-gray-500'} flex items-center justify-center text-xs font-bold">${isUnlocked ? '<i data-lucide="check" size="14"></i>' : '<i data-lucide="lock" size="12"></i>'}</div>
                                        <span class="text-sm font-bold ${isUnlocked ? 'text-green-800' : 'text-gray-500'}">Group Price</span>
                                    </div>
                                    <div class="flex flex-col items-end">
                                        <span class="text-2xl font-bold ${isUnlocked ? 'text-green-700' : 'text-gray-400'}">‚Çπ${p.price5}</span>
                                        ${!isUnlocked ? '<span class="text-[9px] font-bold text-red-500 uppercase tracking-wider">LOCKED</span>' : ''}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="space-y-3 mb-8">
                            <div class="flex justify-between items-end mb-4">
                                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest">${isCreator ? 'People in Your Group' : 'People Joined'}</h3>
                                <div class="flex flex-col items-end">
                                   ${g.type !== 'solo' ? (!isUnlocked ? `<span class="text-xs font-bold text-jodo-ctaPrimary animate-pulse">Need ${Math.max(0, MIN_GROUP_SIZE - count)} more to unlock</span>` : '<span class="text-xs font-bold text-green-600">Unlocked!</span>') : ''}
                                </div>
                            </div>
                            
                            ${members.map((member) => {
                                const isMe = JOIN_SESSION_PHONE === member.phone;
                                // üî• REQ 1: USE price1 IF LOCKED
                                const effectivePrice = isUnlocked ? p.price5 : p.price1;
                                const t = Math.round(effectivePrice * member.quantity);
                                const weight = member.quantity * p.baseWeight;
                                const weightLabel = weight < 1 ? (weight * 1000).toFixed(0) + 'g' : weight + 'kg';

                                if (member.isLeader) {
                                    return `<div class="bg-green-50 border border-green-200 p-4 rounded-xl shadow-sm mb-3 transition-all relative overflow-hidden">
                                        <div class="absolute top-0 right-0 bg-green-200 text-green-800 text-[9px] font-bold px-2 py-0.5 rounded-bl-lg uppercase tracking-wide">Host</div>
                                        <div class="flex items-center justify-between mb-2">
                                            <div class="flex items-center gap-3">
                                                <div class="w-10 h-10 rounded-full bg-green-600 text-white flex items-center justify-center font-bold text-sm shadow-sm shrink-0 border-2 border-white ring-2 ring-green-100">
                                                    <i data-lucide="crown" size="16"></i>
                                                </div>
                                                <div>
                                                    <div class="text-sm font-bold text-gray-900 flex items-center gap-2">${isMe ? 'You (Host)' : member.name}</div>
                                                    <div class="text-xs text-green-700 font-medium">${weightLabel}</div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="flex justify-between items-center pt-2 border-t border-green-200/60">
                                            <span class="text-[10px] font-medium text-green-700 uppercase">Total ${!isUnlocked && g.type !== 'solo' ? '(Pending Unlock)' : ''}</span>
                                            <span class="text-sm font-bold ${isUnlocked ? 'text-green-800' : 'text-gray-500'}">‚Çπ${t}</span>
                                        </div>
                                    </div>`;
                                }

                                return `<div class="bg-white border border-gray-100 p-3 rounded-xl shadow-[0_1px_2px_rgba(0,0,0,0.03)] mb-2 transition-all cursor-default">
                                    <div class="flex items-center justify-between mb-2">
                                        <div class="flex items-center gap-3">
                                            <div class="w-8 h-8 rounded-full ${isMe ? 'bg-gray-800 text-white' : 'bg-gray-100 text-gray-500'} flex items-center justify-center font-bold text-xs border border-white shadow-sm shrink-0">${member.name[0]}</div>
                                            <div><div class="text-sm font-bold text-gray-800 flex items-center gap-2">${isMe ? 'You' : member.name}</div><div class="text-xs text-gray-400 font-medium">${weightLabel}</div></div>
                                        </div>
                                    </div>
                                    <div class="flex justify-between items-center pt-2 border-t border-gray-5">
                                        <span class="text-[10px] font-medium text-gray-400 uppercase">Total ${!isUnlocked && g.type !== 'solo' ? '(Pending Unlock)' : ''}</span>
                                        <span class="text-sm font-bold ${isUnlocked ? 'text-gray-900' : 'text-gray-400'}">‚Çπ${t}</span>
                                    </div>
                                </div>`;
                            }).join('')}
                        </div>
                    </div>

                    <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 p-4 pb-safe z-50 shadow-[0_-4px_20px_rgba(0,0,0,0.03)]">
                        <div class="max-w-md mx-auto pt-2 pb-2">
                            ${(() => {
                                // üî• SOLO ORDER UI FIX
                                if (g.type === 'solo') {
                                    return `
                                    <div class="text-center text-[11px] text-gray-500 font-medium mb-2">Order Confirmed ‚Ä¢ Pay on delivery</div>
                                    <button onclick="window.goHome()" class="block w-full bg-white border border-gray-300 text-gray-700 h-[56px] rounded-xl font-bold text-lg shadow-sm flex items-center justify-center gap-2 mb-3 btn-press">
                                        <span>Back Home</span>
                                    </button>
                                    <div class="mt-2 text-center"><button onclick="openSupportOptions()" class="text-xs font-bold text-gray-400 hover:text-gray-600">Need Help?</button></div>`;
                                }

                                // üî• REQ 6: SHOW SHARE CTA IF HOST OR GROUP NOT UNLOCKED
                                if (isCreator || (hasJoinedThisGroup && !isUnlocked)) {
                                    return `
                                    <div class="text-center text-[10px] text-gray-400 font-medium mb-1">Invite More & Unlock Savings</div>
                                    <a href="${inviteLink}" target="_blank" class="block w-full bg-jodo-ctaPrimary text-white h-[56px] flex items-center justify-center rounded-xl font-bold text-lg text-center shadow-sm btn-press gap-2 transition-all">
                                        <i data-lucide="share-2" size="20"></i>
                                        <span>${!isUnlocked ? 'Invite to Unlock' : 'Copy & Share'}</span>
                                    </a>
                                    <div class="mt-2 text-center"><button onclick="openSupportOptions()" class="text-xs font-bold text-gray-400 hover:text-gray-600">Need Help?</button></div>`;
                                }

                                // Full State (Waitlist)
                                if (isFull && !hasJoinedThisGroup && !isExpired) {
                                     return `<div class="text-center text-sm text-red-600 font-bold mb-3 border border-red-100 bg-red-50 p-3 rounded-xl">
                                        Group full ‚Ä¢ Join Waitlist
                                    </div>
                                    <button onclick="addToWishlist('${g.productId}', 1, '${state.user.phone || ''}', '${state.user.name || ''}', '${g.id}'); toast('Added to wishlist', 'check');" class="block w-full bg-white border border-gray-300 text-gray-700 h-[56px] rounded-xl font-bold text-lg shadow-sm flex items-center justify-center gap-2 mb-3 btn-press">
                                        <span>Notify Me</span>
                                    </button>
                                    <div class="mt-2 text-center"><button onclick="openSupportOptions()" class="text-xs font-bold text-gray-400 hover:text-gray-600">Need Help?</button></div>`;
                                }

                                // Join State
                                if (!isExpired && !hasJoinedThisGroup) {
                                    return `
                                    <div class="text-center text-[11px] text-gray-500 font-medium mb-2">No payment now ‚Ä¢ Pay on delivery</div>
                                    <button onclick="openJoinFlow('${g.id}')" class="block w-full bg-jodo-ctaPrimary text-white h-[56px] rounded-xl font-bold text-lg shadow-sm flex items-center justify-center gap-2 mb-3 btn-press">
                                        <span>Join Order</span>
                                    </button>
                                    <div class="mt-2 text-center"><button onclick="openSupportOptions()" class="text-xs font-bold text-gray-400 hover:text-gray-600">Need Help?</button></div>`;
                                }

                                // Expired State
                                if (isExpired) {
                                    return `
                                    <div class="text-center text-xs text-gray-500 font-medium mb-2">Orders for today are closed</div>
                                    <button disabled class="block w-full bg-gray-100 text-gray-400 h-[56px] rounded-xl font-bold text-lg shadow-sm flex items-center justify-center gap-2 mb-3 cursor-not-allowed">
                                        <span>Closed</span>
                                    </button>
                                    <div class="mt-2 text-center"><button onclick="openSupportOptions()" class="text-xs font-bold text-gray-400 hover:text-gray-600">Need Help?</button></div>
                                    `;
                                }
                                
                                // Fallback (e.g. joined and unlocked, showing generic share or nothing)
                                return `
                                <div class="text-center text-[10px] text-gray-400 font-medium mb-1">Sharing helps more people get the wholesale price</div>
                                <a href="${inviteLink}" target="_blank" class="block w-full bg-white border border-gray-300 text-gray-700 h-[56px] flex items-center justify-center rounded-xl font-bold text-lg text-center shadow-sm btn-press gap-2 transition-all hover:bg-gray-50">
                                    <i data-lucide="share-2" size="20"></i>
                                    <span>Copy & Share</span>
                                </a>
                                <div class="mt-2 text-center"><button onclick="openSupportOptions()" class="text-xs font-bold text-gray-400 hover:text-gray-600">Need Help?</button></div>`;
                            })()}
                        </div>
                    </div>
                </div>
            `;

            // üî• START GROUP TIMER
            const timerEl = document.getElementById('cutoff-timer');
            if (timerEl) {
                startCutoffTimer((remaining) => {
                    timerEl.textContent = remaining > 0
                      ? `‚è∞ ${formatRemaining(remaining)} left ‚Äî miss it & price doubles tomorrow`
                      : "‚õî Missed today ‚Äî price is back to normal";
                });
            }
        }

        function render() {
            const app = document.getElementById('app');
            if (!app) return;
            
            if (state.view === 'home') renderHome(app);
            else renderGroup(app);
            
            if (window.lucide) window.lucide.createIcons();
        }
        
        function safeRender() {
            if (renderScheduled) return;
            renderScheduled = true;
            requestAnimationFrame(() => {
                render();
                renderScheduled = false;
            });
        }

        function listenToGroupForHome(gid) {
            if (!window.fs || !window.db) return;
            
            const unsubG = window.fs.onSnapshot(
                window.fs.doc(window.db, "groups", gid),
                (doc) => { if (doc.exists()) { state.groups[gid] = doc.data(); safeRender(); } }
            );
            state.homeListeners.push(unsubG);

            const unsubM = window.fs.onSnapshot(
                window.fs.collection(window.db, "groups", gid, "members"),
                (snap) => {
                    const m = []; 
                    snap.forEach(d => m.push({ ...d.data(), id: d.id })); 
                    m.sort((a, b) => a.joinedAt - b.joinedAt); 
                    state.members[gid] = m;
                    safeRender();
                }
            );
            state.homeListeners.push(unsubM);
        }

        function initHomeListeners() {
            state.homeListeners.forEach(u => u());
            state.homeListeners = [];
            state.user.joinedGroupIds.forEach(gid => {
                listenToGroupForHome(gid);
            });
        }

        window.openGroup = function(gid) { 
            if (!gid || typeof gid !== 'string') {
                toast('Invalid group link', 'alert-circle');
                window.goHome();
                return;
            }
            
            // CLEANUP TIMER
            if (cutoffTimerInterval) { clearInterval(cutoffTimerInterval); cutoffTimerInterval = null; }

            try { 
                if (window.location.protocol !== 'blob:') {
                    history.pushState({}, '', `${BASE_URL}?group=${gid}`);
                }
            } catch(e) {} 

            state.currentGroupId = gid; 
            state.view = 'group'; 
            
            if (state.unsubGroup) { state.unsubGroup(); state.unsubGroup = null; }
            if (state.unsubMembers) { state.unsubMembers(); state.unsubMembers = null; }

            safeRender(); 

            if (window.fs && window.db) {
                state.unsubGroup = window.fs.onSnapshot(
                    window.fs.doc(window.db, "groups", gid),
                    (doc) => {
                        if (doc.exists()) {
                            state.groups[gid] = doc.data();
                            safeRender();
                        } else {
                            toast("Squad not found", "alert-circle");
                            window.goHome();
                        }
                    },
                    (error) => { console.error("Group Listen Error:", error); }
                );

                state.unsubMembers = window.fs.onSnapshot(
                    window.fs.collection(window.db, "groups", gid, "members"),
                    (snapshot) => {
                        const members = [];
                        snapshot.forEach((doc) => {
                            const data = doc.data();
                            members.push({ ...data, id: doc.id });
                        });
                        members.sort((a, b) => a.joinedAt - b.joinedAt); 
                        state.members[gid] = members;
                        safeRender();
                    },
                      (error) => { console.error("Member Listen Error:", error); }
                );
            }
        };

        window.goHome = function() { 
            if (state.timerInterval) clearInterval(state.timerInterval);
            
            // CLEANUP TIMER
            if (cutoffTimerInterval) { clearInterval(cutoffTimerInterval); cutoffTimerInterval = null; }

            if (state.unsubGroup) { state.unsubGroup(); state.unsubGroup = null; }
            if (state.unsubMembers) { state.unsubMembers(); state.unsubMembers = null; }

            try { 
                if (window.location.protocol !== 'blob:') {
                    history.pushState({}, '', BASE_URL);
                }
            } catch(e) {} 
            
            AUTO_JOIN_TRIGGERED = false;
            
            state.view = 'home'; 
            state.currentGroupId = null; 
            
            safeRender(); 
        };

        function init() {
            if (JODO_INITIALIZED) return; 
            JODO_INITIALIZED = true;
            
            const params = new URLSearchParams(window.location.search);
            const gid = params.get('group');

            if (gid) {
                IS_JOIN_LINK = true;
                state.user = { name: '', phone: '', joinedGroupIds: [] };
                JOIN_SESSION_PHONE = null;
                state.view = 'group';
                state.currentGroupId = gid;
            } else {
                loadData(); 
                IS_JOIN_LINK = false;
                state.view = 'home';
            }
            
            const startApp = () => {
                if (IS_JOIN_LINK && state.currentGroupId) {
                    safeRender();
                    window.openGroup(state.currentGroupId);
                } else {
                    initHomeListeners(); 
                    safeRender();
                }
            };

            if (window.db) startApp();
            else window.addEventListener('firebase-ready', startApp);

            window.addEventListener('popstate', () => {
                const params = new URLSearchParams(location.search);
                const gid = params.get('group');
                if (gid) window.openGroup(gid); else window.goHome();
            });
        }
        
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
