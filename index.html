<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover" />
    <title>JODO</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üçÖ</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    
    <!-- ‚úÖ FIREBASE INITIALIZATION -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import {
        getFirestore,
        doc,
        setDoc,
        getDoc,
        getDocs,
        updateDoc,
        onSnapshot,
        collection,
        runTransaction,
        serverTimestamp,
        query,
        where,
        increment,
        Timestamp
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyAHsRiYhNea5tFpKVSU7YA9nsR6qINtQdA",
        authDomain: "jodo-prod-v2.firebaseapp.com",
        projectId: "jodo-prod-v2",
        storageBucket: "jodo-prod-v2.firebasestorage.app",
        messagingSenderId: "577075664016",
        appId: "1:577075664016:web:dcf613e7650217cc94b415"
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      window.db = db;
      window.auth = auth;
      window.appId = typeof __app_id !== 'undefined' ? __app_id : "jodo-prod-v2"; 
      
      window.fs = {
        doc, setDoc, getDoc, getDocs, updateDoc, onSnapshot,
        collection, runTransaction, serverTimestamp, query, where, increment, Timestamp
      };
      
      console.log("üöÄ JODO v11.2 - TIMESTAMP HARDENING");

      const initAuth = async () => {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
            try { await signInWithCustomToken(auth, __initial_auth_token); } 
            catch (e) { console.warn("Auth failed", e); await signInAnonymously(auth); }
        } else { await signInAnonymously(auth); }
      };
      initAuth().catch(console.error);
    </script>

    <script>
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            if (msg.includes("ResizeObserver")) return;
            const appEl = document.getElementById('app');
            if (appEl) {
                appEl.innerHTML = `<div style="padding:20px;color:#DC2626;text-align:center;"><h2 style="font-weight:bold;">Error</h2><p>${msg}</p><button onclick="window.location.reload()" style="margin-top:20px;padding:10px 20px;background:#333;color:#fff;">Retry</button></div>`;
            }
            return false;
        };
        tailwind.config = { theme: { extend: { colors: { jodo: { ctaPrimary: '#15803D', danger: '#DC2626' }, gray: { 50:'#F9FAFB', 100:'#F3F4F6', 200:'#E5E7EB', 500:'#6B7280', 600:'#4B5563', 800:'#1F2937', 900:'#111827' } }, fontFamily: { sans: ['-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'sans-serif'] }, animation: { 'fade-in-up': 'fadeInUp 0.5s ease-out', 'slide-up': 'slideUp 0.3s ease-out forwards', 'pop': 'popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)' }, keyframes: { fadeInUp: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } }, slideUp: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } }, popIn: { '0%': { opacity: '0', transform: 'scale(0.9)' }, '100%': { opacity: '1', transform: 'scale(1)' } } } } } }
    </script>
    
    <style>
        body { background: #F3F4F6; color: #111827; -webkit-tap-highlight-color: transparent; min-height: 100dvh; display: flex; justify-content: center; margin: 0; overscroll-behavior-y: none; }
        #app { width: 100%; max-width: 448px; background: #FFFFFF; min-height: 100dvh; position: relative; overflow-y: auto; display: flex; flex-direction: column; box-shadow: 0 0 20px rgba(0,0,0,0.05); }
        .btn-press { transition: opacity 0.1s; cursor: pointer; user-select: none; }
        .btn-press:active:not(:disabled) { opacity: 0.8; }
        .glass-header { background: rgba(255, 255, 255, 0.98); border-bottom: 1px solid #E5E7EB; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .pt-safe { padding-top: env(safe-area-inset-top); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .spinner-fallback { width: 32px; height: 32px; border: 3px solid #E5E7EB; border-top: 3px solid #15803D; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="antialiased">

    <div id="app">
        <div style="height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #fff; color: #333;">
            <div class="spinner-fallback"></div>
            <div style="margin-top: 16px; font-family: sans-serif; font-size: 14px; font-weight: 600;">JODO v11.2</div>
        </div>
    </div>

    <!-- MODAL -->
    <div id="modal-overlay" class="fixed inset-0 bg-black/60 hidden z-[60] flex items-end justify-center backdrop-blur-sm transition-opacity duration-300">
        <div id="modal-content" class="bg-white w-full max-w-[448px] rounded-t-[1.5rem] shadow-2xl transform transition-transform duration-300 translate-y-full max-h-[95dvh] flex flex-col overflow-hidden pb-safe"></div>
    </div>

    <!-- TOAST -->
    <div id="toast" class="fixed top-24 left-1/2 -translate-x-1/2 bg-gray-900 text-white px-6 py-3 rounded-full text-sm font-medium shadow-xl hidden z-[90] flex items-center gap-2 pointer-events-none pt-safe text-center w-max max-w-[90%]"></div>

    <script type="module">
        // ==========================================
        // 1. CONSTANTS
        // ==========================================
        const CONSTANTS = {
            PUBLIC_SHARE_URL: "https://satyanarayanagaraga.github.io/jodo-mvp/",
            MIN_GROUP_SIZE: 3, 
            GROUP_MAX_KG: 1000, 
            GROUPS_STORAGE_KEY: 'jodo_groups_joined_v1',
            CUTOFF_HOUR: 23, 
            PRODUCTS: [
                { id: 'tomato', name: 'Fresh Tomatoes', nameTe: '‡∞ü‡∞Æ‡∞æ‡∞ü‡∞æ‡∞≤‡±Å', unit: '1kg', step: 0.25, imageSrc: 'https://images.unsplash.com/photo-1592924357228-91a4daadcfea?auto=format&fit=crop&w=800&q=80' },
                { id: 'onion', name: 'Red Onions', nameTe: '‡∞â‡∞≤‡±ç‡∞≤‡∞ø‡∞™‡∞æ‡∞Ø‡∞≤‡±Å', unit: '1kg', step: 0.25, imageSrc: 'https://images.unsplash.com/photo-1618512496248-a07fe83aa8cb?auto=format&fit=crop&w=800&q=80' },
                { id: 'chilli', name: 'Green Chillies', nameTe: '‡∞™‡∞ö‡±ç‡∞ö‡∞ø ‡∞Æ‡∞ø‡∞∞‡∞™‡∞ï‡∞æ‡∞Ø‡∞≤‡±Å', unit: '250g', step: 0.25, imageSrc: 'https://images.unsplash.com/photo-1577218349272-37eb645284eb?auto=format&fit=crop&w=800&q=80' }
            ],
            PRODUCT_LIMITS: { tomato: 10, onion: 10, chilli: 2 },
            PRICE_LADDERS: {
                tomato: [
                    { min: 1, price: 42 },   // solo
                    { min: 2, price: 38 },
                    { min: 4, price: 34 },
                    { min: 7, price: 30 }    // best
                ],
                onion: [
                    { min: 1, price: 36 },
                    { min: 3, price: 32 },
                    { min: 6, price: 28 }
                ],
                chilli: [
                    { min: 1, price: 80 },   
                    { min: 3, price: 70 },
                    { min: 6, price: 60 }
                ]
            }
        };

        // ==========================================
        // 2. STORE
        // ==========================================
        const Store = {
            state: {
                view: 'home',
                currentGroupId: null,
                groups: {},
                members: {},
                user: { name: '', phone: '', joinedGroupIds: [] },
                cart: {},
                invitingGroup: null,
                pendingJoinId: null,
                isAppInitialized: false
            },
            update(key, value) {
                this.state[key] = value;
                if(key === 'view' || key === 'groups' || key === 'members' || key === 'cart') UI.scheduleRender();
            },
            updateUser(field, value) {
                this.state.user[field] = value;
                if (field === 'joinedGroupIds') localStorage.setItem(CONSTANTS.GROUPS_STORAGE_KEY, JSON.stringify(value));
                else if (field === 'name') localStorage.setItem('jodo_user_name', value);
                else if (field === 'phone') localStorage.setItem('jodo_user_phone', value);
            },
            loadFromStorage() {
                try {
                    this.state.user.name = localStorage.getItem('jodo_user_name') || '';
                    this.state.user.phone = localStorage.getItem('jodo_user_phone') || '';
                    const savedGroups = localStorage.getItem(CONSTANTS.GROUPS_STORAGE_KEY);
                    this.state.user.joinedGroupIds = savedGroups ? JSON.parse(savedGroups) : [];
                } catch(e) { console.error("Storage Error", e); }
            }
        };

        // ==========================================
        // 3. UTILITIES
        // ==========================================
        const Utils = {
            Time: {
                getCutoffTimestamp() {
                    const now = new Date();
                    const utcNow = now.getTime();
                    const istOffset = 5.5 * 60 * 60 * 1000;
                    const istTime = new Date(utcNow + istOffset);
                    istTime.setUTCHours(CONSTANTS.CUTOFF_HOUR, 59, 59, 999);
                    return istTime.getTime() - istOffset;
                },
                isPastCutoff() { return Date.now() > this.getCutoffTimestamp(); },
                isTimestampPast(ts) {
                    return Date.now() > this.getMillis(ts);
                },
                calculateInitialCutoff() {
                    const now = new Date();
                    const utcNow = now.getTime();
                    const istOffset = 5.5 * 60 * 60 * 1000;
                    const istTime = new Date(utcNow + istOffset);
                    istTime.setUTCHours(CONSTANTS.CUTOFF_HOUR, 59, 59, 999);
                    return window.fs.Timestamp.fromMillis(istTime.getTime() - istOffset);
                },
                getMillis(ts) {
                    if (!ts) return 0;
                    if (typeof ts.toMillis === 'function') return ts.toMillis();
                    if (ts instanceof Date) return ts.getTime();
                    if (typeof ts === 'number') return ts;
                    if (ts.seconds) return ts.seconds * 1000;
                    console.warn("Unknown timestamp format:", ts);
                    return 0;
                }
            },
            Pricing: {
                formatQty(qty) { return qty < 1 ? (qty * 1000).toFixed(0) + 'g' : qty + 'kg'; },
                getGroupPrice(productId, memberCount) {
                    const ladder = CONSTANTS.PRICE_LADDERS[productId];
                    if (!ladder) return null;
                    let applicable = ladder[0];
                    for (const tier of ladder) {
                        if (memberCount >= tier.min) applicable = tier;
                    }
                    return applicable.price;
                },
                getNextTier(productId, memberCount) {
                    const ladder = CONSTANTS.PRICE_LADDERS[productId];
                    if (!ladder) return null;
                    return ladder.find(t => t.min > memberCount) || null;
                }
            }
        };

        // ==========================================
        // 4. SERVER (SIMULATED CLOUD FUNCTIONS)
        // ==========================================
        const BackendSimulation = {
            async call(functionName, data) {
                console.log(`[BACKEND] Invoked: ${functionName}`, data);
                await new Promise(r => setTimeout(r, 600));
                
                const context = {
                    auth: window.auth.currentUser ? { uid: window.auth.currentUser.uid } : null
                };

                try {
                    if (functionName === 'joinGroup') return await this.joinGroup(data, context);
                    throw new Error("Unknown function");
                } catch (e) {
                    console.error(`[BACKEND] Error:`, e);
                    throw e; 
                }
            },

            async joinGroup({ name, phone, cart, joinGroupId, isManual, location }, context) {
                if (!context.auth && !isManual) throw new Error("Unauthenticated");
                if (!name || !phone) throw new Error("Invalid input");
                if (isManual && !joinGroupId) throw new Error("Manual entry needs group ID");

                const groupId = joinGroupId || window.fs.doc(window.fs.collection(window.db, 'artifacts', window.appId, 'public', 'data', "groups")).id;
                const groupRef = window.fs.doc(window.db, 'artifacts', window.appId, 'public', 'data', "groups", groupId);
                
                await window.fs.runTransaction(window.db, async (transaction) => {
                    const groupSnap = await transaction.get(groupRef);
                    let gData;

                    if (!groupSnap.exists()) {
                        if (joinGroupId) throw "Group not found";
                        const cutoffTime = Utils.Time.calculateInitialCutoff();
                        gData = { 
                            id: groupId, ownerName: name, ownerPhone: phone, 
                            ownerId: context.auth.uid, 
                            expiresAt: cutoffTime, 
                            createdAt: window.fs.serverTimestamp(), 
                            type: 'multi', maxKg: CONSTANTS.GROUP_MAX_KG, 
                            memberCount: 0, status: 'FORMING' 
                        };
                        transaction.set(groupRef, gData);
                    } else {
                        gData = groupSnap.data();
                    }

                    if (isManual) {
                        if (gData.ownerId && gData.ownerId !== context.auth.uid) {
                            // Security check placeholder
                        }
                    }

                    if (Utils.Time.isTimestampPast(gData.expiresAt)) throw "Event has ended. Orders closed.";
                    if (gData.status === 'CANCELLED') throw "Group is closed.";

                    const memberRef = window.fs.doc(window.db, 'artifacts', window.appId, 'public', 'data', "groups", groupId, "members", phone);
                    const memberSnap = await transaction.get(memberRef);
                    const memberData = memberSnap.exists() ? memberSnap.data() : {};
                    
                    const isNewMember = !memberSnap.exists();
                    const wasCounted = !!memberData.hasJoined;
                    const willBeCounted = !isManual;

                    let newMemberCount = gData.memberCount || 0;
                    if (!wasCounted && willBeCounted) newMemberCount += 1;

                    transaction.update(groupRef, { memberCount: newMemberCount });
                    transaction.set(memberRef, { 
                        memberId: phone, name, phone, cart, 
                        joinedAt: memberSnap.exists() ? memberData.joinedAt : window.fs.serverTimestamp(), 
                        location: location, isManualEntry: isManual, hasJoined: willBeCounted,
                        isLeader: (!joinGroupId && isNewMember) || (gData.ownerPhone === phone) 
                    });
                });

                this.triggerBackgroundTasks(groupId);
                return { success: true, groupId };
            },

            async triggerBackgroundTasks(gid) {
                try {
                    const groupRef = window.fs.doc(window.db, 'artifacts', window.appId, 'public', 'data', "groups", gid);
                    const snap = await window.fs.getDoc(groupRef);
                    if (!snap.exists()) return;
                    
                    const g = snap.data();
                    if (g.status === 'FORMING' && g.memberCount >= CONSTANTS.MIN_GROUP_SIZE) {
                        if (!Utils.Time.isTimestampPast(g.expiresAt)) {
                            setTimeout(async () => {
                                await window.fs.updateDoc(groupRef, { status: 'VALID' });
                            }, 500); 
                        }
                    }
                } catch(e) { console.warn("Background Trigger Error", e); }
            }
        };

        // ==========================================
        // 5. CLIENT SERVICES
        // ==========================================
        const Services = {
            Data: {
                getGroupRef(gid) { return window.fs.doc(window.db, 'artifacts', window.appId, 'public', 'data', "groups", gid); },
                getMembersCol(gid) { return window.fs.collection(window.db, 'artifacts', window.appId, 'public', 'data', "groups", gid, "members"); },
                listenToGroup(gid) {
                    window.fs.onSnapshot(this.getGroupRef(gid), (snap) => {
                        if (snap.exists()) Store.update('groups', { ...Store.state.groups, [gid]: snap.data() });
                    });
                    window.fs.onSnapshot(this.getMembersCol(gid), (snap) => {
                        const mList = [];
                        snap.forEach(d => mList.push({ ...d.data(), id: d.id }));
                        mList.sort((a,b) => Utils.Time.getMillis(a.joinedAt) - Utils.Time.getMillis(b.joinedAt));
                        Store.update('members', { ...Store.state.members, [gid]: mList });
                    });
                }
            },
            Status: {
                getGroupStatus(group) {
                    if (!group) return 'UNKNOWN';
                    if (group.status === 'CANCELLED') return 'CANCELLED'; 
                    if (group.status === 'VALID') return 'VALID'; 
                    if (Utils.Time.isTimestampPast(group.expiresAt) && group.memberCount < CONSTANTS.MIN_GROUP_SIZE) return 'CANCELLED';
                    return 'FORMING';
                }
            }
        };

        const Actions = {
            initApp() {
                if (Store.state.isAppInitialized) return;
                Store.update('isAppInitialized', true);
                Store.loadFromStorage();
                
                const params = new URLSearchParams(window.location.search);
                const gid = params.get('group');
                Store.state.user.joinedGroupIds.forEach(id => Services.Data.listenToGroup(id));

                if (gid) {
                    if (Store.state.user.joinedGroupIds.includes(gid)) this.navigateToGroup(gid);
                    else {
                        Store.update('view', 'home');
                        Store.update('pendingJoinId', gid);
                        this.fetchInviteGroup(gid);
                    }
                } else Store.update('view', 'home');

                window.addEventListener('popstate', () => {
                    const p = new URLSearchParams(location.search);
                    const g = p.get('group');
                    if (g) this.navigateToGroup(g); else this.navigateToHome();
                });
            },

            async fetchInviteGroup(gid) {
                try {
                    const snap = await window.fs.getDoc(Services.Data.getGroupRef(gid));
                    if (snap.exists()) {
                        Store.update('invitingGroup', snap.data());
                        Store.update('groups', { ...Store.state.groups, [gid]: snap.data() });
                        Services.Data.listenToGroup(gid);
                    } else {
                        UI.toast("Group not found", "alert-circle");
                        this.navigateToHome();
                    }
                } catch(e) { console.error(e); this.navigateToHome(); }
            },

            updateCart(productId, delta) {
                if (Utils.Time.isPastCutoff()) { UI.toast("Event ended.", "clock"); return; }
                const currentQty = Store.state.cart[productId] || 0;
                let newQty = Math.round((currentQty + delta) * 100) / 100;
                if (newQty < 0) newQty = 0;
                if (newQty > (CONSTANTS.PRODUCT_LIMITS[productId] || 99)) { UI.toast(`Limit reached`, "alert-circle"); return; }
                const newCart = { ...Store.state.cart };
                if (newQty === 0) delete newCart[productId]; else newCart[productId] = newQty;
                Store.update('cart', newCart);
                UI.triggerVibration();
            },

            navigateToGroup(gid) {
                if (!gid) return;
                try { history.pushState({}, '', `?group=${gid}`); } catch(e) {}
                Store.update('currentGroupId', gid);
                Store.update('view', 'group');
                Services.Data.listenToGroup(gid);
            },

            navigateToHome() {
                try { history.pushState({}, '', window.location.pathname); } catch(e) {}
                Store.update('currentGroupId', null);
                Store.update('view', 'home');
                Store.update('invitingGroup', null);
            },

            async submitOrder(name, phone, joinGroupId, isManual = false, location = null) {
                if (!name || !/^[6-9]\d{9}$/.test(phone)) { UI.toast('Enter valid details', 'alert-circle'); return false; }
                
                if (!isManual) {
                    Store.updateUser('name', name);
                    Store.updateUser('phone', phone);
                }
                
                const cart = { ...Store.state.cart };

                try {
                    const result = await BackendSimulation.call('joinGroup', {
                        name, phone, cart, joinGroupId, isManual, location
                    });

                    const finalGroupId = result.groupId;
                    if (joinGroupId && !isManual) { Store.update('pendingJoinId', null); Store.update('invitingGroup', null); }
                    if (!isManual) {
                        const joined = [...Store.state.user.joinedGroupIds];
                        if(!joined.includes(finalGroupId)) {
                            joined.push(finalGroupId);
                            Store.updateUser('joinedGroupIds', joined);
                        }
                        Actions.navigateToGroup(finalGroupId);
                    } else { UI.toast("Manual order added", "user-plus"); }
                    
                    Store.update('cart', {});
                    if (!isManual) UI.toast("Joined!", "users");
                    return true;

                } catch (e) { 
                    const errMsg = typeof e === 'object' ? (e.message || JSON.stringify(e)) : String(e);
                    console.error("Order Error", errMsg);
                    UI.toast(errMsg.includes('closed') ? "Group is closed." : "Request failed.", "alert-triangle"); 
                    return false; 
                }
            }
        };

        // ==========================================
        // 6. UI RENDERER
        // ==========================================
        const UI = {
            renderScheduled: false,
            scheduleRender() {
                if (this.renderScheduled) return;
                this.renderScheduled = true;
                requestAnimationFrame(() => { this.render(); this.renderScheduled = false; });
            },
            render() {
                const app = document.getElementById('app');
                if (!app) return;
                const { view } = Store.state;
                if (view === 'home') this.renderHome(app);
                else if (view === 'group') this.renderGroup(app);
                if (window.lucide) window.lucide.createIcons();
            },
            renderHome(container) {
                const { user, groups, invitingGroup, cart } = Store.state;
                if (Utils.Time.isPastCutoff()) {
                    container.innerHTML = `<div class="h-screen flex flex-col items-center justify-center bg-gray-50 px-6 text-center"><h1 class="text-3xl font-black text-gray-900 mb-2">Event Ended</h1><p class="text-gray-500">Come back on Wednesday.</p></div>`; return;
                }
                const activeGroups = user.joinedGroupIds.map(gid => groups[gid]).filter(Boolean);
                let groupsHtml = activeGroups.map(g => {
                    const status = Services.Status.getGroupStatus(g);
                    const color = status === 'VALID' ? 'green' : (status === 'CANCELLED' ? 'red' : 'gray');
                    return `<div onclick="window.JodoApp.Actions.navigateToGroup('${g.id}')" class="shrink-0 w-[80%] bg-white rounded-xl border border-gray-200 shadow-sm p-4 btn-press relative overflow-hidden flex items-center gap-3"><div class="w-10 h-10 bg-${color}-100 rounded-full flex items-center justify-center text-${color}-700"><i data-lucide="${status === 'VALID' ? 'check' : 'users'}" size="20"></i></div><div><div class="font-bold text-gray-900">Your Group</div><div class="text-[10px] font-bold px-2 py-0.5 rounded border border-${color}-200 bg-${color}-50 text-${color}-700 inline-block mt-1">${status === 'VALID' ? 'Confirmed' : 'Forming'}</div></div></div>`;
                }).join('');
                if (activeGroups.length) groupsHtml = `<div class="mt-6 mb-4"><div class="px-4 flex gap-3 overflow-x-auto no-scrollbar">${groupsHtml}</div></div>`;

                const productsHtml = CONSTANTS.PRODUCTS.map(p => {
                    const qty = cart[p.id] || 0;
                    const soloPrice = CONSTANTS.PRICE_LADDERS[p.id] ? CONSTANTS.PRICE_LADDERS[p.id][0].price : 0;
                    return `<div class="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 flex gap-4 mb-3 mx-4"><div class="w-20 h-20 bg-gray-50 rounded-xl shrink-0 overflow-hidden"><img src="${p.imageSrc}" class="w-full h-full object-cover"></div><div class="flex-1 flex flex-col justify-between py-1"><div><h3 class="font-bold text-lg">${p.name}</h3><p class="text-sm text-gray-500">${p.nameTe}</p></div><div class="mt-2 flex items-center justify-between"><span class="text-sm font-black text-gray-800">‚Çπ${soloPrice}</span>${qty===0 ? `<button onclick="window.JodoApp.Actions.updateCart('${p.id}',${p.step})" class="bg-white border border-gray-300 font-bold px-4 py-2 rounded-xl text-sm">Add</button>` : `<div class="flex items-center bg-gray-900 rounded-xl px-1 py-1"><button onclick="window.JodoApp.Actions.updateCart('${p.id}',-${p.step})" class="w-8 h-8 text-white">-</button><div class="w-12 text-center text-sm font-bold text-white">${Utils.Pricing.formatQty(qty)}</div><button onclick="window.JodoApp.Actions.updateCart('${p.id}',${p.step})" class="w-8 h-8 text-white">+</button></div>`}</div></div></div>`;
                }).join('');

                let inviteHtml = invitingGroup ? `<div class="px-4 mb-6 mt-4"><div class="bg-indigo-50 border border-indigo-100 rounded-2xl p-5"><h3 class="font-bold text-lg">Accept Invite</h3><button onclick="window.JodoApp.UI.openCheckoutModal('${Store.state.pendingJoinId}')" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-xl mt-3">Join Group</button></div></div>` : '';
                let cartCount = 0; Object.values(cart).forEach(v => { if(v>0) cartCount++ });

                container.innerHTML = `<div class="pb-32 fade-in bg-white min-h-screen"><div class="glass-header sticky top-0 z-40 px-4 pt-safe pb-3"><h1 class="font-black text-2xl text-jodo-ctaPrimary">JODO</h1><div id="home-timer" class="text-xs font-black text-red-600">Loading...</div></div>${inviteHtml}${groupsHtml}<div class="mt-6">${productsHtml}</div>${cartCount>0?`<div class="fixed bottom-4 left-4 right-4 z-50"><button onclick="window.JodoApp.UI.openCheckoutModal(${Store.state.pendingJoinId?`'${Store.state.pendingJoinId}'`:'null'})" class="w-full bg-jodo-ctaPrimary text-white h-[60px] rounded-xl font-bold text-lg shadow-xl flex justify-between px-6 items-center"><span>${cartCount} Items</span><span>Checkout -></span></button></div>`:''}</div>`;
                this.startTimer(document.getElementById('home-timer'), null);
            },

            renderGroup(container) {
                const { currentGroupId, groups, members } = Store.state;
                const g = groups[currentGroupId];
                if (!g) return;
                const memberList = members[currentGroupId] || [];
                const status = Services.Status.getGroupStatus(g);
                const remaining = Math.max(0, CONSTANTS.MIN_GROUP_SIZE - g.memberCount);
                const hasJoined = Store.state.user.phone && memberList.some(m => m.phone === Store.state.user.phone);

                if (status === 'CANCELLED') {
                    container.innerHTML = `<div class="min-h-screen bg-white flex flex-col p-6 items-center text-center pt-20"><h1 class="text-2xl font-black text-gray-900 mb-2">Order Cancelled</h1><p class="text-gray-600 mb-8">We did not reach 3 orders.</p><button onclick="window.JodoApp.Actions.navigateToHome()" class="text-gray-500 font-bold underline">Go Home</button></div>`;
                    return;
                }

                const headerHTML = (status === 'VALID') 
                    ? `<div class="bg-blue-600 text-white text-center py-3 px-4 font-bold text-sm tracking-wide leading-tight">‚úÖ Order locked.<br><span class="opacity-80 text-xs font-normal">Final price = lowest tier reached before cutoff.</span></div>`
                    : `<div class="bg-red-600 text-white text-center py-3 px-4 font-black text-sm tracking-wide leading-tight">üö® This group is incomplete.<br>${remaining} more people needed or your order will cancel.</div>`;

                const ladderHtml = CONSTANTS.PRODUCTS.map(p => {
                    const price = Utils.Pricing.getGroupPrice(p.id, g.memberCount);
                    const next = Utils.Pricing.getNextTier(p.id, g.memberCount);
                    return `<div class="bg-gray-50 border border-gray-200 rounded-xl p-4 mb-3"><div class="flex justify-between items-center"><div class="font-bold text-gray-900">${p.name}</div><div class="text-lg font-black text-green-700">‚Çπ${price}</div></div>${next ? `<div class="text-xs text-gray-600 mt-1">${next.min - g.memberCount} more people ‚Üí ‚Çπ${next.price}</div>` : `<div class="text-xs text-green-700 mt-1 font-bold">Lowest price achieved üéâ</div>`}</div>`;
                }).join('');

                const membersHTML = memberList.map(m => {
                    const isMe = Store.state.user.phone === m.phone;
                    const parts = Object.entries(m.cart || {}).map(([pid, qty]) => { const p = CONSTANTS.PRODUCTS.find(x => x.id === pid); return p ? `${Utils.Pricing.formatQty(qty)} ${p.name}` : null; }).filter(Boolean);
                    const subText = status === 'VALID' ? `<div class="text-[10px] text-blue-700 font-bold mt-0.5">Order Placed ‚Ä¢ Waiting for Price</div>` : `<div class="text-[10px] text-gray-500 font-medium mt-0.5">Waiting for confirmation...</div>`;
                    return `<div class="bg-white border ${isMe ? 'border-green-300 ring-1 ring-green-100' : 'border-gray-100'} p-3 rounded-xl flex justify-between items-center"><div><div class="text-xs font-bold text-gray-900">${isMe ? 'You' : m.name} ${m.isLeader ? 'üëë' : ''} ${isMe ? `<span onclick="window.JodoApp.UI.openCheckoutModal('${g.id}')" class="text-blue-600 underline ml-2 cursor-pointer text-xs">Edit</span>` : ''}</div><div class="text-[11px] text-gray-500 mt-0.5">${parts.join(", ")}</div>${subText}</div><div class="text-[10px] bg-gray-100 text-gray-500 px-2 py-1 rounded font-bold">PENDING</div></div>`;
                }).join('') + Array.from({ length: Math.max(0, CONSTANTS.MIN_GROUP_SIZE - memberList.length) }).map(() => `<div class="border border-dashed border-red-300 bg-red-50/40 p-3 rounded-xl text-center text-xs font-bold text-red-600 flex items-center justify-center min-h-[50px]">Empty slot ‚Äì invite someone</div>`).join('');

                const footerHTML = hasJoined 
                    ? (status === 'VALID' ? `<div class="flex flex-col gap-2 w-full"><button onclick="window.JodoApp.UI.shareGroup('${g.id}', true)" class="w-full bg-blue-600 text-white h-[56px] flex items-center justify-center rounded-xl font-black text-sm tracking-wide gap-2 shadow-lg">SHARE GROUP LINK</button></div>` : `<div class="flex flex-col w-full"><button onclick="window.JodoApp.UI.shareGroup('${g.id}', false)" class="w-full bg-jodo-ctaPrimary text-white h-[56px] flex items-center justify-center rounded-xl font-black text-sm tracking-wide gap-2 shadow-lg">INVITE ${remaining} PEOPLE ¬∑ ORDER NOT CONFIRMED</button></div>`)
                    : `<button onclick="window.JodoApp.UI.openCheckoutModal('${g.id}')" class="w-full bg-jodo-ctaPrimary text-white h-[56px] rounded-xl font-black text-sm tracking-wide shadow-lg">JOIN GROUP</button>`;

                container.innerHTML = `
                <div class="fade-in bg-white min-h-screen pb-40 font-sans">
                    <div class="glass-header h-[60px] sticky top-0 z-[1000] px-4 flex justify-between items-center bg-white border-b border-gray-100">
                        <button onclick="window.JodoApp.Actions.navigateToHome()" class="flex items-center gap-2 px-2 py-1 rounded-lg active:bg-gray-100 text-gray-600"><i data-lucide="arrow-left" size="24"></i></button>
                        <button onclick="window.JodoApp.UI.openCheckoutModal('${g.id}', true)" class="bg-gray-50 border border-gray-200 text-gray-600 px-3 py-1.5 rounded-lg text-xs font-bold flex items-center gap-1 active:bg-gray-100"><i data-lucide="user-plus" size="14"></i> Add Manual</button>
                    </div>
                    ${headerHTML}
                    <div class="p-4">
                        <div class="text-center mb-6 mt-4 px-2"><h1 class="text-xl font-black text-gray-900">${g.ownerName}'s Group</h1><div id="cutoff-timer" class="text-sm font-black text-red-600 mt-2">‚è≥ ...</div></div>
                        ${ladderHtml}
                        <div class="space-y-2 mt-6"><div class="flex justify-between items-end mb-1 px-1"><h3 class="text-[11px] font-bold text-gray-400 uppercase">Members</h3><div class="text-xs font-bold text-gray-800">${g.memberCount} Joined</div></div>${membersHTML}</div>
                    </div>
                    <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-100 p-4 pb-safe z-50 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">${footerHTML}</div>
                </div>`;
                this.startTimer(document.getElementById('cutoff-timer'), g.expiresAt);
            },

            openCheckoutModal(joinGroupId = null, isManual = false) {
                // if (Utils.Time.isPastCutoff()) { this.toast("Event Ended", "x"); return; } // Removed to let server handle it
                const { user, members, cart } = Store.state;
                let activeCart = isManual ? {} : { ...cart }; 
                let capturedLocation = null;

                if (joinGroupId && !isManual) {
                     const me = (members[joinGroupId] || []).find(m => m.phone === user.phone);
                     if (me) { activeCart = { ...(me.cart || {}) }; Store.update('cart', activeCart); }
                     else if (Object.keys(Store.state.cart).length === 0) { this.toast("Select items first", "shopping-bag"); return; }
                } else if (!isManual && Object.keys(cart).length === 0) { this.toast("Select items first", "shopping-bag"); return; }
                else if (isManual) { Store.update('cart', {}); }

                const modalHtml = `<div class="flex flex-col h-[90vh] bg-white relative rounded-t-[1.5rem] overflow-hidden font-sans">
                    <div class="bg-white px-5 py-4 flex items-center justify-between border-b border-gray-100 shrink-0 z-20">
                        <div class="flex items-center gap-2 text-gray-800"><h3 class="font-black text-xl tracking-tight">${isManual ? 'Manual Entry' : 'Confirm Order'}</h3></div>
                        <button id="close-modal" class="p-2 bg-gray-50 rounded-full text-gray-500"><i data-lucide="x" size="20"></i></button>
                    </div>
                    <div class="p-5 overflow-y-auto flex-1 relative bg-gray-50/30">
                        <div class="bg-white border border-gray-200 rounded-xl p-4 mb-6 shadow-sm">
                            <div class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Order</div>
                            <div id="modal-items-container"></div>
                        </div>
                        <div class="space-y-4 mb-4">
                            <input id="inp-name" value="${isManual?'':user.name}" class="w-full bg-white border border-gray-300 py-3 px-4 rounded-lg outline-none font-medium text-gray-900" placeholder="Name">
                            <input id="inp-phone" value="${isManual?'':user.phone}" type="tel" class="w-full bg-white border border-gray-300 py-3 px-4 rounded-lg outline-none font-medium text-gray-900" placeholder="Mobile Number">
                            <button id="btn-location" class="w-full bg-blue-50 text-blue-600 border border-blue-100 py-3 rounded-lg font-bold flex items-center justify-center gap-2 text-sm animate-pulse">
                                <i data-lucide="map-pin" size="16"></i> <span>Confirm delivery location (used only for routing)</span>
                            </button>
                        </div>
                    </div>
                    <div class="bg-white border-t border-gray-100 p-4 shrink-0 pb-safe z-20">
                        <button id="action-btn" disabled class="w-full bg-gray-300 text-gray-500 h-[56px] rounded-xl font-black text-lg shadow-none flex items-center justify-center gap-2 transition-all btn-press cursor-not-allowed">
                            <span>${isManual ? "Add Manual Order" : "Place Order"}</span>
                        </button>
                    </div>
                </div>`;

                const node = this.createNode(modalHtml);
                this.showModal(node);
                
                const locBtn = node.querySelector('#btn-location');
                const actionBtn = node.querySelector('#action-btn');

                locBtn.onclick = () => {
                    if (!navigator.geolocation) { this.toast("GPS not supported", "alert-circle"); return; }
                    
                    // Prevent multiple clicks
                    if (locBtn.dataset.scanning === "true") return;
                    locBtn.dataset.scanning = "true";
                    
                    locBtn.innerHTML = '<span class="animate-pulse">Searching for better GPS signal...</span>';
                    locBtn.className = "w-full bg-blue-50 text-blue-600 border border-blue-100 py-3 rounded-lg font-bold flex items-center justify-center gap-2 text-sm";
                    locBtn.classList.remove('animate-pulse'); // remove initial pulse class if present
                    
                    let bestFix = null;
                    const startTime = Date.now();
                    
                    const finish = (finalPos) => {
                        if (watchId) navigator.geolocation.clearWatch(watchId);
                        locBtn.dataset.scanning = "false";
                        
                        if (!finalPos) {
                             locBtn.innerHTML = '‚ö†Ô∏è GPS Failed. Retry.';
                             this.toast("GPS failed. Move outside.", "map-pin-off");
                             return;
                        }

                        const acc = finalPos.coords.accuracy;
                        
                        // Thresholds
                        // > 120m -> Reject
                        if (acc > 120) {
                            capturedLocation = null;
                            locBtn.innerHTML = `‚ùå Signal Weak (${Math.round(acc)}m). Move outside & retry.`;
                            locBtn.className = "w-full bg-red-50 text-red-600 border border-red-100 py-3 rounded-lg font-bold flex items-center justify-center gap-2 text-sm";
                            this.toast(`Accuracy ${Math.round(acc)}m too low. Needs <120m.`, "alert-triangle");
                            actionBtn.disabled = true;
                            actionBtn.className = "w-full bg-gray-300 text-gray-500 h-[56px] rounded-xl font-black text-lg shadow-none flex items-center justify-center gap-2 transition-all btn-press cursor-not-allowed";
                            return;
                        }

                        // Accept
                        capturedLocation = { 
                            lat: finalPos.coords.latitude, 
                            lng: finalPos.coords.longitude, 
                            accuracy: acc,
                            capturedAt: Date.now(),
                            device: navigator.userAgent,
                            isSuspicious: (Date.now() - startTime) < 2000 && acc < 20
                        };

                        let msg = `‚úÖ GPS Locked: ${Math.round(acc)}m`;
                        let style = "bg-green-50 text-green-600 border-green-100";

                        if (acc > 60) {
                             msg = `‚ö†Ô∏è GPS Accuracy: ${Math.round(acc)}m (Weak)`;
                             style = "bg-orange-50 text-orange-600 border-orange-100";
                        } else if (acc <= 25) {
                             msg = `‚úÖ GPS Locked: ${Math.round(acc)}m (Excellent)`;
                        }

                        locBtn.innerHTML = msg;
                        locBtn.className = `w-full ${style} border py-3 rounded-lg font-bold flex items-center justify-center gap-2 text-sm`;
                        
                        // ‚úÖ ENABLE BUTTON
                        actionBtn.disabled = false;
                        actionBtn.className = "w-full bg-jodo-ctaPrimary text-white h-[56px] rounded-xl font-black text-lg shadow-lg flex items-center justify-center gap-2 active:scale-[0.99] transition-all btn-press";
                    };

                    const watchId = navigator.geolocation.watchPosition(
                        (pos) => {
                            const acc = pos.coords.accuracy;
                            
                            if (!bestFix || acc < bestFix.coords.accuracy) {
                                bestFix = pos;
                            }
                            
                            // Visual feedback during scan
                            locBtn.innerHTML = `<span class="animate-pulse">Searching for better GPS signal... (${Math.round(bestFix.coords.accuracy)}m)</span>`;

                            // Convergence criteria: <= 40m is good enough to stop early
                            if (bestFix.coords.accuracy <= 40) {
                                finish(bestFix);
                            }
                        }, 
                        (err) => { 
                            console.error(err);
                            // Don't finish immediately, might recover or timeout will handle it
                        },
                        { enableHighAccuracy: true, timeout: 20000, maximumAge: 0 }
                    );

                    // 15s timeout to stop scanning
                    setTimeout(() => {
                        if (locBtn.dataset.scanning === "true") {
                            finish(bestFix);
                        }
                    }, 15000);
                };

                const updateModalUI = () => {
                    const currentCart = Store.state.cart;
                    const itemsHtml = CONSTANTS.PRODUCTS.map(p => {
                        const qty = currentCart[p.id] || 0;
                        return `<div class="flex items-center justify-between py-3 border-b border-gray-50 last:border-0"><div class="flex items-center gap-3"><div class="w-12 h-12 bg-gray-50 rounded-lg overflow-hidden border border-gray-200 shrink-0"><img src="${p.imageSrc}" class="w-full h-full object-cover"></div><div class="flex flex-col"><div class="font-bold text-gray-800 text-sm">${p.name}</div></div></div><div class="flex items-center gap-3 bg-white border border-gray-200 rounded-lg p-1 shadow-sm"><button class="btn-minus w-8 h-8 flex items-center justify-center bg-white text-gray-600" data-id="${p.id}" data-delta="-${p.step}"><i data-lucide="minus" size="14"></i></button><span class="w-10 text-center text-sm font-bold text-gray-800 tabular-nums">${qty > 0 ? Utils.Pricing.formatQty(qty) : '0'}</span><button class="btn-plus w-8 h-8 flex items-center justify-center bg-jodo-ctaPrimary text-white rounded-md shadow-sm" data-id="${p.id}" data-delta="${p.step}"><i data-lucide="plus" size="14"></i></button></div></div>`;
                    }).join('');
                    node.querySelector('#modal-items-container').innerHTML = itemsHtml;
                    if(window.lucide) window.lucide.createIcons();
                    node.querySelectorAll('.btn-minus, .btn-plus').forEach(btn => { btn.onclick = () => { Actions.updateCart(btn.dataset.id, parseFloat(btn.dataset.delta)); updateModalUI(); } });
                };
                updateModalUI();

                node.querySelector('#close-modal').onclick = this.closeModal;
                
                actionBtn.onclick = async () => {
                    const name = node.querySelector('#inp-name').value.trim();
                    const phone = node.querySelector('#inp-phone').value.trim();
                    if(actionBtn.disabled) return;
                    if (!name || !/^[6-9]\d{9}$/.test(phone)) { this.toast("Enter valid name & mobile", "alert-circle"); return; }
                    if (isManual && Object.keys(Store.state.cart).length === 0) { this.toast("Empty Cart", "shopping-bag"); return; }
                    if (!capturedLocation) {
                        this.toast("Delivery location required.", "map-pin");
                        return;
                    }
                    actionBtn.disabled = true; actionBtn.innerHTML = 'Processing...';
                    const success = await Actions.submitOrder(name, phone, joinGroupId, isManual, capturedLocation);
                    if (!success) { 
                        actionBtn.disabled = false; 
                        actionBtn.innerHTML = `<span>Try Again</span>`; 
                        // Re-enable style if failed but location is still valid
                        if(capturedLocation) {
                             actionBtn.className = "w-full bg-jodo-ctaPrimary text-white h-[56px] rounded-xl font-black text-lg shadow-lg flex items-center justify-center gap-2 active:scale-[0.99] transition-all btn-press";
                        }
                    } else { this.closeModal(); }
                };
            },
            
            toast(msg, icon) {
                const t = document.getElementById('toast');
                t.innerHTML = `<i data-lucide="${icon}" size="16" class="text-white"></i> ${msg}`;
                t.classList.remove('hidden');
                if(window.lucide) window.lucide.createIcons();
                setTimeout(() => t.classList.add('hidden'), 4000);
            },

            shareGroup(groupId, isValid) {
                const currentUrl = `${CONSTANTS.PUBLIC_SHARE_URL}?group=${groupId}`;
                const text = isValid ? `‚úÖ Group Order Placed. Join to increase volume and lower final price:` : `üö® My vegetable order will be CANCELLED tonight if ${CONSTANTS.MIN_GROUP_SIZE} people don't join. Help me confirm this group:`;
                window.open(`https://wa.me/?text=${encodeURIComponent(text + "\n\nüëâ " + currentUrl)}`, '_blank');
            },

            createNode(html) { const t = document.createElement('template'); t.innerHTML = html.trim(); return t.content.firstElementChild; },
            showModal(node) { const o = document.getElementById('modal-overlay'), c = document.getElementById('modal-content'); c.innerHTML=''; c.appendChild(node); o.classList.remove('hidden'); setTimeout(()=> { o.classList.remove('opacity-0'); c.classList.remove('translate-y-full'); }, 10); },
            closeModal() { const o = document.getElementById('modal-overlay'), c = document.getElementById('modal-content'); c.classList.add('translate-y-full'); o.classList.add('opacity-0'); setTimeout(()=> { o.classList.add('hidden'); c.innerHTML=''; }, 300); },
            triggerVibration() { if (navigator.vibrate) navigator.vibrate(10); },
            initTilt() {},
            
            _timerInterval: null,
            startTimer(el) {
                if (!el) return;
                if (this._timerInterval) clearInterval(this._timerInterval);
                const tick = () => {
                    const rem = Utils.Time.getCutoffTimestamp() - Date.now();
                    if (rem <= 0) { el.textContent = "ENDED"; return; }
                    const h = Math.floor(rem/3600000);
                    const m = Math.floor((rem%3600000)/60000);
                    el.textContent = `‚è≥ ${h}h ${m}m left before cancellation`;
                };
                tick();
                this._timerInterval = setInterval(tick, 1000);
            }
        };

        window.JodoApp = { Actions, UI };
        function bootstrap() { Actions.initApp(); }
        document.addEventListener('DOMContentLoaded', () => { bootstrap(); });
    </script>
</body>
</html>
