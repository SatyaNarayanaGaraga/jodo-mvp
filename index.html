<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover" />
    <title>JODO - Village Order</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üçÖ</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        jodo: {
                            base: '#FFFFFF',
                            textPrimary: '#111827',
                            ctaPrimary: '#000000', 
                            error: '#DC2626',
                        }
                    },
                    fontFamily: {
                        sans: ['-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'sans-serif'],
                        mono: ['ui-monospace', 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'monospace'],
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>
    <style>
        body { 
            background: #F3F4F6; 
            color: #111827; 
            -webkit-tap-highlight-color: transparent; 
            min-height: 100dvh; 
            display: flex; 
            justify-content: center; 
            margin: 0; 
            overscroll-behavior-y: none;
            line-height: 1.45;
            letter-spacing: 0.01em; 
        }
        #app { width: 100%; max-width: 448px; background: #F3F4F6; min-height: 100dvh; position: relative; overflow-y: auto; display: flex; flex-direction: column; border-left: 1px solid #E5E7EB; border-right: 1px solid #E5E7EB; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .pt-safe { padding-top: env(safe-area-inset-top); }
        .custom-checkbox:checked {
            background-color: #000000;
            border-color: #000000;
            background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e");
        }
    </style>
</head>
<body class="antialiased">

    <div id="app"></div>

    <div id="modal-overlay" class="fixed inset-0 bg-black/80 hidden z-[60] flex items-end justify-center backdrop-blur-sm transition-opacity duration-300">
        <div id="modal-content" class="bg-gray-50 w-full max-w-[448px] rounded-t-2xl shadow-2xl transform transition-transform duration-300 translate-y-full max-h-[95dvh] flex flex-col overflow-hidden pb-safe"></div>
    </div>

    <div id="my-order-modal" class="fixed inset-0 bg-black/80 hidden z-[70] flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white w-full max-w-[350px] shadow-2xl p-5 relative rounded-2xl">
            <button onclick="document.getElementById('my-order-modal').classList.add('hidden')" class="absolute top-3 right-3 text-gray-500 hover:text-gray-900"><i data-lucide="x" size="20"></i></button>
            <div class="text-xl font-black text-gray-900 mb-4">My JODO</div>
            <div id="my-order-content" class="space-y-2"></div>
        </div>
    </div>

    <div id="toast" class="fixed top-12 left-1/2 -translate-x-1/2 bg-gray-900 text-white px-6 py-3 text-sm font-bold shadow-xl hidden z-[90] flex items-center gap-2 pointer-events-none text-center w-max max-w-[90%] rounded-full"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, runTransaction, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "",
            authDomain: "jodo-prod-e7788.firebaseapp.com",
            projectId: "jodo-prod-e7788",
            storageBucket: "jodo-prod-e7788.firebasestorage.app",
            messagingSenderId: "535883967600",
            appId: "1:535883967600:web:aa0b73a70ca506ad4fd8b5"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        window.db = db;
        window.fs = { doc, getDoc, setDoc, onSnapshot, collection, runTransaction, serverTimestamp, updateDoc };
        
        window.dispatchEvent(new Event('firebase-ready'));
    </script>
    
    <script>
        const BASE_URL = 'https://satyanarayanagaraga.github.io/jodo-mvp'; 
        const DELIVERY_FEE = 10;
        
        const FORCE_OPEN_FOR_TESTING = true; 

        const OPEN_HOUR = 6;
        const CLOSE_HOUR = 21; 
        
        const PRODUCTS = [
            { 
                id: 'tomato', 
                name: '‡∞ü‡∞Æ‡∞æ‡∞ü‡∞æ‡∞≤‡±Å (Tomato)', 
                target: 25, 
                priceMin: 38,       
                priceMax: 42,       
                step: 0.5, 
                min: 0.5,
                unit: 'kg',
                img: 'https://images.unsplash.com/photo-1592924357228-91a4daadcfea?auto=format&fit=crop&w=150&q=80'
            },
            { 
                id: 'onion', 
                name: '‡∞â‡∞≤‡±ç‡∞≤‡∞ø‡∞™‡∞æ‡∞Ø‡∞≤‡±Å (Onion)', 
                target: 15, 
                priceMin: 27,
                priceMax: 32,
                step: 0.5, 
                min: 0.5,
                unit: 'kg',
                img: 'https://images.unsplash.com/photo-1508747703725-7197771e445d?auto=format&fit=crop&w=150&q=80'
            }
        ];

        const PICKUP_POINTS = [
            {
                id: "duvva_main",
                name: "Duvva Main Road",
                note: "Opposite SBI Bank, near banyan tree",
                mapLink: "https://maps.google.com/?q=Duvva+Main+Road"
            },
            {
                id: "temple",
                name: "Near Temple",
                note: "Beside Hanuman Temple gate",
                mapLink: "https://maps.google.com/?q=Hanuman+Temple+Duvva"
            },
            {
                id: "bus_stop",
                name: "Bus Stop",
                note: "Main village bus stop shelter",
                mapLink: "https://maps.google.com/?q=Duvva+Bus+Stop"
            }
        ];

        const state = { 
            view: 'home', 
            groups: {}, 
            members: {}, 
            user: { name: '', phone: '' },
            cart: {}, 
            listeners: [],
            modalStep: 0,
            deliveryMethod: 'pickup',
            cycleId: null,
            deliveryLocation: null 
        };
        
        function getISTDate() {
            return new Date(new Date().toLocaleString("en-US", { timeZone: "Asia/Kolkata" }));
        }

        function getISTDateStr() {
            const d = getISTDate();
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${y}-${m}-${day}`;
        }

        function getCycleGroupId() {
            if (FORCE_OPEN_FOR_TESTING) {
                const d = getISTDate();
                const days = ['SUN','MON','TUE','WED','THU','FRI','SAT'];
                const y = d.getFullYear();
                const m = String(d.getMonth()+1).padStart(2,'0');
                const da = String(d.getDate()).padStart(2,'0');
                return `duvva_${days[d.getDay()]}_${y}_${m}_${da}`;
            }

            const d = getISTDate();
            const days = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];
            let targetDate = new Date(d);
            const currentDay = d.getDay();
            
            if (currentDay !== 2 && currentDay !== 5) {
                let addDays = 0;
                if (currentDay === 0) addDays = 2; // Sun -> Tue
                if (currentDay === 1) addDays = 1; // Mon -> Tue
                if (currentDay === 3) addDays = 2; // Wed -> Fri
                if (currentDay === 4) addDays = 1; // Thu -> Fri
                if (currentDay === 6) addDays = 3; // Sat -> Tue
                targetDate.setDate(d.getDate() + addDays);
            }
            
            const year = targetDate.getFullYear();
            const month = String(targetDate.getMonth() + 1).padStart(2, '0');
            const day = String(targetDate.getDate()).padStart(2, '0');
            const dayStr = days[targetDate.getDay()];
            
            return `duvva_${dayStr}_${year}_${month}_${day}`;
        }

        function isOrderWindowOpen() {
            if (FORCE_OPEN_FOR_TESTING) return true;
            const d = getISTDate();
            const day = d.getDay();
            const hour = d.getHours();
            if (day !== 2 && day !== 5) return false;
            if (hour < OPEN_HOUR || hour >= CLOSE_HOUR) return false;
            return true;
        }
        
        function isViewingTodayCycle(groupId) {
            const d = getISTDate();
            const days = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            const dayStr = days[d.getDay()];
            const todayId = `duvva_${dayStr}_${year}_${month}_${day}`;
            return groupId === todayId;
        }

        function getCutoffRemaining() {
            const now = getISTDate();
            const cutoff = new Date(now);
            cutoff.setHours(CLOSE_HOUR, 0, 0, 0);

            const diff = cutoff - now;
            if (diff <= 0) return "Closed";

            const mins = Math.floor(diff / 60000);
            const hrs = Math.floor(mins / 60);
            const remMins = mins % 60;

            return hrs > 0 ? `${hrs}h ${remMins}m` : `${remMins}m`;
        }

        function getProductStats(members, prodId) {
            let total = 0;
            let peopleCount = 0;
            members.forEach(m => {
                if (m.items && m.items[prodId]) {
                    total += parseFloat(m.items[prodId]);
                    peopleCount++;
                }
            });
            const p = PRODUCTS.find(x => x.id === prodId);
            return {
                total: parseFloat(total.toFixed(2)),
                target: p.target,
                isRunning: total >= p.target,
                remaining: Math.max(0, p.target - total),
                peopleCount: peopleCount
            };
        }
        
        function getUserAdjustedPrice(p, qty) {
            return {
                min: p.priceMin,
                max: p.priceMax
            };
        }

        function toast(msg, type = 'normal') { 
            const t = document.getElementById('toast'); 
            t.innerHTML = msg; 
            t.className = type === 'error' ? "fixed top-12 left-1/2 -translate-x-1/2 bg-red-600 text-white px-6 py-3 rounded-full text-sm font-bold shadow-2xl z-[90]" : "fixed top-12 left-1/2 -translate-x-1/2 bg-black text-white px-6 py-3 font-bold shadow-2xl z-[90] rounded-full";
            t.classList.remove('hidden'); 
            setTimeout(() => t.classList.add('hidden'), 3000); 
        }

        function loadUser() {
            state.user.name = localStorage.getItem('jodo_name') || '';
            state.user.phone = localStorage.getItem('jodo_phone') || '';
        }

        function saveUser(name, phone) {
            state.user.name = name;
            state.user.phone = phone;
            localStorage.setItem('jodo_name', name);
            localStorage.setItem('jodo_phone', phone);
        }

        function listenToCycleGroup() {
            const gid = getCycleGroupId();
            state.cycleId = gid;
            if (!window.fs) return;
            state.listeners.forEach(u => u()); state.listeners = [];
            const unsubG = window.fs.onSnapshot(window.fs.doc(window.db, "groups", gid), (doc) => {
                state.groups[gid] = doc.exists() ? doc.data() : null;
                render();
            });
            const unsubM = window.fs.onSnapshot(window.fs.collection(window.db, "groups", gid, "members"), (snap) => {
                const m = [];
                snap.forEach(d => m.push({ ...d.data(), id: d.id }));
                m.sort((a, b) => (a.joinedAt?.seconds || 0) - (b.joinedAt?.seconds || 0));
                state.members[gid] = m;
                render();
                if (state.modalStep === 2) renderDetailsStep();
            });
            state.listeners.push(unsubG, unsubM);
        }

        function updateCart(prodId, delta) {
            if (!isOrderWindowOpen()) { toast('JODO Closed', 'error'); return; }
            const p = PRODUCTS.find(x => x.id === prodId);
            let current = state.cart[prodId] || 0;
            if (delta === 0) {
                if (current > 0) current = 0; else current = p.min;
            } else {
                current += delta;
                if (current < p.min) current = 0; 
            }
            current = Math.round(current * 100) / 100;
            if (current > 0) state.cart[prodId] = current; else delete state.cart[prodId];
            if (delta > 0) toast('JODO Updated', 'success');
            render();
        }

        window.useMyLocation = async function() {
            if (!navigator.geolocation) { toast('GPS not supported', 'error'); return; }
            toast('Getting GPS...', 'normal');
            navigator.geolocation.getCurrentPosition(async (pos) => {
                const lat = pos.coords.latitude;
                const lng = pos.coords.longitude; 
                const accuracy = pos.coords.accuracy;
                
                if (accuracy > 80) {
                    toast(`GPS Accuracy Low (${Math.round(accuracy)}m). Move outside.`, 'error');
                    return;
                }
                
                state.deliveryLocation = { lat, lng, accuracy };
                
                const btn = document.getElementById('btn-use-location');
                if(btn) {
                    btn.innerHTML = `‚úÖ GPS Captured (${Math.round(accuracy)}m)`;
                    btn.classList.remove('border-dashed', 'border-gray-300', 'text-gray-700');
                    btn.classList.add('border-solid', 'border-green-600', 'text-green-700', 'bg-green-50');
                }
                
                try {
                     const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
                     const data = await res.json();
                     const addr = data.address || {};
                     const place = addr.suburb || addr.village || addr.town || '';
                     const road = addr.road || '';
                     const finalText = [road, place].filter(Boolean).join(', ') || 'My Location';
                     const inp = document.getElementById('inp-address');
                     if (inp) inp.value = finalText;
                     toast('Location set ‚úÖ', 'normal');
                 } catch (e) { toast('Location saved (Map only)', 'normal'); }
                 
            }, (err) => {
                console.error(err);
                toast('Please allow GPS permission', 'error');
            }, { enableHighAccuracy: true, timeout: 10000 });
        }

        window.updatePickupPreview = function(selectedId) {
            const point = PICKUP_POINTS.find(p => p.id === selectedId);
            const preview = document.getElementById('pickup-preview');
            
            if (!point) {
                preview.innerHTML = '';
                preview.classList.add('hidden');
                return;
            }

            preview.innerHTML = `
                <div class="border border-gray-200 p-3 mt-3 bg-gray-50 rounded-xl">
                    <div class="font-semibold text-sm text-gray-900 flex items-center gap-2">
                        <i data-lucide="map-pin" size="14"></i> ${point.name}
                    </div>
                    <div class="text-xs text-gray-500 mt-1 pl-5">
                        ${point.note}
                    </div>
                    <div class="flex gap-4 mt-3 pl-5 text-xs">
                        <a href="${point.mapLink}" target="_blank" class="text-blue-700 underline font-medium">
                            View on Map
                        </a>
                    </div>
                </div>
            `;
            if(window.lucide) window.lucide.createIcons();
            preview.classList.remove('hidden');
        }

        function openModalFlow() {
            if (!isOrderWindowOpen()) { toast('Closed', 'error'); return; }
            if (Object.keys(state.cart).length === 0) { toast('Select items first', 'error'); return; }
            state.deliveryMethod = 'pickup';
            state.deliveryLocation = null; 
            state.modalStep = 2; 
            renderDetailsStep();
            document.getElementById('modal-overlay').classList.remove('hidden');
            setTimeout(() => { 
                document.getElementById('modal-overlay').classList.remove('opacity-0'); 
                document.getElementById('modal-content').classList.remove('translate-y-full'); 
            }, 10);
        }

        function closeModal() {
            const overlay = document.getElementById('modal-overlay');
            const content = document.getElementById('modal-content');
            content.classList.add('translate-y-full');
            overlay.classList.add('opacity-0');
            setTimeout(() => { overlay.classList.add('hidden'); state.modalStep = 0; }, 300);
        }

        function renderDetailsStep() {
            const container = document.getElementById('modal-content');
            const gid = getCycleGroupId(); 
            const members = state.members[gid] || [];
            const isBeforeCutoff = isOrderWindowOpen();
            
            let listHtml = '';
            let minTotal = 0;
            let maxTotal = 0;

            Object.entries(state.cart).forEach(([pid, qty]) => {
                const p = PRODUCTS.find(x => x.id === pid);
                
                minTotal += qty * p.priceMin;
                maxTotal += qty * p.priceMax;

                const priceDisplay = `‚Çπ${p.priceMin} - ‚Çπ${p.priceMax} / kg`;
                const itemTotalDisplay = `‚Çπ${(qty * p.priceMin).toFixed(0)} - ‚Çπ${(qty * p.priceMax).toFixed(0)}`;

                listHtml += `
                    <div class="flex justify-between items-center py-2 border-b border-gray-100 last:border-0">
                        <div>
                            <div class="font-bold text-gray-900">${p.name} <span class="text-gray-500 font-medium">x ${qty}kg</span></div>
                        </div>
                        <div class="text-right">
                             <div class="text-sm font-bold text-gray-900">${itemTotalDisplay}</div>
                        </div>
                    </div>
                `;
            });

            const isHome = state.deliveryMethod === 'home';
            const deliveryCharge = isHome ? DELIVERY_FEE : 0;
            const finalMin = minTotal + deliveryCharge;
            const finalMax = maxTotal + deliveryCharge;
            
            const totalDisplay = `‚Çπ${finalMin.toFixed(0)} - ‚Çπ${finalMax.toFixed(0)}`;
            
            container.innerHTML = `
                <div class="flex flex-col h-full bg-gray-50 relative font-sans">
                    <div class="px-6 py-4 bg-white shadow-sm flex justify-between items-center z-10">
                        <h3 class="font-black text-xl text-gray-900">Confirm Order</h3>
                        <button onclick="window.closeModal()" class="p-2 bg-gray-100 hover:bg-gray-200 rounded-full"><i data-lucide="x" size="20"></i></button>
                    </div>
                    
                    <div class="p-4 overflow-y-auto flex-1 space-y-4">
                        
                        <!-- 1. Items Card -->
                        <div class="bg-white rounded-2xl shadow-sm p-5">
                            <h4 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-3">Your Items</h4>
                            ${listHtml}
                            
                            <div class="border-t border-gray-100 my-3 pt-3">
                                <div class="flex justify-between items-center mb-1">
                                    <div class="text-xs font-bold text-gray-500 uppercase">Total Estimate</div>
                                    <div class="text-2xl font-black text-gray-900">${totalDisplay}</div>
                                </div>
                                ${isHome ? `<div class="text-[11px] text-gray-500 mt-1 text-right">Home Delivery: +‚Çπ${DELIVERY_FEE}</div>` : ''}
                                <div class="text-xs text-gray-500 bg-gray-50 border border-gray-100 p-3 rounded-xl flex items-center gap-2 mt-2">
                                    <i data-lucide="info" size="14" class="text-gray-400"></i>
                                    Final price depends on group size.
                                </div>
                            </div>
                        </div>

                        <!-- 2. Delivery Card -->
                        <div class="bg-white rounded-2xl shadow-sm p-5">
                            <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-3">Delivery Type</label>
                            <div class="grid grid-cols-2 gap-3 mb-4">
                                <label class="cursor-pointer" onclick="window.setDelivery('pickup')">
                                    <input type="radio" class="peer hidden" ${state.deliveryMethod === 'pickup' ? 'checked' : ''}>
                                    <div class="border-2 rounded-xl p-4 text-center transition-all ${state.deliveryMethod === 'pickup' ? 'border-black bg-gray-50' : 'border-gray-200'}">
                                        <div class="font-bold text-sm text-gray-900 flex items-center justify-center gap-1">üö∂ Pickup</div>
                                        <div class="text-[10px] text-green-700 font-bold mt-1">Free</div>
                                    </div>
                                </label>

                                <label class="cursor-pointer" onclick="window.setDelivery('home')">
                                    <input type="radio" class="peer hidden" ${state.deliveryMethod === 'home' ? 'checked' : ''}>
                                    <div class="border-2 rounded-xl p-4 text-center transition-all ${state.deliveryMethod === 'home' ? 'border-black bg-gray-50' : 'border-gray-200'}">
                                        <div class="font-bold text-sm text-gray-900 flex items-center justify-center gap-1">üöö Home</div>
                                        <div class="text-[10px] text-gray-600 font-bold mt-1">+‚Çπ10</div>
                                    </div>
                                </label>
                            </div>

                            <div id="pickup-container" style="display: ${isHome ? 'none' : 'block'};">
                                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">Select Pickup Point</label>
                                <select id="inp-pickup-point" class="w-full bg-white border border-gray-200 p-3 rounded-xl font-bold text-gray-900 focus:border-black focus:outline-none" onchange="window.updatePickupPreview(this.value)">
                                    <option value="" disabled selected>Choose location...</option>
                                    ${PICKUP_POINTS.map(p => `<option value="${p.id}">${p.name}</option>`).join('')}
                                </select>
                                <div id="pickup-preview" class="hidden"></div>
                            </div>

                            <div id="home-address-container" style="display: ${isHome ? 'block' : 'none'};">
                                <button id="btn-use-location" type="button" onclick="window.useMyLocation()" class="mb-4 w-full border border-dashed border-gray-400 rounded-xl py-3 text-sm font-bold text-gray-700 flex items-center justify-center gap-2 active:scale-[0.98]">
                                    üìç Use My Location
                                </button>
                                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">Landmark</label>
                                <input id="inp-landmark" placeholder="Near Rama Temple" class="w-full border border-gray-200 p-3 rounded-xl font-bold text-gray-900 focus:border-black focus:outline-none">
                            </div>
                        </div>

                        <!-- 3. User Details Card -->
                        <div class="bg-white rounded-2xl shadow-sm p-5">
                            <div class="space-y-4">
                                <div><label class="block text-xs font-bold text-gray-500 uppercase mb-2">Name</label><input id="inp-name" value="${state.user.name}" class="w-full border border-gray-200 p-3 rounded-xl font-bold focus:border-black focus:outline-none"></div>
                                <div><label class="block text-xs font-bold text-gray-500 uppercase mb-2">Mobile</label><input id="inp-phone" type="tel" value="${state.user.phone}" class="w-full border border-gray-200 p-3 rounded-xl font-bold focus:border-black focus:outline-none"></div>
                            </div>
                        </div>
                    </div>

                    <div class="p-4 bg-white border-t border-gray-200 pb-safe">
                         <button id="btn-submit-order" class="w-full bg-black text-white font-black text-xl h-[64px] rounded-2xl shadow-lg flex flex-col items-center justify-center leading-tight active:scale-[0.98]">
                            Confirm JODO
                        </button>
                        <div class="text-center text-[11px] text-gray-400 mt-3 font-medium">Payment later ‚Ä¢ Only if confirmed</div>
                    </div>
                </div>
            `;
            if(window.lucide) window.lucide.createIcons();

            if (isHome && state.deliveryLocation) {
                 const btn = document.getElementById('btn-use-location');
                 if(btn) {
                    btn.innerHTML = `‚úÖ GPS Captured (${Math.round(state.deliveryLocation.accuracy)}m)`;
                    btn.classList.remove('border-dashed', 'border-gray-400', 'text-gray-700');
                    btn.classList.add('border-solid', 'border-black', 'text-black', 'bg-gray-50');
                 }
            }

            document.getElementById('btn-submit-order').onclick = async () => {
                const name = document.getElementById('inp-name').value.trim();
                const phone = document.getElementById('inp-phone').value.trim();
                
                let pickupPoint = null;
                let landmark = null;

                if (state.deliveryMethod === 'pickup') {
                    const pickupId = document.getElementById('inp-pickup-point').value;
                    const pointObj = PICKUP_POINTS.find(p => p.id === pickupId);
                    if(!pointObj) { toast('Select Pickup Point', 'error'); return; }
                    pickupPoint = pointObj.name; 
                } else {
                    if(!state.deliveryLocation) { 
                        toast('Home delivery needs GPS. Click "Use My Location"', 'error'); 
                        return; 
                    }
                    landmark = document.getElementById('inp-landmark').value.trim();
                }

                if(!name || phone.length < 10) { toast('Enter valid details', 'error'); return; }
                if(members.some(m => m.phone === phone)) { toast('Order already exists', 'error'); return; }

                document.getElementById('btn-submit-order').innerText = 'Processing...';
                document.getElementById('btn-submit-order').disabled = true;
                await submitOrder(name, phone, pickupPoint, landmark, 0);
            };
        }

        window.setDelivery = (val) => { state.deliveryMethod = val; renderDetailsStep(); }

        async function submitOrder(name, phone, pickupPoint, landmark, amountPayable) {
            saveUser(name, phone);
            const gid = state.cycleId;
            const memberId = phone;
            try {
                await window.fs.runTransaction(window.db, async (transaction) => {
                    const groupRef = window.fs.doc(window.db, "groups", gid);
                    const groupSnap = await transaction.get(groupRef);
                    if (!groupSnap.exists()) transaction.set(groupRef, { id: gid, date: getISTDateStr(), createdAt: window.fs.serverTimestamp(), expiresAt: Date.now() + 43200000 });
                    
                    const memberRef = window.fs.doc(window.db, "groups", gid, "members", memberId);
                    
                    const deliveryData = {
                        method: state.deliveryMethod,
                        pickupPoint: pickupPoint,
                        location: state.deliveryLocation, 
                        landmark: landmark,
                        mapsLink: state.deliveryLocation ? `https://maps.google.com/?q=${state.deliveryLocation.lat},${state.deliveryLocation.lng}` : null
                    };

                    transaction.set(memberRef, { 
                        name, phone, items: state.cart, 
                        delivery: deliveryData,
                        paymentStatus: "pending_manual",
                        futurePaymentMethod: "UPI",
                        amountPayable: amountPayable,
                        joinedAt: window.fs.serverTimestamp() 
                    });
                });
                closeModal(); toast('JODO Joined', 'normal');
            } catch(e) { console.error(e); toast('Error', 'error'); document.getElementById('btn-submit-order').disabled = false; }
        }

        function renderHome(app) {
            const gid = getCycleGroupId();
            const isOpen = isOrderWindowOpen();
            const viewingToday = isViewingTodayCycle(gid);
            
            if (!isOpen && !viewingToday) {
                const nextDay = gid.includes('TUE') ? 'Tuesday' : 'Friday';
                app.innerHTML = `
                    <div class="min-h-screen bg-gray-50 flex flex-col items-center justify-center p-8 text-center font-sans">
                        <div class="w-20 h-20 bg-gray-200 rounded-full flex items-center justify-center mb-6 text-gray-500">
                            <i data-lucide="calendar-clock" size="40"></i>
                        </div>
                        <h2 class="text-2xl font-black text-gray-900 mb-2">JODO Closed</h2>
                        <p class="text-gray-500 font-medium text-lg">Next JODO: <span class="text-gray-900 font-bold">${nextDay} 6 AM</span></p>
                    </div>
                `;
                if(window.lucide) window.lucide.createIcons();
                return;
            }

            const members = state.members[gid] || [];
            const myMember = state.user.phone ? members.find(m => m.phone === state.user.phone) : null;
            
            if (myMember) renderStatusScreen(app, state.groups[gid], members, myMember);
            else renderSelectionScreen(app, members, isOpen);
        }

        function renderSelectionScreen(app, members, isOpen) {
            if (!isOpen) {
                app.innerHTML = `<div class="p-10 text-center text-gray-500 font-bold">Time Up</div>`;
                return;
            }

            const hasItems = Object.keys(state.cart).length > 0;
            const isBeforeCutoff = isOrderWindowOpen();
            
            let productsHtml = PRODUCTS.map(p => {
                const qty = state.cart[p.id] || 0;
                const isSelected = qty > 0;
                const stats = getProductStats(members, p.id);
                
                const progressPct = Math.min(100, (stats.total / p.target) * 100);

                return `
                    <div class="bg-white rounded-2xl shadow-md p-4 mb-4 border border-gray-100 relative overflow-hidden transition-all ${isSelected ? 'ring-2 ring-black' : ''}">
                        <div class="flex gap-4">
                            <div class="w-24 h-24 rounded-xl overflow-hidden bg-gray-100 shrink-0 shadow-inner">
                                <img src="${p.img}" class="w-full h-full object-cover">
                            </div>
                            
                            <div class="flex-1 flex flex-col justify-center">
                                <h3 class="text-lg font-black text-gray-900 leading-tight">${p.name}</h3>
                                
                                <div class="mt-1">
                                  <div class="text-2xl font-black text-gray-900">
                                    ‚Çπ${p.priceMin}‚Äì${p.priceMax}
                                    <span class="text-sm font-medium text-gray-500">/kg</span>
                                  </div>
                                </div>

                                <div class="mt-3">
                                  <div class="flex justify-between text-xs font-bold mb-1">
                                    <span class="text-gray-400 uppercase tracking-wider">Joined</span>
                                    <span class="text-green-600">üî• ${stats.total}kg</span>
                                  </div>
                                  <div class="w-full bg-gray-100 h-2 rounded-full overflow-hidden">
                                    <div class="bg-black h-2 transition-all duration-500" style="width: ${progressPct}%"></div>
                                  </div>
                                </div>
                            </div>
                        </div>
                        
                        ${isSelected ? `
                            <div class="flex items-center justify-between mt-4 pt-4 border-t border-gray-100">
                               <span class="text-xs font-bold text-gray-400 uppercase">Your Order</span>
                               <div class="flex items-center gap-6">
                                 <button onclick="window.updateCart('${p.id}', -${p.step})" class="w-10 h-10 rounded-full bg-gray-100 text-gray-900 text-xl font-black flex items-center justify-center active:scale-90 transition-transform">‚àí</button>
                                 <div class="text-lg font-mono font-black text-gray-900 min-w-[3ch] text-center">${qty} <span class="text-sm text-gray-500">kg</span></div>
                                 <button onclick="window.updateCart('${p.id}', ${p.step})" class="w-10 h-10 rounded-full bg-black text-white text-xl font-black flex items-center justify-center active:scale-90 transition-transform shadow-lg">+</button>
                               </div>
                            </div>
                        ` : `
                            <!-- Full card click target -->
                            <div class="absolute inset-0 z-10" onclick="window.updateCart('${p.id}', ${p.min})"></div>
                        `}
                    </div>
                `;
            }).join('');

            app.innerHTML = `
                <div class="min-h-screen bg-gray-50 flex flex-col font-sans pb-safe">
                    <div class="bg-black text-white px-6 pt-safe pb-4 sticky top-0 z-20 shadow-xl">
                        <div class="flex justify-between items-start">
                            <div>
                                <div class="text-xs font-bold opacity-80 uppercase tracking-widest">üóìÔ∏è Today‚Äôs Group Buying</div>
                                <div class="text-3xl font-black tracking-tight mt-1">JODO Round</div>
                                <div class="text-xs opacity-70 mt-1 font-medium">Final price locks at 9 PM</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-4 pb-32">
                        ${productsHtml}
                    </div>
                    
                    <div class="fixed bottom-0 left-0 right-0 bg-black p-4 pb-safe shadow-2xl z-50 rounded-t-2xl">
                         <button onclick="window.openModalFlow()" ${!hasItems ? 'disabled' : ''} class="w-full h-[72px] bg-white text-black text-xl font-black rounded-2xl shadow-lg active:scale-[0.98] transition-transform disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2">
                            Join Today‚Äôs JODO
                         </button>
                         <div class="text-center text-xs text-gray-300 mt-2 font-medium tracking-wide">
                            Price finalizes at 9 PM
                         </div>
                    </div>
                </div>
            `;
            if(window.lucide) window.lucide.createIcons();
            window.updateCart = updateCart;
            window.openModalFlow = openModalFlow;
        }

        function renderStatusScreen(app, group, members, myMember) {
            const productStats = PRODUCTS.map(p => {
                const stats = getProductStats(members, p.id);
                return { ...p, ...stats };
            });

            const now = getISTDate();
            const cutoff = new Date(now);
            cutoff.setHours(CLOSE_HOUR, 0, 0, 0);
            const isPostCutoff = !isOrderWindowOpen(); 

            let failingItems = [], runningItems = [], cancelledItems = [];

            if (!isPostCutoff) {
                failingItems = productStats.filter(p => !p.isRunning); 
                runningItems = productStats.filter(p => p.isRunning); 
            } else {
                runningItems = productStats.filter(p => p.total >= p.target); 
                cancelledItems = productStats.filter(p => p.total < p.target); 
            }
            
            const myItemCount = myMember.items ? Object.keys(myMember.items).length : 0;
            const isStarter = members.length > 0 && members[0].phone === myMember.phone;

            // üî¥ BOLD HEADER FOR STATUS
            let contentHtml = `
                <div class="bg-black text-white text-center py-2 text-[11px] font-bold pt-safe">
                  üóìÔ∏è JODO Round: ${group.date || getISTDateStr()}
                </div>
                <div class="px-6 py-4 border-b border-gray-200 bg-white sticky top-0 z-20 shadow-sm flex justify-between items-center">
                    <div>
                        <div class="text-2xl font-black text-gray-900 leading-none tracking-tight">
                            ${isPostCutoff ? 'Final Results' : 'Action Required'}
                        </div>
                        <div class="text-xs font-bold text-gray-500 mt-1 uppercase tracking-wide">
                            ${isPostCutoff ? 'Round Closed' : 'Share to complete JODO'}
                        </div>
                    </div>
                    ${myItemCount > 0 ? `<div class="bg-black text-white text-xs font-bold px-3 py-1.5 rounded-full">My Order</div>` : ''}
                </div>
            `;
            
            if (isStarter) {
                contentHtml += `<div class="bg-yellow-50 border border-yellow-200 rounded-lg p-2 text-center text-xs font-bold text-yellow-800 mx-4 mt-4">üëë Group Starter</div>`;
            }

            if (isPostCutoff) {
                contentHtml += `<div class="p-4 space-y-4">`;
                
                if (cancelledItems.length > 0) {
                    contentHtml += `
                        <div class="bg-white rounded-2xl shadow-sm border border-red-100 p-5">
                            <h2 class="text-2xl font-black text-red-600 mb-1">Didn't Make It ‚ùå</h2>
                            <div class="text-xs text-gray-500 mb-4 font-medium">Target not reached. No payment needed.</div>
                            ${cancelledItems.map(p => `
                                <div class="flex justify-between items-center py-2 border-b border-gray-100 last:border-0">
                                    <span class="font-bold text-gray-900">${p.name}</span>
                                    <span class="text-xs font-mono font-bold text-red-500 bg-red-50 px-2 py-1 rounded">${p.total}/${p.target}kg</span>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
                
                if (runningItems.length > 0) {
                    contentHtml += `
                        <div class="bg-white rounded-2xl shadow-sm border border-green-100 p-5">
                            <h2 class="text-2xl font-black text-green-700 mb-1">JODO Confirmed ‚úÖ</h2>
                            <div class="text-xs text-gray-500 mb-4 font-medium">Delivery tomorrow morning.</div>
                            ${runningItems.map(p => `
                                <div class="flex justify-between items-center py-2 border-b border-gray-100 last:border-0">
                                    <span class="font-bold text-gray-900">${p.name}</span>
                                    <span class="text-xs font-mono font-bold text-green-700 bg-green-50 px-2 py-1 rounded">${p.total}kg</span>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
                contentHtml += `</div>`;
            } else {
                if (failingItems.length > 0) {
                    const cutoffTime = getCutoffRemaining();
                    const shareText = `‚ö†Ô∏è JODO Alert\n\nNeeds more orders:\n${failingItems.map(p => `${p.name} ‚Äì ${p.remaining}kg`).join('\n')}\n\nJoin here: ${BASE_URL}?group=${group.id}`;
                    const waLink = `https://wa.me/?text=${encodeURIComponent(shareText)}`;

                    contentHtml += `
                        <div class="p-4 bg-gray-50 min-h-[30vh] pb-32 mt-2">
                            <div class="bg-white rounded-2xl shadow-md border border-gray-100 p-6 mb-4">
                                <div class="flex items-center gap-3 mb-4">
                                    <div class="w-10 h-10 rounded-full bg-red-100 flex items-center justify-center text-red-600">
                                        <i data-lucide="alert-triangle" size="20"></i>
                                    </div>
                                    <div>
                                        <div class="text-lg font-black text-gray-900 leading-none">Risk of Failure</div>
                                        <div class="text-xs text-red-600 font-bold mt-1">Action required before 9 PM</div>
                                    </div>
                                </div>
                                
                                <div class="space-y-3">
                                    ${failingItems.map(p => renderFailingItem(p)).join('')}
                                </div>
                                <div class="text-[10px] text-gray-400 mt-4 text-center font-bold uppercase tracking-wide">Everyone must help</div>
                            </div>
                        </div>

                        <div class="fixed bottom-0 left-0 right-0 z-[80] bg-black text-white h-[80px] flex flex-col items-center justify-center shadow-2xl rounded-t-2xl">
                            <a href="${waLink}" target="_blank" class="w-full h-full flex flex-col items-center justify-center active:scale-95 transition-transform">
                                <div class="text-xl font-black flex items-center gap-2"><i data-lucide="share-2" size="24"></i> Share to Save JODO</div>
                                <div class="text-xs font-bold text-gray-400 mt-1">
                                    ‚è≥ Time Left: ${cutoffTime}
                                </div>
                            </a>
                        </div>
                    `;
                } else {
                    contentHtml += `
                        <div class="p-8 text-center min-h-[50vh] flex flex-col items-center justify-center mt-2">
                            <div class="w-24 h-24 bg-green-100 rounded-full flex items-center justify-center mb-6 text-green-600 shadow-inner">
                                <i data-lucide="check-circle" size="48"></i>
                            </div>
                            <h2 class="text-3xl font-black text-gray-900 tracking-tight">Success!</h2>
                            <p class="text-gray-500 font-medium mt-2">All targets met. Delivery tomorrow.</p>
                        </div>
                    `;
                }
            }

            if (runningItems.length > 0) {
                contentHtml += `
                    <div class="text-center p-4 text-xs text-gray-400 font-bold mb-20 uppercase tracking-widest">
                        ${runningItems.length} items confirmed ‚úÖ
                    </div>
                `;
            }

            app.innerHTML = `<div class="min-h-screen bg-gray-50 flex flex-col font-sans">${contentHtml}</div>`;
            if(window.lucide) window.lucide.createIcons();
        }

        function renderFailingItem(p) {
            return `
                <div class="flex justify-between items-center p-3 bg-red-50 rounded-xl border border-red-100">
                    <div>
                        <div class="font-bold text-gray-900 text-sm">${p.name}</div>
                        <div class="text-[10px] text-gray-500 mt-0.5">${p.total} / ${p.target} kg</div>
                    </div>
                    <div class="text-right">
                        <div class="text-sm font-black text-red-600 animate-pulse">Need ${p.remaining}kg</div>
                    </div>
                </div>
            `;
        }

        function render() {
            const app = document.getElementById('app');
            if (state.view === 'home') renderHome(app);
        }

        function init() {
            loadUser();
            listenToCycleGroup();
            render();
            setInterval(() => { 
                if (state.view === 'home') {
                    const el = document.getElementById('cutoff-timer');
                    if(el) el.innerText = getCutoffRemaining();
                }
            }, 1000);
        }

        if (window.db) init();
        else window.addEventListener('firebase-ready', init);

    </script>
</body>
</html>
