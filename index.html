<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover" />
    <title>JODO - Farm Deals</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üî•</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        jodo: {
                            base: '#FFFFFF',
                            textPrimary: '#1F2937', 
                            textSecondary: '#6B7280', 
                            priceFinal: '#15803D', 
                            priceCut: '#DC2626',   
                            priceOld: '#9CA3AF',   
                            ctaPrimary: '#DC2626', 
                            ctaSuccess: '#16A34A', 
                            progress: '#FACC15',   
                            progressBg: '#F3F4F6', 
                            bonus: '#EAB308',      
                            urgency: '#DC2626',    
                            border: '#E5E7EB',     
                        }
                    },
                    fontFamily: {
                        sans: ['-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'sans-serif'],
                    },
                    animation: {
                        'pop': 'pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)',
                        'fade-in-up': 'fadeInUp 0.5s ease-out'
                    },
                    keyframes: {
                        pop: { '0%': { transform: 'scale(0.95)' }, '100%': { transform: 'scale(1)' } },
                        fadeInUp: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
                        explode: { '0%': { transform: 'scale(1)', opacity: '1' }, '50%': { transform: 'scale(1.2) rotate(5deg)', opacity: '0.8' }, '100%': { transform: 'scale(0) rotate(20deg)', opacity: '0' } }
                    }
                }
            }
        }
    </script>
    <style>
        body { background: #FFFFFF; color: #1F2937; -webkit-tap-highlight-color: transparent; min-height: 100dvh; display: flex; justify-content: center; margin: 0; overscroll-behavior-y: none; }
        #app { width: 100%; max-width: 448px; background: #FFFFFF; min-height: 100dvh; position: relative; overflow-y: auto; display: flex; flex-direction: column; box-shadow: 0 0 20px rgba(0,0,0,0.05); }
        .btn-press { transition: transform 0.1s; cursor: pointer; user-select: none; }
        .btn-press:active:not(:disabled) { transform: scale(0.96); }
        .card-modern { background: #FFFFFF; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); border: 1px solid #E5E7EB; }
        .glass-header { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); box-shadow: 0 1px 2px rgba(0,0,0,0.05); border-bottom: 1px solid #E5E7EB; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .pt-safe { padding-top: env(safe-area-inset-top); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .fade-in { animation: fadeInUp 0.5s ease-out forwards; }
        .tilt-card { transition: transform 0.15s ease-out; transform-style: preserve-3d; }
        .animate-explode { animation: explode 0.4s ease-out forwards; }
        .price-anchor { color: #15803D; font-weight: 900; letter-spacing: -0.025em; }
        
        /* Loading skeleton shimmer */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #f8f8f8 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    </style>
</head>
<body class="antialiased">

    <div id="app"></div>

    <div id="modal-overlay" class="fixed inset-0 bg-black/60 hidden z-[60] flex items-end justify-center backdrop-blur-sm transition-opacity duration-300">
        <div id="modal-content" class="bg-white w-full max-w-[448px] rounded-t-[2rem] shadow-2xl transform transition-transform duration-300 translate-y-full max-h-[95dvh] flex flex-col overflow-hidden pb-safe"></div>
    </div>

    <div id="full-feed-container"></div>

    <div id="live-ticker" class="fixed bottom-6 left-1/2 -translate-x-1/2 bg-gray-900/90 backdrop-blur text-white px-4 py-2.5 rounded-full text-xs font-medium shadow-2xl z-[55] flex items-center gap-2 pointer-events-none whitespace-nowrap hidden max-w-[90%] overflow-hidden transition-all duration-500 pb-safe border border-white/10">
        <div id="ticker-dot" class="w-2 h-2 bg-green-500 rounded-full animate-pulse shrink-0"></div>
        <span id="ticker-text" class="truncate font-bold tracking-wide">...</span>
    </div>

    <div id="toast" class="fixed top-24 left-1/2 -translate-x-1/2 bg-gray-900/95 text-white px-6 py-3 rounded-full text-sm font-bold shadow-2xl hidden z-[90] flex items-center gap-2 pointer-events-none animate-pop pt-safe backdrop-blur border border-white/10"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
          getFirestore,
          doc,
          setDoc,
          getDoc, 
          getDocs, 
          updateDoc,
          onSnapshot,
          collection
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
      
        const firebaseConfig = {
          apiKey: "AIzaSyBPqMkzfPjPzKIFSCYPipocH97TmPn2NLI",
          authDomain: "jodo-prod-e7788.firebaseapp.com",
          projectId: "jodo-prod-e7788",
          storageBucket: "jodo-prod-e7788.firebasestorage.app",
          messagingSenderId: "535883967600",
          appId: "1:535883967600:web:aa0b73a70ca506ad4fd8b5"
        };
      
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
      
        window.db = db;
        window.fs = { doc, setDoc, getDoc, getDocs, updateDoc, onSnapshot, collection };
        
        window.dispatchEvent(new Event('firebase-ready'));
    </script>
    
    <script>
        // --- CONSTANTS & CONFIG ---
        const COMPANY_PHONE = "918500742671"; 
        const BASE_URL = 'https://satyanarayanagaraga.github.io/jodo-mvp';
        const MAX_GROUP_MEMBERS = 20; 
        
        const PRODUCTS = [
            { id: 'onion', name: 'Red Onions', nameTe: '‡∞é‡∞∞‡±ç‡∞∞ ‡∞â‡∞≤‡±ç‡∞≤‡∞ø‡∞™‡∞æ‡∞Ø‡∞≤‡±Å', unit: '500g', baseWeight: 0.5, weightUnit: 'kg', price1: 25, price5: 18, mandiPrice: 32, remainingStock: 14, icon: 'layers', imageColor: 'bg-red-50 text-red-600', location: 'Duvva Fields', imageSrc: 'https://images.unsplash.com/photo-1620574387735-3624d75b2dbc?auto=format&fit=crop&w=600&q=80' },
            { id: 'oil', name: 'Sunflower Oil', nameTe: '‡∞™‡±ä‡∞¶‡±ç‡∞¶‡±Å‡∞§‡∞ø‡∞∞‡±Å‡∞ó‡±Å‡∞°‡±Å ‡∞®‡±Ç‡∞®‡±Ü', unit: '500ml', baseWeight: 0.5, weightUnit: 'L', price1: 60, price5: 50, mandiPrice: 65, remainingStock: 8, icon: 'droplet', imageColor: 'bg-yellow-50 text-yellow-600', location: 'Factory Direct', imageSrc: 'https://images.unsplash.com/photo-1474979266404-7eaacbcd87c5?auto=format&fit=crop&w=600&q=80' },
            { id: 'sugar', name: 'Sugar', nameTe: '‡∞ö‡∞ï‡±ç‡∞ï‡±Ü‡∞∞', unit: '500g', baseWeight: 0.5, weightUnit: 'kg', price1: 24, price5: 20, mandiPrice: 38, remainingStock: 42, icon: 'package', imageColor: 'bg-blue-50 text-blue-600', location: 'Local Stock', imageSrc: 'https://images.unsplash.com/photo-1581441363689-1f3c3c414635?auto=format&fit=crop&w=600&q=80' }
        ];

        const HABIT_KEY = 'jodo_habit_v1';
        const GROUPS_KEY = 'jodo_groups_joined_v1';
        const TICKER_MESSAGES = [
            { msg: "‚úÖ 58 squads completed in Duvva.", type: 'good' }, 
            { msg: "üõ°Ô∏è Pay on delivery available.", type: 'neutral' },
            { msg: "üî• Red Onions lowest price unlocked!", type: 'good' },
            { msg: "üöö Next delivery tomorrow 8 AM.", type: 'neutral' }
        ];

        const DELIVERY_DAYS = [3, 6]; 
        const CUTOFF_HOUR = 20; 

        function getNextDeliveryDate() {
            const now = new Date();
            for (let i = 0; i < 7; i++) {
                const d = new Date();
                d.setDate(now.getDate() + i);
                if (DELIVERY_DAYS.includes(d.getDay())) {
                    if (i === 0 && now.getHours() >= CUTOFF_HOUR) continue;
                    return d;
                }
            }
            const d = new Date(); 
            d.setDate(d.getDate() + 1);
            return d;
        }

        const state = { 
            view: 'home', 
            currentGroupId: null, 
            groups: {}, 
            members: {}, 
            user: { name: '', phone: '', ward: '', joinedGroupIds: [] }, 
            timerInterval: null, 
            tickerInterval: null, 
            lastMemberCount: 0,
            unsubGroup: null,
            unsubMembers: null,
            homeListeners: [] 
        };

        const habitState = { totalOrders: 0, streakDays: 0, lastOrderDate: null };
        let JODO_INITIALIZED = false;
        let renderScheduled = false;

        function loadData() {
            try {
                state.user.name = localStorage.getItem('jodo_user_name') || '';
                state.user.phone = localStorage.getItem('jodo_user_phone') || '';
                state.user.ward = localStorage.getItem('jodo_user_ward') || '';
                const savedGroups = localStorage.getItem(GROUPS_KEY);
                state.user.joinedGroupIds = savedGroups ? JSON.parse(savedGroups) : [];
            } catch(e) { console.error("Load Error", e); }
        }

        function saveUser(name, phone, ward) {
            state.user.name = name;
            state.user.phone = phone;
            localStorage.setItem('jodo_user_name', name);
            localStorage.setItem('jodo_user_phone', phone);
            if (ward) {
                state.user.ward = ward;
                localStorage.setItem('jodo_user_ward', ward);
            }
        }

        function saveJoinedGroup(gid) {
            if (!state.user.joinedGroupIds.includes(gid)) {
                state.user.joinedGroupIds.push(gid);
                localStorage.setItem(GROUPS_KEY, JSON.stringify(state.user.joinedGroupIds));
                listenToGroupForHome(gid);
            }
        }

        function loadHabit() {
            try {
                const raw = localStorage.getItem(HABIT_KEY);
                if (raw) {
                    const data = JSON.parse(raw);
                    habitState.totalOrders = data.totalOrders || 0;
                    habitState.streakDays = data.streakDays || 0;
                    habitState.lastOrderDate = data.lastOrderDate || null;
                }
            } catch (e) {}
        }

        function saveHabit() {
            try { localStorage.setItem(HABIT_KEY, JSON.stringify(habitState)); } catch (e) {}
        }

        function markOrderHabit() {
            const today = new Date();
            const todayStr = today.toISOString().slice(0,10);
            if (!habitState.lastOrderDate) {
                habitState.streakDays = 1;
            } else {
                const last = new Date(habitState.lastOrderDate);
                const diffDays = Math.round((today - last) / 86400000);
                if (diffDays === 1) habitState.streakDays += 1;
                else if (diffDays > 1) habitState.streakDays = 1;
            }
            habitState.lastOrderDate = todayStr;
            habitState.totalOrders += 1;
            saveHabit();
        }

        function toast(msg, icon) { 
            const t = document.getElementById('toast'); 
            t.innerHTML = `<i data-lucide="${icon}" size="16"></i> ${msg}`; 
            t.classList.remove('hidden'); 
            if(window.lucide) window.lucide.createIcons(); 
            setTimeout(() => t.classList.add('hidden'), 3000); 
        }

        function triggerConfetti() { 
            if (typeof confetti === 'function') confetti({ particleCount: 150, spread: 80, origin: { y: 0.6 }, colors: ['#16A34A', '#FACC15', '#FFFFFF'] }); 
        }

        function triggerVibration() { 
            if (navigator.vibrate) navigator.vibrate(20); 
        }

        function createNodeFromHTML(html) { 
            const t = document.createElement('template'); 
            t.innerHTML = html.trim(); 
            return t.content.firstElementChild; 
        }
        
        function showModalNode(node) { 
            const overlay = document.getElementById('modal-overlay');
            const content = document.getElementById('modal-content');
            content.innerHTML = ''; content.appendChild(node); 
            overlay.classList.remove('hidden'); 
            setTimeout(() => { 
                overlay.classList.remove('opacity-0'); 
                content.classList.remove('translate-y-full'); 
            }, 10);
            if(node.querySelector('input')) node.querySelector('input').focus(); 
            if(window.lucide) window.lucide.createIcons(); 
        }

        window.closeModal = () => {
            const overlay = document.getElementById('modal-overlay');
            const content = document.getElementById('modal-content');
            content.classList.add('translate-y-full');
            overlay.classList.add('opacity-0');
            setTimeout(() => { 
                overlay.classList.add('hidden'); 
                content.innerHTML = ''; 
            }, 300);
        };

        function safeVal(el) { return (el && el.value) ? el.value.trim() : ''; }

        function startTicker() {
            if (state.tickerInterval) clearInterval(state.tickerInterval);
            const update = () => {
                const el = document.getElementById('live-ticker');
                const txt = document.getElementById('ticker-text');
                if(!el || !txt) return;
                const item = TICKER_MESSAGES[Math.floor(Math.random() * TICKER_MESSAGES.length)];
                txt.innerText = item.msg;
                el.classList.remove('hidden', 'translate-y-10', 'opacity-0');
                el.classList.add('translate-y-0', 'opacity-100');
                setTimeout(() => { 
                    el.classList.add('translate-y-10', 'opacity-0'); 
                    setTimeout(() => el.classList.add('hidden'), 500); 
                }, 5000);
            };
            update(); 
            state.tickerInterval = setInterval(update, 12000); 
        }

        function initCardTilt() {
            if (window.matchMedia("(pointer: coarse)").matches) return;
            const cards = document.querySelectorAll('.tilt-card');
            cards.forEach(card => {
                card.addEventListener('mousemove', (e) => {
                    const rect = card.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    const centerX = rect.width / 2;
                    const centerY = rect.height / 2;
                    const rotateX = ((y - centerY) / centerY) * -5; 
                    const rotateY = ((x - centerX) / centerX) * 5;
                    card.style.transform = `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg) scale3d(1.02, 1.02, 1.02)`;
                });
                card.addEventListener('mouseleave', () => {
                    card.style.transform = `perspective(1000px) rotateX(0deg) rotateY(0deg) scale3d(1, 1, 1)`;
                });
            });
        }

        window.openLiveGuide = function() {
            toast("Guide video coming soon!", "video");
        };

        window.openSupportOptions = function() {
            window.open("https://wa.me/" + COMPANY_PHONE, "_blank");
        };

        window.openFullFeed = function(productId) {
            toast("Live farm feed loading...", "signal");
        };

        window.openStartModal = function(pid, joinGroupId = null) {
            const p = PRODUCTS.find(x => x.id === pid);
            const user = state.user;
            let qty = 2; let isGroupMode = true; 
            
            const nextDelivery = getNextDeliveryDate();
            const deliveryTime = new Date(nextDelivery);
            deliveryTime.setHours(CUTOFF_HOUR, 0, 0, 0); 

            const title = joinGroupId ? "Join Squad" : "Select Buying Option";
            const btnText = joinGroupId ? "Join Squad Now" : "Start Group Buy";

            const node = createNodeFromHTML(`
                <div class="flex flex-col h-[90vh] bg-white relative rounded-t-[2rem] overflow-hidden">
                    <div class="bg-white px-5 py-4 flex items-center justify-between shadow-sm border-b border-jodo-border shrink-0 z-20">
                        <div class="flex items-center gap-2"><h3 class="font-bold text-xl text-jodo-textPrimary uppercase tracking-tight">${title}</h3></div>
                        <button id="close-modal" class="p-2 bg-gray-100 rounded-full text-jodo-textSecondary hover:bg-gray-200 transition-colors"><i data-lucide="x" size="20"></i></button>
                    </div>
                    <div class="p-5 overflow-y-auto flex-1 relative">
                        <div class="flex gap-4 mb-6">
                            <div class="w-20 h-20 rounded-xl shadow-sm border border-gray-200 relative overflow-hidden shrink-0"><div class="absolute inset-0 ${p.imageColor} flex items-center justify-center"><i data-lucide="${p.icon}" size="32" class="text-white/80"></i></div></div>
                            <div class="flex-1 flex flex-col justify-center"><h4 class="font-black text-xl text-jodo-textPrimary leading-none mb-1">${p.name}</h4><div class="text-sm font-semibold text-jodo-textSecondary mb-2">${p.nameTe}</div><div class="inline-block bg-green-50 border border-green-200 text-green-700 px-2 py-0.5 rounded text-[10px] font-bold uppercase w-fit">${p.remainingStock}kg In Stock</div></div>
                        </div>
                        <div class="bg-yellow-50 border border-yellow-100 p-3 rounded-xl mb-6 text-xs text-yellow-800 font-medium">
                            <i data-lucide="clock" class="inline-block w-3 h-3 mr-1"></i> Order for <strong>${nextDelivery.toLocaleDateString('en-US', { weekday: 'long' })} Delivery</strong>. Cutoff is 8 PM.
                        </div>
                        
                        ${!joinGroupId ? `
                        <div class="grid grid-cols-2 gap-3 mb-6">
                            <div id="mode-solo" class="relative p-4 rounded-xl border-2 border-gray-200 bg-white cursor-pointer active:scale-95 transition-all"><div class="font-bold text-jodo-textSecondary text-xs uppercase tracking-wider mb-0.5">Solo Buy</div><div class="price-anchor text-xl text-jodo-textPrimary price-text">‚Çπ${p.price1}</div></div>
                            <div id="mode-group" class="relative p-4 rounded-xl border-2 border-jodo-progress bg-yellow-50 cursor-pointer active:scale-95 transition-all shadow-md"><div class="absolute -top-3 left-1/2 -translate-x-1/2 bg-jodo-bonus text-black text-[9px] font-black uppercase px-2 py-0.5 rounded-full shadow-sm border border-white">Best Value</div><div class="font-bold text-yellow-800 text-xs uppercase tracking-wider mb-0.5">Group Buy</div><div class="price-anchor text-xl text-jodo-priceFinal price-text">‚Çπ${p.price5}</div></div>
                        </div>` : ''}

                        <div class="bg-white p-3 rounded-xl border border-jodo-border shadow-sm mb-6 flex items-center justify-between">
                            <div class="pl-2"><div class="text-[10px] font-bold text-jodo-textSecondary uppercase tracking-wider">Quantity</div><div class="text-[10px] text-jodo-urgency font-bold">Min 2 ${p.weightUnit}</div></div>
                            <div class="flex items-center gap-3 bg-gray-50 p-1.5 rounded-lg border border-gray-200"><button id="btn-minus" class="w-10 h-10 rounded-md bg-white border border-gray-300 text-gray-500 flex items-center justify-center active:scale-90 transition-all shadow-sm"><i data-lucide="minus" size="18"></i></button><div class="text-xl font-bold text-jodo-textPrimary w-20 text-center leading-none tabular-nums" id="qty-display">1.0 kg</div><button id="btn-plus" class="w-10 h-10 rounded-md bg-jodo-ctaPrimary text-white shadow-md flex items-center justify-center active:scale-90 transition-all"><i data-lucide="plus" size="18"></i></button></div>
                        </div>
                        <div class="space-y-4 mb-8">
                            <div class="relative group"><div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-jodo-textSecondary"><i data-lucide="user" size="18"></i></div><input id="inp-name" value="${user.name}" class="w-full bg-white border border-gray-300 py-3.5 pl-12 pr-4 rounded-lg font-bold text-jodo-textPrimary outline-none focus:border-jodo-ctaPrimary focus:ring-1 focus:ring-jodo-ctaPrimary transition-all placeholder-gray-400" placeholder="Your Name"></div>
                            <div class="relative group"><div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-jodo-textSecondary"><i data-lucide="phone" size="18"></i></div><input id="inp-phone" value="${user.phone}" type="tel" class="w-full bg-white border border-gray-300 py-3.5 pl-12 pr-4 rounded-lg font-bold text-jodo-textPrimary outline-none focus:border-jodo-ctaPrimary focus:ring-1 focus:ring-jodo-ctaPrimary transition-all placeholder-gray-400" placeholder="WhatsApp Number"></div>
                            <div class="relative group"><div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-jodo-textSecondary"><i data-lucide="map-pin" size="18"></i></div><input id="inp-ward" value="${user.ward || ''}" type="number" class="w-full bg-white border border-gray-300 py-3.5 pl-12 pr-4 rounded-lg font-bold text-jodo-textPrimary outline-none focus:border-jodo-ctaPrimary focus:ring-1 focus:ring-jodo-ctaPrimary transition-all placeholder-gray-400" placeholder="Ward Number (e.g. 12)"></div>
                        </div>
                    </div>
                    <div class="bg-white border-t border-jodo-border p-4 shrink-0 pb-safe shadow-[0_-4px_20px_rgba(0,0,0,0.05)] z-20">
                        <div class="flex justify-between items-end mb-4 px-1"><div><div class="text-[10px] text-jodo-textSecondary font-bold uppercase">Total to Pay</div><div class="text-3xl price-anchor text-jodo-textPrimary leading-none" id="footer-total">‚Çπ${p.price5 * 2}</div></div><div class="text-right"><div class="text-[10px] text-green-700 font-bold bg-green-50 px-2 py-1 rounded border border-green-100 uppercase" id="footer-savings">Savings: ‚Çπ${(p.price1 - p.price5) * 2}</div></div></div>
                        <button id="action-btn" class="w-full bg-jodo-ctaPrimary text-white h-[64px] rounded-xl font-black text-xl shadow-lg flex items-center justify-center gap-3 cursor-pointer active:scale-[0.98] transition-all btn-press">
                            <i data-lucide="zap" size="24"></i> 
                            <span id="btn-text-action">${btnText}</span>
                        </button>
                    </div>
                </div>
            `);
            showModalNode(node);

            const modeSoloEl = node.querySelector('#mode-solo');
            const modeGroupEl = node.querySelector('#mode-group');
            const footerTotalEl = node.querySelector('#footer-total');
            const footerSavingsEl = node.querySelector('#footer-savings');
            const btnTextEl = node.querySelector('#btn-text-action');
            const actionBtn = node.querySelector('#action-btn');

            const renderMode = () => {
                const t1 = Math.round(p.price1 * qty);
                const t5 = Math.round(p.price5 * qty);
                
                if (!joinGroupId) {
                    modeSoloEl.className = `relative p-4 rounded-xl border-2 cursor-pointer transition-all active:scale-95 ${!isGroupMode ? 'border-gray-900 bg-white ring-1 ring-gray-900/10' : 'border-gray-200 bg-white'}`;
                    modeGroupEl.className = `relative p-4 rounded-xl border-2 cursor-pointer transition-all shadow-md active:scale-95 ${isGroupMode ? 'border-jodo-progress bg-yellow-50 ring-1 ring-jodo-progress/50' : 'border-gray-200 bg-white'}`;
                    modeSoloEl.querySelector('.price-text').innerText = `‚Çπ${t1}`;
                    modeGroupEl.querySelector('.price-text').innerText = `‚Çπ${t5}`;
                }

                node.querySelector('#qty-display').innerText = `${(qty * p.baseWeight).toFixed(2)} ${p.weightUnit}`;
                
                const total = Math.round((isGroupMode ? p.price5 : p.price1) * qty);
                footerTotalEl.innerText = `‚Çπ${total}`;
                
                if (isGroupMode) { 
                    const savings = Math.round((p.price1 * qty) - total); 
                    footerSavingsEl.innerHTML = `Savings: ‚Çπ${savings}`; 
                    btnTextEl.innerText = joinGroupId ? "Join Squad Now" : "Start Group Buy"; 
                } else { 
                    footerSavingsEl.innerText = "No Savings"; 
                    btnTextEl.innerText = `Buy Solo (‚Çπ${total})`; 
                }
            };

            if (!joinGroupId) {
                modeSoloEl.onclick = () => { isGroupMode = false; renderMode(); };
                modeGroupEl.onclick = () => { isGroupMode = true; renderMode(); };
            }
            
            const btnMinus = node.querySelector('#btn-minus'); if (btnMinus) btnMinus.onclick = () => { if (qty > 2) { qty--; renderMode(); } else { toast("Min quantity reached", 'alert-triangle'); triggerVibration(); } };
            const btnPlus = node.querySelector('#btn-plus'); if (btnPlus) btnPlus.onclick = () => { if (qty < 20) { qty++; renderMode(); } };
            renderMode(); 
            node.querySelector('#close-modal').addEventListener('click', window.closeModal);
            
            // --- SUBMIT ACTION ---
            const triggerAction = async () => {
                if (actionBtn.disabled) return; 
                actionBtn.disabled = true;
                const originalText = actionBtn.innerHTML; 
                actionBtn.innerHTML = `<div class="w-6 h-6 border-2 border-white/30 border-t-white rounded-full animate-spin"></div> Processing...`; 
                actionBtn.classList.add('opacity-75', 'cursor-not-allowed');
                
                const name = safeVal(node.querySelector('#inp-name')); 
                const phone = safeVal(node.querySelector('#inp-phone')); 
                const ward = safeVal(node.querySelector('#inp-ward'));
                
                if (!name || !/^[6-9]\d{9}$/.test(phone) || !ward) { 
                    actionBtn.disabled = false; 
                    actionBtn.innerHTML = originalText; 
                    actionBtn.classList.remove('opacity-75', 'cursor-not-allowed'); 
                    toast('Please check details', 'alert-circle'); 
                    return; 
                }
                
                triggerVibration(); 
                saveUser(name, phone, ward);
                
                const gid = joinGroupId || ('g-' + Date.now().toString(36) + Math.random().toString(36).slice(2, 6));

                if (!window.fs || !window.db) {
                     toast("Connecting to server...", "wifi");
                     await new Promise(r => setTimeout(r, 1000));
                }

                // 1. EXPIRY & STATUS CHECK
                let groupExpiryTime = deliveryTime.getTime(); 
                if (joinGroupId) {
                    try {
                        const gRef = window.fs.doc(window.db, "groups", joinGroupId);
                        const gSnap = await window.fs.getDoc(gRef);
                        
                        if (gSnap.exists()) {
                            const gData = gSnap.data();
                            
                            // CHECK 1: Is Closed?
                            if (gData.status === 'closed') {
                                toast("This group is closed", "lock");
                                actionBtn.disabled = false; actionBtn.innerHTML = originalText;
                                return;
                            }
                            
                            // CHECK 2: Is Expired?
                            if (gData.expiresAt < Date.now()) {
                                toast("This group has expired", "clock");
                                actionBtn.disabled = false; actionBtn.innerHTML = originalText;
                                return;
                            }

                            // CHECK 3: Max Members (SECURE - Count Subcollection)
                            const mCol = window.fs.collection(window.db, "groups", joinGroupId, "members");
                            const mSnap = await window.fs.getDocs(mCol);
                            if (mSnap.size >= MAX_GROUP_MEMBERS) {
                                toast("Group is full (Max 20)", "users");
                                actionBtn.disabled = false; actionBtn.innerHTML = originalText;
                                return;
                            }
                            
                            // CHECK 4: Check if member already exists (By scanning phone numbers)
                            // Note: We scan the docs because IDs are now unique timestamps
                            let alreadyJoined = false;
                            mSnap.forEach(doc => {
                                if (doc.data().phone === phone) alreadyJoined = true;
                            });
                            if (alreadyJoined) {
                                toast("Already joined this squad", "user-check");
                                saveJoinedGroup(joinGroupId); 
                                window.closeModal();
                                window.openGroup(joinGroupId);
                                return;
                            }

                            groupExpiryTime = gData.expiresAt;
                        }
                    } catch(e) { console.error("Validation error", e); }
                }

                const group = { 
                    id: gid, 
                    productId: pid, 
                    ownerName: name, 
                    ownerWard: ward, 
                    expiresAt: groupExpiryTime, 
                    deliveryDay: groupExpiryTime, 
                    createdAt: Date.now(), 
                    status: isGroupMode ? 'open' : 'closed', 
                    type: isGroupMode ? 'group' : 'solo' 
                };
                
                // üîë FIX 1: UNIQUE MEMBER ID
                const memberId = phone + '_' + Date.now();
                
                const member = { 
                    memberId, // Store ID in doc
                    groupId: gid, 
                    name, 
                    phone, 
                    ward, 
                    isLeader: !joinGroupId, 
                    quantity: Math.max(2, qty), 
                    joinedAt: Date.now() 
                };
                
                try {
                    if (!joinGroupId) {
                        await window.fs.setDoc(window.fs.doc(window.db, "groups", gid), group);
                    }
                    // üîë FIX 1: Use Unique ID for Doc
                    await window.fs.setDoc(window.fs.doc(window.db, "groups", gid, "members", memberId), member);
                    
                    saveJoinedGroup(gid);
                    markOrderHabit(); 
                    
                    console.log("[ADMIN] JOINED:", gid, phone, qty);

                    setTimeout(() => { 
                        window.closeModal(); 
                        if (isGroupMode) window.openGroup(gid); 
                        else { 
                            toast("Solo Order Confirmed!", "check-circle"); 
                            render(); 
                        } 
                        triggerConfetti(); 
                    }, 800); 
                } catch (e) {
                    console.error(e);
                    actionBtn.disabled = false; actionBtn.innerHTML = originalText; actionBtn.classList.remove('opacity-75', 'cursor-not-allowed');
                    toast('Network error. Try again.', 'wifi-off');
                }
            };
            actionBtn.onclick = triggerAction;
        };

        window.openEditMemberModal = function(gid, memberIndex) {
            const group = state.groups[gid];
            if (!group) return toast('Group data missing', 'alert-circle');
            const members = state.members[gid];
            if (!Array.isArray(members) || !members[memberIndex]) return;
            const member = members[memberIndex];
            
            if (member.phone !== state.user.phone) {
                toast("You can only edit your own order", "lock");
                return;
            }

            const p = PRODUCTS.find(x => x.id === group.productId);
            const isExpired = group.expiresAt < Date.now();

            const node = createNodeFromHTML(`
                <div class="flex flex-col h-[85vh] bg-white transition-all duration-300 relative rounded-t-[2rem] overflow-hidden">
                    <div class="bg-white px-5 py-4 flex items-center justify-between shadow-sm border-b border-jodo-border shrink-0 z-20">
                        <h3 class="font-bold text-xl text-jodo-textPrimary">Edit Order</h3>
                        <button id="close-modal" class="p-2 bg-gray-100 rounded-full text-jodo-textSecondary hover:bg-gray-200 cursor-pointer"><i data-lucide="x" size="20"></i></button>
                    </div>
                    <div class="p-5 overflow-y-auto flex-1 overscroll-contain relative">
                        <div class="bg-white border border-jodo-border rounded-xl p-4 mb-6 text-center shadow-sm relative overflow-hidden">
                             <div class="text-[10px] text-jodo-textSecondary font-bold uppercase tracking-wider mb-1">Est. Total Cost</div>
                             <div class="text-4xl price-anchor tracking-tighter" id="live-total">‚Çπ0</div>
                             <div class="flex items-center justify-center gap-2 mt-2">
                                <div class="text-[10px] font-bold text-green-700 bg-green-50 px-2 py-1 rounded border border-green-100 flex items-center gap-1"><i data-lucide="trending-down" size="10"></i> <span id="live-savings">Saves ‚Çπ0</span></div>
                                <div class="text-[10px] font-bold text-jodo-textSecondary bg-gray-50 px-2 py-1 rounded border border-gray-100" id="live-rate">@ ‚Çπ0/${p.unit}</div>
                             </div>
                        </div>
                        <div class="flex items-center justify-between bg-white p-4 rounded-xl border border-jodo-border mb-6 shadow-sm">
                            <div class="ml-1">
                                <div class="text-xs font-bold text-jodo-textSecondary uppercase">Total Weight</div>
                                <div class="text-[10px] text-gray-400 font-medium">Increments of ${p.unit}</div>
                            </div>
                            <div class="flex items-center gap-3">
                                <button id="btn-minus" class="w-10 h-10 rounded-md bg-white border border-gray-300 text-gray-500 flex items-center justify-center shadow-sm active:scale-95 transition-transform cursor-pointer" ${isExpired ? 'disabled' : ''}><i data-lucide="minus" size="18"></i></button>
                                <span id="qty-display" class="font-bold text-xl w-20 text-center text-jodo-textPrimary tabular-nums">...</span>
                                <button id="btn-plus" class="w-10 h-10 rounded-md bg-jodo-ctaPrimary text-white shadow-md flex items-center justify-center active:scale-95 transition-transform cursor-pointer" ${isExpired ? 'disabled' : ''}><i data-lucide="plus" size="18"></i></button>
                            </div>
                        </div>
                        <div class="space-y-4 mb-6">
                            <div><label class="block text-xs font-bold text-jodo-textSecondary uppercase mb-1.5 ml-1">Name</label><input id="m-name" value="${member.name}" class="w-full bg-white border border-gray-300 p-3.5 rounded-lg font-bold text-jodo-textPrimary text-base outline-none focus:border-jodo-ctaPrimary focus:ring-1 focus:ring-jodo-ctaPrimary transition-all" ${isExpired ? 'disabled' : ''}></div>
                            <div><label class="block text-xs font-bold text-jodo-textSecondary uppercase mb-1.5 ml-1">WhatsApp Number</label><input id="m-phone" value="${member.phone}" type="tel" class="w-full bg-gray-100 border border-gray-300 p-3.5 rounded-lg font-bold text-jodo-textSecondary text-base outline-none cursor-not-allowed" disabled></div>
                            <div><label class="block text-xs font-bold text-jodo-textSecondary uppercase mb-1.5 ml-1">Ward Number</label><input id="m-ward" value="${member.ward || ''}" type="number" class="w-full bg-white border border-gray-300 p-3.5 rounded-lg font-bold text-jodo-textPrimary text-base outline-none focus:border-jodo-ctaPrimary focus:ring-1 focus:ring-jodo-ctaPrimary transition-all" ${isExpired ? 'disabled' : ''}></div>
                        </div>
                    </div>
                    <div class="bg-white border-t border-jodo-border p-4 shrink-0 pb-safe shadow-[0_-4px_20px_rgba(0,0,0,0.05)] z-20">
                        ${isExpired 
                            ? '<div class="text-center text-jodo-urgency font-bold mb-4 bg-red-50 p-3 rounded-lg border border-red-100">Deal Expired - Cannot Edit</div>' 
                            : '<button id="save-btn" class="w-full bg-jodo-ctaPrimary text-white h-[56px] rounded-xl font-bold text-lg shadow-lg btn-press flex items-center justify-center gap-2 cursor-pointer">Save Changes</button>'
                        }
                    </div>
                </div>
            `);
            showModalNode(node);
            
            let qty = member.quantity || 2;
            if (qty < 2) qty = 2; const minQty = 2;
            const updateEditDisplay = () => {
                const totalWeight = qty * p.baseWeight;
                node.querySelector('#qty-display').innerText = `${totalWeight.toFixed(2)} ${p.weightUnit}`;
                const total = Math.round(p.price5 * qty);
                const soloTotal = Math.round(p.price1 * qty);
                const savings = soloTotal - total;
                node.querySelector('#live-total').innerText = `‚Çπ${total}`;
                node.querySelector('#live-savings').innerText = `Saves ‚Çπ${savings}`;
                node.querySelector('#live-rate').innerText = `@ ‚Çπ${p.price5}/${p.unit}`;
            };
            const btnMinus = node.querySelector('#btn-minus');
            if(btnMinus) btnMinus.onclick = () => { if(qty > minQty) { qty--; updateEditDisplay(); } else toast("Min quantity reached", "alert-triangle"); };
            const btnPlus = node.querySelector('#btn-plus');
            if(btnPlus) btnPlus.onclick = () => { if(qty < 20) { qty++; updateEditDisplay(); } };
            updateEditDisplay();
            node.querySelector('#close-modal').addEventListener('click', window.closeModal);
            
            const saveBtn = node.querySelector('#save-btn');
            if (saveBtn && !isExpired) {
                saveBtn.onclick = async () => { 
                    const name = safeVal(node.querySelector('#m-name')); 
                    const phone = member.phone; 
                    const ward = safeVal(node.querySelector('#m-ward'));
                    
                    if (!name || !ward) return toast('Name & Ward required', 'alert-circle'); 
                    
                    // üîí SECURITY: Re-check expiry AND status before write
                    if (group.expiresAt < Date.now()) {
                        toast("Group has expired", "clock");
                        window.closeModal();
                        return;
                    }
                    if (group.status === 'closed') {
                        toast("Group is closed", "lock");
                        window.closeModal();
                        return;
                    }

                    const updatedMember = { ...member, name, ward, quantity: qty, updatedAt: Date.now() };
                    
                    try {
                        saveBtn.disabled = true;
                        saveBtn.innerHTML = 'Saving...';
                        
                        // üîë FIX 1b: Use captured DOC ID (not phone) to update correct record
                        await window.fs.setDoc(
                            window.fs.doc(window.db, "groups", gid, "members", member.id),
                            updatedMember
                        );
                        saveUser(name, phone, ward); 
                        window.closeModal(); 
                        toast('Order Updated!', 'check-circle'); 
                    } catch(e) {
                        console.error(e);
                        toast('Save Failed', 'alert-circle');
                        saveBtn.disabled = false;
                        saveBtn.innerHTML = 'Save Changes';
                    }
                };
            }
        };

        function renderHome(el) {
            const activeUserGroups = [];
            state.user.joinedGroupIds.forEach(gid => {
                if (state.groups[gid]) activeUserGroups.push(state.groups[gid]);
            });
            activeUserGroups.sort((a, b) => b.createdAt - a.createdAt);
            
            const userActiveGroupIds = {};
            activeUserGroups.forEach(g => { userActiveGroupIds[g.productId] = g.id; });
            
            const sortedProducts = [...PRODUCTS].sort((a, b) => { 
                const aActive = !!userActiveGroupIds[a.id]; 
                const bActive = !!userActiveGroupIds[b.id]; 
                if (aActive && !bActive) return -1; 
                if (!aActive && bActive) return 1; 
                return 0; 
            });

            let heroContent = '';
            if (activeUserGroups.length > 0) {
                const cardsHtml = activeUserGroups.map(g => {
                    const p = PRODUCTS.find(x => x.id === g.productId); if (!p) return '';
                    const members = state.members[g.id] || []; 
                    const count = members.length;
                    const progress = Math.min(100, (count / 3) * 100);
                    const needed = Math.max(0, 3 - count); 
                    const isUnlocked = count >= 3;
                    const statusLabel = isUnlocked ? 'Price Unlocked!' : `${needed} more needed`;
                    const statusClass = isUnlocked ? 'text-green-700 bg-green-50 border-green-200' : 'text-yellow-800 bg-yellow-50 border-yellow-200';
                    const barClass = isUnlocked ? 'bg-jodo-ctaSuccess' : 'bg-jodo-progress';
                    
                    return `<div onclick="openGroup('${g.id}')" class="shrink-0 w-[85%] max-w-[280px] snap-center cursor-pointer card-modern tilt-card">
                        <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-200 relative overflow-hidden h-full flex flex-col justify-between">
                            <div class="flex items-center gap-3 mb-3 relative z-10 mt-2">
                                <div class="w-12 h-12 bg-gray-50 border border-gray-100 rounded-lg flex items-center justify-center text-jodo-textPrimary shadow-sm shrink-0"><i data-lucide="${p.icon}" size="24"></i></div>
                                <div class="flex-1 min-w-0"><h3 class="font-bold text-jodo-textPrimary text-base leading-none mb-2 truncate">${p.name}</h3>
                                    <div class="flex items-center justify-between gap-2"><div class="flex items-center gap-1 text-[10px] text-jodo-textSecondary"><i data-lucide="users" size="12"></i><span class="text-jodo-textPrimary font-bold">${count}/3</span></div><div class="${statusClass} text-[9px] font-bold px-2 py-0.5 rounded border uppercase tracking-wider whitespace-nowrap">${statusLabel}</div></div>
                                </div>
                            </div>
                            <div class="relative h-1.5 bg-gray-100 rounded-full overflow-hidden"><div class="absolute inset-y-0 left-0 ${barClass} transition-all duration-1000" style="width: ${progress}%"></div></div>
                        </div>
                    </div>`;
                }).join('');
                heroContent = `<div class="mt-6 mb-4"><div class="px-4 flex gap-3 overflow-x-auto snap-x snap-mandatory no-scrollbar pb-2">${cardsHtml}</div></div>`;
            } else {
                heroContent = `
                <div class="px-4 mt-6 mb-4">
                    <div onclick="openLiveGuide()" class="relative w-full h-40 bg-gray-900 rounded-2xl overflow-hidden shadow-md border border-gray-200 group cursor-pointer tilt-card">
                        <img src="https://images.unsplash.com/photo-1595245863955-d14dc7a488e0?auto=format&fit=crop&w=800&q=80" class="w-full h-full object-cover opacity-60 transition-transform duration-700 group-hover:scale-110">
                        <div class="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent flex flex-col justify-end p-5">
                            <div class="text-white font-black text-xl mb-1 flex items-center gap-2">How JODO Works <i data-lucide="play-circle" class="text-white fill-white/20"></i></div>
                            <div class="text-gray-200 text-xs font-medium">Join forces with neighbors to unlock wholesale mandi prices.</div>
                        </div>
                    </div>
                </div>`;
            }

            el.innerHTML = `
                <div class="pb-safe fade-in bg-white">
                    <div class="glass-header sticky top-0 z-40 shadow-sm border-b-0">
                        <div class="pt-safe px-4 pb-3 flex justify-between items-end min-h-[88px]">
                            <div class="flex flex-col justify-end pb-0.5">
                                <h1 class="font-black text-3xl tracking-tighter text-jodo-ctaPrimary leading-none mb-1">JODO</h1>
                                <span class="text-[10px] text-jodo-textSecondary font-bold uppercase tracking-widest">Community Buying</span>
                            </div>
                            <div class="flex flex-col items-end justify-end h-full">
                                <button onclick="openSupportOptions()" class="group flex items-center gap-2 bg-gray-100 border border-gray-200 px-3 py-1.5 rounded-xl active:bg-gray-200 transition-all shadow-sm">
                                    <i data-lucide="headset" size="14" class="text-gray-600 group-active:scale-90 transition-transform"></i>
                                    <span class="text-sm font-bold text-gray-700 tracking-wide">Help</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="px-4 mt-4">
                        <div class="bg-blue-50 border border-blue-100 rounded-lg p-2.5 flex items-center gap-2 text-[10px] font-bold text-blue-800 shadow-sm">
                            <span class="relative flex h-2 w-2">
                              <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-blue-400 opacity-75"></span>
                              <span class="relative inline-flex rounded-full h-2 w-2 bg-blue-500"></span>
                            </span>
                            58 squads completed in Duvva today.
                        </div>
                    </div>
                    
                    ${heroContent}
                    
                    <div class="px-4 space-y-3 mt-2 pb-32">
                        <div class="flex items-center justify-between mb-2 mt-6">
                            <h2 class="text-xs font-bold text-jodo-textSecondary uppercase tracking-widest">Live Deals</h2>
                            <div class="text-[10px] font-bold text-gray-400 bg-gray-50 px-2 py-1 rounded border border-gray-100">Ends 8 PM</div>
                        </div>
                        
                        ${sortedProducts.map(p => {
                            const activeGid = userActiveGroupIds[p.id];
                            const savings = p.price1 - p.price5;
                            const actionAttr = activeGid ? `onclick="openGroup('${activeGid}')"` : `onclick="openStartModal('${p.id}')"`;
                            const btnText = activeGid ? 'View Order' : 'Grab Deal';
                            const btnClass = activeGid ? 'bg-white border border-jodo-ctaPrimary text-jodo-ctaPrimary' : 'bg-jodo-ctaPrimary text-white border border-transparent';
                            
                            return `
                            <div class="bg-white p-3 rounded-2xl flex gap-3 shadow-[0_4px_20px_rgba(0,0,0,0.03)] border border-gray-100 relative overflow-hidden active:scale-[0.99] transition-all duration-200 group-card" ${actionAttr}>
                                <div onclick="event.stopPropagation(); openFullFeed('${p.id}')" class="w-28 h-28 bg-gray-100 rounded-xl relative overflow-hidden shrink-0 border border-gray-100 cursor-pointer group shadow-sm">
                                    <img src="${p.imageSrc}" class="absolute inset-0 w-full h-full object-cover transition-transform duration-700 group-hover:scale-110" alt="${p.name}" loading="lazy">
                                    <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 to-transparent p-1.5 pt-6"><div class="text-white text-[9px] font-bold text-center leading-none tracking-wide">${p.remainingStock}kg left</div></div>
                                </div>

                                <div class="flex-1 flex flex-col justify-between py-1 min-w-0">
                                    <div>
                                        <div class="mb-1"><h3 class="font-black text-lg text-jodo-textPrimary leading-tight line-clamp-1">${p.name}</h3><div class="text-xs font-semibold text-jodo-textSecondary line-clamp-1">${p.nameTe}</div></div>
                                        <div class="flex flex-wrap gap-1.5"><span class="bg-gray-100 text-jodo-textSecondary text-[9px] font-bold px-1.5 py-0.5 rounded border border-gray-200">Fresh</span><span class="bg-green-50 text-green-700 text-[9px] font-bold px-1.5 py-0.5 rounded border border-green-200 flex items-center gap-0.5"><i data-lucide="trending-down" size="10"></i> Save ‚Çπ${savings}</span></div>
                                    </div>
                                    <div>
                                        <div class="flex items-end justify-between gap-2">
                                            <div>
                                                <div class="text-[9px] text-gray-400 font-bold uppercase tracking-wider mb-0.5 line-through decoration-red-500">‚Çπ${p.price1}</div>
                                                <div class="flex items-baseline gap-1.5 text-jodo-priceFinal"><div class="flex items-baseline leading-none"><span class="text-sm font-bold">‚Çπ</span><span class="text-2xl font-black tracking-tighter">${p.price5}</span></div><span class="text-[10px] text-jodo-textSecondary font-bold">/ ${p.unit}</span></div>
                                            </div>
                                            <button class="${btnClass} h-9 px-3.5 rounded-lg shadow-sm flex items-center gap-1.5 active:scale-95 transition-transform shrink-0"><span class="text-xs font-bold uppercase tracking-wide">${btnText}</span><i data-lucide="${activeGid ? 'chevron-right' : 'arrow-right'}" size="14"></i></button>
                                        </div>
                                    </div>
                                </div>
                            </div>`;
                        }).join('')}
                    </div>
                </div>
            `;
            initCardTilt();
        }

        function renderGroup(el) {
            if (state.timerInterval) { clearInterval(state.timerInterval); state.timerInterval = null; }
            
            const g = state.groups[state.currentGroupId]; 
            if (!g) {
                el.innerHTML = `
                <div class="min-h-screen bg-white p-6 pt-24 space-y-6">
                    <div class="w-2/3 h-8 bg-gray-100 rounded-lg skeleton mx-auto"></div>
                    <div class="w-1/2 h-4 bg-gray-100 rounded-lg skeleton mx-auto"></div>
                    <div class="w-full h-64 bg-gray-100 rounded-xl skeleton mt-8"></div>
                    <div class="space-y-3 mt-8">
                         <div class="w-full h-20 bg-gray-100 rounded-xl skeleton"></div>
                         <div class="w-full h-20 bg-gray-100 rounded-xl skeleton"></div>
                    </div>
                </div>`;
                return;
            }
            
            const p = PRODUCTS.find(x => x.id === g.productId); 
            if (!p) { toast('Product unavailable', 'alert-circle'); return goHome(); }
            
            const members = state.members[g.id] || []; 
            const count = members.length;
            const needed = Math.max(0, 3 - count);
            const currentUserMember = members.find(m => m.phone === state.user.phone);
            
            if (count >= 3 && count !== state.lastMemberCount && state.lastMemberCount !== 0) {
                triggerConfetti();
            }
            state.lastMemberCount = count;

            const expiryDate = new Date(g.expiresAt);
            const now = new Date();
            const isExpired = g.expiresAt < now.getTime();
            let hours = expiryDate.getHours();
            const minutes = expiryDate.getMinutes();
            const ampm = hours >= 12 ? 'PM' : 'AM';
            hours = hours % 12; hours = hours ? hours : 12; 
            const minutesStr = minutes < 10 ? '0'+minutes : minutes;
            const timeStr = hours + ':' + minutesStr + ' ' + ampm;
            let dateLabel = "Today";
            const tomorrow = new Date(now); tomorrow.setDate(tomorrow.getDate() + 1);
            if (expiryDate.toDateString() === now.toDateString()) dateLabel = "Today";
            else if (expiryDate.toDateString() === tomorrow.toDateString()) dateLabel = "Tomorrow";
            else { const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"]; dateLabel = `${monthNames[expiryDate.getMonth()]} ${expiryDate.getDate()}`; }

            const currentUrl = `${BASE_URL}?group=${g.id}`;
            const inviteMsg = `Join my squad for ${p.name} on JODO! We need ${needed} more to get it for ‚Çπ${p.price5}/${p.unit}. Order here: ${currentUrl}`;
            const inviteLink = `https://wa.me/?text=${encodeURIComponent(inviteMsg)}`;

            el.innerHTML = `
                <div class="fade-in bg-white min-h-screen pb-40 font-sans">
                    <div class="glass-header h-[64px] sticky top-0 z-50 px-4 flex justify-between items-center bg-white shadow-sm">
                        <div class="flex items-center gap-3 cursor-pointer pt-safe" onclick="goHome()">
                            <i data-lucide="arrow-left" size="24" class="text-jodo-textPrimary"></i>
                            <span class="font-bold text-lg tracking-wide text-jodo-textPrimary">Group #${g.id.slice(-4)}</span>
                        </div>
                        <div class="font-mono font-bold text-lg tracking-widest text-jodo-textPrimary tabular-nums pt-safe" id="header-timer">...</div>
                    </div>

                    <div class="p-4">
                        <div class="flex flex-col items-center mb-6 mt-6 animate-in fade-in-up duration-300">
                            <h1 class="text-3xl font-black text-jodo-textPrimary leading-none mb-1 tracking-tight text-center">${p.name}</h1>
                            <p class="text-sm font-bold text-jodo-textSecondary">${p.nameTe} ‚Ä¢ ${p.unit} Bundle</p>
                        </div>

                        ${isExpired ? `
                        <div class="bg-red-50 text-red-700 p-4 mb-6 rounded-xl shadow-sm text-center border border-red-100 flex items-center justify-center gap-2">
                            <i data-lucide="clock" size="20"></i>
                            <div class="font-bold text-lg uppercase">Squad Expired</div>
                        </div>` : ''}

                        <div class="text-center mb-8 relative">
                            <div class="inline-block relative">
                                <div class="text-6xl font-mono font-black text-jodo-textPrimary tracking-tighter tabular-nums relative z-10 leading-none" id="hero-timer">--:--:--</div>
                            </div>
                            <div class="text-jodo-textSecondary text-xs font-bold uppercase tracking-[0.2em] mt-3">Expires ${dateLabel} ${timeStr}</div>
                        </div>

                        <div class="bg-white border border-gray-200 rounded-xl p-4 mb-6 shadow-sm">
                            <div class="space-y-4 mb-6">
                                <div class="flex justify-between items-center ${count < 3 ? 'opacity-100' : 'opacity-40 grayscale'} transition-all">
                                    <div class="flex items-center gap-3"><div class="w-6 h-6 rounded-full bg-gray-100 text-gray-500 flex items-center justify-center text-xs font-bold">1</div><span class="text-sm font-bold text-jodo-textSecondary">Solo Price</span></div>
                                    <span class="text-base font-bold text-jodo-priceOld line-through">‚Çπ${p.price1}</span>
                                </div>
                                <div class="flex justify-between items-center ${count >= 3 ? 'scale-105' : ''} transition-all p-3 -mx-3 rounded-lg ${count >= 3 ? 'bg-green-50 border border-green-200 shadow-sm' : ''}">
                                    <div class="flex items-center gap-3"><div class="w-6 h-6 rounded-full ${count >= 3 ? 'bg-green-600 text-white' : 'bg-gray-100 text-gray-500'} flex items-center justify-center text-xs font-bold">3+</div><span class="text-sm font-bold ${count >= 3 ? 'text-green-800' : 'text-jodo-textSecondary'}">Group Price</span></div>
                                    <span class="text-2xl price-anchor ${count >= 3 ? 'text-jodo-priceFinal' : 'text-gray-400'}">‚Çπ${p.price5}</span>
                                </div>
                            </div>
                            <div class="text-center">
                                <div class="text-3xl font-black text-jodo-textPrimary mb-1">${count} <span class="text-gray-300 text-2xl">/</span> 3+</div>
                                <div class="text-sm font-bold ${count < 3 ? 'text-jodo-urgency' : 'text-jodo-priceFinal'}">${count < 3 ? `Need ${needed} more to unlock ‚Çπ${p.price5}` : 'üéâ LOWEST PRICE UNLOCKED!'}</div>
                            </div>
                        </div>

                        <div class="space-y-3 mb-8">
                            <h3 class="text-xs font-bold text-jodo-textSecondary uppercase tracking-widest mb-4">Our Gang (${count} Joined)</h3>
                            ${(() => {
                                const totalSlots = Math.max(members.length + 1, 3); 
                                return Array(totalSlots).fill(0).map((_, i) => {
                                    const member = members[i];
                                    if (member) {
                                        const isMe = (state.user.phone && member.phone === state.user.phone);
                                        const t1 = Math.round(member.quantity * p.price1);
                                        const t5 = Math.round(member.quantity * p.price5);
                                        
                                        const clickAttr = isMe ? `onclick="openEditMemberModal('${g.id}', ${i})"` : '';
                                        const cursorClass = isMe ? 'active:scale-[0.99] cursor-pointer' : 'cursor-default';

                                        return `<div class="bg-white border border-gray-200 p-4 rounded-xl shadow-sm mb-3 transition-all ${cursorClass}" ${clickAttr}>
                                            <div class="flex items-center justify-between mb-3">
                                                <div class="flex items-center gap-3">
                                                    <div class="w-10 h-10 rounded-full ${isMe ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-500'} flex items-center justify-center font-bold text-sm border-2 border-white shadow-sm shrink-0">${member.name[0]}</div>
                                                    <div><div class="text-sm font-bold text-jodo-textPrimary flex items-center gap-2">${isMe ? 'YOU' : member.name} ${member.isLeader ? '<span class="text-[9px] bg-yellow-100 text-yellow-800 px-1 rounded border border-yellow-200 font-bold uppercase">Leader</span>' : ''}</div><div class="text-xs text-jodo-textSecondary font-medium">${(member.quantity * p.baseWeight).toFixed(1)} ${p.weightUnit} confirmed</div></div>
                                                </div>
                                                ${isMe ? '<div class="text-green-600 bg-green-50 p-1.5 rounded-full"><i data-lucide="edit-2" size="14"></i></div>' : '<div class="text-gray-400 bg-gray-100 p-1.5 rounded-full"><i data-lucide="lock" size="14"></i></div>'}
                                            </div>
                                            <div class="grid grid-cols-2 gap-2 text-center bg-gray-50 rounded-lg p-2 border border-gray-100">
                                                <div class="flex flex-col"><span class="text-[9px] font-bold text-gray-400 uppercase mb-0.5">Solo Cost</span><span class="text-xs font-medium text-gray-500">‚Çπ${t1}</span></div>
                                                <div class="flex flex-col relative">${count >= 3 ? '<div class="absolute -top-3 left-1/2 -translate-x-1/2 text-[8px] bg-green-100 text-green-800 px-1.5 rounded-full font-bold border border-green-200">Unlocked</div>' : ''}<span class="text-[9px] font-bold ${count >= 3 ? 'text-green-700' : 'text-gray-400'} uppercase mb-0.5">Group Cost</span><span class="text-xs font-black ${count >= 3 ? 'text-green-700' : 'text-jodo-textPrimary'}">‚Çπ${t5}</span></div>
                                            </div>
                                        </div>`;
                                    } else {
                                        return `<div class="flex items-center justify-between bg-white border-2 border-dashed border-gray-200 p-4 rounded-xl mb-3">
                                            <div class="flex items-center gap-3 opacity-60"><div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center text-gray-400"><i data-lucide="user" size="18"></i></div><span class="text-sm font-bold text-gray-500">Open Spot</span></div>
                                            <div class="text-xs font-bold text-gray-400 bg-gray-50 px-3 py-1.5 rounded-lg border border-gray-100">Waiting...</div>
                                        </div>`;
                                    }
                                }).join('');
                            })()}
                        </div>
                    </div>

                    <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-jodo-border p-4 pb-safe z-50 shadow-[0_-10px_40px_rgba(0,0,0,0.05)]">
                        <div class="max-w-md mx-auto pt-2 pb-2">
                            ${count < 3 ? `
                                ${!currentUserMember && !isExpired ? `
                                <button onclick="openStartModal('${p.id}', '${g.id}')" class="block w-full bg-jodo-ctaPrimary text-white h-[56px] rounded-xl font-bold text-lg shadow-lg flex items-center justify-center gap-2 mb-3 btn-press">
                                    <i data-lucide="user-plus" size="24"></i>
                                    <span>Join This Squad</span>
                                </button>
                                ` : ''}
                                <a href="${inviteLink}" target="_blank" class="block w-full bg-[#25D366] text-white h-[56px] flex items-center justify-center rounded-xl font-bold text-lg text-center shadow-lg btn-press gap-2 transition-all hover:bg-[#1ebc57]">
                                    <i data-lucide="share-2" size="24"></i>
                                    <span>Share Invite Link</span>
                                </a>
                                <div class="text-center mt-3 flex items-center justify-center gap-2 text-xs font-medium text-jodo-textSecondary">
                                    <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                                    <span>${needed} spots left to unlock ‚Çπ${p.price5}</span>
                                </div>
                            ` : `
                                <div class="text-center text-green-700 bg-green-50 p-3 rounded-lg border border-green-200 font-bold mb-3 shadow-sm flex items-center justify-center gap-2">
                                  <i data-lucide="lock" size="18"></i>
                                  üéâ Lowest Price Unlocked! Order Locked.
                                </div>
                                <div class="text-center text-xs text-gray-400 font-medium">Admin will process delivery soon.</div>
                            `}
                        </div>
                    </div>
                </div>
            `;

            const timerEl = el.querySelector('#hero-timer');
            const headerTimerEl = el.querySelector('#header-timer');
            if (timerEl) {
                const tick = () => {
                    const now = Date.now();
                    const diff = Math.max(0, g.expiresAt - now);
                    const h = Math.floor(diff / 3600000);
                    const m = Math.floor((diff % 3600000) / 60000);
                    const s = Math.floor((diff % 60000) / 1000);
                    const fmt = (n) => n < 10 ? '0'+n : n;
                    const mainStr = `${fmt(h)}:${fmt(m)}:${fmt(s)}`;
                    timerEl.innerText = mainStr;
                    if (headerTimerEl) headerTimerEl.innerText = mainStr;
                    
                    if (diff < 7200000 && diff > 0) { 
                        timerEl.classList.add('text-jodo-urgency'); 
                        if (headerTimerEl) headerTimerEl.classList.add('text-jodo-urgency'); 
                    }
                    
                    if (diff <= 0) { 
                        timerEl.innerText = "00:00:00"; 
                        timerEl.classList.add('text-gray-400'); 
                        if (headerTimerEl) headerTimerEl.classList.add('text-gray-400'); 
                        
                        if (g.status !== 'closed' && window.fs && window.db) {
                            const groupRef = window.fs.doc(window.db, "groups", g.id);
                            window.fs.updateDoc(groupRef, { status: 'closed' }).catch(e => console.log("Auto-close err", e));
                        }
                        
                        clearInterval(state.timerInterval); 
                        state.timerInterval = null; 
                    }
                };
                state.timerInterval = setInterval(tick, 1000); tick();
            }
        }

        function render() {
            const app = document.getElementById('app');
            if (!app) return;
            
            if (state.view === 'home') renderHome(app);
            else renderGroup(app);
            
            if (window.lucide) window.lucide.createIcons();
        }
        
        function safeRender() {
            if (renderScheduled) return;
            renderScheduled = true;
            requestAnimationFrame(() => {
                render();
                renderScheduled = false;
            });
        }

        function listenToGroupForHome(gid) {
            if (!window.fs || !window.db) return;
            
            const unsubG = window.fs.onSnapshot(
                window.fs.doc(window.db, "groups", gid),
                (doc) => { if (doc.exists()) { state.groups[gid] = doc.data(); safeRender(); } }
            );
            state.homeListeners.push(unsubG);

            const unsubM = window.fs.onSnapshot(
                window.fs.collection(window.db, "groups", gid, "members"),
                (snap) => {
                    const m = []; snap.forEach(d => m.push(d.data()));
                    state.members[gid] = m;
                    safeRender();
                }
            );
            state.homeListeners.push(unsubM);
        }

        function initHomeListeners() {
            state.homeListeners.forEach(u => u());
            state.homeListeners = [];
            state.user.joinedGroupIds.forEach(gid => {
                listenToGroupForHome(gid);
            });
        }

        window.openGroup = function(gid) { 
            if (!gid || typeof gid !== 'string') {
                toast('Invalid group link', 'alert-circle');
                window.goHome();
                return;
            }
            
            try { 
                if (window.location.protocol !== 'blob:') {
                    history.pushState({}, '', `${BASE_URL}?group=${gid}`);
                }
            } catch(e) {} 

            state.currentGroupId = gid; 
            state.view = 'group'; 
            
            if (state.unsubGroup) { state.unsubGroup(); state.unsubGroup = null; }
            if (state.unsubMembers) { state.unsubMembers(); state.unsubMembers = null; }

            safeRender(); 

            if (window.fs && window.db) {
                state.unsubGroup = window.fs.onSnapshot(
                    window.fs.doc(window.db, "groups", gid),
                    (doc) => {
                        if (doc.exists()) {
                            state.groups[gid] = doc.data();
                            safeRender();
                        } else {
                            toast("Squad not found", "alert-circle");
                            window.goHome();
                        }
                    },
                    (error) => { console.error("Group Listen Error:", error); }
                );

                state.unsubMembers = window.fs.onSnapshot(
                    window.fs.collection(window.db, "groups", gid, "members"),
                    (snapshot) => {
                        const members = [];
                        snapshot.forEach((doc) => {
                            const data = doc.data();
                            // üîë CAPTURE UNIQUE ID so we can edit later
                            members.push({ ...data, id: doc.id });
                        });
                        state.members[gid] = members;
                        safeRender();
                    },
                     (error) => { console.error("Member Listen Error:", error); }
                );
            }
        };

        window.goHome = function() { 
            if (state.timerInterval) clearInterval(state.timerInterval);
            
            if (state.unsubGroup) { state.unsubGroup(); state.unsubGroup = null; }
            if (state.unsubMembers) { state.unsubMembers(); state.unsubMembers = null; }

            try { 
                if (window.location.protocol !== 'blob:') {
                    history.pushState({}, '', BASE_URL);
                }
            } catch(e) {} 
            
            state.view = 'home'; 
            state.currentGroupId = null; 
            
            safeRender(); 
            startTicker(); 
        };

        function init() {
            if (JODO_INITIALIZED) return; 
            JODO_INITIALIZED = true;
            
            loadData(); 
            loadHabit(); 
            
            const startApp = () => {
                initHomeListeners(); 
                
                const params = new URLSearchParams(window.location.search);
                const gid = params.get('group');
                
                if (gid) {
                    window.openGroup(gid);
                } else {
                    state.view = 'home';
                    safeRender();
                    startTicker();
                }
            };

            if (window.db) startApp();
            else window.addEventListener('firebase-ready', startApp);

            window.addEventListener('popstate', () => {
                const params = new URLSearchParams(location.search);
                const gid = params.get('group');
                if (gid) window.openGroup(gid); else window.goHome();
            });
        }
        
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
