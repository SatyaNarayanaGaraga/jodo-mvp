<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover" />
    <title>JODO - Farm Deals</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ¥¬</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        // ðŸ§  PSYCHOLOGY COLOR SYSTEM - STRICT MODE
                        psycho: {
                            action: '#059669',      // GREEN: Action, Savings, Confidence
                            actionLight: '#10b981', 
                            actionBg: '#ecfdf5',    // Green-50 equivalent
                            urgency: '#ef4444',     // RED: Fear, Loss, Spike
                            urgencyBg: '#fef2f2',   // Red-50 equivalent
                            reward: '#f59e0b',      // GOLD: Goal, Best Price, Status
                            rewardLight: '#fbbf24',
                            rewardBg: '#fffbeb',    // Yellow-50 equivalent
                            trust: '#3b82f6',       // BLUE: Safety, Verification, Calm
                            trustBg: '#eff6ff',     // Blue-50 equivalent
                            alert: '#f97316',       // ORANGE: Attention without Panic
                            alertBg: '#fff7ed',     // Orange-50 equivalent
                            neutral: '#64748b',     // SLATE: Baseline
                            base: '#f8fafc'         // WHITE/SLATE: Eye Reset
                        },
                        slate: {
                            50: '#f8fafc',
                            100: '#f1f5f9',
                            200: '#e2e8f0',
                            300: '#cbd5e1',
                            400: '#94a3b8',
                            500: '#64748b',
                            600: '#475569',
                            700: '#334155',
                            800: '#1e293b',
                            900: '#0f172a',
                            950: '#020617',
                        }
                    },
                    animation: {
                        'float-slow': 'float 4s ease-in-out infinite',
                        'slide-shimmer': 'shimmer 2s linear infinite',
                        'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'pop': 'pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)',
                        'shake': 'shake 0.5s cubic-bezier(.36,.07,.19,.97) both',
                        'ping-slow': 'ping 3s cubic-bezier(0, 0, 0.2, 1) infinite',
                        'flash-red': 'flashRed 1s ease-out',
                        'flash-green': 'flashGreen 1s ease-out',
                    },
                    keyframes: {
                        float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-6px)' } },
                        shimmer: { '0%': { backgroundPosition: '-200% 0' }, '100%': { backgroundPosition: '200% 0' } },
                        pop: { '0%': { transform: 'scale(0.9)' }, '100%': { transform: 'scale(1)' } },
                        shake: { '10%, 90%': { transform: 'translate3d(-1px, 0, 0)' }, '20%, 80%': { transform: 'translate3d(2px, 0, 0)' }, '30%, 50%, 70%': { transform: 'translate3d(-4px, 0, 0)' }, '40%, 60%': { transform: 'translate3d(4px, 0, 0)' } },
                        flashRed: { '0%': { color: '#ef4444', transform: 'scale(1.2)' }, '100%': { color: 'inherit', transform: 'scale(1)' } },
                        flashGreen: { '0%': { color: '#059669', transform: 'scale(1.2)' }, '100%': { color: 'inherit', transform: 'scale(1)' } }
                    }
                }
            }
        }
    </script>
    <style>
        body { 
            font-family: 'Inter', system-ui, sans-serif; 
            background: #0f172a; 
            color: #0f172a; 
            -webkit-tap-highlight-color: transparent; 
            min-height: 100dvh; 
            display: flex;
            justify-content: center;
            overscroll-behavior: none;
        }
        #app {
            width: 100%;
            max-width: 28rem;
            background: #f8fafc; /* RESET WHITE */
            height: 100dvh;
            position: relative;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            overflow-y: auto;
            overflow-x: hidden;
        }
        .btn-press { transition: transform 0.1s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer; }
        .btn-press:active:not(:disabled) { transform: scale(0.97); }
        
        .card-modern { background: white; border-radius: 1.25rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03); border: 1px solid #f1f5f9; }
        .glass-header { background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        input[type=range].slider-lock { -webkit-appearance: none; width: 100%; background: transparent; cursor: pointer; }
        input[type=range].slider-lock::-webkit-slider-thumb { -webkit-appearance: none; height: 52px; width: 52px; border-radius: 50%; background: #ffffff; box-shadow: 0 4px 12px rgba(0,0,0,0.2); margin-top: -2px; position: relative; z-index: 50; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23059669' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='m9 18 6-6-6-6'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: center; }
        input[type=range].slider-lock::-webkit-slider-runnable-track { width: 100%; height: 48px; cursor: pointer; background: rgba(0,0,0,0.05); border-radius: 99px; border: 2px solid rgba(255,255,255,0.8); }
        
        .video-grain { background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.05'/%3E%3C/svg%3E"); }
        
        .pulse-attention { animation: pulse-fast 2s infinite; }
        .blur-effect { filter: blur(2px) grayscale(0.5); transition: all 0.3s; }
        .animate-shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }

        /* Trust Badge Style */
        .bg-trust-badge { background-color: #eff6ff; border: 1px solid #bfdbfe; color: #1e40af; }
    </style>
</head>
<body class="pb-10 antialiased selection:bg-psycho-actionLight/20">

    <div id="app"></div>

    <div id="modal-overlay" class="fixed inset-0 bg-slate-900/60 hidden z-[60] flex items-end sm:items-center justify-center p-4 backdrop-blur-sm transition-all duration-300">
        <!-- MODAL FIX: Added max-h-[85dvh] and overflow-y-auto to ensure it fits on small screens/keyboards -->
        <div id="modal-content" class="bg-white w-full max-w-sm rounded-t-3xl sm:rounded-3xl p-6 pt-8 shadow-2xl transform transition-all relative overflow-y-auto max-h-[85dvh] pb-8"></div>
    </div>

    <!-- TRIGGER 5 & 16: PSYCHOLOGY TICKER -->
    <div id="live-ticker" class="fixed bottom-4 left-1/2 -translate-x-1/2 bg-slate-900/95 backdrop-blur-md text-white px-4 py-2.5 rounded-full text-xs font-medium shadow-2xl z-[55] flex items-center gap-2 pointer-events-none border border-white/10 whitespace-nowrap hidden max-w-[90%] overflow-hidden transition-all duration-500">
        <div id="ticker-dot" class="w-2 h-2 rounded-full animate-pulse shrink-0"></div>
        <span id="ticker-text" class="truncate font-bold tracking-wide">...</span>
    </div>

    <div id="toast" aria-live="polite" role="status" class="fixed top-24 left-1/2 -translate-x-1/2 bg-slate-900/95 backdrop-blur-md text-white px-6 py-3 rounded-full text-sm font-bold shadow-2xl hidden z-[90] flex items-center gap-2 pointer-events-none border border-white/10 transition-all duration-300 tracking-wide animate-pop"></div>

    <script>
        // --- CONFIG & STATE ---
        const COMPANY_PHONE = "919999999999"; 
        const GUIDE_VIDEO_SRC = 'https://storage.googleapis.com/gtv-videos-bucket/sample/ForBiggerJoyrides.mp4';

        // ðŸ§  DYNAMIC COLOR FUNCTION
        function getTierColor(count, tier, forceGoal = false) {
            // TIER 5: GOAL / REWARD TIER
            if (tier === 5) {
                // ðŸ† VICTORY STATE
                if (count >= 5) {
                    return "bg-psycho-reward text-black shadow-[0_0_12px_rgba(245,158,11,0.6)] ring-2 ring-psycho-reward/50 transition-all duration-300 font-black";
                }
                
                // ðŸŽ¯ TARGET STATE
                return "bg-[#FFF9E5] text-[#F59E0B] border border-[#FCD34D] shadow-sm font-black";
            }

            // TIER 2: ACTION TIER
            if (tier === 2) {
                if (count >= 2) return "bg-psycho-action text-white shadow-[0_0_8px_rgba(5,150,105,0.5)] transition-all duration-300 font-bold";
                return "bg-psycho-actionLight/10 text-psycho-action border border-psycho-action/20";
            }

            // TIER 1: BASELINE
            if (tier === 1) {
                if (count < 2) return "bg-slate-200 text-slate-600 border border-slate-300";
                return "bg-slate-100 text-slate-500 border border-slate-200";
            }
        }
        
        // ðŸš¨ PSYCHOLOGY TRIGGERS
        const TICKER_MESSAGES = [
            { msg: "ðŸ’¡ Tip: Groups of 5 unlock the lowest wholesale price.", type: 'neutral' }, 
            { msg: "ðŸ“¦ Wholesale prices sourced directly from farmers.", type: 'good' },
            { msg: "ðŸ›¡ï¸ Pay on delivery available for all orders.", type: 'neutral' },
            { msg: "âš¡ Invite neighbors to fill your squad faster.", type: 'good' },
            { msg: "ðŸ“‰ Duvva Shops prices are updated daily at 5 AM.", type: 'neutral' }
        ];

        const PRODUCTS = [
            { 
                id: 'onion', 
                name: 'Red Onions', 
                nameTe: 'à°Žà°°à±à°° à°‰à°²à±à°²à°¿à°ªà°¾à°¯à°²à±', 
                unit: '500g', 
                baseWeight: 0.5, 
                weightUnit: 'kg', 
                price1: 25, price2: 22, price5: 18,
                mandiPrice: 32,
                farmerPrice: 12,
                remainingStock: 14,
                icon: 'layers', 
                imageColor: 'bg-slate-100 text-psycho-urgency', 
                farmer: 'Raju Bhai', 
                farmerLoc: 'Duvva',
                location: 'Duvva Fields', 
                liveViewers: '1.2k', 
                recentBuys: '124', 
                videoClass: 'bg-gradient-to-br from-slate-800 to-slate-900',
                videoSrc: 'https://storage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4' 
            },
            { 
                id: 'oil', 
                name: 'Sunflower Oil', 
                nameTe: 'à°ªà±Šà°¦à±à°¦à±à°¤à°¿à°°à±à°—à±à°¡à± à°¨à±‚à°¨à±†', 
                unit: '500ml', 
                baseWeight: 0.5, 
                weightUnit: 'L', 
                price1: 60, price2: 55, price5: 50,
                mandiPrice: 65,
                farmerPrice: 40,
                remainingStock: 8,
                icon: 'droplet', 
                imageColor: 'bg-slate-100 text-psycho-reward', 
                farmer: 'Sunil', 
                farmerLoc: 'Mills',
                location: 'Factory Direct', 
                liveViewers: '850', 
                recentBuys: '89', 
                videoClass: 'bg-gradient-to-br from-slate-900 to-black',
                videoSrc: 'https://storage.googleapis.com/gtv-videos-bucket/sample/ElephantsDream.mp4' 
            },
            { 
                id: 'sugar', 
                name: 'Sugar', 
                nameTe: 'à°šà°•à±à°•à±†à°°', 
                unit: '500g', 
                baseWeight: 0.5, 
                weightUnit: 'kg', 
                price1: 24, price2: 22, price5: 20, 
                mandiPrice: 38,
                farmerPrice: 15,
                remainingStock: 42,
                icon: 'package', 
                imageColor: 'bg-slate-100 text-psycho-trust', 
                farmer: 'Co-op', 
                farmerLoc: 'Society',
                location: 'Local Stock', 
                liveViewers: '340', 
                recentBuys: '45', 
                videoClass: 'bg-gradient-to-br from-slate-900 to-black',
                videoSrc: 'https://storage.googleapis.com/gtv-videos-bucket/sample/TearsOfSteel.mp4' 
            }
        ];

        const DB_KEY = 'jodo_local_db_v54';
        const EXPIRY_MS = 2 * 24 * 60 * 60 * 1000;
        
        // 1ï¸âƒ£ HABIT ENGINE
        const HABIT_KEY = 'jodo_habit_v1';
        const habitState = {
            totalOrders: 0,
            streakDays: 0,
            lastOrderDate: null
        };

        let lastTickerTime = 0;
        const TICKER_COOLDOWN_MS = 6000;

        const state = { 
            view: 'home', 
            currentGroupId: null, 
            groups: {}, 
            members: {}, 
            user: { name: '', phone: '' }, 
            timerInterval: null, 
            scrollObserver: null, 
            tickerInterval: null, 
            oneHourAlerted: false,
            hesitationInterval: null,
            dependencyInterval: null,
            painLoopInterval: null,
            mandiModalInterval: null, 
            mandiGroupInterval: null,
            lastMandiUpdate: { id: null, dir: null }
        };

        // --- UTILS ---
        function toast(msg, icon) { 
            const t = document.getElementById('toast'); 
            t.innerHTML = `<i data-lucide="${icon}" size="16"></i> ${msg}`; 
            t.classList.remove('hidden'); 
            if(window.lucide) window.lucide.createIcons(); 
            setTimeout(() => t.classList.add('hidden'), 3500); 
        }

        function triggerConfetti() {
            if (typeof confetti === 'function') {
                confetti({ particleCount: 150, spread: 80, origin: { y: 0.6 }, colors: ['#059669', '#f59e0b', '#ef4444'] });
            }
        }

        function triggerVibration() {
            if (navigator.vibrate) navigator.vibrate(20);
        }

        function showTicker(msg, type = 'neutral') {
            const modal = document.getElementById('modal-overlay');
            const feed = document.getElementById('full-feed-overlay');
            if ((modal && !modal.classList.contains('hidden')) || feed) return;

            const now = Date.now();
            if (type === 'neutral' && now - lastTickerTime < TICKER_COOLDOWN_MS) {
                return;
            }
            lastTickerTime = now;

            const el = document.getElementById('live-ticker');
            const txt = document.getElementById('ticker-text');
            const dot = document.getElementById('ticker-dot');
            if(!el || !txt || !dot) return;

            txt.innerText = msg;
            
            let bgClass, borderClass, dotClass;

            if(type === 'urgent') {
                bgClass = 'bg-psycho-urgency/95'; borderClass = 'border-psycho-urgency/30'; dotClass = 'bg-white';
            } else if (type === 'good') {
                bgClass = 'bg-psycho-action/95'; borderClass = 'border-psycho-action/30'; dotClass = 'bg-white';
            } else if (type === 'alert') {
                bgClass = 'bg-psycho-alert/95'; borderClass = 'border-psycho-alert/30'; dotClass = 'bg-white';
            } else { // neutral
                bgClass = 'bg-slate-900/95'; borderClass = 'border-white/10'; dotClass = 'bg-psycho-action';
            }

            el.className = `fixed bottom-4 left-1/2 -translate-x-1/2 ${bgClass} backdrop-blur-md text-white px-4 py-2.5 rounded-full text-xs font-bold shadow-2xl z-[55] flex items-center gap-2 pointer-events-none border ${borderClass} whitespace-nowrap max-w-[90%] overflow-hidden transition-all duration-500`;
            dot.className = `w-2 h-2 rounded-full animate-pulse shrink-0 ${dotClass}`;

            el.classList.remove('hidden', 'translate-y-10', 'opacity-0');
            el.classList.add('translate-y-0', 'opacity-100');
            
            setTimeout(() => {
                el.classList.add('translate-y-10', 'opacity-0');
                setTimeout(() => el.classList.add('hidden'), 500);
            }, 5000);
        }

        function startTicker() {
            if (state.tickerInterval) clearInterval(state.tickerInterval);
            
            const update = () => {
                const item = TICKER_MESSAGES[Math.floor(Math.random() * TICKER_MESSAGES.length)];
                showTicker(item.msg, item.type);
            };
            
            update();
            state.tickerInterval = setInterval(update, 12000); 
        }

        let scrollTimeout;
        const initBehaviorEngine = () => {
            const app = document.getElementById('app');
            app.addEventListener('scroll', () => {
                clearTimeout(scrollTimeout);
                scrollTimeout = setTimeout(() => {
                    if (state.view === 'home') {
                        showTicker("â³ Prices change soon â€” don't miss today's rate", 'alert');
                    }
                }, 4000);
            });
        };

        function startMandiEngine() {
            render();
        }

        function loadData() {
            try {
                state.user.name = localStorage.getItem('jodo_user_name') || '';
                state.user.phone = localStorage.getItem('jodo_user_phone') || '';
                const raw = localStorage.getItem(DB_KEY);
                if (raw) {
                    const data = JSON.parse(raw);
                    state.groups = data.groups || {};
                    state.members = data.members || {};
                }
            } catch(e) { console.error("Load Error", e); }
        }

        function saveData() {
            try {
                localStorage.setItem(DB_KEY, JSON.stringify({ groups: state.groups, members: state.members }));
                window.dispatchEvent(new Event('storage')); 
                setTimeout(() => showTicker("âœ… Squad details saved on this device.", 'good'), 2000);
            } catch(e) { console.error("Save Error", e); }
        }

        function saveUser(name, phone) {
            state.user.name = name;
            state.user.phone = phone;
            localStorage.setItem('jodo_user_name', name);
            localStorage.setItem('jodo_user_phone', phone);
        }

        function loadHabit() {
            try {
                const raw = localStorage.getItem(HABIT_KEY);
                if (raw) {
                    const data = JSON.parse(raw);
                    habitState.totalOrders = data.totalOrders || 0;
                    habitState.streakDays = data.streakDays || 0;
                    habitState.lastOrderDate = data.lastOrderDate || null;
                }
            } catch (e) {}
        }

        function saveHabit() {
            try { localStorage.setItem(HABIT_KEY, JSON.stringify(habitState)); } catch (e) {}
        }

        function markOrderHabit() {
            const today = new Date();
            const todayStr = today.toISOString().slice(0,10);
            if (!habitState.lastOrderDate) {
                habitState.streakDays = 1;
            } else {
                const last = new Date(habitState.lastOrderDate);
                const diffDays = Math.round((today - last) / 86400000);
                if (diffDays === 1) habitState.streakDays += 1;
                else if (diffDays > 1) habitState.streakDays = 1;
            }
            habitState.lastOrderDate = todayStr;
            habitState.totalOrders += 1;
            saveHabit();
        }

        function getActiveGroupId(pid) {
            if (state.user.name && state.user.phone) {
                for (const g of Object.values(state.groups)) {
                    if (g.productId === pid) {
                        const mems = state.members[g.id] || [];
                        if (mems.some(m => m.name === state.user.name && m.phone === state.user.phone)) return g.id;
                    }
                }
            }
            return null;
        }

        function createNodeFromHTML(html) { const t = document.createElement('template'); t.innerHTML = html.trim(); return t.content.firstElementChild; }
        function showModalNode(node) { const c = document.getElementById('modal-content'); c.innerHTML = ''; c.appendChild(node); document.getElementById('modal-overlay').classList.remove('hidden'); if(node.querySelector('input')) node.querySelector('input').focus(); if(window.lucide) window.lucide.createIcons(); }
        window.closeModal = () => document.getElementById('modal-overlay').classList.add('hidden');
        function showFieldError(c, m) { c.innerHTML = `<div class="field-error text-xs text-psycho-urgency font-bold bg-psycho-urgency/10 p-3 rounded-xl flex items-center gap-2 border border-psycho-urgency/20"><i data-lucide="alert-circle" size="16"></i> ${m}</div>`; if(window.lucide) window.lucide.createIcons(); }
        function safeVal(el) { return (el && el.value) ? el.value.trim() : ''; }

        function createSliderHTML(label) {
            return `<div class="relative w-full h-14 mt-6 mb-2 select-none"><div class="absolute inset-0 bg-slate-100 rounded-full flex items-center justify-center pointer-events-none transition-colors duration-300" id="slider-track"><span class="text-slate-400 font-extrabold text-sm tracking-widest uppercase opacity-80 animate-pulse transition-all duration-200" id="slider-label">${label}</span><div class="absolute inset-0 bg-gradient-to-r from-transparent via-psycho-actionLight to-transparent animate-slide-shimmer" style="background-size: 200% 100%;"></div></div><input type="range" min="0" max="100" value="0" class="slider-lock absolute inset-0 w-full h-full z-10 opacity-0 cursor-pointer" id="unlock-slider"></div><div class="error-container"></div>`;
        }

        function getPricingRoadmapHTML(p, count = 1, isHome = false) {
            const tier1Class = getTierColor(count, 1);
            const tier2Class = getTierColor(count, 2);
            const tier5Class = getTierColor(count, 5, isHome); 

            const boxBase = "px-2.5 py-1.5 rounded-xl border shadow-sm min-w-[3.5rem] mb-3 flex items-center justify-center transition-transform bg-white relative z-10 tier-box";
            const dotBase = `w-3 h-3 rounded-full border-2 border-white relative z-10`;

            const mandiSavings = p.mandiPrice ? p.mandiPrice - p.price5 : 0;
            
            const savingsHtml = p.mandiPrice ? `
                <div class="mt-4 flex justify-center w-full">
                    <div class="bg-slate-100/90 backdrop-blur-sm px-3 py-1 rounded-full text-[9px] font-medium text-slate-500 flex items-center gap-2 border border-slate-200/50 shadow-sm">
                        <span>Duvva Shops: <span class="line-through decoration-psycho-urgency text-psycho-urgency">â‚¹${p.mandiPrice}</span></span>
                        <span class="w-1 h-1 bg-slate-300 rounded-full"></span>
                        <span class="text-psycho-action font-bold bg-green-50 px-1 rounded">Save â‚¹${mandiSavings}</span>
                    </div>
                </div>
            ` : '';

            const boxCommon = "px-2.5 py-1.5 rounded-xl border shadow-sm min-w-[3.5rem] flex items-center justify-center transition-transform bg-white";

            return `
                <div class="w-full py-4 px-2 select-none relative mb-2">
                    <!-- Row 1: Boxes -->
                    <div class="flex justify-between items-end mb-2 relative z-10">
                        <div class="flex justify-center w-1/3">
                            <div class="${boxBase} ${tier1Class} tier-1"><div class="text-sm font-bold">â‚¹${p.price1}</div></div>
                        </div>
                        <div class="flex justify-center w-1/3">
                            <div class="${boxBase} ${tier2Class} scale-105 tier-2"><div class="text-base font-black">â‚¹${p.price2}</div></div>
                        </div>
                        <div class="flex justify-center w-1/3">
                            <div class="${boxBase} ${tier5Class} scale-110 origin-bottom tier-5"><div class="text-3xl font-black">â‚¹${p.price5}</div></div>
                        </div>
                    </div>

                    <!-- Row 2: Line & Dots (Perfectly Aligned) -->
                    <div class="relative h-3 w-full mb-2">
                         <!-- Line anchored to center of dots (6px down) -->
                         <div class="absolute top-1.5 left-[16.66%] right-[16.66%] h-1 bg-slate-200 -translate-y-1/2 z-0 rounded-full"></div>
                         
                         <!-- Dots centered in 1/3 columns -->
                         <div class="flex justify-between items-center h-full relative z-10">
                            <div class="w-1/3 flex justify-center"><div class="${dotBase} bg-slate-300"></div></div>
                            <div class="w-1/3 flex justify-center"><div class="${dotBase} bg-psycho-action ring-2 ring-green-100 ring-opacity-50"></div></div>
                            <div class="w-1/3 flex justify-center"><div class="${dotBase} bg-psycho-reward"></div></div>
                         </div>
                    </div>

                    <!-- Row 3: Labels -->
                    <div class="flex justify-between items-start text-center">
                        <div class="w-1/3 flex justify-center"><div class="text-[9px] font-bold uppercase text-slate-400 tracking-wide">1 Person</div></div>
                        <div class="w-1/3 flex justify-center"><div class="text-[9px] font-bold uppercase text-psycho-action tracking-wide">2 People</div></div>
                        <div class="w-1/3 flex justify-center"><div class="text-[9px] font-bold uppercase text-psycho-reward tracking-wide">5 People</div></div>
                    </div>

                    ${savingsHtml}
                </div>
            `;
        }

        function getPriceBreakdownHTML(p) {
            const savings = p.mandiPrice ? p.mandiPrice - p.price5 : 0;
            return `
                <div class="bg-slate-50 rounded-xl border border-slate-200 mb-4 overflow-hidden transition-all">
                    <div class="p-3 flex justify-between items-center cursor-pointer active:bg-slate-100 transition-colors" onclick="this.nextElementSibling.classList.toggle('hidden'); this.querySelector('.chevron').classList.toggle('rotate-180')">
                        <div class="flex items-center gap-1.5">
                            <span class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Today's Savings</span>
                            <div class="chevron transition-transform duration-300 text-slate-400"><i data-lucide="chevron-down" size="14"></i></div>
                        </div>
                        <span class="text-[10px] text-psycho-action font-black bg-psycho-actionBg px-2 py-0.5 rounded border border-psycho-action/20 animate-pulse">YOU SAVE â‚¹${savings}/${p.weightUnit}</span>
                    </div>
                    
                    <div class="hidden px-3 pb-3 space-y-3 border-t border-slate-100 bg-white/50 pt-3">
                        <div class="flex justify-between items-center opacity-60 grayscale">
                            <span class="text-xs font-bold text-slate-500">Duvva Shops Price</span>
                            <span class="text-sm font-black text-psycho-urgency line-through decoration-2 decoration-red-500/50">â‚¹${p.mandiPrice}</span>
                        </div>
                        <div class="flex justify-between items-center bg-white p-2 rounded-lg border border-slate-100 shadow-sm">
                            <div class="flex items-center gap-2">
                                <span class="text-sm font-bold text-slate-700">Farmer (${p.farmer})</span>
                                <i data-lucide="check-circle" size="14" class="text-psycho-trust fill-blue-100"></i>
                            </div>
                            <span class="text-base font-black text-slate-600">â‚¹${p.farmerPrice}</span>
                        </div>
                        <div class="flex justify-between items-center px-2">
                            <span class="text-xs font-medium text-slate-400">Logistics & Packaging</span>
                            <span class="text-xs font-bold text-slate-400">â‚¹${p.price5 - p.farmerPrice}</span>
                        </div>
                        <div class="h-px bg-slate-200 w-full my-1"></div>
                        <div class="flex justify-between items-center px-2">
                            <span class="text-sm font-black text-slate-900 uppercase">Your Squad Price</span>
                            <div class="flex items-center gap-2">
                                <span class="text-xl font-black text-psycho-reward">â‚¹${p.price5}</span>
                                <span class="text-[10px] font-bold text-slate-400">/${p.unit}</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex items-center gap-2 mb-6 px-2 bg-psycho-trustBg p-2 rounded-lg border border-blue-100">
                    <div class="flex -space-x-2">
                        <div class="w-6 h-6 rounded-full bg-slate-200 border-2 border-white"></div>
                        <div class="w-6 h-6 rounded-full bg-slate-300 border-2 border-white"></div>
                    </div>
                    <span class="text-[10px] text-psycho-trust font-bold">Verified by 124 neighbors today</span>
                </div>
            `;
        }

        function setupQuantityLogic(node, p, labelId) {
            let qty = 1;
            const membersCount = state.members[state.currentGroupId]?.length || 1;
            
            const updateDisplay = () => {
                const totalWeight = qty * p.baseWeight;
                const formattedWeight = parseFloat(totalWeight.toFixed(2)); 
                const qtyDisplay = node.querySelector('#qty-display');
                if (qtyDisplay) qtyDisplay.innerText = `${formattedWeight} ${p.weightUnit}`;
                if(labelId) {
                    const el = node.querySelector(labelId);
                    if (el) {
                        const totalSavings = (p.price1 - p.price5) * qty;
                        const totalPrice = p.price5 * qty;
                        el.innerHTML = `Unlock â‚¹${totalPrice} (Save â‚¹${totalSavings})`;
                    }
                }
                
                const roadmapBoxes = node.querySelectorAll(".tier-box");
                roadmapBoxes.forEach(box => {
                    const tier = box.classList.contains("tier-1") ? 1 :
                                   box.classList.contains("tier-2") ? 2 : 5;

                    let baseClass = "px-2.5 py-1.5 rounded-xl border shadow-sm min-w-[3.5rem] mb-3 flex items-center justify-center transition-transform relative z-10 tier-box tier-" + tier;
                    if(tier === 5) baseClass += " scale-110 origin-bottom";
                    else if (tier === 2) baseClass += " scale-105";
                    
                    box.className = baseClass + " " + getTierColor(membersCount, tier);
                    
                    const priceDiv = box.querySelector('div');
                    if(priceDiv) {
                         if(tier === 1) priceDiv.innerText = 'â‚¹' + (p.price1 * qty);
                         if(tier === 2) priceDiv.innerText = 'â‚¹' + (p.price2 * qty);
                         if(tier === 5) priceDiv.innerText = 'â‚¹' + (p.price5 * qty);
                    }
                });
            };
            const btnMinus = node.querySelector('#btn-minus');
            if (btnMinus) btnMinus.onclick = () => { if (qty > 1) { qty--; updateDisplay(); } };
            const btnPlus = node.querySelector('#btn-plus');
            if (btnPlus) btnPlus.onclick = () => { if (qty < 20) { qty++; updateDisplay(); } };
            updateDisplay();
            return () => qty;
        }

        function render() { const app = document.getElementById('app'); if (state.view === 'home') renderHome(app); else renderGroup(app); if (window.lucide) window.lucide.createIcons(); }

        function renderHome(el) {
            if (state.timerInterval) clearInterval(state.timerInterval);
            if (state.hesitationInterval) clearInterval(state.hesitationInterval);
            if (state.dependencyInterval) clearInterval(state.dependencyInterval);
            if (state.painLoopInterval) clearInterval(state.painLoopInterval);
            if (state.mandiModalInterval) clearInterval(state.mandiModalInterval);
            if (state.mandiGroupInterval) clearInterval(state.mandiGroupInterval);
            if (state.scrollObserver) state.scrollObserver.disconnect();
            
            const user = state.user;
            const userActiveGroupIds = {}; 
            const activeUserGroups = [];
            if (user.name && user.phone) { 
                Object.values(state.groups).forEach(g => { 
                    const members = state.members[g.id] || []; 
                    if (members.some(m => m.name === user.name && m.phone === user.phone)) { 
                        userActiveGroupIds[g.productId] = g.id; 
                        activeUserGroups.push(g);
                    } 
                }); 
            }
            activeUserGroups.sort((a, b) => b.createdAt - a.createdAt);

            let headerTargetTime, headerLabel; 
            if (activeUserGroups.length > 0) { 
                const soonest = [...activeUserGroups].sort((a,b) => a.expiresAt - b.expiresAt)[0];
                headerTargetTime = soonest.expiresAt; 
                headerLabel = "Offer Ends In"; 
            } else { 
                const midnight = new Date(); midnight.setHours(24, 0, 0, 0); headerTargetTime = midnight.getTime(); headerLabel = "Market Closes"; 
            }
            const sortedProducts = [...PRODUCTS].sort((a, b) => { const aActive = !!userActiveGroupIds[a.id]; const bActive = !!userActiveGroupIds[b.id]; if (aActive && !bActive) return 1; if (!aActive && bActive) return -1; return 0; });
            
            const featuredMandiPrice = PRODUCTS[0].mandiPrice || 32;
            const featuredSquadPrice = PRODUCTS[0].price5 || 18;

            let heroContent = '';
            if (activeUserGroups.length > 0) {
                const cardsHtml = activeUserGroups.map(g => {
                    const p = PRODUCTS.find(x => x.id === g.productId);
                    if (!p) return '';
                    const members = state.members[g.id] || [];
                    const count = members.length;
                    const needed = Math.max(0, 5 - count);
                    const progress = (count / 5) * 100;
                    
                    return `
                    <div onclick="openGroup('${g.id}')" class="snap-center shrink-0 w-[85%] max-w-[300px] cursor-pointer animate-in fade-in zoom-in duration-300">
                        <div class="bg-slate-900 rounded-2xl p-4 shadow-xl shadow-slate-900/20 border border-slate-800 relative overflow-hidden group h-full flex flex-col justify-between">
                            <!-- Background Glow -->
                            <div class="absolute -right-10 -top-10 w-40 h-40 bg-psycho-action/20 rounded-full blur-3xl"></div>
                            
                            <div class="flex justify-between items-start mb-3 relative z-10">
                                <div class="flex items-center gap-2">
                                    <span class="relative flex h-2.5 w-2.5">
                                      <!-- SLOW PING FIX -->
                                      <span class="absolute inline-flex h-full w-full rounded-full bg-psycho-urgency opacity-75 animate-ping-slow"></span>
                                      <span class="relative inline-flex rounded-full h-2.5 w-2.5 bg-psycho-urgency"></span>
                                    </span>
                                    <span class="text-[10px] font-black text-white tracking-widest uppercase">Live Gang</span>
                                </div>
                                <div class="bg-white/10 backdrop-blur px-2 py-1 rounded text-[10px] font-mono font-bold text-white/90 border border-white/10 live-timer-home" data-expires="${g.expiresAt}">...</div>
                            </div>

                            <div class="flex items-center gap-3 mb-3 relative z-10">
                                <div class="w-12 h-12 bg-white rounded-xl flex items-center justify-center text-slate-900 shadow-sm shrink-0">
                                    <i data-lucide="${p.icon}" size="24"></i>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <h3 class="font-black text-white text-base leading-none mb-1 truncate">${p.name}</h3>
                                    <div class="flex items-center gap-1.5 text-[10px]">
                                        <span class="text-white font-bold">${count}/5</span>
                                        <span class="text-slate-500">â€¢</span>
                                        ${needed > 0 ? `<span class="text-psycho-rewardLight font-bold">Need ${needed}</span>` : `<span class="text-psycho-actionLight font-bold">Unlocked</span>`}
                                    </div>
                                </div>
                            </div>

                            <div class="relative h-1.5 bg-slate-800 rounded-full overflow-hidden">
                                <div class="absolute inset-y-0 left-0 bg-gradient-to-r from-psycho-action to-psycho-actionLight transition-all duration-1000" style="width: ${progress}%"></div>
                            </div>
                        </div>
                    </div>`;
                }).join('');

                heroContent = `<div class="flex overflow-x-auto snap-x snap-mandatory no-scrollbar px-4 gap-3 mt-4 mb-2 pb-2">${cardsHtml}</div>`;
            } else {
                heroContent = `
                <div onclick="openLiveGuide()" class="px-4 mt-4 mb-2 cursor-pointer">
                    <div class="relative w-full h-48 bg-slate-900 rounded-2xl overflow-hidden shadow-lg border border-slate-200 group">
                        <video src="${GUIDE_VIDEO_SRC}" autoplay loop muted playsinline class="w-full h-full object-cover opacity-80 group-hover:scale-105 transition-transform duration-700"></video>
                        <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none z-10">
                            <div class="bg-white/20 backdrop-blur-md text-white px-5 py-3 rounded-full font-black text-sm border border-white/30 flex items-center gap-2 shadow-xl transform group-hover:scale-110 transition-transform">
                                <div class="bg-white text-slate-900 rounded-full p-1"><i data-lucide="play" size="14" fill="currentColor"></i></div>
                                How to Order?
                            </div>
                        </div>
                        <div class="absolute inset-0 bg-gradient-to-t from-slate-900/80 via-transparent to-transparent pointer-events-none"></div>
                        <div class="absolute bottom-4 left-4 right-4 text-center">
                            <div class="text-white font-bold text-sm mb-0.5">Watch 30s Guide</div>
                            <div class="text-slate-200 text-[10px] font-medium uppercase tracking-widest">Learn to Save 60%</div>
                        </div>
                    </div>
                </div>`;
            }

            setTimeout(() => {
                const ts = document.getElementById('trust-strip');
                // REMOVED PULSE ANIMATION HERE
                // if(ts) ts.classList.add('pulse-attention'); 
            }, 1000);

            el.innerHTML = `
                <div class="fade-in pb-32">
                    <div class="glass-header text-white p-5 sticky top-0 z-40 border-b border-white/10 shadow-xl shadow-slate-900/20">
                        <div class="flex justify-between items-center mb-4">
                            <div>
                                <h1 class="font-black text-3xl tracking-tighter">JODO</h1>
                                ${
                                    habitState.streakDays >= 3
                                    ? `<div class="text-[11px] text-psycho-actionLight font-bold opacity-90">
                                           Youâ€™ve ordered <span class="underline decoration-psycho-actionLight">${habitState.streakDays} days</span> in a row.
                                       </div>`
                                    : habitState.totalOrders >= 3
                                    ? `<div class="text-[11px] text-psycho-actionLight font-bold opacity-90">
                                           You saved with squads ${habitState.totalOrders} times.
                                       </div>`
                                    : `<div class="text-[11px] text-white font-bold tracking-widest uppercase opacity-90">
                                           Group Up. Price Down.
                                       </div>`
                                }
                            </div>
                            <button onclick="openFullFeed('${PRODUCTS[0].id}', true)" class="group relative overflow-hidden bg-slate-900/30 backdrop-blur-md border border-white/10 rounded-full pr-4 pl-1.5 py-1.5 flex items-center gap-2.5 shadow-xl active:scale-95 transition-all cursor-pointer hover:bg-slate-800/50 hover:border-white/20">
                                <div class="absolute inset-0 bg-gradient-to-r from-slate-900/30 to-slate-800/30 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                                <div class="relative w-7 h-7 bg-gradient-to-br from-slate-700 via-slate-600 to-slate-500 rounded-full flex items-center justify-center shadow-lg group-hover:scale-110 transition-transform duration-300 ring-2 ring-black/20">
                                    <i data-lucide="play" size="10" class="fill-white text-white ml-0.5"></i>
                                </div>
                                <span class="relative text-[10px] font-black tracking-widest text-white/90 group-hover:text-white">Duvva Market Live</span>
                            </button>
                        </div>
                        <div class="flex items-center justify-between gap-3 text-xs font-semibold text-white/70 bg-black/20 p-2.5 rounded-xl border border-white/10 backdrop-blur-sm transition-colors duration-300" id="home-header-timer-container">
                            <div class="flex items-center gap-2 opacity-80"><i data-lucide="clock" size="14" class="animate-pulse"></i><span class="uppercase text-[10px] font-bold tracking-wider">${headerLabel}</span></div>
                            <div class="font-mono font-bold tracking-widest text-white text-sm tabular-nums" id="appbar-header-timer" data-expires="${headerTargetTime}">Loading...</div>
                        </div>
                    </div>
                    
                    <!-- ðŸŸ¢ TRIGGER 1 & 17: TRUST STRIP + WARD LEADERBOARD -->
                    <div class="px-4 mt-3 mb-1">
                        <!-- BLUE: Trust Strip. Safe Information -->
                        <div id="trust-strip" class="bg-psycho-trustBg border border-psycho-trust/20 rounded-xl py-2 px-3 flex justify-between items-center shadow-sm relative overflow-hidden transition-all duration-300">
                            <div class="flex flex-col relative z-10">
                                <span class="text-[9px] font-bold text-slate-500 uppercase tracking-wider flex items-center gap-1">Duvva Shops Today <span class="text-[8px] text-slate-300 font-normal">5:02 AM</span></span>
                                <span class="text-xs font-black text-psycho-urgency line-through decoration-psycho-urgency/50">â‚¹${featuredMandiPrice}/kg</span>
                            </div>
                            
                            <div class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2">
                                <i data-lucide="arrow-right" size="14" class="text-psycho-trust/50"></i>
                            </div>

                            <div class="flex flex-col items-end relative z-10">
                                <span class="text-[9px] font-bold text-psycho-trust uppercase tracking-wider flex items-center gap-1">
                                    Your Squad Price <i data-lucide="shield-check" size="10" class="text-psycho-trust"></i>
                                </span>
                                <span class="text-sm font-black text-psycho-action">â‚¹${featuredSquadPrice}/kg</span>
                            </div>
                        </div>
                        
                        <!-- WARD COMPETITION -->
                        <div class="mt-2 flex items-center justify-between text-[10px] font-bold text-slate-500 bg-white border border-slate-100 px-3 py-1.5 rounded-lg shadow-sm">
                            <div class="flex items-center gap-1.5">
                                <span class="w-1.5 h-1.5 bg-psycho-action rounded-full"></span>
                                <span>Ward 7: <span class="text-slate-800">45 orders</span></span>
                            </div>
                            <!-- RED text only for "Catch Up" urgency -->
                            <div class="text-psycho-urgency flex items-center gap-1">
                                Your Ward: 12 orders <span class="bg-psycho-urgencyBg px-1 rounded text-[9px] uppercase">Catch Up</span>
                            </div>
                        </div>
                    </div>

                    ${heroContent}

                    <div class="px-4 space-y-4 mt-4"><h2 class="text-xs font-bold text-slate-400 uppercase tracking-widest ml-1">Today's Rate</h2>${sortedProducts.map(p => {
                        const activeGid = userActiveGroupIds[p.id]; const activeGroup = activeGid ? state.groups[activeGid] : null;
                        let buttonHtml, timerHtml = ''; 
                        if (activeGid && activeGroup) {
                            timerHtml = `<div class="flex items-center gap-1.5 bg-psycho-urgencyBg text-psycho-urgency px-2 py-1 rounded-md border border-psycho-urgency/20 shadow-sm ml-auto mb-2"><div class="w-1.5 h-1.5 bg-psycho-urgency rounded-full animate-pulse"></div><span class="text-[10px] font-mono font-bold live-timer-home" data-expires="${activeGroup.expiresAt}">...</span></div>`;
                            buttonHtml = `<button onclick="openGroup('${activeGid}')" class="w-full bg-slate-800 text-white py-3 rounded-xl font-bold text-sm shadow-xl flex items-center justify-center gap-2 border border-slate-700 mt-3 cursor-pointer"><span>View Your Squad</span><i data-lucide="arrow-right" size="16"></i></button>`;
                        } else {
                            // GREEN: Start Squad (Action)
                            buttonHtml = `<button onclick="openStartModal('${p.id}')" class="w-full bg-psycho-action text-white py-3.5 rounded-xl font-bold text-sm shadow-lg flex items-center justify-center gap-2 tap-effect transition-all active:scale-95 cursor-pointer"><span>Buy Together</span><span class="bg-black/20 text-[10px] px-1.5 py-0.5 rounded border border-white/10 font-medium ml-1">Save â‚¹${p.price1 - p.price5}</span></button>`;
                        }
                        
                        let backgroundContent = p.videoSrc ? `<div class="w-28 h-40 rounded-xl flex items-center justify-center shrink-0 shadow-inner relative overflow-hidden border border-black/5"><video src="${p.videoSrc}" autoplay loop muted playsinline class="absolute inset-0 w-full h-full object-cover opacity-90"></video><div class="absolute top-0 left-0 bg-black/60 backdrop-blur-md text-white text-[8px] font-bold px-1.5 py-0.5 rounded-br-lg border-b border-r border-white/10 z-20 shadow-sm">${p.farmer}</div><div class="absolute bottom-1 right-1 bg-black/50 text-white text-[8px] px-1.5 rounded flex items-center gap-1 z-10"><i data-lucide="play" size="8"></i> Live</div></div>` : `<div class="w-28 h-40 ${p.videoClass} video-grain rounded-xl flex items-center justify-center shrink-0 shadow-inner relative overflow-hidden border border-black/5"><div class="absolute top-0 left-0 bg-black/60 backdrop-blur-md text-white text-[10px] font-bold px-2 py-1 rounded-br-lg border-b border-r border-white/10 z-20 shadow-sm">â‚¹${p.price5}</div><i data-lucide="${p.icon}" size="32" class="text-white/80 z-10 relative group-hover/img:scale-110 transition-transform"></i></div>`;

                        return `
                        <div class="card-modern relative overflow-hidden group">
                            <!-- GOLD: Best Price Badge -->
                            <div class="absolute top-0 right-0 bg-psycho-rewardLight text-white text-[10px] font-black px-2.5 py-1 rounded-bl-xl shadow-md z-10">SAVE â‚¹${p.price1 - p.price5}</div>
                            <div class="p-3.5">
                                <div class="flex gap-3 mb-3 cursor-pointer group/img" onclick="openFullFeed('${p.id}')">
                                    ${backgroundContent}
                                    <div class="flex-1 py-0.5">
                                        <h3 class="font-black text-xl text-slate-800 leading-tight mb-1">${p.name}</h3>
                                        <div class="text-xs font-semibold text-slate-500 bg-slate-100 px-2 py-0.5 rounded-md inline-block mb-1">${p.unit}</div>
                                        <div class="text-xs text-slate-400 font-medium">${p.nameTe}</div>
                                        <!-- BLUE: Trust / Guarantee -->
                                        <div class="flex items-center gap-1 text-[10px] font-bold text-psycho-trust bg-psycho-trustBg px-2 py-1 rounded mt-2 w-fit border border-psycho-trust/20"><i data-lucide="truck" size="12"></i> Get by Tomorrow, 9 AM</div>
                                    </div>
                                </div>
                                <div class="bg-white rounded-xl border border-slate-200 p-4 shadow-sm relative overflow-hidden">${timerHtml}${getPricingRoadmapHTML(p, 1)}${buttonHtml}</div>
                            </div>
                        </div>`;
                    }).join('')}</div></div>`;

            // MANDI PRICE FLASH LOGIC
            const mandiPriceEl = document.querySelector('#trust-strip .line-through');
            const squadPriceEl = document.querySelector('#trust-strip .text-psycho-action');
            if (mandiPriceEl && squadPriceEl) {
                const p = PRODUCTS[0];
                mandiPriceEl.innerText = `â‚¹${p.mandiPrice}/kg`;
                squadPriceEl.innerText = `â‚¹${p.price5}/kg`;
                
                if (state.lastMandiUpdate.id === p.id) {
                    if (state.lastMandiUpdate.dir === 'up') mandiPriceEl.classList.add('animate-flash-red');
                    if (state.lastMandiUpdate.dir === 'down') mandiPriceEl.classList.add('animate-flash-green');
                }
            }

            const updateHomeTimers = () => {
                const now = Date.now();
                const formatTime = (diff) => { if (diff <= 0) return "00h 00m 00s 00"; const h = Math.floor(diff / 3600000); const m = Math.floor((diff % 3600000) / 60000); const s = Math.floor((diff % 60000) / 1000); const ms = Math.floor((diff % 1000) / 10); return `${h}h ${m < 10 ? '0'+m : m}m ${s < 10 ? '0'+s : s}s ${ms < 10 ? '0'+ms : ms}`; };
                const headerTimer = document.getElementById('appbar-header-timer'); const headerContainer = document.getElementById('home-header-timer-container');
                if (headerTimer) { const expires = parseInt(headerTimer.dataset.expires); const diff = expires - now; headerTimer.innerText = formatTime(diff); if (diff <= 0) { headerContainer.classList.remove('bg-black/20', 'border-white/10'); headerContainer.classList.add('bg-psycho-urgency', 'border-psycho-urgency', 'animate-pulse'); } else { headerContainer.classList.add('bg-black/20', 'border-white/10'); headerContainer.classList.remove('bg-psycho-urgency', 'border-psycho-urgency', 'animate-pulse'); } }
                document.querySelectorAll('.live-timer-home').forEach(el => { const expires = parseInt(el.dataset.expires); const diff = expires - now; el.innerText = formatTime(diff); if (diff <= 0) el.classList.add('text-psycho-urgency'); });
            };
            updateHomeTimers(); state.timerInterval = setInterval(updateHomeTimers, 50);
            startTicker();
            initBehaviorEngine();
        }

        // --- RESTORED FUNCTIONS ---
        function goHome() { 
            if (state.timerInterval) clearInterval(state.timerInterval);
            if (state.hesitationInterval) clearInterval(state.hesitationInterval);
            if (state.dependencyInterval) clearInterval(state.dependencyInterval);
            if (state.painLoopInterval) clearInterval(state.painLoopInterval);
            if (state.mandiModalInterval) clearInterval(state.mandiModalInterval);
            if (state.mandiGroupInterval) clearInterval(state.mandiGroupInterval);
            if (state.scrollObserver) state.scrollObserver.disconnect();
            
            try { if (window.location.protocol !== 'blob:') history.pushState({}, '', location.pathname); } catch(e) {} 
            state.view = 'home'; state.currentGroupId = null; render(); 
            startTicker(); 
        }

        function openGroup(gid) { 
            try { if (window.location.protocol !== 'blob:') history.pushState({}, '', `?group=${gid}`); } catch(e) {} 
            state.currentGroupId = gid; state.view = 'group'; render(); 
        }

        function openLiveGuide() {
            const videoSrc = GUIDE_VIDEO_SRC;
            const node = createNodeFromHTML(`
                <div id="live-guide-overlay" class="fixed inset-0 z-[80] flex justify-center items-center bg-slate-900/95 backdrop-blur-sm animate-in fade-in duration-200">
                    <button id="close-guide" class="absolute top-6 right-6 z-[90] p-2 bg-white/10 backdrop-blur-md rounded-full text-white border border-white/10 hover:bg-white/20 transition-colors cursor-pointer tap-effect"><i data-lucide="x" size="24"></i></button>
                    <div class="w-full max-w-md h-full relative flex flex-col justify-center">
                        <div class="aspect-[9/16] w-full bg-black relative rounded-2xl overflow-hidden shadow-2xl border border-white/10">
                            <video src="${videoSrc}" autoplay loop playsinline controls class="w-full h-full object-cover"></video>
                            <div class="absolute top-4 left-4 bg-psycho-urgency text-white text-xs font-bold px-3 py-1 rounded-full shadow-lg z-20">ðŸ”´ LIVE GUIDE</div>
                        </div>
                    </div>
                </div>
            `);
            node.querySelector('#close-guide').onclick = () => node.remove();
            document.body.appendChild(node);
            lucide.createIcons();
        }

        window.goHome = goHome;
        window.openGroup = openGroup;
        window.openLiveGuide = openLiveGuide;

        window.openFullFeed = function(startPid, forceOpen = false) {
            if (!forceOpen) {
                const activeGid = getActiveGroupId(startPid);
                if (activeGid) { window.openGroup(activeGid); return; }
            }
            const slidesHtml = PRODUCTS.map(p => {
                let backgroundContent = p.videoSrc ? `<div class="absolute inset-0 w-full h-full bg-black rounded-2xl overflow-hidden"><video src="${p.videoSrc}" autoplay loop playsinline controls class="w-full h-full object-cover"></video></div>` : `<div class="absolute inset-0 z-0 ${p.videoClass} video-grain hidden"></div>`;
                const slideActiveGid = getActiveGroupId(p.id);
                let buttonHtml = slideActiveGid ? `<button onclick="openGroup('${slideActiveGid}')" class="w-full bg-white/10 backdrop-blur-md border border-white/20 text-white py-3 rounded-xl font-bold text-sm shadow-lg flex items-center justify-center gap-2 tap-effect cursor-pointer"><span>Check My Group</span><i data-lucide="arrow-right" size="16"></i></button>` : `<button onclick="openStartModal('${p.id}')" class="w-full bg-psycho-action text-white py-3.5 rounded-xl font-bold text-sm shadow-lg flex items-center justify-center gap-2 tap-effect transition-all active:scale-95 cursor-pointer"><span>Buy Together</span><span class="bg-black/20 text-[10px] px-1.5 py-0.5 rounded border border-white/10 font-medium ml-1">Save â‚¹${p.price1 - p.price5}</span></button>`;
                return `<div id="slide-${p.id}" class="snap-center shrink-0 relative w-full h-full bg-black overflow-hidden flex flex-col"><div class="absolute inset-0 z-0">${backgroundContent}<div class="absolute inset-0 bg-gradient-to-t from-black/90 via-black/40 to-transparent z-10 pointer-events-none"></div></div><div class="absolute top-6 left-4 right-4 z-40 flex justify-between items-start"><div class="bg-psycho-urgency/90 backdrop-blur text-white text-[10px] font-bold px-2.5 py-1 rounded-full flex items-center gap-1.5 shadow-sm"><span class="w-1.5 h-1.5 bg-white rounded-full animate-pulse"></span> LIVE DEAL</div><div class="bg-black/30 backdrop-blur-md text-white text-[10px] font-medium px-2 py-1 rounded-full border border-white/10 flex items-center gap-1"><i data-lucide="eye" size="10"></i> ${p.liveViewers}</div></div><div class="absolute bottom-0 left-0 right-0 p-4 pb-6 z-30 flex flex-col gap-3"><div class="text-white drop-shadow-md flex flex-col gap-1"><div class="flex items-center gap-2"><div class="bg-white/20 backdrop-blur px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider">@${p.farmer}</div></div><h3 class="font-black text-xl leading-tight">${p.name}</h3><div class="text-slate-200 text-xs font-medium opacity-90 truncate">${p.unit} Bundle â€¢ ${p.nameTe}</div></div>${getPricingRoadmapHTML(p, 1)}${buttonHtml}</div></div>`;
            }).join('');
            const node = createNodeFromHTML(`<div id="full-feed-overlay" class="fixed inset-0 z-[70] flex justify-center items-center bg-slate-900/90 backdrop-blur-sm animate-in fade-in duration-200"><button id="close-feed" class="absolute top-6 right-6 z-[80] p-2 bg-white/10 backdrop-blur-md rounded-full text-white border border-white/10 hover:bg-white/20 transition-colors cursor-pointer tap-effect"><i data-lucide="x" size="24"></i></button><div class="w-full max-w-md h-full bg-black relative shadow-2xl overflow-hidden"><div class="h-full overflow-y-scroll snap-y snap-mandatory no-scrollbar bg-black scroll-container">${slidesHtml}</div></div></div>`);
            node.querySelector('#close-feed').onclick = () => node.remove();
            
            setTimeout(() => {
                const scrollContainer = node.querySelector('.scroll-container');
                const observer = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        const video = entry.target.querySelector('video');
                        if (video) {
                            if (entry.isIntersecting) {
                                const playPromise = video.play();
                                if (playPromise !== undefined) { playPromise.catch(error => {}); }
                            } else {
                                video.pause();
                                video.currentTime = 0;
                            }
                        }
                    });
                }, { root: scrollContainer, threshold: 0.7 });
                const slides = node.querySelectorAll('[id^="slide-"]');
                slides.forEach(slide => observer.observe(slide));
            }, 100);

            document.body.appendChild(node);
            lucide.createIcons();
            const target = document.getElementById(`slide-${startPid}`);
            if (target) target.scrollIntoView({ behavior: 'auto' });
        }

        window.openStartModal = function(pid) {
            const fullFeed = document.getElementById('full-feed-overlay'); if(fullFeed) fullFeed.remove();
            const p = PRODUCTS.find(x => x.id === pid);
            const user = state.user;
            const savings = p.price1 - p.price5;
            
            const node = createNodeFromHTML(`
                <div class="flex flex-col h-full transition-all duration-300" id="modal-container-inner">
                    <div class="sticky -top-8 -mt-8 pt-8 pb-4 -mx-6 px-6 bg-white/95 backdrop-blur-md z-50 flex items-center justify-between mb-4 border-b border-slate-100">
                        <div class="flex items-center gap-2">
                            <button id="back-btn-modal" class="text-slate-400 hover:text-slate-600 transition-colors p-1 -ml-1 rounded-full hover:bg-slate-100 active:scale-95"><i data-lucide="arrow-left" size="24"></i></button>
                            <h3 class="font-black text-xl text-slate-800 tracking-tight">Start Group Buy</h3>
                        </div>
                        <button id="close-modal" class="p-2 bg-slate-100 rounded-full text-slate-500 hover:bg-slate-200 cursor-pointer transition-colors active:scale-95"><i data-lucide="x" size="20"></i></button>
                    </div>
                    
                    <div class="flex items-start gap-4 mb-4">
                        <div class="w-16 h-16 ${p.imageColor} rounded-2xl flex items-center justify-center shrink-0 text-white shadow-md relative overflow-hidden">
                            <div class="absolute bottom-0 left-0 w-full h-1/3 bg-black/40 backdrop-blur-sm flex items-center justify-center text-[8px] font-bold text-white z-10">${p.farmer}</div>
                            <i data-lucide="${p.icon}" size="32"></i>
                        </div>
                        <div class="flex-1">
                            <h4 class="font-black text-xl text-slate-900 leading-tight mb-1">${p.name}</h4>
                            
                            <div class="flex flex-wrap gap-1.5 mt-1">
                                <span class="bg-psycho-alertBg text-psycho-alert px-1.5 py-0.5 rounded text-[9px] font-bold border border-orange-100 flex items-center gap-1 animate-pulse"><i data-lucide="flame" size="8"></i> Only ${p.remainingStock}kg left</span>
                            </div>
                        </div>
                    </div>
                    
                    ${getPricingRoadmapHTML(p, 1)}

                    <div class="flex items-center justify-between bg-slate-50 p-3 rounded-xl border border-slate-100 mb-4 mt-2">
                        <div class="ml-1">
                            <div class="text-xs font-bold text-slate-500 uppercase">Total Weight</div>
                            <div class="text-[10px] text-slate-400 font-medium">Increments of ${p.unit}</div>
                        </div>
                        <div class="flex items-center gap-3">
                            <button id="btn-minus" class="w-12 h-12 rounded-xl bg-white border border-slate-200 flex items-center justify-center shadow-sm active:scale-95 transition-transform cursor-pointer">
                                <i data-lucide="minus" size="20"></i>
                            </button>
                            <span id="qty-display" class="font-black text-xl w-20 text-center text-slate-800 tabular-nums">0.5 kg</span>
                            <button id="btn-plus" class="w-12 h-12 rounded-xl bg-white border border-slate-200 flex items-center justify-center shadow-sm active:scale-95 transition-transform cursor-pointer">
                                <i data-lucide="plus" size="20"></i>
                            </button>
                        </div>
                    </div>

                    ${getPriceBreakdownHTML(p)}
                    
                    <div class="space-y-4 mb-2">
                        <div class="relative"><div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400"><i data-lucide="user" size="16"></i></div><input id="inp-name" value="${user.name}" class="w-full bg-white border border-slate-300 py-3.5 pl-10 pr-4 rounded-xl font-bold text-slate-900 focus:outline-none focus:ring-2 focus:ring-psycho-action transition-all placeholder-slate-300 text-sm" placeholder="Your Name"></div>
                        <div class="relative"><div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400"><i data-lucide="phone" size="16"></i></div><input id="inp-phone" value="${user.phone}" type="tel" class="w-full bg-white border border-slate-300 py-3.5 pl-10 pr-4 rounded-xl font-bold text-slate-900 focus:outline-none focus:ring-2 focus:ring-psycho-action transition-all placeholder-slate-300 text-sm" placeholder="Phone Number"></div>
                    </div>

                    <div class="mt-auto relative">
                        <button id="confirm-btn" class="w-full bg-psycho-action text-white py-4 rounded-2xl font-black text-lg shadow-lg shadow-green-600/30 btn-press flex items-center justify-center gap-2 cursor-pointer mt-6 mb-2">
                            <i data-lucide="users" size="24"></i> Create Squad
                        </button>
                        <div class="error-container"></div>
                        
                        <div class="mt-3 text-[10px] text-psycho-trust text-center bg-psycho-trustBg py-1.5 rounded-lg border border-blue-100 font-medium">
                            <i data-lucide="shield" size="10" class="inline mb-0.5"></i> Pay safely at delivery. Cancel anytime.
                        </div>

                        <div id="lock-in-overlay" class="absolute inset-0 bg-white/80 backdrop-blur-sm z-20 flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300 rounded-2xl">
                            <div class="text-center animate-pop">
                                <div class="w-12 h-12 bg-psycho-action rounded-full flex items-center justify-center mx-auto mb-2 shadow-xl shadow-green-500/40 text-white"><i data-lucide="check" size="24"></i></div>
                                <div class="text-green-800 font-black text-lg">Squad Created!</div>
                            </div>
                        </div>
                    </div>
                </div>
            `);
            showModalNode(node);
            const getQty = setupQuantityLogic(node, p, '#price-label');
            
            if (state.mandiModalInterval) clearInterval(state.mandiModalInterval);
            state.mandiModalInterval = setInterval(() => {
                const mandiEl = node.querySelector('.decoration-psycho-urgency');
                if (mandiEl) mandiEl.innerText = `â‚¹${p.mandiPrice}`;
            }, 5000);

            const closeLogic = () => {
                if (state.hesitationInterval) clearInterval(state.hesitationInterval);
                if (state.mandiModalInterval) clearInterval(state.mandiModalInterval);
                window.closeModal();
            };

            node.querySelector('#close-modal').addEventListener('click', closeLogic);
            node.querySelector('#back-btn-modal').addEventListener('click', closeLogic);
            
            const confirmBtn = node.querySelector('#confirm-btn');

            if (state.hesitationInterval) clearInterval(state.hesitationInterval);
            state.hesitationInterval = setInterval(() => {
                const n = Math.floor(Math.random() * 3);
                const msgs = [
                    "ðŸ“‰ Others are joining â€” price may change",
                    "ðŸ”¥ This item is in demand right now",
                    "âš  Stock reduces while you wait"
                ];
                toast(msgs[n], ["alert-circle", "flame", "package"][n]);
                triggerVibration();
            }, 7000);

            confirmBtn.onclick = async function() {
                this.disabled = true;
                const name = safeVal(node.querySelector('#inp-name'));
                const phone = safeVal(node.querySelector('#inp-phone'));
                const qty = getQty();
                const errCont = node.querySelector('.error-container');

                if (!name || !/^[6-9]\d{9}$/.test(phone)) {
                    this.disabled = false;
                    showFieldError(errCont, 'Enter Valid Name & Phone');
                    return;
                }

                document.getElementById('lock-in-overlay').classList.remove('opacity-0');
                document.getElementById('lock-in-overlay').classList.add('opacity-100');
                
                if (state.hesitationInterval) clearInterval(state.hesitationInterval);
                if (state.mandiModalInterval) clearInterval(state.mandiModalInterval);

                try {
                    saveUser(name, phone);
                    const gid = 'g' + Date.now();
                    const expires = Date.now() + EXPIRY_MS;
                    
                    const group = { id: gid, productId: pid, ownerName: name, expiresAt: expires, createdAt: Date.now(), status: 'open' };
                    const member = { groupId: gid, name, phone, isLeader: true, quantity: qty };
                    
                    state.groups[gid] = group;
                    state.members[gid] = [member];
                    saveData();
                    
                    markOrderHabit(); 

                    setTimeout(() => { 
                        window.closeModal(); 
                        window.openGroup(gid); 
                        triggerConfetti();
                    }, 800); 
                } catch (err) {
                    this.disabled = false;
                    showFieldError(errCont, 'Error saving data');
                }
            };
        };

        window.openAddMemberModal = function(gid) {
            const members = state.members[gid] || []; if(members.length >= 5) return toast("Group is full!", 'lock');
            const group = state.groups[gid]; const p = PRODUCTS.find(x => x.id === group.productId);
            
            const node = createNodeFromHTML(`<div><div class="flex items-center justify-between mb-6"><h3 class="font-bold text-xl text-slate-800">Add Neighbor</h3><button id="close-modal" class="p-2 bg-slate-100 rounded-full text-slate-500 hover:bg-slate-200 cursor-pointer"><i data-lucide="x" size="20"></i></button></div>
            
            ${getPricingRoadmapHTML(p, members.length)}

            <div class="flex items-center justify-between bg-slate-50 p-3 rounded-xl border border-slate-100 mb-4 mt-2">
                <div class="ml-1">
                    <div class="text-xs font-bold text-slate-500 uppercase">Total Weight</div>
                    <div class="text-[10px] text-slate-400 font-medium">Increments of ${p.unit}</div>
                </div>
                <div class="flex items-center gap-3">
                    <button id="btn-minus" class="w-12 h-12 rounded-xl bg-white border border-slate-200 flex items-center justify-center shadow-sm active:scale-95 transition-transform cursor-pointer">
                        <i data-lucide="minus" size="20"></i>
                    </button>
                    <span id="qty-display" class="font-black text-xl w-20 text-center text-slate-800 tabular-nums">0.5 kg</span>
                    <button id="btn-plus" class="w-12 h-12 rounded-xl bg-white border border-slate-200 flex items-center justify-center shadow-sm active:scale-95 transition-transform cursor-pointer">
                        <i data-lucide="plus" size="20"></i>
                    </button>
                </div>
            </div>
            
            <div class="space-y-4 mb-6"><div><label class="block text-xs font-bold text-slate-400 uppercase mb-1.5 ml-1">Neighbor Name</label><input id="m-name" class="w-full bg-white border border-slate-300 p-4 rounded-xl font-bold text-slate-900 focus:outline-none focus:ring-2 focus:ring-psycho-action transition-all placeholder-slate-300 text-sm" placeholder="Friend Name"></div><div><label class="block text-xs font-bold text-slate-400 uppercase mb-1.5 ml-1">Phone Number</label><input id="m-phone" type="tel" class="w-full bg-white border border-slate-300 p-4 rounded-xl font-bold text-slate-900 focus:outline-none focus:ring-2 focus:ring-psycho-action transition-all placeholder-slate-300 text-sm" placeholder="Phone Number"></div></div><div class="mt-auto mb-2"><p class="text-center text-[11px] text-slate-400 font-medium mt-2 flex items-center justify-center gap-1"><i data-lucide="info" size="10"></i> Add neighbor if they are with you.</p></div>
            <button id="add-btn" class="w-full bg-psycho-action text-white py-4 rounded-2xl font-black text-lg shadow-lg shadow-green-600/30 btn-press flex items-center justify-center gap-2 cursor-pointer mt-4">
                <i data-lucide="plus-circle" size="24"></i> Add Neighbor
            </button>
            <div class="error-container"></div>
            </div>`);
            
            showModalNode(node);
            const getQty = setupQuantityLogic(node, p, null);
            node.querySelector('#close-modal').addEventListener('click', window.closeModal);
            
            const addBtn = node.querySelector('#add-btn');
            addBtn.onclick = async function() { 
                this.disabled = true;
                const name = safeVal(node.querySelector('#m-name')); 
                const phone = safeVal(node.querySelector('#m-phone')); 
                const qty = getQty(); 
                const errCont = node.querySelector('.error-container'); 
                
                if (!name || !/^[6-9]\d{9}$/.test(phone)) { 
                    this.disabled = false; 
                    showFieldError(errCont, 'Valid Details Required'); 
                    return; 
                } 
                
                this.innerHTML = '<span class="animate-pulse">Adding...</span>';
                
                try { 
                    const memberData = { groupId: gid, name, phone, isLeader: false, quantity: qty }; 
                    if (!state.members[gid]) state.members[gid] = []; 
                    state.members[gid].push(memberData); 
                    saveData(); 
                    setTimeout(() => { 
                        window.closeModal(); 
                        toast('Added Successfully!', 'check-circle'); 
                        render(); 
                        triggerConfetti(); 
                    }, 500); 
                } catch (err) { 
                    toast('Error Saving', 'alert-circle'); 
                    this.disabled = false;
                    this.innerHTML = '<i data-lucide="plus-circle" size="24"></i> Add Neighbor';
                    if(window.lucide) window.lucide.createIcons();
                } 
            }; 
        };

        window.openEditMemberModal = function(gid, memberIndex) {
            const member = state.members[gid][memberIndex]; const group = state.groups[gid]; const p = PRODUCTS.find(x => x.id === group.productId);
            const members = state.members[gid] || [];
            const node = createNodeFromHTML(`<div><div class="flex items-center justify-between mb-6"><h3 class="font-bold text-xl text-slate-800">Edit Order</h3><button id="close-modal" class="p-2 bg-slate-100 rounded-full text-slate-500 hover:bg-slate-200 cursor-pointer"><i data-lucide="x" size="20"></i></button></div>
            
            ${getPricingRoadmapHTML(p, members.length)}

            <div class="flex items-center justify-between bg-slate-50 p-3 rounded-xl border border-slate-100 mb-4 mt-2">
                <div class="ml-1">
                    <div class="text-xs font-bold text-slate-500 uppercase">Total Weight</div>
                    <div class="text-[10px] text-slate-400 font-medium">Increments of ${p.unit}</div>
                </div>
                <div class="flex items-center gap-3">
                    <button id="btn-minus" class="w-12 h-12 rounded-xl bg-white border border-slate-200 flex items-center justify-center shadow-sm active:scale-95 transition-transform cursor-pointer">
                        <i data-lucide="minus" size="20"></i>
                    </button>
                    <span id="qty-display" class="font-black text-xl w-20 text-center text-slate-800 tabular-nums">...</span>
                    <button id="btn-plus" class="w-12 h-12 rounded-xl bg-white border border-slate-200 flex items-center justify-center shadow-sm active:scale-95 transition-transform cursor-pointer">
                        <i data-lucide="plus" size="20"></i>
                    </button>
                </div>
            </div>
            
            <div class="space-y-4 mb-6"><div><label class="block text-xs font-bold text-slate-400 uppercase mb-1.5 ml-1">Name</label><input id="m-name" value="${member.name}" class="w-full bg-white border border-slate-300 p-4 rounded-xl font-bold text-slate-900 focus:outline-none focus:ring-2 focus:ring-psycho-action transition-all"></div><div><label class="block text-xs font-bold text-slate-400 uppercase mb-1.5 ml-1">Phone</label><input id="m-phone" value="${member.phone}" type="tel" class="w-full bg-white border border-slate-300 p-4 rounded-xl font-bold text-slate-900 focus:outline-none focus:ring-2 focus:ring-psycho-action transition-all"></div></div><button id="save-btn" class="w-full bg-psycho-action text-white h-14 rounded-2xl font-bold text-lg shadow-lg btn-press flex items-center justify-center gap-2 cursor-pointer">Save Changes</button></div>`);
            showModalNode(node);
            const getQty = setupQuantityLogic(node, p, null);
            const targetQty = member.quantity || 1; const plusBtn = node.querySelector('#btn-plus'); for(let i=1; i<targetQty; i++) { plusBtn.click(); }
            node.querySelector('#close-modal').addEventListener('click', window.closeModal);
            node.querySelector('#save-btn').onclick = () => { const name = safeVal(node.querySelector('#m-name')); const phone = safeVal(node.querySelector('#m-phone')); const qty = getQty(); if (!name || !/^[6-9]\d{9}$/.test(phone)) return toast('Valid Name & Phone required', 'alert-circle'); state.members[gid][memberIndex] = { ...member, name, phone, quantity: qty }; saveData(); saveUser(name, phone); window.closeModal(); toast('Order Updated!', 'check-circle'); render(); };
        };

        function renderGroup(el) {
            // 1. CLEANUP PREVIOUS STATES
            if (state.timerInterval) clearInterval(state.timerInterval);
            if (state.hesitationInterval) clearInterval(state.hesitationInterval);
            if (state.dependencyInterval) clearInterval(state.dependencyInterval);
            if (state.painLoopInterval) clearInterval(state.painLoopInterval);
            if (state.mandiModalInterval) clearInterval(state.mandiModalInterval);
            if (state.mandiGroupInterval) clearInterval(state.mandiGroupInterval);
            if (state.scrollObserver) state.scrollObserver.disconnect();

            state.oneHourAlerted = false;

            // 2. DATA PREP
            const g = state.groups[state.currentGroupId]; if (!g) return goHome();
            const p = PRODUCTS.find(x => x.id === g.productId); if (!p) return goHome();
            const members = state.members[g.id] || []; const count = members.length;
            const needed = Math.max(0, 5 - count);
            
            // Pricing Logic
            let currentPrice = p.price1;
            if (count >= 5) currentPrice = p.price5;
            else if (count >= 2) currentPrice = p.price2;

            const loss = p.price1 - currentPrice;
            const nextSavings = (count < 2) ? (p.price1 - p.price2) : (count < 5) ? (p.price2 - p.price5) : 0;
            const totalPotentialSavings = p.price1 - p.price5;

            // Links
            const manualOrderMsg = `Hi, I want to join the squad for ${p.name}. Need ${needed} more to unlock â‚¹${p.price5}/kg. Link: jodo.in/g/${g.id}`;
            const companyLink = `https://wa.me/?text=${encodeURIComponent(manualOrderMsg)}`;
            
            const currentUserMember = members.find(m => m.name === state.user.name && m.phone === state.user.phone);
            let waOrderLink = "#";
            if(currentUserMember) {
                const totalWeight = currentUserMember.quantity * p.baseWeight;
                const formattedWeight = parseFloat(totalWeight.toFixed(2));
                const msg = `Hi JODO, Confirming my order!\n\nProduct: ${p.name}\nQuantity: ${formattedWeight} ${p.weightUnit}\nName: ${currentUserMember.name}\nPhone: ${currentUserMember.phone}\n\nPlease confirm my slot.`;
                waOrderLink = `https://wa.me/${COMPANY_PHONE}?text=${encodeURIComponent(msg)}`;
            }

            // Expiry Time Format
            const expiryDate = new Date(g.expiresAt);
            const now = new Date();
            
            let hours = expiryDate.getHours();
            const minutes = expiryDate.getMinutes();
            const ampm = hours >= 12 ? 'PM' : 'AM';
            hours = hours % 12;
            hours = hours ? hours : 12; // the hour '0' should be '12'
            const minutesStr = minutes < 10 ? '0'+minutes : minutes;
            const timeStr = hours + ':' + minutesStr + ' ' + ampm;

            // Dynamic Date Label Logic
            let dateLabel = "Today";
            const tomorrow = new Date(now);
            tomorrow.setDate(tomorrow.getDate() + 1);

            if (expiryDate.toDateString() === now.toDateString()) {
                dateLabel = "Today";
            } else if (expiryDate.toDateString() === tomorrow.toDateString()) {
                dateLabel = "Tomorrow";
            } else {
                const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
                dateLabel = `${monthNames[expiryDate.getMonth()]} ${expiryDate.getDate()}`;
            }

            // 3. RENDER HTML (THE NEW CLEAN LAYOUT)
            el.innerHTML = `
                <div class="fade-in bg-slate-50 min-h-screen pb-40 font-sans">
                    
                    <!-- ðŸ§¨ SECTION 1: HEADER (Psychological Prime) -->
                    <div class="bg-slate-900 text-white sticky top-0 z-50 px-4 py-4 flex justify-between items-center shadow-md">
                        <div class="flex items-center gap-3" onclick="goHome()">
                            <i data-lucide="arrow-left" size="20" class="text-slate-400"></i>
                            <span class="font-bold text-sm tracking-wide text-slate-200">Our Gang</span>
                        </div>
                        <div class="font-mono font-bold text-lg tracking-widest text-white tabular-nums" id="header-timer">Loading...</div>
                    </div>

                    <div class="p-5">
                        
                        <!-- ðŸ“¦ SECTION 1.5: PRODUCT IDENTITY (Added for Context) -->
                        ${loss > 0 ? `
                        <div class="bg-red-50 border-l-4 border-red-500 p-4 mb-8 rounded-r-lg shadow-sm animate-in fade-in slide-in-from-top-4">
                            <div class="flex items-start gap-3">
                                <i data-lucide="alert-triangle" class="text-red-600 mt-1 shrink-0" size="20"></i>
                                <div>
                                    <div class="text-red-900 font-black text-lg leading-tight">âš  You are losing â‚¹${loss}/kg right now.</div>
                                    <div class="text-red-700 text-sm mt-1 font-medium leading-snug">Finish the squad to avoid paying extra.</div>
                                </div>
                            </div>
                        </div>` : ''}

                        <!-- â³ SECTION 3: DOMINANT COUNTDOWN HERO -->
                        <div class="text-center mb-10 relative">
                            <div class="inline-block relative">
                                <div class="text-6xl font-mono font-black text-slate-900 tracking-tighter tabular-nums relative z-10 leading-none" id="hero-timer">
                                    --:--:--
                                </div>
                                <!-- Subtle glow for urgency -->
                                <div class="absolute inset-0 bg-red-500/20 blur-2xl rounded-full opacity-50 animate-pulse"></div>
                            </div>
                            <div class="text-slate-400 text-xs font-bold uppercase tracking-[0.2em] mt-3">Expires ${dateLabel} ${timeStr}</div>
                        </div>

                        <!-- ðŸŸ© SECTION 4: PROGRESS TO PRICE (Motivation) -->
                        <div class="bg-white rounded-2xl p-6 border border-slate-200 shadow-sm mb-8">
                            <div class="space-y-4 mb-6">
                                <!-- Step 1 -->
                                <div class="flex justify-between items-center ${count < 2 ? 'opacity-100' : 'opacity-40 grayscale'} transition-all">
                                    <div class="flex items-center gap-3">
                                        <div class="w-6 h-6 rounded-full bg-slate-200 text-slate-600 flex items-center justify-center text-xs font-bold">1</div>
                                        <span class="text-sm font-bold text-slate-600">1 Person</span>
                                    </div>
                                    <span class="text-base font-bold text-slate-900">â‚¹${p.price1}</span>
                                </div>
                                
                                <!-- Step 2 -->
                                <div class="flex justify-between items-center ${count >= 2 && count < 5 ? 'opacity-100' : (count >= 5 ? 'opacity-40 grayscale' : 'opacity-40 grayscale')} transition-all">
                                    <div class="flex items-center gap-3">
                                        <div class="w-6 h-6 rounded-full ${count >= 2 ? 'bg-psycho-action text-white' : 'bg-slate-200 text-slate-600'} flex items-center justify-center text-xs font-bold">2</div>
                                        <span class="text-sm font-bold ${count >= 2 ? 'text-psycho-action' : 'text-slate-600'}">2 People</span>
                                    </div>
                                    <span class="text-base font-bold text-slate-900">â‚¹${p.price2}</span>
                                </div>

                                <!-- Step 3 (Gold) -->
                                <div class="flex justify-between items-center ${count >= 5 ? 'scale-105' : ''} transition-all p-2 -mx-2 rounded-lg ${count >= 5 ? 'bg-amber-50 border border-amber-100' : ''}">
                                    <div class="flex items-center gap-3">
                                        <div class="w-6 h-6 rounded-full ${count >= 5 ? 'bg-psycho-reward text-black' : 'bg-slate-200 text-slate-600'} flex items-center justify-center text-xs font-bold">5</div>
                                        <span class="text-sm font-black ${count >= 5 ? 'text-psycho-reward' : 'text-slate-400'}">5 People (Best Price)</span>
                                    </div>
                                    <span class="text-2xl font-black ${count >= 5 ? 'text-psycho-reward' : 'text-slate-300'}">â‚¹${p.price5}</span>
                                </div>
                            </div>

                            <!-- Progress Text -->
                            <div class="text-center">
                                <div class="text-3xl font-black text-slate-900 mb-1">${count} <span class="text-slate-300 text-2xl">/</span> 5</div>
                                <div class="text-sm font-bold ${count < 5 ? 'text-psycho-action' : 'text-psycho-reward'}">
                                    ${count < 5 ? `Need ${needed} more to unlock â‚¹${p.price5}` : 'ðŸŽ‰ LOWEST PRICE UNLOCKED!'}
                                </div>
                            </div>
                        </div>

                        <!-- ðŸ‘¥ SECTION 5: MEMBERS LIST (Social Proof) -->
                        <div class="space-y-3 mb-8">
                            <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4">Our Gang</h3>
                            
                            ${Array(5).fill(0).map((_, i) => {
                                const member = members[i];
                                if (member) {
                                    const isMe = (state.user.name && member.name === state.user.name && member.phone === state.user.phone);
                                    
                                    // Calculate totals for this specific member's quantity
                                    const t1 = Math.round(member.quantity * p.price1);
                                    const t2 = Math.round(member.quantity * p.price2);
                                    const t5 = Math.round(member.quantity * p.price5);
                                    
                                    return `
                                    <div class="bg-white border border-slate-100 p-3 rounded-xl shadow-sm mb-3 transition-all" onclick="openEditMemberModal('${g.id}', ${i})">
                                        <div class="flex items-center justify-between mb-3">
                                            <div class="flex items-center gap-3">
                                                <div class="w-10 h-10 rounded-full ${isMe ? 'bg-green-100 text-green-700' : 'bg-slate-100 text-slate-500'} flex items-center justify-center font-bold text-sm border-2 border-white shadow-sm">
                                                    ${member.name[0]}
                                                </div>
                                                <div>
                                                    <div class="text-sm font-bold text-slate-900 flex items-center gap-2">
                                                        ${isMe ? 'YOU' : member.name}
                                                        ${member.isLeader ? '<i data-lucide="crown" size="12" class="text-amber-500 fill-amber-500"></i>' : ''}
                                                    </div>
                                                    <div class="text-xs text-slate-400 font-medium">${(member.quantity * p.baseWeight).toFixed(1)} ${p.weightUnit} confirmed</div>
                                                </div>
                                            </div>
                                            <div class="text-green-600"><i data-lucide="edit-2" size="16" class="text-slate-300"></i></div>
                                        </div>
                                        
                                        <!-- restored: 1-2-5 Price Matrix for this user -->
                                        <div class="grid grid-cols-3 gap-2 text-center bg-slate-50/50 rounded-lg p-2 border border-slate-100">
                                            <div class="flex flex-col">
                                                <span class="text-[9px] font-bold text-slate-400 uppercase mb-0.5">1 Person</span>
                                                <span class="text-xs font-medium text-slate-500">â‚¹${t1}</span>
                                            </div>
                                            <div class="flex flex-col relative">
                                                ${count >= 2 && count < 5 ? '<div class="absolute -top-3 left-1/2 -translate-x-1/2 text-[8px] bg-green-100 text-green-700 px-1 rounded font-bold">Current</div>' : ''}
                                                <span class="text-[9px] font-bold ${count >= 2 ? 'text-psycho-action' : 'text-slate-400'} uppercase mb-0.5">2 People</span>
                                                <span class="text-xs font-bold ${count >= 2 ? 'text-psycho-action' : 'text-slate-400'}">â‚¹${t2}</span>
                                            </div>
                                            <div class="flex flex-col relative">
                                                ${count >= 5 ? '<div class="absolute -top-3 left-1/2 -translate-x-1/2 text-[8px] bg-amber-100 text-amber-700 px-1 rounded font-bold">Unlocked</div>' : ''}
                                                <span class="text-[9px] font-bold ${count >= 5 ? 'text-amber-600' : 'text-slate-400'} uppercase mb-0.5">5 People</span>
                                                <span class="text-xs font-black ${count >= 5 ? 'text-amber-600' : 'text-slate-900'}">â‚¹${t5}</span>
                                            </div>
                                        </div>
                                    </div>`;
                                } else {
                                    return `
                                    <div onclick="openAddMemberModal('${g.id}')" class="flex items-center justify-between bg-slate-50 border-2 border-dashed border-slate-200 p-3 rounded-xl cursor-pointer hover:bg-white hover:border-psycho-action/50 transition-all group mb-3">
                                        <div class="flex items-center gap-3 opacity-60 group-hover:opacity-100 transition-opacity">
                                            <div class="w-10 h-10 rounded-full bg-slate-200 flex items-center justify-center text-slate-400">
                                                <i data-lucide="user" size="18"></i>
                                            </div>
                                            <span class="text-sm font-bold text-slate-500">Open Spot</span>
                                        </div>
                                        <div class="text-xs font-bold text-psycho-action bg-green-50 px-2 py-1 rounded border border-green-100">+ Add Neighbor</div>
                                    </div>`;
                                }
                            }).join('')}
                        </div>

                    </div>

                    <!-- ðŸŸ£ SECTION 6 & 7: ACTION BAR (Conversion Engine) -->
                    <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 p-4 pb-6 z-50 shadow-[0_-10px_40px_rgba(0,0,0,0.05)]">
                        <div class="max-w-md mx-auto">
                            ${count < 5 ? `
                            <a href="${companyLink}" target="_blank" class="block w-full bg-psycho-action text-white py-4 rounded-2xl font-black text-lg text-center shadow-lg shadow-green-600/30 btn-press flex items-center justify-center gap-2 relative overflow-hidden group">
                                <div class="absolute inset-0 bg-white/20 translate-x-[-100%] group-hover:translate-x-[100%] transition-transform duration-700"></div>
                                <span>Call Your People</span>
                                <i data-lucide="arrow-right" size="24"></i>
                            </a>
                            <div class="text-center mt-3 flex items-center justify-center gap-2 text-xs font-medium text-slate-500">
                                <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                                <span>${needed} spots left â€¢ Typical squads finish in 6 mins</span>
                            </div>
                            ` : `
                            <a href="${waOrderLink}" target="_blank" class="block w-full bg-slate-900 text-white py-4 rounded-2xl font-black text-lg text-center shadow-xl btn-press flex items-center justify-center gap-2">
                                <i data-lucide="message-circle" size="24"></i>
                                <span>Get Best Price Slip</span>
                            </a>
                            <div class="text-center mt-3 text-xs font-medium text-green-600 bg-green-50 py-1 rounded inline-block w-full border border-green-100">
                                ðŸ† Lowest Price Unlocked!
                            </div>
                            `}
                        </div>
                    </div>

                </div>
            `;

            // --- TIMERS & TRIGGERS ---
            
            const timerEl = document.getElementById('hero-timer');
            const headerTimerEl = document.getElementById('header-timer');

            if (timerEl) {
                const tick = () => {
                    const diff = Math.max(0, g.expiresAt - Date.now());
                    
                    const h = Math.floor(diff / 3600000);
                    const m = Math.floor((diff % 3600000) / 60000);
                    const s = Math.floor((diff % 60000) / 1000);
                    
                    // Format: 01 : 12 : 55
                    const fmt = (n) => n < 10 ? '0'+n : n;
                    const mainStr = `${fmt(h)} : ${fmt(m)} : ${fmt(s)}`;
                    
                    timerEl.innerText = mainStr;
                    if(headerTimerEl) headerTimerEl.innerText = mainStr;
                    
                    // Red styling if urgent
                    if (diff < 7200000) { // < 2 hours
                        timerEl.classList.add('text-red-600');
                        if(headerTimerEl) headerTimerEl.classList.add('text-red-400');
                    }
                };
                state.timerInterval = setInterval(tick, 1000); 
                tick();
            }

            // Triggers - Reduced Frequency to avoid noise
            state.painLoopInterval = setInterval(() => {
                if (count < 5 && loss > 0) {
                     showTicker(`âš  You are losing â‚¹${loss}/kg right now`, 'urgent');
                     triggerVibration();
                }
            }, 15000); // Slower loop
        }
        
        function init() {
            loadData();
            loadHabit(); 
            startMandiEngine();
            const handleRoute = () => {
                const params = new URLSearchParams(location.search);
                state.currentGroupId = params.get('group') || null;
                state.view = state.currentGroupId ? 'group' : 'home';
                render();
            };
            window.addEventListener('popstate', handleRoute);
            window.addEventListener('storage', () => { loadData(); render(); });
            handleRoute();
        }
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
