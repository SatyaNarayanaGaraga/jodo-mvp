<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover" />
    <title>JODO - Farm Deals</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üî•</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        psycho: {
                            action: '#E53935', actionLight: '#FF5252', actionBg: '#FFF5F5',
                            urgency: '#B71C1C', urgencyBg: '#FFEBEE',
                            reward: '#FFD600', rewardText: '#374151', rewardBg: '#FFFDE7',
                            trust: '#F57C00', trustBg: '#FFF3E0',
                            alert: '#FF6D00', alertBg: '#FFF8E1',
                            neutral: '#6B7280', base: '#FFFFFF'
                        }
                    },
                    animation: {
                        'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'pop': 'pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)',
                        'fade-in-up': 'fadeInUp 0.5s ease-out',
                        'zoom-in': 'zoomIn 0.3s ease-out'
                    },
                    keyframes: {
                        pop: { '0%': { transform: 'scale(0.95)' }, '100%': { transform: 'scale(1)' } },
                        fadeInUp: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
                        zoomIn: { '0%': { opacity: '0', transform: 'scale(0.95)' }, '100%': { opacity: '1', transform: 'scale(1)' } }
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background: #111827; color: #111827; -webkit-tap-highlight-color: transparent; min-height: 100dvh; display: flex; justify-content: center; align-items: flex-start; margin: 0; overscroll-behavior-y: none; }
        #app { width: 100%; max-width: 448px; background: #F9FAFB; min-height: 100dvh; position: relative; box-shadow: 0 0 40px rgba(0, 0, 0, 0.3); overflow-y: auto; overflow-x: hidden; display: flex; flex-direction: column; }
        .btn-press { transition: transform 0.1s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer; user-select: none; }
        .btn-press:active:not(:disabled) { transform: scale(0.96); }
        .card-modern { background: white; border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); border: 1px solid #F3F4F6; transform-style: preserve-3d; transition: transform 0.1s ease-out; }
        .glass-header { background: #E53935; box-shadow: 0 2px 10px rgba(229, 57, 53, 0.3); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .tilt-card { transition: transform 0.15s ease-out; transform-style: preserve-3d; }
        .hold-btn { position: relative; overflow: hidden; user-select: none; touch-action: none; }
        .hold-btn-fill { position: absolute; top: 0; left: 0; height: 100%; background: rgba(0,0,0,0.25); width: 0%; transition: width 0s linear; }
        .hold-btn.holding .hold-btn-fill { width: 100%; transition: width 1.2s linear; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .pt-safe { padding-top: env(safe-area-inset-top); }
        .fade-in { animation: fadeInUp 0.5s ease-out forwards; }
    </style>
</head>
<body class="antialiased selection:bg-psycho-action/20">

    <div id="app"></div>

    <!-- MODAL OVERLAY -->
    <div id="modal-overlay" class="fixed inset-0 bg-slate-900/80 hidden z-[60] flex items-end justify-center backdrop-blur-sm transition-opacity duration-300">
        <div id="modal-content" class="bg-white w-full max-w-[448px] rounded-t-[2rem] shadow-2xl transform transition-transform duration-300 translate-y-full max-h-[95dvh] flex flex-col overflow-hidden"></div>
    </div>

    <!-- PSYCHOLOGY TICKER -->
    <div id="live-ticker" class="fixed bottom-6 left-1/2 -translate-x-1/2 bg-slate-900/95 backdrop-blur-md text-white px-4 py-2.5 rounded-full text-xs font-medium shadow-2xl z-[55] flex items-center gap-2 pointer-events-none border border-white/10 whitespace-nowrap hidden max-w-[90%] overflow-hidden transition-all duration-500 pb-safe">
        <div id="ticker-dot" class="w-2 h-2 rounded-full animate-pulse shrink-0"></div>
        <span id="ticker-text" class="truncate font-bold tracking-wide">...</span>
    </div>

    <!-- TOAST -->
    <div id="toast" aria-live="polite" role="status" class="fixed top-24 left-1/2 -translate-x-1/2 bg-slate-900/95 backdrop-blur-md text-white px-6 py-3 rounded-full text-sm font-bold shadow-2xl hidden z-[90] flex items-center gap-2 pointer-events-none border border-white/10 transition-all duration-300 tracking-wide animate-pop pt-safe"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, updateDoc, arrayUnion, collection, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 1. FIREBASE CONFIG ---
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const PUBLIC_GROUPS_COLL = 'groups';

        // --- 2. CONFIG & STATE ---
        const COMPANY_PHONE = "919999999999"; 
        const ADMIN_PASSWORD = "JODO2025"; // üîí CHANGE THIS PASSWORD
        const GUIDE_IMG_SRC = 'https://images.unsplash.com/photo-1542838132-92c53300491e?q=80&w=1000&auto=format&fit=crop';
        
        const state = { 
            view: 'home', 
            currentGroupId: null, 
            groups: {}, 
            members: {}, 
            adminGroups: [],
            user: { name: '', phone: '', uid: null },
            timerInterval: null, 
            tickerInterval: null,
            firebaseUnsubscribe: null,
            adminUnsubscribe: null,
            isAdmin: false // üîí Admin State
        };

        const PRODUCTS = [
            { id: 'onion', name: 'Red Onions', nameTe: '‡∞é‡∞∞‡±ç‡∞∞ ‡∞â‡∞≤‡±ç‡∞≤‡∞ø‡∞™‡∞æ‡∞Ø‡∞≤‡±Å', unit: '500g', baseWeight: 0.5, weightUnit: 'kg', price1: 25, price5: 18, remainingStock: 14, icon: 'layers', imageColor: 'bg-red-50 text-red-600', image: 'https://images.unsplash.com/photo-1618512496248-a07fe83aa8cb?w=500&q=80' },
            { id: 'oil', name: 'Sunflower Oil', nameTe: '‡∞™‡±ä‡∞¶‡±ç‡∞¶‡±Å‡∞§‡∞ø‡∞∞‡±Å‡∞ó‡±Å‡∞°‡±Å ‡∞®‡±Ç‡∞®‡±Ü', unit: '500ml', baseWeight: 0.5, weightUnit: 'L', price1: 60, price5: 50, remainingStock: 8, icon: 'droplet', imageColor: 'bg-yellow-50 text-yellow-600', image: 'https://images.unsplash.com/photo-1620706857370-e1b9770e8bb1?w=500&q=80' },
            { id: 'sugar', name: 'Sugar', nameTe: '‡∞ö‡∞ï‡±ç‡∞ï‡±Ü‡∞∞', unit: '500g', baseWeight: 0.5, weightUnit: 'kg', price1: 24, price5: 20, remainingStock: 42, icon: 'package', imageColor: 'bg-blue-50 text-blue-600', image: 'https://images.unsplash.com/photo-1612196023694-072b22300b75?w=500&q=80' }
        ];

        // --- 3. HELPER FUNCTIONS ---
        function toast(msg, icon) { 
            const t = document.getElementById('toast'); 
            t.innerHTML = `<i data-lucide="${icon}" size="16"></i> ${msg}`; 
            t.classList.remove('hidden'); 
            if(window.lucide) window.lucide.createIcons(); 
            setTimeout(() => t.classList.add('hidden'), 3500); 
        }

        function triggerConfetti() { if (typeof confetti === 'function') confetti({ particleCount: 150, spread: 80, origin: { y: 0.6 }, colors: ['#E53935', '#FDD835', '#ffffff'] }); }
        function triggerVibration() { if (navigator.vibrate) navigator.vibrate(20); }
        function createNodeFromHTML(html) { const t = document.createElement('template'); t.innerHTML = html.trim(); return t.content.firstElementChild; }
        function safeVal(el) { return (el && el.value) ? el.value.trim() : ''; }
        function showFieldError(c, m) { c.innerHTML = `<div class="text-xs text-red-600 font-bold bg-red-50 p-2 rounded flex gap-2"><i data-lucide="alert-circle" size="14"></i> ${m}</div>`; if(window.lucide) window.lucide.createIcons(); }

        // --- 4. UTILS & UI ---
        function initCardTilt() {
             const cards = document.querySelectorAll('.tilt-card');
             if(cards.length === 0) return;
             cards.forEach(card => {
                 card.addEventListener('mousemove', (e) => {
                     const rect = card.getBoundingClientRect();
                     const x = e.clientX - rect.left;
                     const y = e.clientY - rect.top;
                     const centerX = rect.width / 2;
                     const centerY = rect.height / 2;
                     const rotateX = ((y - centerY) / centerY) * -3; 
                     const rotateY = ((x - centerX) / centerX) * 3;
                     card.style.transform = `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg) scale3d(1.02, 1.02, 1.02)`;
                 });
                 card.addEventListener('mouseleave', () => {
                     card.style.transform = `perspective(1000px) rotateX(0deg) rotateY(0deg) scale3d(1, 1, 1)`;
                 });
             });
        }

        window.closeModal = () => {
             const overlay = document.getElementById('modal-overlay');
             const content = document.getElementById('modal-content');
             content.classList.add('translate-y-full');
             setTimeout(() => {
                 overlay.classList.add('hidden');
                 content.innerHTML = ''; 
             }, 200); 
        };

        function showModalNode(node) {
             const overlay = document.getElementById('modal-overlay');
             const content = document.getElementById('modal-content');
             content.innerHTML = ''; content.appendChild(node);
             overlay.classList.remove('hidden'); 
             requestAnimationFrame(() => { overlay.classList.remove('opacity-0'); content.classList.remove('translate-y-full'); });
             if(node.querySelector('input')) node.querySelector('input').focus();
             if(window.lucide) window.lucide.createIcons();
        }

        // --- 5. AUTH & DATA ---
        async function initAuth() {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                try { await signInWithCustomToken(auth, __initial_auth_token); } catch(e) { await signInAnonymously(auth); }
            } else {
                await signInAnonymously(auth);
            }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    state.user.uid = user.uid;
                    checkUrlForGroup(); 
                }
            });
        }

        function loadLocalData() {
            try {
                state.user.name = localStorage.getItem('jodo_user_name') || '';
                state.user.phone = localStorage.getItem('jodo_user_phone') || '';
                // Load local DB cache for instant UI
                const raw = localStorage.getItem('jodo_local_db_v54');
                if (raw) {
                    const data = JSON.parse(raw);
                    state.groups = { ...state.groups, ...data.groups };
                    state.members = { ...state.members, ...data.members };
                }
            } catch(e) {}
        }

        function saveLocalData() {
            try {
                localStorage.setItem('jodo_local_db_v54', JSON.stringify({ groups: state.groups, members: state.members }));
            } catch(e) {}
        }
        
        function saveUserLocally(name, phone) {
            state.user.name = name;
            state.user.phone = phone;
            localStorage.setItem('jodo_user_name', name);
            localStorage.setItem('jodo_user_phone', phone);
        }

        // --- 6. CORE LOGIC (FIRESTORE) ---
        
        async function createGroup(pid, name, phone, qty, isSolo) {
            const gid = 'g' + Date.now();
            const expires = Date.now() + (2 * 24 * 60 * 60 * 1000); // 48h
            
            const member = { 
                name, phone, quantity: qty, isLeader: true, joinedAt: Date.now(),
                uid: state.user.uid 
            };

            const groupData = {
                id: gid,
                productId: pid,
                ownerName: name,
                expiresAt: expires,
                createdAt: Date.now(),
                status: 'open',
                type: isSolo ? 'solo' : 'group',
                members: [member] 
            };

            // Optimistic update
            state.groups[gid] = groupData;
            state.members[gid] = [member];
            saveLocalData();
            saveUserLocally(name, phone);

            try {
                // Real-time Cloud Save
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', PUBLIC_GROUPS_COLL, gid);
                await setDoc(docRef, groupData);
            } catch(e) {
                console.error("Firestore create error", e);
                toast("Network Error: Using Local Storage", "wifi-off");
            }

            return gid;
        }

        async function addMemberToGroup(gid, name, phone, qty) {
            const groupRef = doc(db, 'artifacts', appId, 'public', 'data', PUBLIC_GROUPS_COLL, gid);
            
            const newMember = {
                name, phone, quantity: qty, isLeader: false, joinedAt: Date.now(),
                uid: state.user.uid || 'anon'
            };

            // Optimistic update
            if (!state.members[gid]) state.members[gid] = [];
            state.members[gid].push(newMember);
            saveLocalData();
            saveUserLocally(name, phone); 

            try {
                // Real-time Cloud Update
                await updateDoc(groupRef, {
                    members: arrayUnion(newMember)
                });
            } catch(e) {
                console.error("Firestore join error", e);
                toast("Offline mode: Saved locally", "wifi-off");
            }
        }

        function listenToGroup(gid) {
            if (state.firebaseUnsubscribe) state.firebaseUnsubscribe(); 
            
            const groupRef = doc(db, 'artifacts', appId, 'public', 'data', PUBLIC_GROUPS_COLL, gid);
            
            state.firebaseUnsubscribe = onSnapshot(groupRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    state.groups[gid] = data;
                    state.members[gid] = data.members || [];
                    saveLocalData(); 
                    
                    if (state.view === 'group' && state.currentGroupId === gid) {
                        render(); 
                    }
                } else {
                    if (state.view === 'group' && state.currentGroupId === gid) {
                        toast("Squad Ended or Expired", "clock");
                        setTimeout(() => window.goHome(), 2000);
                    }
                }
            }, (err) => {
                console.log("Snapshot error", err);
            });
        }

        function listenToAllGroupsForAdmin() {
            if (state.adminUnsubscribe) return;
            
            // Real-time listener for ALL groups
            const groupsRef = collection(db, 'artifacts', appId, 'public', 'data', PUBLIC_GROUPS_COLL);
            
            state.adminUnsubscribe = onSnapshot(groupsRef, (snapshot) => {
                const groups = [];
                snapshot.forEach((doc) => {
                    groups.push(doc.data());
                });
                state.adminGroups = groups.sort((a, b) => b.createdAt - a.createdAt);
                if (state.view === 'admin') render();
            }, (err) => {
                console.error("Admin sync error", err);
                toast("Admin Sync Failed", "wifi-off");
            });
        }

        function checkUrlForGroup() {
            const params = new URLSearchParams(location.search);
            const view = params.get('view');
            const gid = params.get('group');
            
            if (view === 'admin') {
                // Intercept Admin Load for Password
                if(state.isAdmin) {
                    state.view = 'admin';
                    listenToAllGroupsForAdmin();
                    render();
                } else {
                    window.goToAdmin(); // Triggers modal
                }
            } else if (gid) {
                window.openGroup(gid);
            } else {
                window.goHome();
            }
        }

        // --- 7. GLOBAL WINDOW FUNCTIONS ---

        window.goHome = () => {
            if (state.timerInterval) clearInterval(state.timerInterval);
            if (state.firebaseUnsubscribe) { state.firebaseUnsubscribe(); state.firebaseUnsubscribe = null; }
            try { history.pushState({}, '', location.pathname); } catch(e) {}
            state.view = 'home';
            state.currentGroupId = null;
            render();
        };

        window.openGroup = (gid) => {
            try { history.pushState({}, '', `?group=${gid}`); } catch(e) {}
            state.currentGroupId = gid;
            state.view = 'group';
            listenToGroup(gid);
            render();
        };

        window.goToAdmin = () => {
            // PASSWORD PROTECTION LOGIC
            if(state.isAdmin) {
                try { history.pushState({}, '', `?view=admin`); } catch(e) {}
                state.view = 'admin';
                listenToAllGroupsForAdmin();
                render();
                return;
            }

            const node = createNodeFromHTML(`
                <div class="bg-white p-6 rounded-2xl w-[90%] max-w-sm m-auto relative top-[20vh] shadow-2xl">
                    <h3 class="font-black text-xl text-slate-900 mb-4">Partner Login</h3>
                    <input id="admin-pass" type="password" class="w-full border-2 border-slate-200 p-3 rounded-xl font-bold text-center mb-4" placeholder="Enter Password">
                    <button id="admin-login-btn" class="w-full bg-slate-900 text-white p-3 rounded-xl font-bold">Access Dashboard</button>
                    <button onclick="window.closeModal()" class="w-full text-slate-400 p-2 mt-2 font-bold text-sm">Cancel</button>
                </div>
            `);
            showModalNode(node);
            
            node.querySelector('#admin-login-btn').onclick = () => {
                const val = node.querySelector('#admin-pass').value;
                if(val === ADMIN_PASSWORD) {
                    state.isAdmin = true;
                    window.closeModal();
                    window.goToAdmin();
                    toast("Welcome Partner", "shield-check");
                } else {
                    toast("Wrong Password", "lock");
                    triggerVibration();
                }
            };
        }

        window.shareToWhatsApp = () => {
            const group = state.groups[state.currentGroupId];
            const p = PRODUCTS.find(x => x.id === group.productId);
            const url = encodeURIComponent(window.location.href);
            const text = encodeURIComponent(`Join my ${p.name} squad on JODO! Buy together to unlock wholesale prices. üëá\n\n`);
            window.open(`https://wa.me/?text=${text}${url}`, '_blank');
        };

        window.shareGroupLink = () => {
             const url = window.location.href;
             navigator.clipboard.writeText(url).then(() => {
                 toast("Link Copied!", "copy");
                 triggerVibration();
             }).catch(err => {
                 const input = document.createElement('input');
                 input.value = url;
                 document.body.appendChild(input);
                 input.select();
                 document.execCommand('copy');
                 document.body.removeChild(input);
                 toast("Link Copied!", "copy");
             });
        }

        window.confirmOrderWhatsApp = () => {
            const group = state.groups[state.currentGroupId];
            const p = PRODUCTS.find(x => x.id === group.productId);
            const me = (state.members[group.id] || []).find(m => m.name === state.user.name && m.phone === state.user.phone);
            
            if(!me) return toast("Identity not found", "alert-circle");

            const text = `*New JODO Order*\n\n` +
                         `üì¶ Product: ${p.name}\n` +
                         `‚öñÔ∏è Qty: ${(me.quantity * p.baseWeight).toFixed(1)} ${p.weightUnit}\n` +
                         `üí∞ Price: ‚Çπ${Math.round(me.quantity * p.price5)} (Unbeatable!)\n` +
                         `------------------\n` +
                         `üë§ Name: ${me.name}\n` +
                         `üì± Phone: ${me.phone}\n` +
                         `üÜî Squad: ${group.id}`;
            
            const encoded = encodeURIComponent(text);
            window.open(`https://wa.me/${COMPANY_PHONE}?text=${encoded}`, '_blank');
        }

        window.openStartModal = (pid) => {
            const p = PRODUCTS.find(x => x.id === pid);
            const user = state.user;
            const node = createNodeFromHTML(`
                <div class="flex flex-col h-[90vh] bg-slate-50 rounded-t-[2rem] overflow-hidden">
                    <div class="bg-white px-5 py-4 flex items-center justify-between shadow-sm border-b border-slate-100 shrink-0">
                        <h3 class="font-black text-xl text-slate-800 uppercase">Start Buying</h3>
                        <button id="close-modal" class="p-2 bg-slate-100 rounded-full text-slate-500"><i data-lucide="x" size="20"></i></button>
                    </div>
                    <div class="p-5 overflow-y-auto flex-1">
                        <div class="flex gap-4 mb-6"><div class="w-20 h-20 rounded-2xl shadow-md border border-slate-100 relative overflow-hidden shrink-0"><div class="absolute inset-0 ${p.imageColor} flex items-center justify-center"><i data-lucide="${p.icon}" size="32" class="text-white/80"></i></div></div><div class="flex-1 flex flex-col justify-center"><h4 class="font-black text-xl text-slate-900 leading-none mb-1">${p.name}</h4><div class="text-sm font-semibold text-slate-400 mb-2">${p.nameTe}</div></div></div>
                        <div class="bg-white p-4 rounded-2xl border-2 border-psycho-reward bg-psycho-rewardBg mb-6 shadow-sm">
                            <div class="font-bold text-yellow-800 text-xs uppercase tracking-wider mb-0.5">Group Price</div>
                            <div class="font-black text-3xl text-slate-900">‚Çπ${p.price5} <span class="text-base text-slate-400 font-medium line-through">‚Çπ${p.price1}</span></div>
                        </div>
                        <div class="bg-white p-3 rounded-2xl border border-slate-100 shadow-sm mb-6 flex items-center justify-between">
                            <div class="pl-2"><div class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Quantity</div><div class="text-[10px] text-psycho-urgency font-bold">Min 1kg</div></div>
                            <div class="flex items-center gap-3 bg-slate-50 p-1.5 rounded-xl border border-slate-100">
                                <button id="btn-minus" class="w-10 h-10 rounded-lg bg-white border border-slate-200 text-slate-400 flex items-center justify-center"><i data-lucide="minus" size="18"></i></button>
                                <div class="text-xl font-black text-slate-900 w-20 text-center leading-none" id="qty-display">1.0 kg</div>
                                <button id="btn-plus" class="w-10 h-10 rounded-lg bg-psycho-action text-white shadow-md flex items-center justify-center"><i data-lucide="plus" size="18"></i></button>
                            </div>
                        </div>
                        <div class="space-y-4 mb-8">
                            <input id="inp-name" value="${user.name}" class="w-full bg-white border-2 border-slate-100 py-4 px-4 rounded-xl font-bold text-slate-900" placeholder="Your Name">
                            <input id="inp-phone" value="${user.phone}" type="tel" class="w-full bg-white border-2 border-slate-100 py-4 px-4 rounded-xl font-bold text-slate-900" placeholder="Mobile Number">
                        </div>
                    </div>
                    <div class="bg-white border-t border-slate-100 p-4 shrink-0 pb-safe">
                        <button id="start-btn" class="w-full bg-psycho-action text-white h-[64px] rounded-2xl font-black text-xl shadow-lg flex items-center justify-center gap-2">
                            <span>Start Group & Share</span> <i data-lucide="arrow-right" size="24"></i>
                        </button>
                    </div>
                </div>
            `);
            
            showModalNode(node);
            
            let qty = 2; 
            const updateQty = () => { node.querySelector('#qty-display').innerText = `${(qty * p.baseWeight).toFixed(1)} ${p.weightUnit}`; };
            node.querySelector('#btn-minus').onclick = () => { if(qty > 2) { qty--; updateQty(); } else { toast('Min 1kg required', 'alert-circle'); }};
            node.querySelector('#btn-plus').onclick = () => { qty++; updateQty(); };
            node.querySelector('#close-modal').onclick = window.closeModal;
            updateQty();

            node.querySelector('#start-btn').onclick = async () => {
                const name = safeVal(node.querySelector('#inp-name'));
                const phone = safeVal(node.querySelector('#inp-phone'));
                if(!name || !phone) return toast("Details required", "alert-circle");
                
                node.querySelector('#start-btn').innerText = "Creating...";
                const gid = await createGroup(pid, name, phone, qty, false);
                window.closeModal();
                window.openGroup(gid);
                triggerConfetti();
            };
        };

        window.openAddMemberModal = (gid) => {
             const group = state.groups[gid];
             const p = PRODUCTS.find(x => x.id === group.productId);
             const node = createNodeFromHTML(`
                <div class="flex flex-col h-[85vh] bg-slate-50 rounded-t-[2rem]">
                    <div class="bg-white px-5 py-4 flex items-center justify-between shadow-sm border-b border-slate-100">
                        <h3 class="font-black text-xl text-slate-800 uppercase">Join Squad</h3>
                        <button id="close-modal" class="p-2 bg-slate-100 rounded-full text-slate-500"><i data-lucide="x" size="20"></i></button>
                    </div>
                    <div class="p-5 overflow-y-auto flex-1">
                        <div class="bg-white p-3 rounded-2xl border border-slate-100 shadow-sm mb-6 flex items-center justify-between">
                            <div class="pl-2"><div class="text-[10px] font-bold text-slate-400 uppercase tracking-wider">Quantity</div><div class="text-[10px] text-psycho-urgency font-bold">Min 1kg</div></div>
                            <div class="flex items-center gap-3 bg-slate-50 p-1.5 rounded-xl border border-slate-100">
                                <button id="btn-minus" class="w-10 h-10 rounded-lg bg-white border border-slate-200 text-slate-400 flex items-center justify-center"><i data-lucide="minus" size="18"></i></button>
                                <div class="text-xl font-black text-slate-900 w-20 text-center leading-none" id="qty-display">1.0 kg</div>
                                <button id="btn-plus" class="w-10 h-10 rounded-lg bg-psycho-action text-white shadow-md flex items-center justify-center"><i data-lucide="plus" size="18"></i></button>
                            </div>
                        </div>
                         <div class="space-y-4 mb-8">
                            <input id="m-name" class="w-full bg-white border-2 border-slate-100 py-4 px-4 rounded-xl font-bold text-slate-900" placeholder="Your Name">
                            <input id="m-phone" class="w-full bg-white border-2 border-slate-100 py-4 px-4 rounded-xl font-bold text-slate-900" placeholder="Mobile Number">
                        </div>
                    </div>
                    <div class="bg-white border-t border-slate-100 p-4 shrink-0 pb-safe">
                        <button id="add-btn" class="w-full bg-psycho-action text-white h-[64px] rounded-2xl font-black text-xl shadow-lg flex items-center justify-center gap-2">
                           <i data-lucide="user-plus"></i> <span>Confirm & Join</span>
                        </button>
                    </div>
                </div>
             `);
             showModalNode(node);
             
             let qty = 2;
             const updateQty = () => { node.querySelector('#qty-display').innerText = `${(qty * p.baseWeight).toFixed(1)} ${p.weightUnit}`; };
             node.querySelector('#btn-minus').onclick = () => { if(qty > 2) { qty--; updateQty(); }};
             node.querySelector('#btn-plus').onclick = () => { qty++; updateQty(); };
             node.querySelector('#close-modal').onclick = window.closeModal;
             updateQty();

             node.querySelector('#add-btn').onclick = async () => {
                 const name = safeVal(node.querySelector('#m-name'));
                 const phone = safeVal(node.querySelector('#m-phone'));
                 if(!name || !phone) return toast("Details required", "alert-circle");
                 
                 node.querySelector('#add-btn').innerText = "Joining...";
                 await addMemberToGroup(gid, name, phone, qty);
                 window.closeModal();
                 triggerConfetti();
                 toast("Welcome to the Squad!", "check-circle");
             };
        }

        window.openLiveGuide = window.openLiveGuide || (() => { 
             const node = createNodeFromHTML(`<div class="flex flex-col h-[70vh]"><div class="flex-1 bg-black relative rounded-t-[2rem] overflow-hidden"><img src="${GUIDE_IMG_SRC}" class="w-full h-full object-cover opacity-80"><button onclick="window.closeModal()" class="absolute top-4 right-4 bg-white/20 p-2 rounded-full text-white"><i data-lucide="x" size="20"></i></button><div class="absolute inset-0 flex flex-col items-center justify-center text-center p-6 bg-black/40"><h3 class="text-white text-2xl font-black mb-2">How JODO Works</h3><p class="text-white/90 text-sm mb-6">1. Pick Product<br>2. Share Link<br>3. Squad fills, Price drops!</p><button onclick="window.closeModal()" class="bg-white text-black px-8 py-3 rounded-full font-bold shadow-xl">Got it!</button></div></div></div>`);
             showModalNode(node);
        });

        // --- 8. RENDER FUNCTIONS ---

        function render() {
            const app = document.getElementById('app');
            if (state.view === 'home') renderHome(app);
            else if (state.view === 'admin') renderAdmin(app);
            else renderGroup(app);
            if(window.lucide) window.lucide.createIcons();
        }

        function renderAdmin(el) {
            el.innerHTML = `
                <div class="fade-in bg-slate-100 min-h-screen pb-safe font-sans">
                    <div class="bg-slate-900 text-white h-[68px] sticky top-0 z-50 px-4 flex justify-between items-center shadow-md">
                        <div class="flex items-center gap-3 cursor-pointer pt-safe" onclick="window.goHome()"><i data-lucide="arrow-left" size="24" class="text-white"></i><span class="font-black text-lg tracking-wide text-white">Company Admin</span></div>
                        <div class="text-xs bg-slate-800 px-2 py-1 rounded border border-slate-700 pt-safe">Live Mode</div>
                    </div>
                    <div class="p-4">
                        <h2 class="font-bold text-slate-500 uppercase text-xs tracking-widest mb-4">All Active Squads</h2>
                        ${state.adminGroups.length === 0 ? '<div class="text-center text-slate-400 mt-10">Fetching active squads...</div>' : 
                          state.adminGroups.map(g => {
                              const p = PRODUCTS.find(x => x.id === g.productId);
                              const count = (g.members || []).length;
                              const isFull = count >= 2;
                              return `
                                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 mb-4">
                                    <div class="flex justify-between items-start mb-3">
                                        <div class="flex items-center gap-3">
                                            <div class="w-10 h-10 rounded-lg bg-slate-100 flex items-center justify-center shrink-0"><i data-lucide="${p ? p.icon : 'package'}" size="20" class="text-slate-500"></i></div>
                                            <div>
                                                <div class="font-black text-slate-900">${p ? p.name : 'Unknown'}</div>
                                                <div class="text-xs text-slate-400 font-mono">${g.id}</div>
                                            </div>
                                        </div>
                                        <div class="px-2 py-1 rounded text-[10px] font-bold uppercase ${isFull ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'}">${isFull ? 'Deal Unlocked' : 'Pending'}</div>
                                    </div>
                                    <div class="border-t border-slate-100 pt-3 space-y-2">
                                        ${(g.members || []).map(m => `
                                            <div class="flex justify-between items-center text-sm">
                                                <div class="flex items-center gap-2">
                                                    <div class="w-2 h-2 rounded-full ${m.isLeader ? 'bg-blue-500' : 'bg-slate-300'}"></div>
                                                    <span class="font-bold text-slate-700">${m.name}</span>
                                                    <span class="text-slate-400 text-xs">${m.phone}</span>
                                                </div>
                                                <div class="font-mono font-bold text-slate-900">${m.quantity}kg</div>
                                            </div>
                                        `).join('')}
                                    </div>
                                    ${isFull ? `
                                    <div class="mt-3 pt-3 border-t border-slate-100 flex justify-between items-center">
                                        <div class="text-xs text-slate-400 font-bold uppercase">Total Order: ${(g.members.reduce((acc, m) => acc + (m.quantity || 0), 0) * (p ? p.baseWeight : 0.5)).toFixed(1)} kg</div>
                                        <a href="https://wa.me/${g.members[0].phone}" target="_blank" class="text-green-600 text-xs font-bold hover:underline">Contact Leader</a>
                                    </div>` : ''}
                                </div>
                              `;
                          }).join('')
                        }
                    </div>
                </div>
            `;
        }

        function renderHome(el) {
            const user = state.user;
            const userActiveGroupIds = {}; 
            const activeUserGroups = []; 

            if (user.name && user.phone) { 
                Object.values(state.groups).forEach(g => { 
                    const members = state.members[g.id] || []; 
                    if (members.some(m => m.name === user.name && m.phone === user.phone)) { 
                        userActiveGroupIds[g.productId] = g.id;
                        activeUserGroups.push(g); 
                    } 
                }); 
            }
            activeUserGroups.sort((a, b) => b.createdAt - a.createdAt);

            const sortedProducts = [...PRODUCTS].sort((a, b) => {
                const aActive = !!userActiveGroupIds[a.id];
                const bActive = !!userActiveGroupIds[b.id];
                if (aActive && !bActive) return 1;
                if (!aActive && bActive) return -1;
                return 0;
            });

            let heroContent = '';
            if (activeUserGroups.length > 0) {
                heroContent = `<div class="mt-6 mb-4 px-4 flex gap-3 overflow-x-auto snap-x no-scrollbar pb-2">
                    ${activeUserGroups.map(g => {
                        const p = PRODUCTS.find(x => x.id === g.productId);
                        if(!p) return '';
                        const members = state.members[g.id] || [];
                        const count = members.length;
                        return `<div onclick="window.openGroup('${g.id}')" class="shrink-0 w-[85%] max-w-[280px] snap-center cursor-pointer card-modern tilt-card">
                            <div class="bg-slate-900 rounded-2xl p-4 shadow-md border border-slate-800 relative overflow-hidden h-full flex flex-col justify-between">
                                <div class="absolute -right-10 -top-10 w-40 h-40 bg-psycho-action/10 rounded-full blur-3xl"></div>
                                <div class="flex items-center gap-3 mb-3 relative z-10 mt-2">
                                    <div class="w-12 h-12 bg-white rounded-xl flex items-center justify-center text-slate-900 shadow-sm shrink-0"><i data-lucide="${p.icon}" size="24"></i></div>
                                    <div class="flex-1 min-w-0">
                                        <h3 class="font-black text-white text-base leading-none mb-1 truncate">${p.name}</h3>
                                        <div class="flex items-center gap-1.5 text-[10px]">
                                            <span class="text-white font-bold">${count}/2</span>
                                            <span class="text-psycho-reward font-bold">In Progress</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="relative h-1.5 bg-slate-800 rounded-full overflow-hidden">
                                    <div class="absolute inset-y-0 left-0 bg-psycho-action" style="width: ${(count/2)*100}%"></div>
                                </div>
                            </div>
                        </div>`;
                    }).join('')}
                </div>`;
            } else {
                heroContent = `<div onclick="window.openLiveGuide()" class="px-4 mt-6 mb-4 cursor-pointer tilt-card">
                    <div class="relative w-full h-48 bg-slate-900 rounded-2xl overflow-hidden shadow-sm border border-slate-100"><img src="${GUIDE_IMG_SRC}" class="w-full h-full object-cover opacity-90"><div class="absolute bottom-4 left-4 right-4 text-center"><div class="text-white font-bold text-sm">Quick Guide</div><div class="text-slate-200 text-[10px] font-medium uppercase tracking-widest">Learn to Save 60%</div></div></div>
                </div>`;
            }

            el.innerHTML = `
                <div class="pb-safe fade-in">
                    <div class="glass-header h-[68px] flex items-center justify-between px-4 sticky top-0 z-40 shadow-md">
                        <div class="pt-safe"><h1 class="font-black text-2xl tracking-tight text-white">JODO</h1><div class="text-[10px] text-white/80 font-medium">Group Up. Price Down.</div></div>
                    </div>
                    ${heroContent}
                    <div class="px-3 space-y-3 mt-2 pb-24">
                        <h2 class="text-xs font-bold text-slate-400 uppercase tracking-widest ml-1 mb-2">Daily Deals</h2>
                        ${sortedProducts.map(p => {
                            const activeGid = userActiveGroupIds[p.id];
                            const savings = p.price1 - p.price5;
                            const actionAttr = activeGid ? `onclick="window.openGroup('${activeGid}')"` : `onclick="window.openStartModal('${p.id}')"`;
                            return `<div class="bg-white p-3 rounded-xl flex gap-3 shadow-sm border border-slate-100 relative overflow-hidden active:scale-[0.99] transition-transform duration-100" ${actionAttr}>
                                <div class="w-32 h-32 bg-slate-100 rounded-lg relative overflow-hidden shrink-0 border border-slate-100">
                                    <img src="${p.image}" class="absolute inset-0 w-full h-full object-cover" />
                                    <div class="absolute top-1.5 left-1.5 bg-black/60 backdrop-blur-md text-white text-[8px] font-black px-1.5 py-0.5 rounded flex items-center gap-1 z-10"><div class="w-1.5 h-1.5 bg-red-500 rounded-full animate-pulse"></div> LIVE</div>
                                    <div class="absolute bottom-0 left-0 right-0 bg-black/60 text-white text-[9px] font-medium text-center py-0.5 backdrop-blur-sm">Only ${p.remainingStock}kg left</div>
                                </div>
                                <div class="flex-1 flex flex-col justify-between py-0.5 min-w-0">
                                    <div>
                                        <div class="flex items-center gap-1.5 mb-1.5 flex-wrap"><span class="bg-black text-white text-[9px] font-bold px-1.5 py-0.5 rounded-[4px]">Brand</span><span class="border border-psycho-action text-psycho-action text-[9px] font-bold px-1.5 py-0.5 rounded-[4px] flex items-center gap-0.5"><i data-lucide="zap" size="8"></i> Best Price</span></div>
                                        <h3 class="font-bold text-base text-slate-900 leading-tight line-clamp-2 mb-1">${p.name}</h3>
                                        <div class="inline-flex items-center gap-1 bg-red-50 text-psycho-action text-[10px] px-1.5 py-0.5 rounded border border-red-100 mb-1"><span>Save ‚Çπ${savings} with Squad</span></div>
                                    </div>
                                    <div class="flex items-end justify-between mt-1">
                                        <div class="relative top-1"><div class="text-[10px] text-slate-400 font-medium mb-[-2px]">Group Price</div><div class="flex items-baseline gap-0.5 text-psycho-action"><span class="text-xs font-bold">‚Çπ</span><span class="text-2xl font-black tracking-tighter">${p.price5}</span></div></div>
                                        <div class="bg-gradient-to-r from-red-500 to-psycho-action text-white px-3 py-1.5 rounded-lg shadow-md flex flex-col items-center justify-center min-w-[70px]"><span class="text-[10px] font-medium opacity-90 leading-none mb-0.5">Limited</span><span class="text-xs font-black leading-none uppercase">Grab</span></div>
                                    </div>
                                </div>
                            </div>`;
                        }).join('')}
                    </div>
                    <div class="text-center pb-8 pt-4">
                        <button onclick="window.goToAdmin()" class="text-slate-300 text-[10px] uppercase font-bold tracking-widest hover:text-slate-500 transition-colors">Partner Login</button>
                    </div>
                </div>`;
            initCardTilt();
        }

        function renderGroup(el) {
            if (state.timerInterval) clearInterval(state.timerInterval);
            const g = state.groups[state.currentGroupId]; 
            if (!g) {
                el.innerHTML = `<div class="flex items-center justify-center h-screen flex-col"><div class="animate-spin w-8 h-8 border-4 border-slate-200 border-t-psycho-action rounded-full mb-4"></div><div class="text-slate-400 font-bold">Searching Global Database...</div></div>`;
                return;
            }
            const p = PRODUCTS.find(x => x.id === g.productId);
            const members = state.members[g.id] || [];
            const count = members.length;
            const needed = Math.max(0, 2 - count);
            const isMeJoined = members.some(m => m.name === state.user.name && m.phone === state.user.phone);

            el.innerHTML = `
                <div class="fade-in bg-slate-50 min-h-screen pb-40 font-sans">
                    <div class="bg-psycho-action text-white h-[68px] sticky top-0 z-50 px-4 flex justify-between items-center shadow-none">
                        <div class="flex items-center gap-3 cursor-pointer pt-safe" onclick="window.goHome()"><i data-lucide="arrow-left" size="24" class="text-white"></i><span class="font-black text-lg tracking-wide text-white">Our Gang</span></div>
                        <div class="font-mono font-bold text-lg tracking-widest text-white tabular-nums pt-safe" id="header-timer"></div>
                    </div>

                    <div class="p-4">
                        <div class="flex flex-col items-center mb-6 mt-2 animate-in fade-in-up duration-300">
                            <h1 class="text-2xl font-black text-slate-900 leading-none mb-1 tracking-tight">${p.name}</h1>
                            <p class="text-sm font-bold text-slate-400">${p.nameTe} ‚Ä¢ ${p.unit} Bundle</p>
                        </div>
                        
                        <div class="card-modern p-4 mb-6 tilt-card">
                            <div class="space-y-4 mb-6">
                                <div class="flex justify-between items-center ${count < 2 ? 'opacity-100' : 'opacity-40 grayscale'} transition-all">
                                    <div class="flex items-center gap-3"><div class="w-6 h-6 rounded-full bg-slate-200 text-slate-600 flex items-center justify-center text-xs font-bold">1</div><span class="text-sm font-bold text-slate-600">Solo Price</span></div>
                                    <span class="text-base font-bold text-slate-900">‚Çπ${p.price1}</span>
                                </div>
                                <div class="flex justify-between items-center ${count >= 2 ? 'scale-105' : ''} transition-all p-3 -mx-3 rounded-xl ${count >= 2 ? 'bg-psycho-rewardBg border border-psycho-reward shadow-sm' : ''}">
                                    <div class="flex items-center gap-3"><div class="w-6 h-6 rounded-full ${count >= 2 ? 'bg-psycho-reward text-black' : 'bg-slate-200 text-slate-600'} flex items-center justify-center text-xs font-bold">2+</div><span class="text-sm font-black ${count >= 2 ? 'text-psycho-rewardText' : 'text-slate-400'}">Group Price</span></div>
                                    <span class="text-2xl font-black ${count >= 2 ? 'text-psycho-rewardText' : 'text-slate-300'}">‚Çπ${p.price5}</span>
                                </div>
                            </div>
                            <div class="text-center">
                                <div class="text-3xl font-black text-slate-900 mb-1">${count} <span class="text-slate-300 text-2xl">/</span> 2+</div>
                                <div class="text-sm font-bold ${count < 2 ? 'text-psycho-action' : 'text-psycho-rewardText'}">${count < 2 ? `Need ${needed} more to unlock ‚Çπ${p.price5}` : 'üéâ LOWEST PRICE UNLOCKED!'}</div>
                            </div>
                        </div>

                        <div class="space-y-3 mb-8">
                            <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4">Squad Members</h3>
                            ${(() => {
                                const totalSlots = Math.max(members.length + 1, 2); 
                                return Array(totalSlots).fill(0).map((_, i) => {
                                    const member = members[i];
                                    if (member) {
                                        const isMe = (state.user.name && member.name === state.user.name && member.phone === state.user.phone);
                                        return `<div class="bg-white border border-slate-100 p-4 rounded-2xl shadow-sm mb-3">
                                            <div class="flex items-center justify-between mb-3">
                                                <div class="flex items-center gap-3">
                                                    <div class="w-10 h-10 rounded-full ${isMe ? 'bg-green-100 text-green-700' : 'bg-slate-100 text-slate-500'} flex items-center justify-center font-bold text-sm border-2 border-white shadow-sm">${member.name[0]}</div>
                                                    <div><div class="text-sm font-bold text-slate-900 flex items-center gap-2">${isMe ? 'YOU' : member.name} ${member.isLeader ? '<span class="text-[9px] bg-yellow-100 text-yellow-800 px-1 rounded border border-yellow-200 font-bold uppercase">Leader</span>' : ''}</div><div class="text-xs text-slate-400 font-medium">${(member.quantity * p.baseWeight).toFixed(1)} ${p.weightUnit} confirmed</div></div>
                                                </div>
                                            </div>
                                        </div>`;
                                    } else {
                                        if (isMeJoined) {
                                            return `<div onclick="window.shareGroupLink()" class="flex items-center justify-between bg-white border-2 border-dashed border-slate-300 p-4 rounded-2xl cursor-pointer hover:bg-slate-50 transition-all group mb-3">
                                                <div class="flex items-center gap-3 opacity-60 group-hover:opacity-100 transition-opacity">
                                                    <div class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-400"><i data-lucide="share-2" size="18"></i></div>
                                                    <span class="text-sm font-bold text-slate-400">Waiting for friend...</span>
                                                </div>
                                                <div class="text-xs font-bold text-slate-500 bg-slate-100 px-2 py-1 rounded border border-slate-200">Invite via Link</div>
                                            </div>`;
                                        } else {
                                            return `<div onclick="window.openAddMemberModal('${g.id}')" class="flex items-center justify-between bg-slate-50 border-2 border-dashed border-psycho-action/30 p-4 rounded-2xl cursor-pointer hover:bg-white hover:border-psycho-action transition-all group mb-3 animate-pulse">
                                                <div class="flex items-center gap-3">
                                                    <div class="w-10 h-10 rounded-full bg-psycho-action/10 text-psycho-action flex items-center justify-center"><i data-lucide="user-plus" size="18"></i></div>
                                                    <span class="text-sm font-bold text-slate-900">Open Spot</span>
                                                </div>
                                                <div class="text-xs font-bold text-white bg-psycho-action px-3 py-1.5 rounded-lg shadow-sm">Join Squad</div>
                                            </div>`;
                                        }
                                    }
                                }).join('');
                            })()}
                        </div>
                    </div>

                    <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 p-4 pb-6 z-50 shadow-[0_-10px_40px_rgba(0,0,0,0.05)]">
                        <div class="max-w-md mx-auto">
                            ${count < 2 ? `
                            <div class="mb-3 text-center bg-psycho-urgencyBg text-psycho-urgency text-xs font-black uppercase py-1 rounded-lg border border-psycho-urgency/20 animate-pulse">
                                ‚ö† 1 Person Away from Deal
                            </div>
                            <button onclick="window.shareToWhatsApp()" class="w-full bg-[#25D366] text-white h-[56px] flex items-center justify-center rounded-2xl font-black text-lg shadow-xl btn-press gap-2 mb-3">
                                <i data-lucide="message-circle" size="24"></i> <span>Share on WhatsApp</span>
                            </button>
                            <button onclick="window.shareGroupLink()" class="w-full bg-slate-900 text-white h-[56px] flex items-center justify-center rounded-2xl font-bold text-base shadow-lg btn-press gap-2">
                                <i data-lucide="copy" size="20"></i> <span>Copy Link</span>
                            </button>
                            ` : `
                            ${isMeJoined ? `
                            <button onclick="window.confirmOrderWhatsApp()" class="w-full bg-green-600 text-white h-[56px] flex items-center justify-center rounded-2xl font-black text-lg shadow-xl btn-press gap-2">
                                <i data-lucide="check-circle" size="20"></i> <span>Confirm Order via WhatsApp</span>
                            </button>
                            ` : `
                            <div class="text-center text-slate-400 font-bold mb-2">Deal Unlocked! Join to buy.</div>
                            `}
                            `}
                        </div>
                    </div>
                </div>
            `;
            
            // Re-init timer
            const timerEl = document.getElementById('header-timer');
            if(timerEl) {
                const tick = () => {
                   const diff = Math.max(0, g.expiresAt - Date.now());
                   const h = Math.floor(diff / 3600000);
                   const m = Math.floor((diff % 3600000) / 60000);
                   timerEl.innerText = `${h}:${m<10?'0'+m:m}`;
                };
                state.timerInterval = setInterval(tick, 1000); tick();
            }
            initCardTilt();
        }

        // --- 9. INIT ---
        loadLocalData();
        initAuth();
        initCardTilt();
        
        window.addEventListener('popstate', () => {
            const params = new URLSearchParams(location.search);
            const gid = params.get('group');
            if(gid) window.openGroup(gid); else window.goHome();
        });
        
        render();

    </script>
</body>
</html>
