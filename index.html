<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover" />
    <title>JODO</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üçÖ</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    
    <!-- ‚úÖ FIREBASE INITIALIZATION (USING ENVIRONMENT DEFAULTS) -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import { 
        getAuth, 
        signInWithCustomToken, 
        signInAnonymously, 
        onAuthStateChanged 
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import {
        getFirestore,
        doc,
        setDoc,
        getDoc,
        getDocs,
        updateDoc,
        onSnapshot,
        collection,
        runTransaction,
        serverTimestamp,
        query,
        where
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

      // ‚úÖ FIX: Use dynamic environment config to avoid "Invalid API Key" errors
      const firebaseConfig = JSON.parse(__firebase_config);
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
      const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

      // üî• MANDATORY AUTH WORKFLOW
      const initAuth = async () => {
        try {
          if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
            await signInWithCustomToken(auth, __initial_auth_token);
          } else {
            await signInAnonymously(auth);
          }
        } catch (err) {
          console.error("Firebase Auth Failed:", err);
        }
      };

      // üî• Expose globally
      window.db = db;
      window.auth = auth;
      window.appId = appId; 
      
      window.fs = {
        doc,
        setDoc,
        getDoc,
        getDocs,
        updateDoc,
        onSnapshot,
        collection,
        runTransaction,
        serverTimestamp,
        query,
        where
      };
      
      console.log("üöÄ JODO v3.11 - JOIN ‚â† ORDER DECOUPLING APPLIED");
      
      onAuthStateChanged(auth, (user) => {
        if (user) {
          window.FIREBASE_READY = true;
          window.dispatchEvent(new Event("firebase-ready"));
        }
      });

      initAuth();
    </script>

    <script>
        // Global Error Handler
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            const app = document.getElementById('app');
            if (msg.includes("ResizeObserver")) return;
            
            if (app) {
                app.innerHTML = `
                    <div style="padding: 20px; color: #DC2626; font-family: sans-serif; height: 100vh; display: flex; flex-direction: column; justify-content: center; text-align: center;">
                        <h2 style="font-weight: bold; font-size: 1.25rem;">Connection Error</h2>
                        <p style="margin-top: 10px; background: #fee2e2; padding: 10px; border-radius: 8px; font-family: monospace; text-align: left;">${msg}</p>
                        <button onclick="window.location.reload()" style="margin-top: 20px; padding: 10px 20px; background: #333; color: #fff; border-radius: 8px; border: none;">Retry</button>
                    </div>
                `;
            }
            return false;
        };

        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        jodo: {
                            base: '#FFFFFF',
                            textPrimary: '#111827',
                            textSecondary: '#4B5563',
                            ctaPrimary: '#15803D',
                            ctaSuccess: '#15803D',      
                            bonus: '#F3F4F6',             
                            bonusText: '#374151',         
                            urgency: '#4B5563',           
                            border: '#E5E7EB',            
                            error: '#DC2626',             
                        }
                    },
                    fontFamily: {
                        sans: ['-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'sans-serif'],
                    },
                    animation: {
                        'fade-in-up': 'fadeInUp 0.5s ease-out',
                        'slide-up': 'slideUp 0.3s ease-out forwards',
                        'pop': 'popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)'
                    },
                    keyframes: {
                        fadeInUp: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
                        slideUp: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
                        popIn: { '0%': { opacity: '0', transform: 'scale(0.9)' }, '100%': { opacity: '1', transform: 'scale(1)' } }
                    }
                }
            }
        }
    </script>
    <style>
        body { background: #FFFFFF; color: #111827; -webkit-tap-highlight-color: transparent; min-height: 100dvh; display: flex; justify-content: center; margin: 0; overscroll-behavior-y: none; }
        #app { width: 100%; max-width: 448px; background: #FFFFFF; min-height: 100dvh; position: relative; overflow-y: auto; display: flex; flex-direction: column; box-shadow: 0 0 20px rgba(0,0,0,0.05); }
        .btn-press { transition: opacity 0.1s; cursor: pointer; user-select: none; }
        .btn-press:active:not(:disabled) { opacity: 0.8; }
        .card-modern { background: #FFFFFF; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid #E5E7EB; }
        .glass-header { background: rgba(255, 255, 255, 0.98); border-bottom: 1px solid #E5E7EB; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .pt-safe { padding-top: env(safe-area-inset-top); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .price-anchor { color: #15803D; font-weight: 700; letter-spacing: -0.01em; }
        
        .spinner-fallback {
            width: 32px;
            height: 32px;
            border: 3px solid #E5E7EB;
            border-top: 3px solid #15803D;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="antialiased">

    <div id="app">
        <div style="height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #fff; color: #333;">
            <div class="spinner-fallback"></div>
            <div style="margin-top: 16px; font-family: sans-serif; font-size: 14px; font-weight: 600;">Connecting to JODO...</div>
        </div>
    </div>

    <div id="modal-overlay" class="fixed inset-0 bg-black/60 hidden z-[60] flex items-end justify-center backdrop-blur-sm transition-opacity duration-300">
        <div id="modal-content" class="bg-white w-full max-w-[448px] rounded-t-[1.5rem] shadow-2xl transform transition-transform duration-300 translate-y-full max-h-[95dvh] flex flex-col overflow-hidden pb-safe"></div>
    </div>

    <div id="toast" class="fixed top-24 left-1/2 -translate-x-1/2 bg-gray-900 text-white px-6 py-3 rounded-full text-sm font-medium shadow-xl hidden z-[90] flex items-center gap-2 pointer-events-none pt-safe text-center w-max max-w-[90%]"></div>

    <script type="module">
        const { db, fs, auth } = window;
        const { doc, setDoc, getDoc, getDocs, updateDoc, onSnapshot, collection, runTransaction, serverTimestamp, query, where } = fs;

        // ==========================================
        // APP LOGIC
        // ==========================================

        var JODO_INITIALIZED = false;
        var renderScheduled = false;
        var COMPANY_PHONE = "918500742671"; 
        
        var BASE_URL;
        try {
            var _urlObj = new URL(window.location.href);
            _urlObj.search = '';
            _urlObj.hash = '';
            BASE_URL = _urlObj.toString();
            if (BASE_URL.endsWith('index.html')) BASE_URL = BASE_URL.replace('index.html', '');
            if (!BASE_URL.endsWith('/') && !BASE_URL.match(/\.[a-zA-Z0-9]+$/)) BASE_URL += '/';
        } catch(e) {
            BASE_URL = window.location.origin + "/";
        }

        var PUBLIC_SHARE_URL = "https://satyanarayanagaraga.github.io/jodo-mvp/";
        var MIN_GROUP_SIZE = 2; 
        var GROUP_MAX_KG = 20; 

        var PRODUCT_LIMITS = { tomato: 10, onion: 10, chilli: 2 };

        var PRODUCTS = [
            { id: 'tomato', name: 'Fresh Tomatoes', nameTe: '‡∞ü‡∞Æ‡∞æ‡∞ü‡∞æ‡∞≤‡±Å', unit: '1kg', baseWeight: 1, step: 0.25, weightUnit: 'kg', price1: 40, price5: 20, icon: 'circle-dot', imageSrc: 'https://images.unsplash.com/photo-1592924357228-91a4daadcfea?auto=format&fit=crop&w=800&q=80' },
            { id: 'onion', name: 'Red Onions', nameTe: '‡∞â‡∞≤‡±ç‡∞≤‡∞ø‡∞™‡∞æ‡∞Ø‡∞≤‡±Å', unit: '1kg', baseWeight: 1, step: 0.25, weightUnit: 'kg', price1: 60, price5: 35, icon: 'layers', imageSrc: 'https://images.unsplash.com/photo-1618512496248-a07fe83aa8cb?auto=format&fit=crop&w=800&q=80' },
            { id: 'chilli', name: 'Green Chillies', nameTe: '‡∞™‡∞ö‡±ç‡∞ö‡∞ø ‡∞Æ‡∞ø‡∞∞‡∞™‡∞ï‡∞æ‡∞Ø‡∞≤‡±Å', unit: '250g', baseWeight: 0.25, step: 0.25, weightUnit: 'g', price1: 80, price5: 50, icon: 'zap', imageSrc: 'https://images.unsplash.com/photo-1577218349272-37eb645284eb?auto=format&fit=crop&w=800&q=80' }
        ];

        var GROUPS_KEY = 'jodo_groups_joined_v1';
        
        function formatQty(qty) {
            return qty < 1 ? (qty * 1000).toFixed(0) + 'g' : qty + 'kg';
        }

        function getPrice(product, isUnlocked) {
            return isUnlocked ? product.price5 : product.price1;
        }
        
        function getTodayCutoffTimestamp() {
            const now = new Date();
            now.setHours(21, 0, 0, 0); 
            return now.getTime();
        }

        function isPastCutoff() {
            return Date.now() > getTodayCutoffTimestamp();
        }
        
        var cutoffTimerInterval = null;

        function formatRemaining(ms) {
            if (ms <= 0) return "Closed";
            const totalSeconds = Math.floor(ms / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            if (hours > 0) return `${hours}h ${minutes}m left`;
            return `${minutes}m ${seconds}s left`;
        }

        function startCutoffTimer(updateFn) {
            if (cutoffTimerInterval) clearInterval(cutoffTimerInterval);
            const tick = () => {
                const now = Date.now();
                const cutoff = getTodayCutoffTimestamp();
                const remaining = cutoff - now;
                updateFn(remaining);
            };
            tick(); 
            cutoffTimerInterval = setInterval(tick, 1000);
        }

        function getMillis(ts) {
            if (!ts) return 0;
            if (typeof ts === 'number') return ts;
            if (ts.toMillis) return ts.toMillis();
            return 0;
        }

        var state = { 
            view: 'home', 
            mode: 'HOME', 
            currentGroupId: null, 
            groups: {}, 
            members: {}, 
            user: { name: '', phone: '', joinedGroupIds: [] }, 
            cart: {}, 
            unsubGroup: null,
            unsubMembers: null,
            homeListeners: [],
            invitingGroup: null,
            pendingJoinId: null
        };

        var IS_JOIN_LINK = false;
        var JOIN_SESSION_PHONE = null;

        function loadData() {
            try {
                state.user.name = localStorage.getItem('jodo_user_name') || '';
                state.user.phone = localStorage.getItem('jodo_user_phone') || '';
                const savedGroups = localStorage.getItem(GROUPS_KEY);
                state.user.joinedGroupIds = savedGroups ? JSON.parse(savedGroups) : [];
                if (state.user.phone) JOIN_SESSION_PHONE = state.user.phone;
            } catch(e) {}
        }

        function saveUser(name, phone) {
            state.user.name = name;
            state.user.phone = phone;
            localStorage.setItem('jodo_user_name', name);
            localStorage.setItem('jodo_user_phone', phone);
            JOIN_SESSION_PHONE = phone;
        }

        window.logout = function() {
            localStorage.removeItem('jodo_user_name');
            localStorage.removeItem('jodo_user_phone');
            state.user = { name: '', phone: '', joinedGroupIds: [] };
            JOIN_SESSION_PHONE = null;
            window.location.reload();
        }

        function saveJoinedGroup(gid) {
            if (!state.user.joinedGroupIds.includes(gid)) {
                state.user.joinedGroupIds.push(gid);
                localStorage.setItem(GROUPS_KEY, JSON.stringify(state.user.joinedGroupIds));
                listenToGroupForHome(gid);
            }
        }

        function toast(msg, icon) { 
            const t = document.getElementById('toast'); 
            const iconColor = icon === 'share-2' ? 'text-white' : 'text-green-400';
            t.className = "fixed top-24 left-1/2 -translate-x-1/2 bg-gray-900 text-white px-6 py-3 rounded-full text-sm font-medium shadow-xl hidden z-[90] flex items-center gap-2 pointer-events-none pt-safe text-center w-max max-w-[90%]";
            t.innerHTML = `<i data-lucide="${icon}" size="16" class="${iconColor}"></i> ${msg}`; 
            t.classList.remove('hidden'); 
            if(window.lucide) window.lucide.createIcons(); 
            setTimeout(() => t.classList.add('hidden'), 4000); 
        }

        function triggerVibration() { 
            if (navigator.vibrate) navigator.vibrate(10); 
        }

        function resetActionButton(btn, html) {
            if(!btn) return;
            btn.disabled = false;
            btn.innerHTML = html;
            btn.classList.remove('opacity-75', 'cursor-not-allowed');
        }

        function createNodeFromHTML(html) { 
            const t = document.createElement('template'); 
            t.innerHTML = html.trim(); 
            return t.content.firstElementChild; 
        }
        
        function showModalNode(node) { 
            const overlay = document.getElementById('modal-overlay');
            const content = document.getElementById('modal-content');
            content.innerHTML = ''; content.appendChild(node); 
            overlay.classList.remove('hidden'); 
            setTimeout(() => { 
                overlay.classList.remove('opacity-0'); 
                content.classList.remove('translate-y-full'); 
            }, 10);
            if(node.querySelector('input')) node.querySelector('input').focus(); 
            if(window.lucide) window.lucide.createIcons(); 
        }

        window.closeModal = () => {
            const overlay = document.getElementById('modal-overlay');
            const content = document.getElementById('modal-content');
            content.classList.add('translate-y-full');
            overlay.classList.add('opacity-0');
            setTimeout(() => { 
                overlay.classList.add('hidden'); 
                content.innerHTML = ''; 
            }, 300);
        };

        function safeVal(el) { return (el && el.value) ? el.value.trim() : ''; }

        function initCardTilt() {
            if (window.matchMedia("(pointer: coarse)").matches) return;
            const cards = document.querySelectorAll('.tilt-card');
            cards.forEach(card => {
                card.addEventListener('mousemove', (e) => {
                    const rect = card.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    const rotateX = ((y - rect.height/2) / (rect.height/2)) * -3; 
                    const rotateY = ((x - rect.width/2) / (rect.width/2)) * 3;
                    card.style.transform = `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg) scale3d(1.01, 1.01, 1.01)`;
                });
                card.addEventListener('mouseleave', () => {
                    card.style.transform = `perspective(1000px) rotateX(0deg) rotateY(0deg) scale3d(1, 1, 1)`;
                });
            });
        }

        window.shareGroup = function(groupId, isUnlocked) {
            const currentUrl = `${PUBLIC_SHARE_URL}?group=${groupId}`;
            const text = isUnlocked 
                ? `‡∞à‡∞∞‡±ã‡∞ú‡±Å ‡∞ó‡±ç‡∞∞‡±Ç‡∞™‡±ç ‡∞°‡±Ä‡∞≤‡±ç ‡∞Ö‡∞®‡±ç‚Äå‡∞≤‡∞æ‡∞ï‡±ç ‡∞Ö‡∞Ø‡±ç‡∞Ø‡∞ø‡∞Ç‡∞¶‡∞ø ‚úÖ\n\n‡∞Æ‡∞æ ‡∞ó‡±ç‡∞∞‡±Ç‡∞™‡±ç‚Äå‡∞≤‡±ã ‡∞Ö‡∞Ç‡∞¶‡∞∞‡±Ç ‡∞§‡∞ï‡±ç‡∞ï‡±Å‡∞µ ‡∞ß‡∞∞‡∞ï‡±á ‡∞ï‡±ä‡∞Ç‡∞ü‡±Å‡∞®‡±ç‡∞®‡∞æ‡∞∞‡±Å\n‡∞á‡∞™‡±ç‡∞™‡±Å‡∞°‡±á ‡∞ú‡∞æ‡∞Ø‡∞ø‡∞®‡±ç ‡∞Ö‡∞Ø‡∞ø‡∞§‡±á ‡∞®‡±Ä‡∞ï‡±Ç ‡∞Ö‡∞¶‡±á ‡∞∞‡±á‡∞ü‡±ç`
                : `‡∞à‡∞∞‡±ã‡∞ú‡±Å ‡∞Ü‡∞∞‡±ç‡∞°‡∞∞‡±ç ‡∞Æ‡±ä‡∞¶‡∞≤‡±à‡∞Ç‡∞¶‡∞ø\n\n‡∞á‡∞¶‡∞ø ‡∞Ü‡∞ó‡∞ø‡∞™‡±ã‡∞§‡±á ‡∞Ö‡∞Ç‡∞¶‡∞∞‡∞Ç ‡∞∑‡∞æ‡∞™‡±Å ‡∞ß‡∞∞‡∞ï‡±á ‡∞ï‡±ä‡∞®‡∞æ‡∞≤‡∞ø\n‡∞®‡±á‡∞®‡±á ‡∞Æ‡±ä‡∞¶‡∞≤‡±Å‡∞™‡±Ü‡∞ü‡±ç‡∞ü‡∞æ‡∞®‡±Å, ‡∞®‡±Å‡∞µ‡±ç‡∞µ‡±á ‡∞ö‡∞ø‡∞µ‡∞∞‡∞ø‡∞µ‡∞æ‡∞°‡±Å`;
                
            const waLink = `https://wa.me/?text=${encodeURIComponent(text + "\n\nüëâ " + currentUrl)}`;
            window.open(waLink, '_blank');
        };

        window.updateCart = function(productId, delta) {
            if (isPastCutoff()) { toast("Orders closed for today", "clock"); return; }
            if (!state.cart[productId]) state.cart[productId] = 0;
            let newQty = state.cart[productId] + delta;
            newQty = Math.round(newQty * 100) / 100;
            if (newQty < 0) newQty = 0;
            const maxLimit = PRODUCT_LIMITS[productId] || Infinity;
            if (newQty > maxLimit) { toast(`Limit ${maxLimit}kg for this item`, "alert-circle"); return; }
            if (newQty === 0) delete state.cart[productId];
            else state.cart[productId] = newQty;
            triggerVibration();
            safeRender();
        };

        window.openJoinFlow = function(gid) {
            const g = state.groups[gid] || state.invitingGroup;
            if (!g) { toast("Loading group...", "loader"); return; }
            if (isPastCutoff()) { toast("Orders closed for today", "clock"); return; }
            window.openCheckoutModal(gid);
        };

        window.openCheckoutModal = function(joinGroupId = null) {
            if (isPastCutoff()) { toast("Orders closed.", "clock"); return; }
            const existingMembers = joinGroupId ? (state.members[joinGroupId] || []) : [];
            const me = existingMembers.find(m => m.phone === JOIN_SESSION_PHONE);
            const isEditing = joinGroupId && JOIN_SESSION_PHONE && me;

            if (isEditing) {
                state.cart = { ...(me.cart || {}) };
                if (Object.keys(state.cart).length === 0 && me.quantity) state.cart['tomato'] = me.quantity;
            } 
            
            if (!joinGroupId && Object.keys(state.cart).length === 0) {
                toast("Please select items first", "shopping-bag");
                return;
            }

            const btnText = isEditing ? "Update Order" : (joinGroupId ? "Join Group" : "Start saving today");
            let totalJodo = 0;
            let totalMarket = 0;

            const itemsHtml = PRODUCTS.map(p => {
                const qty = state.cart[p.id] || 0;
                const itemTotalJodo = Math.round(qty * p.price5);
                const itemTotalMarket = Math.round(qty * p.price1);
                if (qty > 0) { totalJodo += itemTotalJodo; totalMarket += itemTotalMarket; }
                const isSelected = qty > 0;
                
                return `
                <div class="flex items-center justify-between py-3 border-b border-gray-50 last:border-0" id="row-${p.id}">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 bg-gray-50 rounded-lg overflow-hidden border border-gray-200 shrink-0 relative transition-all ${isSelected ? '' : 'opacity-60 grayscale'}">
                            <img src="${p.imageSrc}" class="w-full h-full object-cover">
                        </div>
                        <div class="flex flex-col">
                            <div class="font-bold text-gray-800 text-sm">${p.name}</div>
                            <div class="text-xs text-gray-500 font-medium" id="checkout-price-${p.id}">
                                ${isSelected ? `<span class="text-green-700 font-bold">‚Çπ${itemTotalJodo}</span> <span class="line-through text-gray-300 text-[10px]">‚Çπ${itemTotalMarket}</span>` : `Rate: ‚Çπ${p.price5}/kg`}
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center gap-3 bg-white border border-gray-200 rounded-lg p-1 shadow-sm">
                        <button onclick="updateCart('${p.id}', -${p.step}); renderCheckoutTotal();" class="w-8 h-8 flex items-center justify-center bg-white rounded-md text-gray-600 active:scale-90 transition-transform"><i data-lucide="minus" size="14"></i></button>
                        <span class="w-10 text-center text-sm font-bold text-gray-800 tabular-nums" id="checkout-qty-${p.id}">${qty > 0 ? formatQty(qty) : '0'}</span>
                        <button onclick="updateCart('${p.id}', ${p.step}); renderCheckoutTotal();" class="w-8 h-8 flex items-center justify-center bg-jodo-ctaPrimary text-white rounded-md shadow-sm active:scale-90 transition-transform"><i data-lucide="plus" size="14"></i></button>
                    </div>
                </div>`;
            }).join('');

            const node = createNodeFromHTML(`
                <div class="flex flex-col h-[90vh] bg-white relative rounded-t-[1.5rem] overflow-hidden font-sans">
                    <div class="bg-white px-5 py-4 flex items-center justify-between border-b border-gray-100 shrink-0 z-20">
                        <div class="flex items-center gap-2 text-green-700">
                            <i data-lucide="sparkles" size="20"></i>
                            <h3 class="font-black text-xl tracking-tight">Smart Choice</h3>
                        </div>
                        <button id="close-modal" class="p-2 bg-gray-50 rounded-full text-gray-500 hover:bg-gray-100 transition-colors"><i data-lucide="x" size="20"></i></button>
                    </div>
                    <div class="p-5 overflow-y-auto flex-1 relative bg-gray-50/30">
                        <div class="bg-white border border-green-200 rounded-xl p-6 mb-6 shadow-sm text-center relative" id="savings-banner">
                            <div class="text-gray-500 text-xs font-bold uppercase tracking-wider mb-2">Total Savings</div>
                            <div class="text-6xl font-black text-green-600 tracking-tighter mb-3 leading-none" id="summary-savings">‚Çπ${Math.round(totalMarket - totalJodo)}</div>
                            <div class="bg-gray-50 rounded-lg py-2 px-3 border border-gray-100 inline-block">
                                <div class="text-xs text-gray-500 font-medium">Buying elsewhere is a <span class="text-red-700 font-bold">loss of ‚Çπ<span id="loss-amount">${Math.round(totalMarket - totalJodo)}</span></span></div>
                            </div>
                        </div>
                        <div class="bg-white border border-gray-200 rounded-xl p-4 mb-6 shadow-sm">
                            <div class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Select Items</div>
                            ${itemsHtml}
                            <div class="flex justify-between items-center pt-3 mt-2 border-t border-gray-100">
                                <span class="font-bold text-gray-900">Total To Pay</span>
                                <span class="font-black text-xl text-gray-900" id="checkout-total">‚Çπ${Math.round(totalJodo)}</span>
                            </div>
                        </div>
                        <div class="space-y-4 mb-4">
                            <div class="relative"><div class="absolute inset-y-0 left-0 pl-4 flex items-center text-gray-400"><i data-lucide="user" size="18"></i></div><input id="inp-name" value="${state.user.name}" class="w-full bg-white border border-gray-300 py-3 pl-12 pr-4 rounded-lg outline-none focus:border-green-600 focus:ring-1 focus:ring-green-600" placeholder="Your Name"></div>
                            <div class="relative"><div class="absolute inset-y-0 left-0 pl-4 flex items-center text-gray-400"><i data-lucide="phone" size="18"></i></div><input id="inp-phone" value="${state.user.phone}" type="tel" class="w-full bg-white border border-gray-300 py-3 pl-12 pr-4 rounded-lg outline-none focus:border-green-600 focus:ring-1 focus:ring-green-600" placeholder="Mobile Number"></div>
                        </div>
                    </div>
                    <div class="bg-white border-t border-gray-100 p-4 shrink-0 pb-safe z-20">
                        <div class="text-center text-[11px] text-gray-500 font-medium mb-2">Pay on delivery ‚Ä¢ Cash or UPI</div>
                        <button id="action-btn" class="w-full bg-jodo-ctaPrimary text-white h-[56px] rounded-xl font-bold text-lg shadow-sm flex items-center justify-center gap-2 active:scale-[0.99] transition-all btn-press">
                            <span>${btnText}</span>
                        </button>
                    </div>
                </div>
            `);
            showModalNode(node);

            window.renderCheckoutTotal = () => {
                let totalJodo = 0; let totalMarket = 0;
                PRODUCTS.forEach(p => {
                    const qty = state.cart[p.id] || 0;
                    if (qty > 0) { totalJodo += Math.round(qty * p.price5); totalMarket += Math.round(qty * p.price1); }
                    const qtyEl = document.getElementById(`checkout-qty-${p.id}`);
                    if(qtyEl) qtyEl.innerText = qty > 0 ? formatQty(qty) : '0';
                    const priceEl = document.getElementById(`checkout-price-${p.id}`);
                    if(priceEl) priceEl.innerHTML = qty > 0 ? `<span class="text-green-700 font-bold">‚Çπ${Math.round(qty * p.price5)}</span> <span class="line-through text-gray-300 text-[10px]">‚Çπ${Math.round(qty * p.price1)}</span>` : `Rate: ‚Çπ${p.price5}/kg`;
                });
                const savings = totalMarket - totalJodo;
                const savEl = document.getElementById('summary-savings'); if(savEl) savEl.innerText = `‚Çπ${Math.round(savings)}`;
                const lossEl = document.getElementById('loss-amount'); if(lossEl) lossEl.innerText = `${Math.round(savings)}`;
                const totEl = document.getElementById('checkout-total'); if(totEl) totEl.innerText = `‚Çπ${Math.round(totalJodo)}`;
            };

            node.querySelector('#close-modal').addEventListener('click', window.closeModal);
            
            const actionBtn = node.querySelector('#action-btn');
            actionBtn.onclick = async () => {
                if (!navigator.onLine) { toast("No internet connection", "wifi-off"); return; }
                const name = safeVal(node.querySelector('#inp-name'));
                const phone = safeVal(node.querySelector('#inp-phone'));
                if (!name || !/^[6-9]\d{9}$/.test(phone)) { toast('Please enter name and valid mobile number', 'alert-circle'); return; }
                
                // Freeze the cart state for the transaction
                const cartPayload = { ...state.cart };
                
                if (actionBtn.disabled) return;
                actionBtn.disabled = true;
                actionBtn.innerHTML = `<div class="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>`;
                saveUser(name, phone);
                
                const finalGroupId = joinGroupId || doc(collection(db, 'artifacts', window.appId, 'public', 'data', "groups")).id;
                
                try {
                    if (!joinGroupId) {
                        const groupData = { id: finalGroupId, ownerName: name, ownerPhone: phone, expiresAt: getTodayCutoffTimestamp(), createdAt: serverTimestamp(), type: 'multi', maxKg: GROUP_MAX_KG, pendingKg: 0, usedKg: 0, memberCount: 0, unlockedAt: null };
                        await setDoc(doc(db, 'artifacts', window.appId, 'public', 'data', "groups", finalGroupId), groupData);
                    }

                    let didUnlock = false;
                    await runTransaction(db, async (transaction) => {
                        const groupRef = doc(db, 'artifacts', window.appId, 'public', 'data', "groups", finalGroupId);
                        const groupSnap = await transaction.get(groupRef);
                        if (!groupSnap.exists()) throw "GROUP_NOT_FOUND";
                        
                        const gData = groupSnap.data();
                        const memberRef = doc(db, 'artifacts', window.appId, 'public', 'data', "groups", finalGroupId, "members", phone);
                        const memberSnap = await transaction.get(memberRef); 

                        // üîß PATCH 1: Allow join without cart
                        const isNewMember = !memberSnap.exists();
                        const currentCartQty = Object.values(cartPayload).reduce((a,b) => a+b, 0);
                        const isJoinOnly = isNewMember && currentCartQty === 0;

                        // üîß PATCH 2: Increment memberCount on join, but guard logic
                        let newMemberCount = gData.memberCount || 0;
                        if (isNewMember) {
                            newMemberCount += 1;
                        }

                        let newPending = gData.pendingKg || 0;
                        let newUsed = gData.usedKg || 0;
                        let newUnlockedAt = gData.unlockedAt;

                        // Guard ALL inventory/order logic
                        if (!isJoinOnly) {
                            let oldQty = 0;
                            if (memberSnap.exists()) {
                                const oldData = memberSnap.data();
                                oldQty = Object.values(oldData.cart || {}).reduce((a,b)=>a+b, 0) + (oldData.quantity || 0); 
                            }
                            const qtyChange = currentCartQty - oldQty;
                            const maxKg = gData.maxKg || GROUP_MAX_KG; 
                            
                            // Enforce capacity only for adding items
                            if (qtyChange > 0 && (newPending + newUsed + qtyChange) > maxKg) {
                                throw `Sold Out! Only ${Math.max(0, maxKg - (newPending + newUsed))}kg left.`;
                            }

                            if (newUnlockedAt) {
                                newUsed += qtyChange;
                            } else {
                                newPending += qtyChange;
                            }

                            // üîß PATCH 2: Only trigger unlock if a cart exists or members reached goal
                            if (!newUnlockedAt && newMemberCount >= MIN_GROUP_SIZE && currentCartQty > 0) {
                                didUnlock = true;
                                newUnlockedAt = serverTimestamp();
                                // üîß PATCH 3: We still move pending to used ONLY when unlocking is finally triggered by an order
                                newUsed += newPending;
                                newPending = 0;
                            }
                        }

                        // Write changes back to Firestore
                        transaction.update(groupRef, { 
                            pendingKg: Math.round(newPending*100)/100, 
                            usedKg: Math.round(newUsed*100)/100, 
                            memberCount: newMemberCount, 
                            totalQty: Math.round((newPending + newUsed)*100)/100, 
                            unlockedAt: newUnlockedAt 
                        });

                        transaction.set(memberRef, { 
                            memberId: phone, 
                            name, 
                            phone, 
                            cart: cartPayload, 
                            joinedAt: serverTimestamp(), 
                            isLeader: (!joinGroupId && isNewMember) || (gData.ownerPhone === phone) 
                        });
                    });

                    if (joinGroupId) { 
                        state.pendingJoinId = null; 
                        state.invitingGroup = null; 
                        IS_JOIN_LINK = false; 
                        state.mode = 'HOME'; 
                    }
                    saveJoinedGroup(finalGroupId); 
                    state.cart = {}; 
                    window.closeModal();
                    
                    if (didUnlock) toast("Deal Unlocked! üéâ", "check-circle"); 
                    else if (joinGroupId) toast(isEditing ? "Order Updated!" : "Joined!", "check-circle");
                    else toast("Group Started!", "share-2");
                    
                    window.openGroup(finalGroupId);
                } catch(e) {
                    console.error("JOIN/ORDER FAILED:", e, { phone });
                    resetActionButton(actionBtn, btnText);
                    toast(typeof e === 'string' ? e : "Error processing order", "alert-triangle");
                }
            };
        };

        window.editOrder = function(gid) {
            const members = state.members[gid] || [];
            const me = members.find(m => m.phone === JOIN_SESSION_PHONE);
            if (me) openCheckoutModal(gid); else toast("Member profile not found", "alert-circle");
        };

        function renderHome(app) {
            const isClosedGlobally = isPastCutoff();
            if (state.mode === 'JOIN' && !state.invitingGroup) {
                app.innerHTML = `<div class="min-h-screen flex items-center justify-center text-gray-400"><div class="flex flex-col items-center gap-2"><div class="spinner-fallback"></div><span class="text-sm font-semibold">Connecting to group‚Ä¶</span></div></div>`;
                return;
            }
            if (cutoffTimerInterval) clearInterval(cutoffTimerInterval);
            const activeUserGroups = state.user.joinedGroupIds.map(gid => state.groups[gid]).filter(Boolean).sort((a,b) => getMillis(b.createdAt) - getMillis(a.createdAt));
            
            let invitationHtml = '';
            let headerTitle = `<h1 class="font-black text-2xl tracking-tight text-jodo-ctaPrimary leading-none mb-1">JODO</h1><span class="text-[10px] text-gray-500 font-bold tracking-wide">Group orders for Duvva</span>`;

            if (state.invitingGroup) {
                const ig = state.invitingGroup;
                headerTitle = `<div class="flex flex-col"><h1 class="font-black text-2xl tracking-tight text-jodo-ctaPrimary leading-none mb-1">JODO x ${ig.ownerName}</h1><span class="text-[10px] text-green-700 font-bold tracking-wide bg-green-50 px-2 py-0.5 rounded-full w-fit">Special Invitation</span></div>`;
                invitationHtml = `<div class="px-4 mb-6 mt-4 animate-pop"><div class="bg-indigo-50 border border-indigo-100 rounded-2xl p-5 shadow-sm"><div class="flex items-start gap-4"><div class="w-12 h-12 bg-white rounded-full flex items-center justify-center text-indigo-600 shadow-sm shrink-0"><i data-lucide="users" size="24"></i></div><div class="flex-1"><h3 class="font-bold text-lg text-gray-900 leading-tight mb-2">Accept Invite</h3><p class="text-xs text-gray-600 mb-3">Join this group to unlock wholesale prices.</p><button onclick="openCheckoutModal('${state.pendingJoinId}')" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-xl shadow-md active:scale-95 transition-transform flex items-center justify-center gap-2">Join Group</button></div></div></div></div>`;
            }

            let cartCount = 0; let cartTotal = 0;
            Object.keys(state.cart).forEach(pid => {
                const qty = state.cart[pid]; if (qty > 0) { cartCount++; cartTotal += qty * (PRODUCTS.find(x => x.id === pid)?.price5 || 0); }
            });

            app.innerHTML = `
                <div class="pb-32 fade-in bg-white min-h-screen">
                    <div class="glass-header sticky top-0 z-40 px-4 pt-safe pb-3 flex justify-between items-end min-h-[88px]">
                        <div class="flex flex-col justify-end pb-0.5 w-full">${headerTitle}<div id="home-timer" class="text-[10px] font-bold text-red-600 mt-1">Loading‚Ä¶</div></div>
                    </div>
                    ${invitationHtml}
                    ${activeUserGroups.length > 0 ? `<div class="mt-6 mb-4"><div class="px-4 flex gap-3 overflow-x-auto no-scrollbar">${activeUserGroups.map(g => `<div onclick="openGroup('${g.id}')" class="shrink-0 w-[80%] card-modern p-4"><div class="flex items-center gap-3"><div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center text-green-700"><i data-lucide="shopping-bag" size="20"></i></div><div><div class="font-bold text-gray-900">Your Group</div><div class="text-[10px] font-bold px-2 py-0.5 rounded border inline-block mt-1">${g.unlockedAt ? 'Unlocked' : `${g.memberCount}/${MIN_GROUP_SIZE} joined`}</div></div></div></div>`).join('')}</div></div>` : ''}
                    <div class="px-4 space-y-3 mt-6">
                        ${PRODUCTS.map(p => {
                            const qty = state.cart[p.id] || 0;
                            return `<div class="bg-white p-4 rounded-2xl shadow-[0_2px_12px_rgba(0,0,0,0.04)] border border-gray-100 flex gap-4 ${isClosedGlobally ? 'opacity-70' : ''}">
                                <div class="w-20 h-20 bg-gray-50 rounded-xl shrink-0 overflow-hidden border border-gray-100"><img src="${p.imageSrc}" class="w-full h-full object-cover"></div>
                                <div class="flex-1 flex flex-col justify-between py-1">
                                     <div><h3 class="font-bold text-lg text-gray-900 leading-tight">${p.name}</h3><p class="text-sm text-gray-500">${p.nameTe}</p></div>
                                     <div class="mt-2 flex items-center justify-between">
                                        <div class="bg-green-50 rounded-lg px-2 py-1 border border-green-100 flex flex-col"><span class="text-[10px] font-bold text-green-700 uppercase">Price</span><span class="text-lg font-bold text-green-700">‚Çπ${p.price5}</span></div>
                                        ${qty === 0 ? `<button onclick="updateCart('${p.id}', ${p.step})" class="bg-white border border-gray-300 text-gray-700 font-bold px-4 py-2 rounded-xl text-sm shadow-sm active:bg-gray-50">Add</button>` : `<div class="flex items-center bg-gray-900 rounded-xl px-1 py-1"><button onclick="updateCart('${p.id}', -${p.step})" class="w-8 h-8 text-white"><i data-lucide="minus" size="14"></i></button><div class="w-12 text-center text-sm font-bold text-white">${formatQty(qty)}</div><button onclick="updateCart('${p.id}', ${p.step})" class="w-8 h-8 text-white"><i data-lucide="plus" size="14"></i></button></div>`}
                                     </div>
                                </div>
                            </div>`;
                        }).join('')}
                    </div>
                    ${cartCount > 0 ? `<div class="fixed bottom-4 left-4 right-4 z-50 animate-slide-up"><button onclick="openCheckoutModal(${state.pendingJoinId ? `'${state.pendingJoinId}'` : 'null'})" class="w-full bg-jodo-ctaPrimary text-white h-[60px] rounded-xl font-bold text-lg shadow-xl flex items-center justify-between px-6 btn-press ring-2 ring-white/50"><div><span class="text-xs font-medium opacity-90">${cartCount} Items</span><br><span class="text-lg leading-none">‚Çπ${Math.round(cartTotal)}</span></div><div class="flex items-center gap-2">Checkout <i data-lucide="arrow-right" size="20"></i></div></button></div>` : ''}
                </div>
            `;
            initCardTilt();
            const homeTimer = document.getElementById('home-timer');
            if (homeTimer) startCutoffTimer(rem => { homeTimer.textContent = rem > 0 ? `‚è∞ ${formatRemaining(rem)} left` : "‚õî Today's orders closed"; });
        }

        function renderGroup(app) {
            if (cutoffTimerInterval) clearInterval(cutoffTimerInterval);
            const g = state.groups[state.currentGroupId]; if (!g) return;
            const members = state.members[g.id] || []; 
            const isUnlocked = !!g.unlockedAt;
            const hasJoined = JOIN_SESSION_PHONE && members.some(m => m.phone === JOIN_SESSION_PHONE);
            
            app.innerHTML = `
                <div class="fade-in bg-white min-h-screen pb-40 font-sans">
                    <div class="glass-header h-[60px] sticky top-0 z-50 px-4 flex justify-between items-center bg-white border-b border-gray-100">
                        <div class="flex items-center gap-3 cursor-pointer pt-safe" onclick="goHome(false)"><i data-lucide="arrow-left" size="24" class="text-gray-700"></i><span class="font-bold">Back</span></div>
                    </div>
                    <div class="p-4">
                        <div class="w-full h-40 rounded-2xl bg-gray-100 overflow-hidden mb-4 border border-gray-200 relative"><img src="https://images.unsplash.com/photo-1610348725531-843dff563e2c?auto=format&fit=crop&w=800&q=80" class="w-full h-full object-cover"><div class="absolute inset-0 bg-black/40 flex items-center justify-center"><h1 class="text-3xl font-black text-white">Group Order</h1></div></div>
                        <div class="text-center mb-2"><span class="text-sm font-medium text-gray-500">Host: <span class="font-bold text-gray-900">${g.ownerName}</span></span></div>
                        <div id="cutoff-timer" class="text-xs font-bold text-red-600 text-center mb-6">Loading‚Ä¶</div>
                        <div class="space-y-3">
                            <div class="flex justify-between items-end mb-4"><h3 class="text-xs font-bold text-gray-400 uppercase">People Joined</h3><div class="text-right">${!isUnlocked ? `<span class="text-xs font-bold text-orange-800 bg-orange-100 px-2 py-0.5 rounded animate-pulse">Need ${MIN_GROUP_SIZE - g.memberCount} more</span>` : '<span class="text-xs font-bold text-green-800 bg-green-100 px-2 py-0.5 rounded">Unlocked!</span>'}</div></div>
                            ${members.map(m => {
                                const isMe = JOIN_SESSION_PHONE === m.phone;
                                let totalVal = 0;
                                const parts = Object.entries(m.cart || {}).map(([pid, qty]) => {
                                    const p = PRODUCTS.find(x => x.id === pid); if(!p || qty <= 0) return null;
                                    totalVal += qty * getPrice(p, isUnlocked);
                                    return `${formatQty(qty)} ${p.name}`;
                                }).filter(Boolean);
                                return `<div class="bg-white border ${isMe ? 'border-green-200' : 'border-gray-100'} p-3 rounded-xl flex justify-between items-center">
                                    <div><div class="text-sm font-bold text-gray-800">${isMe ? 'You' : m.name} ${m.isLeader ? 'üëë' : ''}</div><div class="text-xs text-gray-500">${parts.length > 0 ? parts.join(", ") : "Joined"}</div></div>
                                    <div class="font-bold text-sm">‚Çπ${Math.round(totalVal)}</div>
                                </div>`;
                            }).join('')}
                        </div>
                    </div>
                    <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 p-4 pb-safe z-50 shadow-lg">
                        ${hasJoined ? `<button onclick="shareGroup('${g.id}', ${isUnlocked})" class="w-full bg-jodo-ctaPrimary text-white h-[56px] flex items-center justify-center rounded-xl font-bold gap-2"><i data-lucide="share-2" size="20"></i> Share Deal</button>` : `<button onclick="openJoinFlow('${g.id}')" class="w-full bg-jodo-ctaPrimary text-white h-[56px] rounded-xl font-bold">Join Group</button>`}
                    </div>
                </div>
            `;
            const timerEl = document.getElementById('cutoff-timer');
            if (timerEl) startCutoffTimer(rem => { timerEl.textContent = rem > 0 ? `‚è∞ ${formatRemaining(rem)} left` : "‚õî Today's orders closed"; });
        }

        function render() {
            const app = document.getElementById('app'); if (!app) return;
            if (state.view === 'home') renderHome(app); else renderGroup(app);
            if (window.lucide) window.lucide.createIcons();
        }
        
        function safeRender() {
            if (renderScheduled) return;
            renderScheduled = true;
            requestAnimationFrame(() => { render(); renderScheduled = false; });
        }

        function listenToGroupForHome(gid) {
            if (!db) return;
            const unsubG = onSnapshot(doc(db, 'artifacts', window.appId, 'public', 'data', "groups", gid), d => { if (d.exists()) { state.groups[gid] = d.data(); safeRender(); } }, e => console.error(e));
            state.homeListeners.push(unsubG);
            const unsubM = onSnapshot(collection(db, 'artifacts', window.appId, 'public', 'data', "groups", gid, "members"), snap => {
                const m = []; snap.forEach(d => m.push({ ...d.data(), id: d.id })); 
                m.sort((a,b) => getMillis(a.joinedAt) - getMillis(b.joinedAt)); state.members[gid] = m; safeRender();
            }, e => console.error(e));
            state.homeListeners.push(unsubM);
        }

        function initHomeListeners() {
            state.homeListeners.forEach(u => u()); state.homeListeners = [];
            state.user.joinedGroupIds.forEach(gid => listenToGroupForHome(gid));
        }

        window.openGroup = function(gid) { 
            if (!gid) return;
            try { history.pushState({}, '', `${BASE_URL}?group=${gid}`); } catch(e) {} 
            state.currentGroupId = gid; state.view = 'group'; 
            if (state.unsubGroup) state.unsubGroup(); if (state.unsubMembers) state.unsubMembers();
            safeRender(); 
            state.unsubGroup = onSnapshot(doc(db, 'artifacts', window.appId, 'public', 'data', "groups", gid), d => {
                if (d.exists()) { state.groups[gid] = d.data(); safeRender(); } else window.goHome();
            }, e => console.error(e));
            state.unsubMembers = onSnapshot(collection(db, 'artifacts', window.appId, 'public', 'data', "groups", gid, "members"), s => {
                const members = []; s.forEach(d => members.push({ ...d.data(), id: d.id }));
                members.sort((a,b) => getMillis(a.joinedAt) - getMillis(b.joinedAt)); state.members[gid] = members; safeRender();
            }, e => console.error(e));
        };

        window.goHome = function(clearJoin = true) { 
            if (state.unsubGroup) state.unsubGroup(); if (state.unsubMembers) state.unsubMembers();
            try { history.pushState({}, '', BASE_URL); } catch(e) {} 
            if (clearJoin) { state.invitingGroup = null; state.pendingJoinId = null; IS_JOIN_LINK = false; }
            state.view = 'home'; state.currentGroupId = null; safeRender(); 
        };

        function startApp() {
            if (JODO_INITIALIZED) return; 
            JODO_INITIALIZED = true;
            const params = new URLSearchParams(window.location.search);
            const gid = params.get('group');
            if (gid) { IS_JOIN_LINK = true; state.view = 'home'; state.pendingJoinId = gid; } else { loadData(); state.view = 'home'; }
            
            (async () => {
                if (IS_JOIN_LINK && state.pendingJoinId) {
                    try {
                        const snap = await getDoc(doc(db, 'artifacts', window.appId, 'public', 'data', "groups", state.pendingJoinId));
                        if (snap.exists()) {
                            state.invitingGroup = snap.data();
                            state.groups[state.pendingJoinId] = snap.data();
                            listenToGroupForHome(state.pendingJoinId);
                        } else window.goHome();
                    } catch (e) { window.goHome(); }
                }
                loadData(); initHomeListeners(); safeRender();
            })();

            window.addEventListener('popstate', () => {
                const p = new URLSearchParams(location.search); const g = p.get('group');
                if (g) window.openGroup(g); else window.goHome(false);
            });
        }
        
        document.addEventListener('DOMContentLoaded', () => {
             if (window.FIREBASE_READY) startApp();
             else window.addEventListener('firebase-ready', startApp);
        });
    </script>
</body>
</html>
