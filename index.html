<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover" />
    <title>JODO - Village Order</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üçÖ</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        jodo: {
                            base: '#FFFFFF',
                            textPrimary: '#111827',
                            ctaPrimary: '#000000', 
                            error: '#DC2626',
                        }
                    },
                    fontFamily: {
                        sans: ['-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'sans-serif'],
                        mono: ['ui-monospace', 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'monospace'],
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>
    <style>
        body { 
            background: #F3F4F6; 
            color: #111827; 
            -webkit-tap-highlight-color: transparent; 
            min-height: 100dvh; 
            display: flex; 
            justify-content: center; 
            margin: 0; 
            overscroll-behavior-y: contain;
            line-height: 1.45;
            letter-spacing: -0.01em; 
        }
        #app { width: 100%; max-width: 448px; background: #FFFFFF; min-height: 100dvh; position: relative; overflow-y: auto; display: flex; flex-direction: column; box-shadow: 0 0 20px rgba(0,0,0,0.05); }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .pt-safe { padding-top: env(safe-area-inset-top); }
        
        /* Pinduoduo-style Progress Bar */
        .progress-strip {
            background-image: linear-gradient(45deg,rgba(255,255,255,.15) 25%,transparent 25%,transparent 50%,rgba(255,255,255,.15) 50%,rgba(255,255,255,.15) 75%,transparent 75%,transparent);
            background-size: 1rem 1rem;
        }

        /* Fear Ticker (Premium, Colorful, Continuous) */
        .jodo-fear-ticker {
            background: linear-gradient(90deg, #7C2D12, #B91C1C, #7C2D12);
            color: #FFF7ED;
            overflow: hidden;
            padding: 10px 0;
            border-radius: 14px;
            box-shadow: inset 0 0 0 1px rgba(255,255,255,0.15);
        }

        .jodo-fear-track {
            display: inline-flex;
            white-space: nowrap;
            animation: jodo-marquee 30s linear infinite;
            padding-left: 100%;
            font-weight: 900;
            font-size: 14px;
            letter-spacing: 0.2px;
        }

        .jodo-fear-track .gap {
            width: 48px;
            display: inline-block;
        }

        @keyframes jodo-marquee {
            from { transform: translateX(0); }
            to { transform: translateX(-100%); }
        }
    </style>
</head>
<body class="antialiased">

    <div id="app"></div>

    <div id="modal-overlay" class="fixed inset-0 bg-black/80 hidden z-[60] flex items-end justify-center backdrop-blur-sm transition-opacity duration-300">
        <div id="modal-content" class="bg-gray-50 w-full max-w-[448px] rounded-t-2xl shadow-2xl transform transition-transform duration-300 translate-y-full max-h-[95dvh] overflow-y-auto pb-safe"></div>
    </div>

    <div id="toast" class="fixed top-12 left-1/2 -translate-x-1/2 bg-gray-900 text-white px-6 py-3 text-sm font-bold shadow-xl hidden z-[90] flex items-center gap-2 pointer-events-none text-center w-max max-w-[90%] rounded-full transition-all transform duration-200"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, runTransaction, serverTimestamp, updateDoc, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "", // TODO: Add your real API Key here for production deployment
            authDomain: "jodo-prod-e7788.firebaseapp.com",
            projectId: "jodo-prod-e7788",
            storageBucket: "jodo-prod-e7788.firebasestorage.app",
            messagingSenderId: "535883967600",
            appId: "1:535883967600:web:aa0b73a70ca506ad4fd8b5"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        window.db = db;
        window.fs = { doc, getDoc, setDoc, onSnapshot, collection, runTransaction, serverTimestamp, updateDoc, increment };
        
        window.dispatchEvent(new Event('firebase-ready'));
    </script>
    
    <script>
        const BASE_URL = 'https://satyanarayanagaraga.github.io/jodo-mvp'; 
        const FORCE_OPEN_FOR_TESTING = false; 
        const OPEN_HOUR = 6;
        const CLOSE_HOUR = 21; 
        
        // Tier based pricing logic
        function calculateFinalPrice(totalKg, product) {
          if (totalKg >= 100) return product.priceMin;
          if (totalKg >= product.target) return product.priceMin; // Simplified for visual clarity
          return product.priceMax;
        }

        // --- CEO CHANGE: Boring & Correct Pricing ---
        // We do NOT calculate a single price before cutoff. We show the range.
        // This function is kept for internal logic if needed, but UI will prefer ranges.
        function getDisplayPrice(totalKg, product) {
          if (totalKg >= product.target) {
            return product.priceMin; // locked lowest price
          }
          return product.priceMax; // current price before target
        }
        
        // Helper: Convert KG gap to Households (Heuristic: 1 house approx 2kg)
        // Note: This is copy text, not hard data. Real behavior varies.
        function getRemainingHouseholds(remainingKg) {
            return Math.max(1, Math.ceil(remainingKg / 2));
        }

        // STRICT RULES: Min 1kg, Integer options only. No small buyers.
        const PRODUCTS = [
            { 
                id: 'tomato', 
                name: '‡∞ü‡∞Æ‡∞æ‡∞ü‡∞æ‡∞≤‡±Å (Tomato)', 
                target: 25, 
                priceMin: 42,       
                priceMax: 48,       
                step: 1, 
                min: 1,
                unit: 'kg',
                img: 'https://images.unsplash.com/photo-1592924357228-91a4daadcfea?auto=format&fit=crop&w=150&q=80',
                quantityOptions: [1, 2, 3],
                lastShop: 60,
                lastJodo: 42
            }
        ];

        const state = { 
            view: 'home', 
            groups: {}, 
            members: {}, 
            user: { name: '', phone: '' },
            cart: {}, 
            listeners: [],
            modalStep: 0,
            deliveryMethod: 'home', // STRICT: Silent Home Delivery
            cycleId: null,
            extraHouseholds: [], 
            isCollectorMode: false,
            isRepeatUser: false,
            referrerId: null
        };
        
        function getISTDate() {
            return new Date(new Date().toLocaleString("en-US", { timeZone: "Asia/Kolkata" }));
        }

        function getISTDateStr() {
            const d = getISTDate();
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${y}-${m}-${day}`;
        }

        function getCycleGroupId() {
            const d = getISTDate();
            const days = ['SUN','MON','TUE','WED','THU','FRI','SAT'];
            const y = d.getFullYear();
            const m = String(d.getMonth()+1).padStart(2,'0');
            const da = String(d.getDate()).padStart(2,'0');
            return `duvva_${days[d.getDay()]}_${y}_${m}_${da}`;
        }

        function isOrderWindowOpen() {
            if (FORCE_OPEN_FOR_TESTING) return true;
            const d = getISTDate();
            const hour = d.getHours();
            if (hour < OPEN_HOUR || hour >= CLOSE_HOUR) return false;
            return true;
        }
        
        function isViewingTodayCycle(groupId) {
            const d = getISTDate();
            const days = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            const dayStr = days[d.getDay()];
            const todayId = `duvva_${dayStr}_${year}_${month}_${day}`;
            return groupId === todayId;
        }

        function getCutoffRemaining() {
            const now = getISTDate();
            const cutoff = new Date(now);
            cutoff.setHours(CLOSE_HOUR, 0, 0, 0);
            const diff = cutoff - now;
            if (diff <= 0) return "Closed";
            
            const totalSeconds = Math.floor(diff / 1000);
            const hrs = Math.floor(totalSeconds / 3600);
            const mins = Math.floor((totalSeconds % 3600) / 60);
            
            const pMins = String(mins).padStart(2, '0');

            return hrs > 0 ? `${hrs}h ${pMins}m` : `${mins}m`;
        }

        function getCutoffMinutes() {
            const now = getISTDate();
            const cutoff = new Date(now);
            cutoff.setHours(CLOSE_HOUR, 0, 0, 0);
            return Math.floor((cutoff - now) / 60000);
        }

        function getProductStats(members, prodId) {
            const gid = getCycleGroupId();
            const group = state.groups[gid];
            
            let total = 0;
            let peopleCount = 0; // Still useful for UI relative sizing if needed, or we can use confirmedCount from group

            // --- CEO CHANGE: Use Backend Confirmed Totals (Source of Truth) ---
            if (group && group.confirmedTotals && group.confirmedTotals[prodId] !== undefined) {
                 total = group.confirmedTotals[prodId];
            } else {
                // Fallback for older groups or pre-transaction logic (though we are fixing it now)
                members.forEach(m => {
                    if (m.isConfirmed && m.items && m.items[prodId]) {
                        total += parseFloat(m.items[prodId]);
                    }
                });
            }

            const p = PRODUCTS.find(x => x.id === prodId);
            return {
                total: parseFloat(total.toFixed(2)),
                target: p.target,
                isRunning: total >= p.target,
                remaining: Math.max(0, p.target - total),
                peopleCount: peopleCount 
            };
        }
        
        function toast(msg, type = 'normal') { 
            const t = document.getElementById('toast'); 
            t.innerHTML = msg; 
            if(type === 'error') {
                t.className = "fixed top-12 left-1/2 -translate-x-1/2 bg-red-600 text-white px-6 py-3 rounded-full text-sm font-bold shadow-2xl z-[90] scale-100";
            } else {
                t.className = "fixed top-12 left-1/2 -translate-x-1/2 bg-black text-white px-6 py-3 font-bold shadow-2xl z-[90] rounded-full scale-100";
            }
            t.classList.remove('hidden'); 
            setTimeout(() => {
                t.classList.add('hidden');
            }, 3000); 
        }

        function loadUser() {
            state.user.name = localStorage.getItem('jodo_name') || '';
            state.user.phone = localStorage.getItem('jodo_phone') || '';
            const orderCount = parseInt(localStorage.getItem('jodo_order_count') || '0');
            state.isRepeatUser = orderCount > 0;
        }

        function saveUser(name, phone) {
            state.user.name = name;
            state.user.phone = phone;
            localStorage.setItem('jodo_name', name);
            localStorage.setItem('jodo_phone', phone);
        }

        function listenToCycleGroup() {
            const gid = getCycleGroupId();
            state.cycleId = gid;
            if (!window.fs) return;
            state.listeners.forEach(u => u()); state.listeners = [];
            const unsubG = window.fs.onSnapshot(window.fs.doc(window.db, "groups", gid), (doc) => {
                state.groups[gid] = doc.exists() ? doc.data() : null;
                render();
            });
            const unsubM = window.fs.onSnapshot(window.fs.collection(window.db, "groups", gid, "members"), (snap) => {
                const m = [];
                snap.forEach(d => m.push({ ...d.data(), id: d.id }));
                m.sort((a, b) => (a.joinedAt?.seconds || 0) - (b.joinedAt?.seconds || 0));
                state.members[gid] = m;
                render();
                if (state.modalStep === 2) renderDetailsStep();
            });
            state.listeners.push(unsubG, unsubM);
        }

        function setCartQuantity(prodId, qty) {
            if (!isOrderWindowOpen()) {
                toast('JODO Closed', 'error');
                return;
            }
            if (qty === 0) {
                delete state.cart[prodId];
            } else {
                state.cart[prodId] = qty;
            }
            // Minimal toast, systems > words
            toast(qty === 0 ? 'Removed' : 'Updated');
            render();
        }
        window.setCartQuantity = setCartQuantity;
        window.updateCart = setCartQuantity;

        window.addExtraHousehold = function() {
            // STRICT RULE: Max 1 extra household (total 2 max)
            if (state.extraHouseholds.length >= 1) {
                toast('‡∞í‡∞ï‡∞∞‡∞ø‡∞ï‡∞ø ‡∞Æ‡∞ø‡∞Ç‡∞ö‡∞ø ‡∞ú‡±ã‡∞°‡∞ø‡∞Ç‡∞ö‡∞≤‡±á‡∞∞‡±Å (Max 1 neighbor)', 'error');
                return;
            }
            state.extraHouseholds.push({ name: '', phone: '', items: {} });
            renderDetailsStep();
        };

        window.removeExtraHousehold = function(idx) {
            state.extraHouseholds.splice(idx, 1);
            renderDetailsStep();
        };

        window.updateExtraHouseholdField = function(idx, field, value) {
            state.extraHouseholds[idx][field] = value;
        };

        window.updateExtraHouseholdItem = function(idx, prodId, qty) {
            if (qty === 0) {
                delete state.extraHouseholds[idx].items[prodId];
            } else {
                state.extraHouseholds[idx].items[prodId] = qty;
            }
            renderDetailsStep();
        };

        window.openCollectorMode = function() {
            if (!isOrderWindowOpen()) { toast('Closed', 'error'); return; }
            const gid = getCycleGroupId();
            const members = state.members[gid] || [];
            const myMember = state.user.phone ? members.find(m => m.phone === state.user.phone) : null;
            if (!myMember) {
                toast('Order needed to collect', 'error');
                return;
            }
            state.cart = { ...myMember.items }; 
            state.deliveryMethod = 'home'; // Force Home
            state.extraHouseholds = [{ name: '', phone: '', items: {} }];
            state.modalStep = 2;
            state.isCollectorMode = true; 
            renderDetailsStep();
            document.getElementById('modal-overlay').classList.remove('hidden');
            setTimeout(() => { 
                document.getElementById('modal-overlay').classList.remove('opacity-0'); 
                document.getElementById('modal-content').classList.remove('translate-y-full'); 
            }, 10);
        }

        function openModalFlow() {
            if (!isOrderWindowOpen()) { toast('Closed', 'error'); return; }
            if (Object.keys(state.cart).length === 0) { toast('Select items first', 'error'); return; }
            state.deliveryMethod = 'home'; // Force Home
            state.extraHouseholds = []; 
            state.modalStep = 2; 
            state.isCollectorMode = false;
            renderDetailsStep();
            document.getElementById('modal-overlay').classList.remove('hidden');
            setTimeout(() => { 
                document.getElementById('modal-overlay').classList.remove('opacity-0'); 
                document.getElementById('modal-content').classList.remove('translate-y-full'); 
            }, 10);
        }

        function closeModal() {
            const overlay = document.getElementById('modal-overlay');
            const content = document.getElementById('modal-content');
            content.classList.add('translate-y-full');
            overlay.classList.add('opacity-0');
            setTimeout(() => { overlay.classList.add('hidden'); state.modalStep = 0; }, 300);
        }

        function renderDetailsStep() {
            const container = document.getElementById('modal-content');
            const gid = getCycleGroupId(); 
            const members = state.members[gid] || [];
            
            // --- CEO CHANGE: Boring & Correct Pricing (Range) ---
            // Don't show a single total. Show the range of possibilities.
            let minTotal = 0;
            let maxTotal = 0;

            Object.entries(state.cart).forEach(([pid, qty]) => {
                const p = PRODUCTS.find(x => x.id === pid);
                if (p) {
                    minTotal += qty * p.priceMin;
                    maxTotal += qty * p.priceMax;
                }
            });

            // Delivery logic removed. Pure product total.
            
            const summaryHtml = `
                <div class="flex justify-between items-center border-t border-gray-100 mt-3 pt-3">
                    <div>
                        <div class="text-xs font-bold text-gray-500 uppercase">Estimated Total</div>
                        <div class="text-[10px] text-gray-400 font-medium">Final price at 9 PM</div>
                    </div>
                    <div class="text-2xl font-black text-gray-900">‚Çπ${minTotal.toFixed(0)} - ‚Çπ${maxTotal.toFixed(0)}</div>
                </div>
            `;

            let listHtml = '';
            Object.entries(state.cart).forEach(([pid, qty]) => {
                const p = PRODUCTS.find(x => x.id === pid);
                if (!p) return;
                
                listHtml += `
                    <div class="flex justify-between items-center py-2 border-b border-gray-100 last:border-0">
                        <div><div class="font-bold text-gray-900">${p.name} <span class="text-gray-500 font-medium">x ${qty}kg</span></div></div>
                        <div class="text-right">
                             <div class="text-sm font-bold text-gray-900">‚Çπ${(qty * p.priceMin).toFixed(0)} - ‚Çπ${(qty * p.priceMax).toFixed(0)}</div>
                        </div>
                    </div>
                `;
            });

            // Removed extraHouseholdsHtml generation (Manual Add Family Killed)

            const headerTitle = 'Confirm Order';
            const ctaText = 'Confirm Order';
            const ctaSub = 'Group succeeds ‚Üí we deliver tomorrow morning';
            
            container.innerHTML = `
                <div class="bg-gray-50 relative font-sans">
                    <div class="px-6 py-4 bg-white shadow-sm flex justify-between items-center z-10 sticky top-0">
                        <div><h3 class="font-black text-xl text-gray-900 leading-none">${headerTitle}</h3></div>
                        <button onclick="window.closeModal()" class="p-2 bg-gray-100 hover:bg-gray-200 rounded-full"><i data-lucide="x" size="20"></i></button>
                    </div>
                    <div class="p-4 space-y-4">
                        <div class="bg-white rounded-2xl shadow-sm p-5">
                            <h4 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-3">Order Summary</h4>
                            ${listHtml}
                            ${summaryHtml}
                        </div>
                        
                        <div class="bg-white rounded-2xl shadow-sm p-5">
                            <div class="space-y-4">
                                <div><label class="block text-xs font-bold text-gray-500 uppercase mb-2">Name</label><input id="inp-name" value="${state.user.name}" class="w-full border border-gray-200 p-3 rounded-xl font-bold focus:border-black focus:outline-none"></div>
                                <div><label class="block text-xs font-bold text-gray-500 uppercase mb-2">Mobile</label><input id="inp-phone" type="tel" value="${state.user.phone}" class="w-full border border-gray-200 p-3 rounded-xl font-bold focus:border-black focus:outline-none"></div>
                            </div>
                        </div>
                    </div>
                    <div class="p-4 bg-white border-t border-gray-200 pb-safe sticky bottom-0">
                         <button id="btn-submit-order" class="w-full bg-black text-white font-black text-xl h-[64px] rounded-2xl shadow-lg flex flex-col items-center justify-center leading-tight active:scale-[0.98]">
                            <span>${ctaText}</span>
                            <span class="text-[10px] opacity-80 font-medium">${ctaSub}</span>
                         </button>
                    </div>
                </div>
            `;
            if(window.lucide) window.lucide.createIcons();

            document.getElementById('btn-submit-order').onclick = async () => {
                let name = '', phone = '';
                name = document.getElementById('inp-name').value.trim();
                phone = document.getElementById('inp-phone').value.trim();
                if(!name || phone.length < 10) { toast('Invalid details', 'error'); return; }
                
                // ROOT CAUSE 3 FIX: Robust Button Handling
                const btn = document.getElementById('btn-submit-order');
                if (btn) {
                    btn.innerText = 'Processing...';
                    btn.disabled = true;
                }
                
                await submitOrder(name, phone, 0);
            };
        }

        async function submitOrder(name, phone, amountPayable) {
            saveUser(name, phone);
            
            // ROOT CAUSE 1 FIX: Ensure Cycle ID exists
            const gid = state.cycleId || getCycleGroupId();
            state.cycleId = gid; // Sync state
            
            const normalizedPhone = phone.replace(/\D/g, '').slice(-10);
            
            // CEO FIX: Force state sync with normalized phone immediately. 
            state.user.phone = normalizedPhone; 

            // DEBUG CONFIRM
            console.log('SUBMIT', {
              cycleId: state.cycleId,
              cart: state.cart,
              referrer: state.referrerId
            });

            try {
                // --- CEO CHANGE: Robust Transaction Logic ---
                // 1. Validate Referrer (Anti-Abuse)
                // 2. Update confirmedCounts and confirmedTotals AT SOURCE
                
                const memberId = crypto.randomUUID();
                
                await window.fs.runTransaction(window.db, async (transaction) => {
                    const groupRef = window.fs.doc(window.db, "groups", gid);
                    const groupSnap = await transaction.get(groupRef);
                    
                    // Referrer Logic
                    let referrerSnap = null;
                    let isValidReferrer = false;
                    
                    if (state.referrerId) {
                        const referrerRef = window.fs.doc(window.db, "groups", gid, "members", state.referrerId);
                        referrerSnap = await transaction.get(referrerRef);
                        
                        // FIX: Anti-Abuse Checks
                        if (referrerSnap.exists()) {
                            const refData = referrerSnap.data();
                            
                            // 1. Prevent Self-Referral (Phone Check)
                            if (refData.phone === normalizedPhone) {
                                throw new Error("Self-referral is not allowed.");
                            }

                            // 2. Prevent Link Reuse (1 Invite = 1 Confirmation)
                            // Ideally this is server-side, but this adds significant friction client-side.
                            if (refData.hasConfirmedSomeone) {
                                throw new Error("This referral link has already been used.");
                            }

                            isValidReferrer = true;
                        }
                    }

                    // Determine Status
                    // I am confirmed ONLY if I have a valid referrer
                    const newMemberConfirmed = isValidReferrer;
                    
                    // Does referrer need confirmation? (Only if they are currently unconfirmed)
                    const referrerNeedsConfirm = isValidReferrer && (referrerSnap.data().isConfirmed === false);

                    // Initialize Group Data if missing
                    let groupData = { id: gid, date: getISTDateStr(), createdAt: window.fs.serverTimestamp(), expiresAt: Date.now() + 43200000 };
                    let currentConfirmedTotals = {};

                    if (groupSnap.exists()) {
                        groupData = groupSnap.data();
                        currentConfirmedTotals = groupData.confirmedTotals || {};
                    } else {
                        // ROOT CAUSE 2 FIX: Safe creation before update
                        // FIX: Metric Cleanup (ordersPlaced, ordersConfirmed)
                        transaction.set(groupRef, {
                            ...groupData,
                            ordersPlaced: 0,
                            ordersConfirmed: 0,
                            confirmedTotals: {}
                        }, { merge: true });
                    }

                    // --- Calculate Deltas ---
                    let deltaConfirmedCount = 0;
                    let totalsUpdates = {};

                    // 1. If I am confirmed, add my items to totals
                    if (newMemberConfirmed) {
                        deltaConfirmedCount += 1;
                        Object.entries(state.cart).forEach(([pid, qty]) => {
                            totalsUpdates[pid] = (totalsUpdates[pid] || 0) + qty;
                        });
                    }

                    // 2. If referrer is confirmed NOW, add THEIR items to totals
                    if (referrerNeedsConfirm) {
                        deltaConfirmedCount += 1;
                        const rItems = referrerSnap.data().items || {};
                        Object.entries(rItems).forEach(([pid, qty]) => {
                            totalsUpdates[pid] = (totalsUpdates[pid] || 0) + qty;
                        });
                    }

                    // --- Apply Updates ---
                    
                    // 1. Update Group (Source of Truth)
                    // Merge new totals into existing confirmedTotals
                    const newConfirmedTotals = { ...currentConfirmedTotals };
                    Object.entries(totalsUpdates).forEach(([pid, qty]) => {
                        newConfirmedTotals[pid] = (newConfirmedTotals[pid] || 0) + qty;
                    });

                    // FIX: Use window.fs.increment instead of direct increment call
                    // FIX: Metric Renaming (ordersPlaced instead of memberCount)
                    transaction.update(groupRef, { 
                        ordersPlaced: window.fs.increment(1), // Raw orders
                        ordersConfirmed: window.fs.increment(deltaConfirmedCount), // Validated orders
                        confirmedTotals: newConfirmedTotals 
                    });

                    // 2. Create New Member
                    const memberRef = window.fs.doc(window.db, "groups", gid, "members", memberId);
                    const deliveryData = { method: 'home' };
                    
                    // Calculate Immutable Order Snapshot
                    const orderSnapshot = {};
                    Object.entries(state.cart).forEach(([pid, qty]) => {
                        const p = PRODUCTS.find(x => x.id === pid);
                        orderSnapshot[pid] = {
                            priceMin: p.priceMin,
                            priceMax: p.priceMax,
                            target: p.target,
                            qty: qty
                        };
                    });

                    transaction.set(memberRef, { 
                        name, 
                        phone: normalizedPhone, 
                        items: state.cart, 
                        delivery: deliveryData, 
                        paymentStatus: "pending_manual", 
                        futurePaymentMethod: "UPI", 
                        amountPayable: amountPayable, 
                        joinedAt: window.fs.serverTimestamp(),
                        isConfirmed: newMemberConfirmed,
                        hasConfirmedSomeone: false, // Init flag for anti-abuse
                        referrerId: isValidReferrer ? state.referrerId : null,
                        orderSnapshot: orderSnapshot 
                    });

                    // 3. Update Referrer (if needed)
                    if (isValidReferrer) {
                        const referrerRef = window.fs.doc(window.db, "groups", gid, "members", state.referrerId);
                        // Mark referrer as used (Anti-Abuse)
                        const updates = { hasConfirmedSomeone: true };
                        if (referrerNeedsConfirm) {
                            updates.isConfirmed = true;
                        }
                        transaction.update(referrerRef, updates);
                    }
                });
                
                // Update Repeat User Status
                const currentCount = parseInt(localStorage.getItem('jodo_order_count') || '0');
                localStorage.setItem('jodo_order_count', currentCount + 1);
                state.isRepeatUser = true;

                closeModal(); 

                // --- CEO FIX: No Auto Redirect. Let user see status screen. ---
                // The onSnapshot listener will update the member list, causing getHomeHtml to render getStatusScreenHtml
                state.view = 'home';
                render();

            } catch(e) { 
                console.error(e); 
                // Improved Error Toast
                let msg = 'Error submitting order';
                if (e.message.includes("Self-referral")) msg = "Cannot invite yourself.";
                if (e.message.includes("already been used")) msg = "This invite link is expired.";
                toast(msg, 'error'); 
                
                // ROOT CAUSE 3 FIX: Safe Re-enable
                const btn = document.getElementById('btn-submit-order');
                if (btn) {
                    btn.disabled = false;
                    btn.innerText = 'Confirm Order';
                }
            }
        }

        // Ticker Logic - Fear-Based (Pinduoduo Style)
        function getTickerHtml() {
            // Dynamic Ticker Text
            const tomato = PRODUCTS.find(p => p.id === 'tomato');
            const jodoPrice = tomato?.lastJodo || 40;
            const shopPrice = tomato?.lastShop || 60;

            // Conditional Fear: Only show if urgent
            const minsLeft = getCutoffMinutes();
            // Show if less than 3 hours (180 mins)
            if (minsLeft > 180 && !state.isRepeatUser) return '';

            let content = '';
            
            if (state.isRepeatUser) {
                // Fear/Loss framing for repeat users
                content = `<span>‡∞à ‡∞∞‡±ã‡∞ú‡±Å ‡∞Æ‡∞ø‡∞∏‡±ç ‡∞Ö‡∞Ø‡∞ø‡∞§‡±á ‚Äî ‡∞Æ‡∞Ç‡∞ó‡∞≥‡∞µ‡∞æ‡∞∞‡∞Ç ‡∞µ‡∞∞‡∞ï‡±Å ‡∞¶‡±Å‡∞ï‡∞æ‡∞£‡∞Ç ‡∞ß‡∞∞‡±á. ‡∞ú‡±ã‡∞°‡±ã‡∞≤‡±ã ‚Çπ${jodoPrice} | ‡∞¶‡±Å‡∞µ‡±ç‡∞µ ‡∞∑‡∞æ‡∞™‡±Å‡∞≤‡±ã ‚Çπ${shopPrice}.</span>`;
            } else {
                // Mild urgency for new users (FIX: Fear Ticker enabled for new users too)
                content = `<span>‡∞Ü‡∞´‡∞∞‡±ç ‡∞Æ‡±Å‡∞ó‡±Å‡∞∏‡±ç‡∞§‡±ã‡∞Ç‡∞¶‡∞ø! ‡∞ú‡±ã‡∞°‡±ã‡∞≤‡±ã ‚Çπ${jodoPrice} - ‡∞¨‡∞Ø‡∞ü ‚Çπ${shopPrice}. ‡∞Ü‡∞∞‡±ç‡∞°‡∞∞‡±ç ‡∞ö‡±á‡∞Ø‡∞Ç‡∞°‡∞ø.</span>`;
            }

            return `
                <div style="padding: 0 16px; margin-top: 10px;">
                    <div class="jodo-fear-ticker">
                      <div class="jodo-fear-track">
                        ${content}
                        <span class="gap"></span>
                        ${content}
                      </div>
                    </div>
                </div>
            `;
        }

        function getHomeHtml() {
            const gid = getCycleGroupId();
            const isOpen = isOrderWindowOpen();
            const viewingToday = isViewingTodayCycle(gid);
            const group = state.groups[gid];

            if (group && group.status === 'cancelled') {
                 return `<div class="min-h-screen bg-white flex flex-col items-center justify-center p-8 text-center font-sans"><h2 class="text-2xl font-black text-gray-900 mb-2">Cancelled</h2></div>`;
            }
            
            if (!isOpen && !viewingToday) {
                return `<div class="min-h-screen bg-white flex flex-col items-center justify-center p-8 text-center font-sans"><h2 class="text-2xl font-black text-gray-900 mb-2">Closed</h2><p class="text-gray-500 font-bold">Opens 6 AM</p></div>`;
            }

            const members = state.members[gid] || [];
            
            // FIX 1: Normalize phone before comparison
            const normalizedUserPhone = state.user.phone ? state.user.phone.replace(/\D/g, '').slice(-10) : null;
            const myMember = normalizedUserPhone ? members.find(m => m.phone === normalizedUserPhone) : null;
            
            if (myMember) return getStatusScreenHtml(state.groups[gid], members, myMember);
            else return getSelectionScreenHtml(members, isOpen);
        }

        function getSelectionScreenHtml(members, isOpen) {
            if (!isOpen) return `<div class="p-10 text-center text-gray-500 font-bold">Time Up</div>`;

            const hasItems = Object.keys(state.cart).length > 0;
            const remainingTime = getCutoffRemaining();
            
            // Psychology: No moral headers. Just time urgency.
            // Structure: Price Ladder Hero

            let productsHtml = PRODUCTS.map(p => {
                const qty = state.cart[p.id] || 0;
                const isSelected = qty > 0;
                const stats = getProductStats(members, p.id);
                const progressPct = Math.min(100, (stats.total / p.target) * 100);
                
                // --- CEO CHANGE: Boring, Stable, Trustworthy Range ---
                // Revert to showing the range to build trust.
                // No "Current Price" vs "Locked Price" switching which confuses billing expectations.
                
                const priceHtmlContent = `
                    <div class="text-2xl font-black text-gray-900">
                        ‚Çπ${p.priceMin} - ‚Çπ${p.priceMax}
                        <span class="text-sm font-medium text-gray-500">/ kg</span>
                    </div>
                    <div class="text-[11px] text-gray-500 font-medium mt-0.5">
                        *‡∞§‡±Å‡∞¶‡∞ø ‡∞ß‡∞∞ ‡∞∞‡∞æ‡∞§‡±ç‡∞∞‡∞ø 9 ‡∞ó‡∞Ç‡∞ü‡∞≤‡∞ï‡±Å ‡∞®‡∞ø‡∞∞‡±ç‡∞£‡∞Ø‡∞ø‡∞Ç‡∞ö‡∞¨‡∞°‡±Å‡∞§‡±Å‡∞Ç‡∞¶‡∞ø (Final price @ 9 PM)
                    </div>
                `;

                const priceHtml = `
                    <div class="mt-1 mb-2">
                        ${priceHtmlContent}
                    </div>
                `;

                // --- PROGRESS SURGE ---
                // Decoupled from price logic completely. Just shows progress.
                const progressHtml = `
                    <div class="mt-3">
                         <div class="w-full bg-gray-200 h-2.5 rounded-full overflow-hidden">
                            <div class="h-full bg-black rounded-full transition-all duration-700 progress-strip" style="width: ${progressPct}%"></div>
                         </div>
                    </div>
                `;

                const qtyButtons = p.quantityOptions.map(q => {
                  const active = qty === q;
                  const label = q + 'kg';
                  return `<button onclick="window.setCartQuantity('${p.id}', ${q}); event.stopPropagation();" class="flex-1 py-3 rounded-xl text-sm font-bold transition border ${active ? 'bg-black text-white border-black shadow-lg transform scale-105' : 'bg-white text-gray-900 border-gray-200'}">${label}</button>`;
                }).join('');

                return `
                    <div class="bg-white rounded-2xl shadow-sm p-4 mb-4 border border-gray-100 relative overflow-hidden transition-all ${isSelected ? 'ring-2 ring-black' : ''}">
                        <div class="flex gap-4 mb-2">
                            <div class="w-20 h-20 rounded-xl overflow-hidden bg-gray-100 shrink-0"><img src="${p.img}" class="w-full h-full object-cover" onclick="window.setCartQuantity('${p.id}', ${p.quantityOptions[0]})"></div>
                            <div class="flex-1">
                                <h3 class="text-lg font-black text-gray-900 leading-tight">${p.name}</h3>
                                ${priceHtml}
                            </div>
                        </div>
                        ${progressHtml}
                        <div class="mt-4 pt-4 border-t border-gray-100">
                             <div class="flex gap-2">${qtyButtons}</div>
                             <div class="text-[11px] text-gray-500 font-medium mt-2 text-center leading-snug">
                                *‡∞§‡∞¶‡±Å‡∞™‡∞∞‡∞ø ‡∞Ü‡∞∞‡±ç‡∞°‡∞∞‡±ç ‡∞Æ‡∞Ç‡∞ó‡∞≥‡∞µ‡∞æ‡∞∞‡∞Ç. ‡∞Æ‡±Ä‡∞∞‡±Å ‡∞é‡∞Ç‡∞ö‡±Å‡∞ï‡±Å‡∞®‡±ç‡∞® ‡∞™‡∞∞‡∞ø‡∞Æ‡∞æ‡∞£‡∞Ç 3‚Äì4 ‡∞∞‡±ã‡∞ú‡±Å‡∞≤‡∞ï‡±Å ‡∞∏‡∞∞‡∞ø‡∞™‡∞°‡±á‡∞≤‡∞æ ‡∞â‡∞Ç‡∞°‡∞æ‡∞≤‡∞ø
                             </div>
                             ${isSelected ? `<button onclick="window.setCartQuantity('${p.id}', 0); event.stopPropagation();" class="w-full mt-2 py-2 text-xs font-bold text-gray-400">Remove Item</button>` : ''}
                        </div>
                    </div>
                `;
            }).join('');

            // --- DYNAMIC CTA (Structure > Words) ---
            let ctaMain = "Select Items";
            let ctaSub = "";
            let btnBg = "bg-gray-900";

            if (hasItems) {
                // Boring CTA logic
                ctaMain = "Confirm Order";
                ctaSub = "Pay at pickup ONLY if group succeeds";
                btnBg = "bg-black";
            } else {
                ctaMain = "Pick Items to Start";
                btnBg = "bg-gray-300 text-gray-500 cursor-not-allowed";
            }

            return `
                <div class="min-h-screen bg-gray-50 flex flex-col font-sans pb-safe">
                    <div class="bg-white px-6 py-4 sticky top-0 z-20 shadow-sm border-b border-gray-100">
                        <div class="flex justify-between items-center">
                            <div>
                                <div class="text-2xl font-black tracking-tight">JODO</div>
                                ${state.isRepeatUser ? '<div class="text-[10px] text-green-600 font-bold">Welcome back! Previous order saved.</div>' : ''}
                            </div>
                            <div class="text-right">
                                <div class="text-xs font-bold text-gray-400 uppercase tracking-widest">Ends In</div>
                                <div id="cutoff-timer" class="text-xl font-mono font-black text-gray-900 bg-gray-100 px-2 py-0.5 rounded">${remainingTime}</div>
                            </div>
                        </div>
                    </div>
                    ${getTickerHtml()}
                    <div class="p-4 pb-32">
                        ${productsHtml}
                    </div>

                    <div class="fixed bottom-0 left-0 right-0 bg-white p-4 pb-safe border-t border-gray-100 z-50">
                         <button onclick="window.openModalFlow()" ${!hasItems ? 'disabled' : ''} class="w-full h-[64px] ${btnBg} text-white text-lg font-black rounded-xl shadow-lg active:scale-[0.98] transition-all flex flex-col items-center justify-center leading-tight">
                            <span>${ctaMain}</span>
                            ${ctaSub ? `<span class="text-[10px] opacity-80 font-medium">${ctaSub}</span>` : ''}
                         </button>
                    </div>
                </div>
            `;
        }

        function getStatusScreenHtml(group, members, myMember) {
            // FIX 3: Defensive check
            if (!group) {
                return `<div class="min-h-screen bg-white flex flex-col items-center justify-center p-8 text-center font-sans"><h2 class="text-xl font-black text-gray-300">Loading Status...</h2></div>`;
            }

            const productStats = PRODUCTS.map(p => {
                const stats = getProductStats(members, p.id);
                return { ...p, ...stats };
            });

            // --- CEO CHANGE: Invite Lock Logic (INTEGRATED, NOT REPLACEMENT) ---
            const needsInvite = !myMember.isConfirmed;
            
            // Common Share Link Logic
            // If needsInvite (Pending): I need to invite someone to confirm MY order.
            // If !needsInvite (Confirmed): I invite to drop price.
            // In both cases, referrer=myMember.id
            const groupLink = `${BASE_URL}?group=${group.id}&referrer=${myMember.id}`;
            let waText = "";
            let ctaButtonText = "";
            let ctaSubText = "";
            
            if (needsInvite) {
                waText = `‡∞®‡±á‡∞®‡±Å ‡∞ü‡∞Æ‡∞æ‡∞ü‡∞æ‡∞≤‡±Å ‡∞Ü‡∞∞‡±ç‡∞°‡∞∞‡±ç ‡∞ö‡±á‡∞∂‡∞æ‡∞®‡±Å.\n‡∞Æ‡±Ä‡∞∞‡±Å ‡∞ï‡±Ç‡∞°‡∞æ ‡∞Ü‡∞∞‡±ç‡∞°‡∞∞‡±ç ‡∞ö‡±á‡∞∏‡±ç‡∞§‡±á ‡∞Æ‡∞® ‡∞á‡∞¶‡±ç‡∞¶‡∞∞‡∞ø ‡∞Ü‡∞∞‡±ç‡∞°‡∞∞‡±ç ‡∞ï‡∞®‡±ç‡∞´‡∞∞‡±ç‡∞Æ‡±ç ‡∞Ö‡∞µ‡±Å‡∞§‡±Å‡∞Ç‡∞¶‡∞ø.\n\n‡∞Ü‡∞∞‡±ç‡∞°‡∞∞‡±ç ‡∞ö‡±á‡∞Ø‡∞°‡∞æ‡∞®‡∞ø‡∞ï‡∞ø ‡∞á‡∞ï‡±ç‡∞ï‡∞° ‡∞ï‡±ç‡∞≤‡∞ø‡∞ï‡±ç ‡∞ö‡±á‡∞Ø‡∞Ç‡∞°‡∞ø üëá\n${groupLink}`;
                ctaButtonText = "Invite 1 Family to Activate";
                ctaSubText = "Order pending until 1 person joins";
            } else {
                const totalRemainingFamilies = productStats.reduce((acc, i) => acc + Math.ceil(i.remaining/2), 0); // approx
                waText = `‡∞®‡±á‡∞®‡±Å ‡∞ü‡∞Æ‡∞æ‡∞ü‡∞æ‡∞≤‡±Å ‡∞Ü‡∞∞‡±ç‡∞°‡∞∞‡±ç ‡∞ö‡±á‡∞∂‡∞æ‡∞®‡±Å.\n‡∞á‡∞Ç‡∞ï‡∞æ ‡∞ï‡±ä‡∞®‡±ç‡∞®‡∞ø ‡∞á‡∞≥‡±ç‡∞≤‡±Å ‡∞ï‡∞≤‡∞ø‡∞∏‡±ç‡∞§‡±á ‡∞ß‡∞∞ ‡∞§‡∞ó‡±ç‡∞ó‡±Å‡∞§‡±Å‡∞Ç‡∞¶‡∞ø.\n\n‡∞á‡∞ï‡±ç‡∞ï‡∞° ‡∞ö‡±Ç‡∞°‡∞Ç‡∞°‡∞ø üëá\n${groupLink}`;
                ctaButtonText = "üîó Share to unlock price";
                ctaSubText = "‡∞á‡∞Ç‡∞ï‡∞æ ‡∞Æ‡∞Ç‡∞¶‡∞ø‡∞®‡∞ø ‡∞ï‡∞≤‡∞ø‡∞™‡∞ø‡∞§‡±á ‡∞ß‡∞∞ ‡∞§‡∞ó‡±ç‡∞ó‡±Å‡∞§‡±Å‡∞Ç‡∞¶‡∞ø";
            }
            const waLink = `https://wa.me/?text=${encodeURIComponent(waText)}`;


            const isPostCutoff = !isOrderWindowOpen(); 
            let failingItems = [], runningItems = [], cancelledItems = [];

            if (!isPostCutoff) {
                failingItems = productStats.filter(p => !p.isRunning); 
                runningItems = productStats.filter(p => p.isRunning); 
            } else {
                runningItems = productStats.filter(p => p.total >= p.target); 
                cancelledItems = productStats.filter(p => p.total < p.target); 
            }
            
            const headerTitle = isPostCutoff ? "Final Results" : "Live Status";
            
            // Header Badge Logic
            const statusBadge = needsInvite 
                ? `<div class="bg-yellow-100 text-yellow-800 text-[10px] font-bold px-3 py-1.5 rounded-full flex items-center gap-1"><i data-lucide="clock" size="10"></i> Pending</div>`
                : `<div class="bg-green-600 text-white text-[10px] font-bold px-3 py-1.5 rounded-full flex items-center gap-1"><i data-lucide="check" size="10"></i> Confirmed</div>`;

            let contentHtml = `
                <div class="bg-white px-6 py-4 border-b border-gray-100 sticky top-0 z-20 shadow-sm flex justify-between items-center">
                    <div><div class="text-xl font-black text-gray-900">${headerTitle}</div></div>
                    ${statusBadge}
                </div>
            `;
            
            contentHtml += getTickerHtml();
            contentHtml += `<div class="p-4 space-y-4">`;

            if (isPostCutoff) {
                if (runningItems.length > 0) {
                    contentHtml += `
                        <div class="bg-white rounded-2xl shadow-sm border border-green-100 p-6 text-center">
                            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4 text-green-600"><i data-lucide="check" size="32"></i></div>
                            <h2 class="text-2xl font-black text-gray-900 mb-1">Target Reached</h2>
                            <div class="text-sm text-gray-500 mb-6 font-medium">Delivery tomorrow morning.</div>
                            ${runningItems.map(p => `<div class="flex justify-between items-center py-3 border-t border-gray-50"><span class="font-bold text-gray-900">${p.name}</span><span class="font-mono font-bold text-green-600">‚Çπ${p.priceMin} Locked</span></div>`).join('')}
                        </div>
                    `;
                }
                if (cancelledItems.length > 0) {
                     contentHtml += `
                        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 text-center opacity-70 grayscale">
                            <h2 class="text-lg font-black text-gray-900 mb-1">Missed Targets</h2>
                            ${cancelledItems.map(p => `<div class="flex justify-between items-center py-2 border-b border-gray-50"><span class="font-medium text-gray-900">${p.name}</span><span class="text-xs text-gray-500">${p.total}/${p.target}kg</span></div>`).join('')}
                        </div>
                    `;
                }
            } else {
                // LIVE STATUS
                if (failingItems.length > 0) {
                    
                    // --- 1. PENDING WARNING CARD (Shown ONLY if not confirmed) ---
                    if (needsInvite) {
                        contentHtml += `
                            <div class="bg-yellow-50 rounded-2xl border border-yellow-200 p-5 mb-2 relative overflow-hidden">
                                <div class="flex gap-3 items-start relative z-10">
                                    <div class="bg-yellow-100 p-2 rounded-full text-yellow-700 shrink-0 mt-1"><i data-lucide="alert-circle" size="20"></i></div>
                                    <div>
                                        <div class="font-black text-gray-900 text-lg leading-tight mb-1">Action Required</div>
                                        <p class="text-sm text-gray-700 font-medium leading-snug">
                                            ‡∞Æ‡±Ä ‡∞Ü‡∞∞‡±ç‡∞°‡∞∞‡±ç ‡∞™‡±Ü‡∞Ç‡∞°‡∞ø‡∞Ç‡∞ó‡±ç‚Äå‡∞≤‡±ã ‡∞â‡∞Ç‡∞¶‡∞ø. ‡∞Ö‡∞¶‡∞ø ‡∞ï‡∞®‡±ç‡∞´‡∞∞‡±ç‡∞Æ‡±ç ‡∞ï‡∞æ‡∞µ‡∞æ‡∞≤‡∞Ç‡∞ü‡±á ‡∞á‡∞Ç‡∞ï‡∞æ ‡∞í‡∞ï‡±ç‡∞ï‡∞∞‡∞ø‡∞®‡∞ø ‡∞ú‡∞æ‡∞Ø‡∞ø‡∞®‡±ç ‡∞ö‡±á‡∞Ø‡∞æ‡∞≤‡∞ø.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        `;
                    }

                    // --- 2. LIVE PROGRESS (Always visible to show what they are missing/joining) ---
                    contentHtml += `
                        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                             <div class="bg-gray-50 p-4 border-b border-gray-100 text-center">
                                <div class="text-xl font-black text-gray-900 leading-tight">Live Group Status</div>
                                <div class="text-xs font-bold text-gray-500 mt-1">‡∞à ‡∞∞‡±ã‡∞ú‡±Å ‡∞Æ‡±ä‡∞§‡±ç‡∞§‡∞Ç ‡∞é‡∞Ç‡∞§ ‡∞â‡∞Ç‡∞ü‡±á ‚Äî ‡∞Ö‡∞¶‡±á ‡∞ß‡∞∞ ‡∞´‡∞ø‡∞ï‡±ç‡∞∏‡±ç ‡∞Ö‡∞µ‡±Å‡∞§‡±Å‡∞Ç‡∞¶‡∞ø</div>
                             </div>
                             <div class="p-4">
                                ${failingItems.map(p => `
                                    <div class="mb-5 last:mb-0">
                                        <div class="flex justify-between items-end mb-1">
                                            <span class="font-bold text-gray-900 text-lg">${p.name}</span>
                                        </div>
                                        <div class="w-full bg-gray-100 h-1.5 rounded-full overflow-hidden relative">
                                            <div class="h-full bg-gray-600 rounded-full" style="width: ${(p.total/p.target)*100}%"></div>
                                        </div>
                                        <div class="text-[11px] text-gray-500 font-medium mt-1">
                                          ‡∞á‡∞Ç‡∞ï‡∞æ ${getRemainingHouseholds(p.remaining)} ‡∞á‡∞≥‡±ç‡∞≤‡±Å ‡∞ï‡∞≤‡∞ø‡∞∏‡±ç‡∞§‡±á ‡∞ß‡∞∞ ‡∞§‡∞ó‡±ç‡∞ó‡±Å‡∞§‡±Å‡∞Ç‡∞¶‡∞ø
                                        </div>
                                    </div>
                                `).join('')}
                             </div>
                        </div>
                    `;

                    // --- 3. CTA (Context Aware) ---
                    contentHtml += `
                        <div class="mt-4">
                            <a href="${waLink}" target="_blank"
                             class="block w-full bg-black text-white rounded-xl py-4 text-center font-black text-sm active:scale-[0.98] shadow-lg flex flex-col items-center justify-center">
                              <span class="leading-tight text-base">${ctaButtonText}</span>
                              <span class="text-[10px] opacity-80 font-medium mt-0.5">${ctaSubText}</span>
                            </a>
                        </div>
                    `;
                } else {
                    // Success State (Live)
                    contentHtml += `
                        <div class="bg-green-50 rounded-2xl p-8 text-center border border-green-100">
                            <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4 text-green-600"><i data-lucide="lock" size="32"></i></div>
                            <h2 class="text-3xl font-black text-green-800 mb-2">Price Locked</h2>
                            <p class="text-green-700 font-medium">Target reached. Lowest price secured for everyone.</p>
                        </div>
                    `;
                }
            }
            contentHtml += `</div>`;
            return `<div class="min-h-screen bg-gray-50 flex flex-col font-sans pb-safe">${contentHtml}</div>`;
        }

        let lastRenderedHTML = '';
        function render() {
            const app = document.getElementById('app');
            const savedScroll = app.scrollTop;
            let content = '';
            if (state.view === 'home') {
                content = getHomeHtml();
            }
            if (content !== lastRenderedHTML) {
                app.innerHTML = content;
                lastRenderedHTML = content;
                if(window.lucide) window.lucide.createIcons();
                // requestAnimationFrame(() => { app.scrollTop = savedScroll; }); // Optional: maintain scroll
            }
        }

        function updateTimerUI() {
            const el = document.getElementById('cutoff-timer');
            if (el) {
                el.innerText = getCutoffRemaining();
            }
        }

        function init() {
            // URL Parsing for Referrer
            const urlParams = new URLSearchParams(window.location.search);
            const ref = urlParams.get('referrer');
            if (ref) state.referrerId = ref;

            loadUser();
            listenToCycleGroup();
            render();
            // Critical Fix 3: Optimize performance by only updating the timer text, not full re-render
            setInterval(updateTimerUI, 1000);
        }

        if (window.db) init();
        else window.addEventListener('firebase-ready', init);

    </script>
</body>
</html>
