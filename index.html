<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover" />
    <title>JODO</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üçÖ</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        jodo: {
                            base: '#FFFFFF',
                            textPrimary: '#111827',
                            ctaPrimary: '#15803D',
                            error: '#DC2626',
                        }
                    },
                    fontFamily: {
                        sans: ['-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'sans-serif'],
                        mono: ['ui-monospace', 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'monospace'],
                    },
                    animation: {
                        'pop': 'pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)',
                        'fade-in-up': 'fadeInUp 0.5s ease-out',
                        'pulse-fast': 'pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        pop: { '0%': { transform: 'scale(0.95)' }, '100%': { transform: 'scale(1)' } },
                        fadeInUp: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } }
                    }
                }
            }
        }
    </script>
    <style>
        body { background: #FFFFFF; color: #111827; -webkit-tap-highlight-color: transparent; min-height: 100dvh; display: flex; justify-content: center; margin: 0; overscroll-behavior-y: none; }
        #app { width: 100%; max-width: 448px; background: #FFFFFF; min-height: 100dvh; position: relative; overflow-y: auto; display: flex; flex-direction: column; box-shadow: 0 0 20px rgba(0,0,0,0.05); }
        .btn-press { transition: transform 0.1s; cursor: pointer; user-select: none; }
        .btn-press:active:not(:disabled) { transform: scale(0.96); }
        .card-modern { background: #FFFFFF; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid #E5E7EB; }
        .glass-header { background: rgba(255, 255, 255, 0.98); border-bottom: 1px solid #E5E7EB; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .pt-safe { padding-top: env(safe-area-inset-top); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .fade-in { animation: fadeInUp 0.5s ease-out forwards; }
        .tilt-card { transition: transform 0.15s ease-out; transform-style: preserve-3d; }
    </style>
</head>
<body class="antialiased">

    <div id="app"></div>

    <div id="modal-overlay" class="fixed inset-0 bg-black/60 hidden z-[60] flex items-end justify-center backdrop-blur-sm transition-opacity duration-300">
        <div id="modal-content" class="bg-white w-full max-w-[448px] rounded-t-[1.5rem] shadow-2xl transform transition-transform duration-300 translate-y-full max-h-[95dvh] flex flex-col overflow-hidden pb-safe"></div>
    </div>

    <div id="toast" class="fixed top-24 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-full text-sm font-medium shadow-xl hidden z-[90] flex items-center gap-2 pointer-events-none animate-pop pt-safe text-center w-max max-w-[90%]"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, getDocs, onSnapshot, collection, runTransaction, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "",
            authDomain: "jodo-prod-e7788.firebaseapp.com",
            projectId: "jodo-prod-e7788",
            storageBucket: "jodo-prod-e7788.firebasestorage.app",
            messagingSenderId: "535883967600",
            appId: "1:535883967600:web:aa0b73a70ca506ad4fd8b5"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        window.db = db;
        window.fs = { doc, getDoc, getDocs, onSnapshot, collection, runTransaction, serverTimestamp };
        
        window.dispatchEvent(new Event('firebase-ready'));
    </script>
    
    <script>
        /**
         * üî¥ PRICING & VIRALITY FREEZE DIRECTIVE üî¥
         * * 1. _unlockPrice must NEVER be rendered before status === UNLOCKED.
         * 2. Reward / wholesale price must NEVER appear alongside penalty price.
         * 3. Penalty price may be shown ONLY as text ("shop price applies") except inside the creator flow.
         * 4. Invite messages must NEVER include numbers (‚Çπ).
         * 5. Join-gate must focus on helping the host, not saving money.
         * * Any future UI change that shows two prices together is a hard revert.
         * This system is behavior-complete. Do not optimize, clarify, or "improve UX".
         */

        const BASE_URL = 'https://satyanarayanagaraga.github.io/jodo-mvp';
        const MIN_GROUP_SIZE = 2; // ‚ö†Ô∏è LOGIC: Keep 2 for test. Change to 3 ONLY after data validation.

        const PRODUCTS = [
            { 
                id: 'tomato', 
                name: 'Fresh Tomatoes', 
                nameTe: '‡∞ü‡∞Æ‡∞æ‡∞ü‡∞æ‡∞≤‡±Å', 
                unit: '1kg', 
                weightUnit: 'kg', 
                price1: 40, // Shop Price (Penalty Reference)
                // ‚ö†Ô∏è SECURITY NOTE: In a real backend, this stays on server. 
                // DO NOT RENDER THIS VALUE IN CLIENT UI. Treat as write-only for transaction.
                _unlockPrice: 20, 
                mandiPrice: 35, 
                icon: 'circle-dot', 
                imageColor: 'bg-red-50 text-red-600', 
                location: 'Duvva Fields', 
                imageSrc: 'https://images.unsplash.com/photo-1592924357228-91a4daadcfea?auto=format&fit=crop&w=800&q=80' 
            }
        ];

        const GROUPS_KEY = 'jodo_groups_joined_v1';
        
        function getISTNow() {
          return new Date(new Date().toLocaleString("en-US", { timeZone: "Asia/Kolkata" }));
        }

        function isOrderWindowOpen() { return true; } // TEST MODE: Always Open

        // üî• LOGIC CHANGE: Expiry is 3 hours to force the pressure timer to be visible and scary
        function getTodayCutoffTimestamp() {
            return Date.now() + 1000 * 60 * 60 * 3; 
        }

        const state = { 
            view: 'home', 
            currentGroupId: null, 
            groups: {}, 
            members: {}, 
            user: { name: '', phone: '', joinedGroupIds: [] }, 
            timerInterval: null, 
            lastMemberCount: 0,
            unsubGroup: null,
            unsubMembers: null,
            homeListeners: []
        };

        let JODO_INITIALIZED = false;
        let renderScheduled = false;
        let IS_JOIN_LINK = false;
        let JOIN_SESSION_PHONE = null;
        let AUTO_JOIN_TRIGGERED = false;

        function logEvent(name, params) {
            // üìä SILENT ANALYTICS
            console.log(`[JODO_ANALYTICS] ${name}`, params || {});
        }

        function loadData() {
            try {
                state.user.name = localStorage.getItem('jodo_user_name') || '';
                state.user.phone = localStorage.getItem('jodo_user_phone') || '';
                const savedGroups = localStorage.getItem(GROUPS_KEY);
                state.user.joinedGroupIds = savedGroups ? JSON.parse(savedGroups) : [];
                if (state.user.phone) JOIN_SESSION_PHONE = state.user.phone;
            } catch(e) { console.error("Load Error", e); }
        }

        function saveUser(name, phone) {
            state.user.name = name;
            state.user.phone = phone;
            localStorage.setItem('jodo_user_name', name);
            localStorage.setItem('jodo_user_phone', phone);
            JOIN_SESSION_PHONE = phone;
        }

        function saveJoinedGroup(gid) {
            if (!state.user.joinedGroupIds.includes(gid)) {
                state.user.joinedGroupIds.push(gid);
                localStorage.setItem(GROUPS_KEY, JSON.stringify(state.user.joinedGroupIds));
                listenToGroupForHome(gid);
            }
        }

        function formatTimeLeft(ms) {
            if (ms <= 0) return "00 : 00 : 00";
            const totalSeconds = Math.floor(ms / 1000);
            const h = String(Math.floor(totalSeconds / 3600)).padStart(2, '0');
            const m = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, '0');
            const s = String(totalSeconds % 60).padStart(2, '0');
            return `${h} : ${m} : ${s}`;
        }

        function startPenaltyTimer() {
            if (state.timerInterval) clearInterval(state.timerInterval);
            state.timerInterval = setInterval(() => {
                // Timer runs on both 'group' and specific join landing
                if (state.view !== 'group') return; 
                
                const g = state.groups[state.currentGroupId];
                const members = state.members[state.currentGroupId] || [];
                const isUnlocked = members.length >= MIN_GROUP_SIZE;
                
                if (!g || isUnlocked) {
                     clearInterval(state.timerInterval);
                     return;
                }

                const left = g.expiresAt - Date.now();
                const formatted = formatTimeLeft(left);

                // Update Top Timer (standard group view)
                const elTop = document.getElementById('penalty-timer-top');
                if (elTop) elTop.innerText = formatted;

                // Update Creator Card Timer (standard group view)
                const elCard = document.getElementById('penalty-timer-card');
                if (elCard) elCard.innerText = "‚è≥ " + formatted + " remaining";
                
                // Update Join Gate Timer (new focused landing)
                const elGate = document.getElementById('gate-timer');
                if (elGate) elGate.innerText = formatted;

                if (left <= 0) {
                    clearInterval(state.timerInterval);
                    safeRender(); // Trigger re-render to show expired state if needed
                }
            }, 1000);
        }

        // üî• HELPER: Get members who joined in the last X seconds
        function getRecentJoins(members, seconds = 30) {
            const now = Date.now();
            return members.filter(m => {
                // Handle potential missing timestamp (local pending write) -> treat as now
                const joinedTime = m.joinedAt ? (m.joinedAt.toMillis ? m.joinedAt.toMillis() : (m.joinedAt.seconds ? m.joinedAt.seconds * 1000 : m.joinedAt)) : now;
                return (now - joinedTime) <= seconds * 1000;
            });
        }

        window.logShare = function(gid) {
            logEvent('share_clicked', { groupId: gid });
        };

        function toast(msg, icon) { 
            const t = document.getElementById('toast'); 
            const iconColor = icon === 'share-2' ? 'text-white' : 'text-green-400';
            if (icon === 'share-2') {
                t.className = "fixed top-24 left-1/2 -translate-x-1/2 bg-blue-600 text-white px-6 py-3 rounded-full text-sm font-bold shadow-xl hidden z-[90] flex items-center gap-2 pointer-events-none animate-pop pt-safe";
            } else {
                t.className = "fixed top-24 left-1/2 -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-full text-sm font-medium shadow-xl hidden z-[90] flex items-center gap-2 pointer-events-none animate-pop pt-safe";
            }
            t.innerHTML = `<i data-lucide="${icon}" size="16" class="${iconColor}"></i> ${msg}`; 
            t.classList.remove('hidden'); 
            if(window.lucide) window.lucide.createIcons(); 
            setTimeout(() => t.classList.add('hidden'), 4000); 
        }

        function triggerVibration() { if (navigator.vibrate) navigator.vibrate(10); }

        function createNodeFromHTML(html) { 
            const t = document.createElement('template'); 
            t.innerHTML = html.trim(); 
            return t.content.firstElementChild; 
        }
        
        function showModalNode(node) { 
            const overlay = document.getElementById('modal-overlay');
            const content = document.getElementById('modal-content');
            overlay.style.display = '';
            overlay.style.pointerEvents = '';
            content.innerHTML = ''; content.appendChild(node); 
            overlay.classList.remove('hidden'); 
            setTimeout(() => { 
                overlay.classList.remove('opacity-0'); 
                content.classList.remove('translate-y-full'); 
            }, 10);
            if(node.querySelector('input')) node.querySelector('input').focus(); 
            if(window.lucide) window.lucide.createIcons(); 
        }

        window.closeModal = () => {
            const overlay = document.getElementById('modal-overlay');
            const content = document.getElementById('modal-content');
            content.classList.add('translate-y-full');
            overlay.classList.add('opacity-0');
            setTimeout(() => { 
                overlay.classList.add('hidden'); 
                content.innerHTML = ''; 
            }, 300);
        };
        
        window.forceCloseModalImmediately = function() {
            const overlay = document.getElementById('modal-overlay');
            const content = document.getElementById('modal-content');
            if (overlay) {
                overlay.classList.add('hidden');
                overlay.style.display = 'none';
                overlay.style.pointerEvents = 'none';
                overlay.className = "fixed inset-0 bg-black/60 hidden z-[60] flex items-end justify-center backdrop-blur-sm transition-opacity duration-300"; // Reset classes
            }
            if (content) content.innerHTML = '';
            document.body.style.overflow = '';
        }

        function safeVal(el) { return (el && el.value) ? el.value.trim() : ''; }

        function initCardTilt() {
            if (window.matchMedia("(pointer: coarse)").matches) return;
            const cards = document.querySelectorAll('.tilt-card');
            cards.forEach(card => {
                card.addEventListener('mousemove', (e) => {
                    const rect = card.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    const centerX = rect.width / 2;
                    const centerY = rect.height / 2;
                    const rotateX = ((y - centerY) / centerY) * -3; 
                    const rotateY = ((x - centerX) / centerX) * 3;
                    card.style.transform = `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg) scale3d(1.01, 1.01, 1.01)`;
                });
                card.addEventListener('mouseleave', () => {
                    card.style.transform = `perspective(1000px) rotateX(0deg) rotateY(0deg) scale3d(1, 1, 1)`;
                });
            });
        }

        window.openSupportOptions = function() { window.open("https://wa.me/918500742671", "_blank"); };

        function generateInviteLink(groupId, isUnlocked) {
            const currentUrl = `${BASE_URL}?group=${groupId}`;
            let inviteMsg;
            if (!isUnlocked) {
                // üîê VIRAL STRATEGY: RUTHLESS PRESSURE
                inviteMsg = `I started today‚Äôs tomato order.

If no one joins,
I‚Äôll have to buy at shop price.

Join here so the group confirms:
${currentUrl}`;
            } else {
                // üîì UNLOCKED
                inviteMsg = `Order confirmed ‚úÖ. Join here: ${currentUrl}`;
            }
            return `https://wa.me/?text=${encodeURIComponent(inviteMsg)}`;
        }

        window.openJoinFlow = function(gid) {
            if (IS_JOIN_LINK) {
                state.user.name = '';
                state.user.phone = '';
                JOIN_SESSION_PHONE = null; 
            }
            const g = state.groups[gid];
            if (!g) { toast("Loading order details...", "loader"); return; }
            if (!isOrderWindowOpen()) { toast("Orders open only 6 AM ‚Äì 8:30 AM IST", "clock"); return; }
            window.openStartModal(g.productId, gid);
        };

        window.openStartModal = function(productOrId, joinGroupId = null) {
            if (!isOrderWindowOpen()) { toast("Orders open only 6 AM ‚Äì 8:30 AM IST", "clock"); return; }
            
            let p = typeof productOrId === 'string' ? PRODUCTS.find(x => x.id === productOrId) : productOrId;
            if (!p) { toast("Product Unavailable", "alert-circle"); return; }
            
            const user = state.user;
            let qty = 0.25;
            
            const title = joinGroupId ? "Join Order" : "Start today‚Äôs order";
            const btnText = joinGroupId ? "Join & Confirm" : "Start & Commit"; 

            // üî• RULE: Price is ALWAYS hidden/locked in the modal
            // User commits blindly to the wholesale price concept
            
            // üî• RULE: Close button must NOT exist for creator (Prison Entry)
            const closeBtnHtml = joinGroupId 
                ? `<button id="close-modal" class="p-2 bg-gray-50 rounded-full text-gray-500 hover:bg-gray-100 transition-colors"><i data-lucide="x" size="20"></i></button>`
                : ``;

            // üî• VIRAL STRATEGY: WARNING
            // Shown to creator before starting
            const warningHtml = !joinGroupId 
                ? `<div class="bg-red-50 border border-red-100 rounded-lg p-3 mb-3 flex gap-2 items-start">
                      <span class="text-red-600 mt-0.5">‚ö†Ô∏è</span>
                      <div class="text-xs font-bold text-red-700 leading-tight">
                        If no one joins, shop price applies.<br>
                        <span class="font-normal opacity-90 text-[10px]">(‡∞Æ‡∞∞‡±Ü‡∞µ‡∞∞‡±Ç ‡∞∞‡∞æ‡∞ï‡∞™‡±ã‡∞§‡±á shop ‡∞∞‡±á‡∞ü‡±Å ‡∞µ‡∞∞‡±ç‡∞§‡∞ø‡∞∏‡±ç‡∞§‡±Å‡∞Ç‡∞¶‡∞ø)</span>
                      </div>
                    </div>`
                : ``;

            // üî• DELIVERY WARNING (CREATOR ONLY)
            const deliveryHtml = !joinGroupId 
                ? `<div class="bg-blue-50 border border-blue-100 rounded-lg p-3 mb-3 flex gap-2 items-start">
                      <span class="text-blue-600 mt-0.5">üì¶</span>
                      <div class="text-xs font-bold text-blue-700 leading-tight">
                        üì¶ Delivery: Tuesday & Saturday
                      </div>
                    </div>`
                : ``;

            // üî• CRITICAL FIX #2: CREATOR MODAL TAKEOVER
            // If creator (!joinGroupId), make background opaque/solid to prevent escape
            const overlay = document.getElementById('modal-overlay');
            if (!joinGroupId && overlay) {
                overlay.className = "fixed inset-0 bg-gray-900/95 hidden z-[60] flex items-end justify-center backdrop-blur-sm transition-opacity duration-300";
            } else if (overlay) {
                // Reset for joiners
                overlay.className = "fixed inset-0 bg-black/60 hidden z-[60] flex items-end justify-center backdrop-blur-sm transition-opacity duration-300";
            }

            const node = createNodeFromHTML(`
                <div class="flex flex-col h-[90vh] bg-white relative rounded-t-[1.5rem] overflow-hidden font-sans">
                    <div class="bg-white px-5 py-4 flex items-center justify-between border-b border-gray-100 shrink-0 z-20">
                        <div class="flex items-center gap-2"><h3 class="font-bold text-lg text-gray-800">${title}</h3></div>
                        ${closeBtnHtml}
                    </div>
                    <div class="p-5 overflow-y-auto flex-1 relative">
                        <div class="flex gap-4 mb-6 items-center">
                            <div class="w-24 h-24 rounded-xl bg-gray-50 border border-gray-100 relative overflow-hidden shrink-0 shadow-sm">
                                <img src="${p.imageSrc}" class="w-full h-full object-cover" alt="${p.name}">
                            </div>
                            <div class="flex-1 flex flex-col justify-center"><h4 class="font-bold text-2xl text-gray-900 leading-none mb-1">${p.name}</h4><div class="text-base text-gray-500 mb-1">${p.nameTe}</div>
                            <!-- üî• SCARCITY FIX -->
                            <div class="text-xs text-orange-800 font-bold bg-orange-50 px-2 py-1 rounded-full w-fit">Limited quantity today</div>
                            </div>
                        </div>
                        
                        <!-- Warnings Moved Here (RISK BEFORE CHOICE) -->
                        ${warningHtml}
                        ${deliveryHtml}

                        <div class="bg-white p-3 rounded-xl border border-gray-200 mb-6 flex items-center justify-between">
                            <div class="pl-1"><div class="text-xs font-bold text-gray-500 uppercase tracking-wide">Quantity</div><div class="text-[10px] text-gray-400">Min 250 g</div></div>
                            <div class="flex items-center gap-3 bg-gray-50 p-1 rounded-lg border border-gray-200"><button id="btn-minus" class="w-10 h-10 rounded-md bg-white border border-gray-200 text-gray-500 flex items-center justify-center active:scale-90 transition-all"><i data-lucide="minus" size="18"></i></button><div class="text-lg font-bold text-gray-800 w-20 text-center leading-none tabular-nums" id="qty-display">250 g</div><button id="btn-plus" class="w-10 h-10 rounded-md bg-jodo-ctaPrimary text-white shadow-sm flex items-center justify-center active:scale-90 transition-all"><i data-lucide="plus" size="18"></i></button></div>
                        </div>
                        <div class="space-y-4 mb-8">
                            <div class="relative group"><div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-gray-400"><i data-lucide="user" size="18"></i></div><input id="inp-name" value="${user.name}" class="w-full bg-white border border-gray-300 py-3 pl-12 pr-4 rounded-lg font-medium text-gray-900 outline-none focus:border-green-600 focus:ring-1 focus:ring-green-600 transition-all placeholder-gray-400" placeholder="Your Name"></div>
                            <div class="relative group"><div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none text-gray-400"><i data-lucide="phone" size="18"></i></div><input id="inp-phone" value="${user.phone}" type="tel" class="w-full bg-white border border-gray-300 py-3 pl-12 pr-4 rounded-lg font-medium text-gray-900 outline-none focus:border-green-600 focus:ring-1 focus:ring-green-600 transition-all placeholder-gray-400" placeholder="Mobile Number"></div>
                        </div>
                    </div>
                    <div class="bg-gray-50 border-t-2 border-gray-200 p-4 shrink-0 pb-safe shadow-[0_-4px_10px_rgba(0,0,0,0.02)] z-20">
                        <div class="flex justify-between items-end mb-3 px-1"><div><div class="text-[10px] text-gray-500 font-bold uppercase">Total</div><div class="text-3xl font-bold text-gray-900 leading-none" id="footer-total"><span class="text-gray-400 text-xl flex items-center gap-1"><i data-lucide="lock" size="18"></i> Locked</span></div></div></div>
                        <div class="text-center text-[11px] text-gray-500 font-medium mb-2">No payment now ‚Ä¢ Pay on delivery</div>
                        <button id="action-btn" class="w-full bg-jodo-ctaPrimary text-white h-[64px] rounded-xl font-bold text-lg shadow-sm flex items-center justify-center gap-2 cursor-pointer active:scale-[0.99] transition-all btn-press">
                            <span id="btn-text-action">${btnText}</span>
                        </button>
                    </div>
                </div>
            `);
            showModalNode(node);

            const footerTotalEl = node.querySelector('#footer-total');
            const actionBtn = node.querySelector('#action-btn');

            const renderMode = () => {
                let qtyText = qty < 1 ? (qty * 1000).toFixed(0) + ' g' : qty + ' kg';
                node.querySelector('#qty-display').innerText = qtyText;
                // Price always locked/hidden in modal
                footerTotalEl.innerHTML = `<span class="text-gray-400 text-xl flex items-center gap-1"><i data-lucide="lock" size="18"></i> Locked</span>`;
            };
            
            const btnMinus = node.querySelector('#btn-minus'); 
            if (btnMinus) btnMinus.onclick = () => { 
                if (qty <= 0.25) { toast("Minimum quantity reached", 'alert-triangle'); triggerVibration(); return; }
                if (qty <= 0.5) qty = 0.25; else if (qty <= 1.0) qty = 0.5; else qty -= 0.5;
                renderMode(); 
            }; 
            
            const btnPlus = node.querySelector('#btn-plus'); 
            if (btnPlus) btnPlus.onclick = () => { 
                let nextQty; if (qty < 0.5) nextQty = 0.5; else if (qty < 1.0) nextQty = 1.0; else nextQty = qty + 0.5;
                qty = nextQty; renderMode(); 
            };

            renderMode(); 
            // üî• CRITICAL FIX #3: Joiner Confirmation Check
            if (joinGroupId) {
                node.querySelector('#close-modal').addEventListener('click', () => {
                    if (confirm("If you leave, this order may fail. Continue?")) {
                        window.closeModal();
                    }
                });
            }
            
            const triggerAction = async () => {
                if (!navigator.onLine) { toast("No internet connection", "wifi-off"); return; }
                if (!isOrderWindowOpen()) { toast("Orders closed", "clock"); return; }
                if (actionBtn.disabled) return; 
                
                actionBtn.disabled = true;
                const originalText = actionBtn.innerHTML; 
                actionBtn.innerHTML = `<div class="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>`; 
                actionBtn.classList.add('opacity-75', 'cursor-not-allowed');
                
                const name = safeVal(node.querySelector('#inp-name')); 
                const phone = safeVal(node.querySelector('#inp-phone')); 
                
                if (!name || !/^[6-9]\d{9}$/.test(phone)) { 
                    actionBtn.disabled = false; actionBtn.innerHTML = originalText; actionBtn.classList.remove('opacity-75', 'cursor-not-allowed');
                    toast('Please enter name and mobile number', 'alert-circle'); 
                    return; 
                }
                
                triggerVibration(); 
                saveUser(name, phone); 
                
                if (joinGroupId) {
                      const g = state.groups[joinGroupId];
                      const hostName = g ? g.ownerName : "Host";
                      const modalContent = node.querySelector('.p-5'); 
                      const footer = node.querySelector('.bg-gray-50.border-t-2'); // Updated selector
                      modalContent.innerHTML = `
                        <div class="flex flex-col items-center justify-center h-full pt-10 text-center space-y-4 animate-in fade-in zoom-in duration-300">
                            <div class="w-20 h-20 rounded-full bg-green-100 flex items-center justify-center animate-bounce">
                                <i data-lucide="clock" class="text-green-600" size="40"></i>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-gray-900">${hostName} is waiting...</h3>
                                <p class="text-gray-500 mt-2 font-medium">If you join, order gets confirmed.</p>
                            </div>
                        </div>
                      `;
                      if(footer) footer.style.display = 'none'; 
                      if(window.lucide) window.lucide.createIcons(); 
                      await new Promise(r => setTimeout(r, 900)); 
                }
                
                const memberId = phone; 
                const finalGroupId = joinGroupId || ('g-' + Date.now().toString(36) + Math.random().toString(36).slice(2, 6));

                if (!window.fs || !window.db) { toast("Connecting...", "wifi"); await new Promise(r => setTimeout(r, 1000)); }

                try {
                    const requestedKg = qty; // FIX 4: Simplified math
                    let didUnlock = false;
                    
                    // FIX 1: Strip sensitive fields before saving
                    const { _unlockPrice, mandiPrice, ...safeProduct } = p;

                    await window.fs.runTransaction(window.db, async (transaction) => {
                        if (!joinGroupId) {
                            const groupData = { 
                                id: finalGroupId, productId: pid = p.id, productSnapshot: safeProduct, ownerName: name, 
                                expiresAt: getTodayCutoffTimestamp(), deliveryDay: new Date(getISTNow().setHours(18, 0, 0, 0)).getTime(), 
                                createdAt: window.fs.serverTimestamp(), type: 'group', maxKg: 100, usedKg: 0, pendingKg: requestedKg, 
                                memberCount: 1, unlockedAt: null, status: 'OPEN'
                            };
                            const memberData = { memberId, groupId: finalGroupId, name, phone, isLeader: true, quantity: qty, orderPlacedAt: window.fs.serverTimestamp(), joinedAt: window.fs.serverTimestamp() };
                            transaction.set(window.fs.doc(window.db, "groups", finalGroupId), groupData);
                            transaction.set(window.fs.doc(window.db, "groups", finalGroupId, "members", memberId), memberData);
                        } else {
                            const groupRef = window.fs.doc(window.db, "groups", finalGroupId);
                            const groupSnap = await transaction.get(groupRef);
                            if (!groupSnap.exists()) throw "GROUP_NOT_FOUND";
                            
                            const memberRef = window.fs.doc(window.db, "groups", finalGroupId, "members", memberId);
                            const memberSnap = await transaction.get(memberRef);
                            if (memberSnap.exists()) throw "ALREADY_JOINED";
                            
                            const gd = groupSnap.data();
                            const newCount = (gd.memberCount || 1) + 1;
                            let updates = {};

                            if (!gd.firstJoinAt) updates.firstJoinAt = window.fs.serverTimestamp();
                            
                            if (newCount >= MIN_GROUP_SIZE && !gd.unlockedAt) {
                                didUnlock = true;
                                updates = { ...updates, usedKg: (gd.usedKg || 0) + (gd.pendingKg || 0) + requestedKg, pendingKg: 0, memberCount: newCount, unlockedAt: window.fs.serverTimestamp(), groupPrice: p._unlockPrice, status: 'UNLOCKED' };
                            } else {
                                if (gd.unlockedAt) updates = { ...updates, usedKg: (gd.usedKg || 0) + requestedKg, memberCount: newCount };
                                else updates = { ...updates, pendingKg: (gd.pendingKg || 0) + requestedKg, memberCount: newCount };
                            }
                            transaction.set(memberRef, { memberId, name, phone, groupId: finalGroupId, quantity: qty, isLeader: false, orderPlacedAt: window.fs.serverTimestamp(), joinedAt: window.fs.serverTimestamp() });
                            transaction.update(groupRef, updates);
                        }
                    });

                    saveJoinedGroup(finalGroupId);
                    JOIN_SESSION_PHONE = phone;
                    
                    if (!joinGroupId) {
                        logEvent('group_created', { groupId: finalGroupId, phone: memberId });
                        toast("You started today‚Äôs order", "check-circle");
                        
                        // üî• CRITICAL FIX #1: Clean Modal Close for Creator
                        forceCloseModalImmediately();
                        
                        window.openGroup(finalGroupId);
                    } else {
                        IS_JOIN_LINK = false; AUTO_JOIN_TRIGGERED = true;
                        if (didUnlock) {
                            logEvent('group_unlocked', { groupId: finalGroupId });
                            toast("You helped confirm the order", "check-circle");
                        } else {
                            toast("Joined! One more needed.", "share-2");
                        }
                        logEvent('member_joined', { groupId: finalGroupId, phone: memberId });
                        window.closeModal();
                        window.openGroup(finalGroupId);
                    }
                } catch (e) {
                    console.error("Order Failed:", e);
                    const msg = e.message || e;
                    if (msg.includes("ALREADY_JOINED") || e === "ALREADY_JOINED") {
                        saveJoinedGroup(finalGroupId);
                        window.closeModal();
                        window.openGroup(finalGroupId);
                        toast("Already joined!", "check-circle");
                    } else {
                        actionBtn.disabled = false; actionBtn.innerHTML = originalText; actionBtn.classList.remove('opacity-75', 'cursor-not-allowed');
                        toast("Order failed. Please try again.", "alert-triangle");
                    }
                }
            };
            actionBtn.onclick = triggerAction;
        };

        // üî• NEW FUNCTION: Dedicated Focused Join Screen
        function renderJoinGate(el, g) {
            const p = g.productSnapshot || PRODUCTS.find(x => x.id === g.productId);
            const timeLeft = g.expiresAt - Date.now();
            
            el.innerHTML = `
                <div class="fade-in bg-white min-h-screen flex flex-col items-center pt-safe px-6 relative font-sans">
                     <!-- HARD GATE: No navigation, no distractions -->
                     
                     <div class="w-full max-w-sm mx-auto flex flex-col items-center mt-8 mb-8">
                        <!-- 1. IDENTITY -->
                        <div class="mb-5 text-center">
                            <h1 class="font-black text-2xl tracking-tight text-jodo-ctaPrimary leading-none mb-2">JODO</h1>
                            <div class="text-[10px] font-bold text-gray-400 uppercase tracking-widest">You were invited by ${g.ownerName}</div>
                        </div>

                        <!-- 2. PRESSURE (Moved UP) -->
                        <div class="text-center mb-4">
                             <div class="text-[10px] font-bold text-red-500 uppercase tracking-widest mb-1">Time left to confirm</div>
                             <div id="gate-timer" class="text-4xl font-black text-red-600 tracking-widest tabular-nums font-mono leading-none whitespace-nowrap animate-pulse">
                                ${formatTimeLeft(timeLeft)}
                             </div>
                        </div>

                        <!-- PRODUCT HERO (Reduced size) -->
                        <div class="w-28 h-28 bg-gray-50 rounded-full mb-4 relative overflow-hidden mx-auto">
                             <img src="${p.imageSrc}" class="w-full h-full object-cover">
                        </div>

                        <!-- 3. CONSEQUENCE -->
                        <div class="bg-gray-50 border border-gray-200 rounded-xl p-5 w-full text-center shadow-sm mb-4">
                            <div class="font-bold text-gray-900 text-lg mb-2">${g.ownerName} needs your help</div>
                            <div class="text-sm text-gray-600 font-medium leading-relaxed">
                                You won‚Äôt pay anything now.<br>
                                Order confirms when you join.<br>
                                <span class="text-red-600 font-bold block mt-2 bg-white p-2 rounded-lg border border-red-100">
                                    If you don‚Äôt join, they pay shop price.<br>
                                    <span class="font-normal opacity-90 text-[10px]">(‡∞Æ‡±Ä‡∞∞‡±Å ‡∞∞‡∞æ‡∞ï‡∞™‡±ã‡∞§‡±á ‡∞µ‡∞æ‡∞∞‡±Å shop ‡∞∞‡±á‡∞ü‡±Å ‡∞ï‡∞ü‡±ç‡∞ü‡∞æ‡∞≤‡∞ø)</span>
                                </span>
                            </div>
                        </div>

                        <!-- 4. ACTION -->
                        <div class="text-xs font-bold text-gray-600 bg-gray-100 px-4 py-2 rounded-full mb-4">
                          üì¶ Delivery: Tuesday & Saturday
                        </div>

                        <button onclick="openJoinFlow('${g.id}')" class="w-full bg-jodo-ctaPrimary text-white h-[68px] rounded-2xl font-bold text-xl shadow-[0_10px_30px_rgba(21,128,61,0.25)] flex items-center justify-center gap-2 active:scale-95 transition-all btn-press">
                            Join to help confirm
                        </button>
                        
                        <!-- 5. REASSURANCE -->
                        <div class="mt-4 text-[10px] text-gray-400 font-medium">Safe & Secure ‚Ä¢ No payment required</div>
                     </div>
                </div>
            `;
            // Ensure timer starts
            startPenaltyTimer();
        }

        function renderHome(el) {
            const activeUserGroups = [];
            state.user.joinedGroupIds.forEach(gid => {
                const g = state.groups[gid];
                if (g) activeUserGroups.push(g);
            });
            activeUserGroups.sort((a, b) => b.createdAt - a.createdAt);
            
            if (activeUserGroups.length === 0) {
                const p = PRODUCTS[0];
                el.innerHTML = `
                    <div class="pb-safe fade-in bg-white min-h-screen flex flex-col">
                        <div class="glass-header sticky top-0 z-40 shadow-sm border-b-0">
                            <div class="pt-safe px-4 pb-3 flex justify-between items-end min-h-[88px]">
                                <div class="flex flex-col justify-end pb-0.5">
                                    <h1 class="font-black text-2xl tracking-tight text-jodo-ctaPrimary leading-none mb-1">JODO</h1>
                                    <div class="text-[10px] font-bold text-orange-600 mt-1"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex-1 flex flex-col items-center justify-center px-6 text-center animate-in fade-in duration-500 -mt-10">
                            <div class="w-32 h-32 bg-gray-50 rounded-full mb-6 border-4 border-white shadow-xl relative overflow-hidden ring-1 ring-gray-100">
                                 <img src="${p.imageSrc}" class="w-full h-full object-cover">
                            </div>
                            <h2 class="text-3xl font-bold text-gray-900 leading-tight mb-2 tracking-tight">Today‚Äôs tomato order is OPEN</h2>
                            <p class="text-gray-500 font-medium mb-10 text-lg">Not confirmed yet.</p>
                            
                            <div class="space-y-3 mt-8 w-full max-w-[320px]">
                                <button onclick="openStartModal('${p.id}')" class="w-full bg-jodo-ctaPrimary text-white h-[64px] rounded-2xl font-bold text-xl shadow-[0_8px_30px_rgb(0,0,0,0.12)] flex items-center justify-center gap-2 active:scale-95 transition-all btn-press">
                                    Start today‚Äôs order
                                </button>
                                <div class="text-center">
                                    <div class="text-xs font-bold text-blue-700 bg-blue-50 px-4 py-2 rounded-full inline-block">
                                        üì¶ Delivery: Tuesday & Saturday
                                    </div>
                                </div>
                                <!-- üî• VIRAL STRATEGY: PAIN AVOIDANCE COPY -->
                                <div class="text-xs text-red-600 font-medium mt-3 text-center">
                                    Without ${MIN_GROUP_SIZE} people, you will pay shop price.<br>
                                    <span class="font-normal opacity-90 text-[10px]">(‡∞á‡∞Ç‡∞ï‡±Ü‡∞µ‡∞∞‡±Å join ‡∞ï‡∞æ‡∞ï‡∞™‡±ã‡∞§‡±á shop price ‡∞µ‡∞∞‡±ç‡∞§‡∞ø‡∞∏‡±ç‡∞§‡±Å‡∞Ç‡∞¶‡∞ø)</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                if (window.lucide) window.lucide.createIcons();
                initCardTilt();
                return;
            }

            const cardsHtml = activeUserGroups.map(g => {
                const p = g.productSnapshot || PRODUCTS.find(x => x.id === g.productId);
                if (!p) return '';
                const members = state.members[g.id] || []; 
                const isUnlocked = members.length >= MIN_GROUP_SIZE;
                const statusLabel = isUnlocked ? 'Confirmed ‚úÖ' : 'Not Confirmed';
                const statusClass = isUnlocked ? 'text-green-700 bg-green-50 border-green-200' : 'text-gray-600 bg-gray-50 border-gray-200';
                
                return `<div onclick="openGroup('${g.id}')" class="shrink-0 w-[85%] max-w-[280px] snap-center cursor-pointer card-modern tilt-card">
                    <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-200 relative overflow-hidden h-full flex flex-col justify-between">
                        <div class="flex items-center gap-3 mb-3 relative z-10 mt-2">
                            <div class="w-12 h-12 bg-gray-50 border border-gray-100 rounded-lg flex items-center justify-center text-gray-700 shadow-sm shrink-0"><i data-lucide="${p.icon}" size="24"></i></div>
                            <div class="flex-1 min-w-0"><h3 class="font-bold text-gray-900 text-base leading-none mb-2 truncate">${p.name}</h3>
                                <div class="flex items-center justify-between gap-2">
                                    <div class="${statusClass} text-[9px] font-bold px-2 py-0.5 rounded border uppercase tracking-wider whitespace-nowrap">${statusLabel}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;
            }).join('');

            el.innerHTML = `
                <div class="pb-safe fade-in bg-white">
                    <div class="glass-header sticky top-0 z-40 shadow-sm border-b-0">
                        <div class="pt-safe px-4 pb-3 flex justify-between items-end min-h-[88px]">
                            <div class="flex flex-col justify-end pb-0.5">
                                <h1 class="font-black text-2xl tracking-tight text-jodo-ctaPrimary leading-none mb-1">JODO</h1>
                                <span class="text-[10px] text-gray-500 font-bold tracking-wide">Group orders work differently</span>
                                <div class="text-[10px] font-bold text-orange-600 mt-1"></div>
                            </div>
                        </div>
                    </div>
                    <div class="mt-6 mb-4"><div class="px-4 flex gap-3 overflow-x-auto snap-x snap-mandatory no-scrollbar pb-2">${cardsHtml}</div></div>
                    
                    <div class="px-4 space-y-3 mt-2 pb-32">
                        <div class="flex items-center justify-between mb-2 mt-6">
                            <h2 class="text-xs font-bold text-gray-500 uppercase tracking-widest">Start New Order</h2>
                        </div>
                        <div onclick="openStartModal('tomato')" class="bg-white p-4 rounded-2xl shadow-[0_2px_12px_rgba(0,0,0,0.04)] border border-gray-100 relative overflow-hidden active:scale-[0.99] transition-all duration-200 cursor-pointer mb-3">
                            <div class="flex gap-4">
                                <div class="w-24 h-24 bg-gray-50 rounded-xl shrink-0 relative overflow-hidden border border-gray-100">
                                     <img src="${PRODUCTS[0].imageSrc}" class="w-full h-full object-cover" loading="lazy">
                                </div>
                                <div class="flex-1 flex flex-col justify-between py-1">
                                    <div><h3 class="font-bold text-lg text-gray-900 leading-tight mb-1">${PRODUCTS[0].name}</h3><p class="text-sm text-gray-500">${PRODUCTS[0].nameTe}</p></div>
                                    <!-- üî• SCARCITY FIX -->
                                    <div class="text-xs text-orange-800 font-bold bg-orange-50 px-2 py-1 rounded-full w-fit">Limited quantity today</div>
                                    <div class="mt-2"><div class="text-sm font-medium text-gray-500 mt-1">Today‚Äôs order is not confirmed yet</div></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            initCardTilt();
            if(window.lucide) window.lucide.createIcons();
        }

        function renderGroup(el) {
            const g = state.groups[state.currentGroupId]; 
            if (!g) {
                el.innerHTML = `<div class="min-h-screen bg-white p-6 pt-24 space-y-6"><div class="w-2/3 h-8 bg-gray-100 rounded-lg skeleton mx-auto"></div></div>`;
                return;
            }
            
            const p = g.productSnapshot || PRODUCTS.find(x => x.id === g.productId); 
            if (!p) { toast('Product data missing', 'alert-circle'); return; }
            
            const members = state.members[g.id] || []; 
            const isUnlocked = members.length >= MIN_GROUP_SIZE;
            const hasJoinedThisGroup = !IS_JOIN_LINK && JOIN_SESSION_PHONE && members.some(m => m.phone === JOIN_SESSION_PHONE);
            const isCreator = JOIN_SESSION_PHONE && g.ownerName && members.some(m => m.phone === JOIN_SESSION_PHONE && m.isLeader === true);
            const isMember = hasJoinedThisGroup || isCreator;

            // üî• FATAL ISSUE #1 FIX: HARD JOIN GATE
            // If they are on a join link AND haven't joined yet -> Show ONLY the Gate.
            if (IS_JOIN_LINK && !isMember) {
                renderJoinGate(el, g);
                if(window.lucide) window.lucide.createIcons();
                return;
            }

            // ... (Rest of standard renderGroup logic for members/creators)
            
            // üî• CRITICAL FIX #2: Hard Expiry Check
            const isExpired = Date.now() > g.expiresAt;
            if (isExpired && !isUnlocked) {
                logEvent('group_expired', { groupId: g.id });
                el.innerHTML = `
                    <div class="min-h-screen flex flex-col items-center justify-center text-center px-6">
                        <i data-lucide="x-circle" size="48" class="text-red-500 mb-4"></i>
                        <h2 class="text-2xl font-black text-gray-900 mb-2">Order Cancelled</h2>
                        <p class="text-gray-500 mb-6">
                            No one joined in time.
                        </p>
                        <button onclick="goHome()" class="bg-jodo-ctaPrimary text-white px-6 py-3 rounded-xl font-bold">
                            Start New Order
                        </button>
                    </div>
                `;
                if(window.lucide) window.lucide.createIcons();
                return;
            }

            const inviteLink = generateInviteLink(g.id, isUnlocked);
            
            // üî• LOGIC: THE PRISON STATE
            // If group is NOT unlocked and user is in it, they CANNOT leave easily.
            const isPrison = (isCreator || hasJoinedThisGroup) && !isUnlocked;
            
            // üî• HARD RULE: REMOVE BACK BUTTON IN PRISON STATE
            const backButtonHtml = isPrison 
                ? `<div class="flex items-center gap-2 text-amber-600"><i data-lucide="lock" size="16"></i><span class="font-bold text-xs uppercase tracking-wider">Commitment Locked</span></div>`
                : `<div class="flex items-center gap-3 cursor-pointer pt-safe" onclick="goHome()">
                       <i data-lucide="arrow-left" size="24" class="text-gray-700"></i>
                       <span class="font-bold text-base tracking-wide text-gray-800">Back</span>
                   </div>`;

            // üî• LOGIC: Locked Creator View
            const creatorCardClass = isUnlocked ? "bg-green-50 border border-green-200" : "bg-gray-50 border border-gray-200";
            const creatorIconColor = isUnlocked ? "text-green-700" : "text-gray-400";
            const creatorTextColor = isUnlocked ? "text-green-900" : "text-gray-700";

            // üî• TIMER LOGIC
            const timeLeft = g.expiresAt - Date.now();
            const timerTopHtml = !isUnlocked ? `
                <div class="flex flex-col items-center mb-6 animate-in fade-in zoom-in duration-300">
                    <div class="text-[10px] font-bold text-red-500 uppercase tracking-widest mb-1">Time left before shop price applies</div>
                    <div id="penalty-timer-top" class="text-4xl sm:text-5xl font-black text-red-600 tracking-[0.15em] sm:tracking-[0.2em] tabular-nums font-mono leading-none animate-pulse whitespace-nowrap">
                        ${formatTimeLeft(timeLeft)}
                    </div>
                </div>
            ` : '';

            // üî• LIVE BUYING LOGIC (LAST 45 SECONDS)
            const recentJoins = getRecentJoins(members, 45);
            if (recentJoins.length > 0) {
                setTimeout(() => safeRender(), 46000);
            }

            const liveBuyingHtml = (!isUnlocked && recentJoins.length > 0) ? `
                <div class="mb-3 space-y-0.5 animate-in fade-in-up duration-300">
                    ${recentJoins.slice(-3).map(m => `
                        <div class="text-[11px] text-gray-500 font-medium flex items-center justify-center gap-2">
                            <span class="w-2 h-2 bg-green-500 rounded-full"></span>
                            ${(m.name === 'You' || m.phone === JOIN_SESSION_PHONE) ? 'You' : m.name} just joined
                        </div>
                    `).join('')}
                </div>
            ` : '';

            const timerCardHtml = !isUnlocked ? `
                <div id="penalty-timer-card" class="text-xs font-mono text-red-500 font-bold mt-1 opacity-80">
                   ‚è≥ ${formatTimeLeft(timeLeft)} remaining
                </div>
            ` : '';

            // üî• TOTAL QUANTITY CALCULATION (Fix 4: Simplified Math)
            const totalQty = members.reduce((sum, m) => sum + (m.quantity || 0), 0);
            const totalQtyLabel = totalQty < 1 ? (totalQty * 1000).toFixed(0) + ' g' : totalQty.toFixed(1) + ' kg';

            const qtySummaryHtml = `
            <div class="bg-gray-50 border border-gray-200 rounded-xl p-3 mb-4 text-center">
              <div class="text-xs text-gray-500 font-medium">Total quantity committed</div>
              <div class="text-lg font-bold text-gray-900">${totalQtyLabel}</div>
            </div>`;

            el.innerHTML = `
                <div class="fade-in bg-white min-h-screen pb-40 font-sans">
                    <div class="glass-header h-[60px] sticky top-0 z-50 px-4 flex justify-between items-center bg-white shadow-sm border-b border-gray-100 mb-6">
                        ${backButtonHtml}
                    </div>
                    
                    <div class="p-4">
                        ${timerTopHtml}
                        ${liveBuyingHtml}
                        
                        <div class="flex flex-col items-center mb-4 mt-2 animate-in fade-in-up duration-300">
                            ${!isUnlocked && isMember ? '<div class="text-xs font-bold text-red-500 mb-2" id="validity-warning">Not confirmed yet</div>' : ''}
                            <div class="w-28 h-28 rounded-full border-4 border-white shadow-lg overflow-hidden mb-6 relative z-10 bg-gray-100">
                                <img src="${p.imageSrc}" class="w-full h-full object-cover" alt="${p.name}">
                            </div>
                            <h1 class="text-2xl font-bold text-gray-900 leading-none mb-1 tracking-tight text-center">${p.name}</h1>
                            <div class="text-xs font-bold text-blue-700 bg-blue-50 px-3 py-1 rounded-full mb-3 inline-block">
                              üì¶ Delivery: Tuesday & Saturday
                            </div>
                            <div class="text-[10px] text-gray-400 font-medium mb-2">Picked up fresh from local market</div>
                            <div class="text-xs text-orange-800 font-bold bg-orange-50 px-2 py-1 rounded-full w-fit mb-2">Limited quantity today</div>
                            <p class="text-sm font-medium text-gray-500 mb-2">${p.nameTe}</p>
                        </div>

                        ${isCreator ? `
                        <div class="${creatorCardClass} p-5 rounded-xl text-center mb-6 transition-colors duration-300">
                            <div class="flex justify-center items-center gap-2 mb-1">
                                <i data-lucide="crown" class="${creatorIconColor}" size="20"></i>
                                <span class="font-black ${creatorTextColor} text-sm uppercase tracking-wide">You started this order</span>
                            </div>
                            <!-- üî• VIRAL STRATEGY: FAILURE PENALTY -->
                            <p class="text-sm text-red-700 font-semibold leading-snug">
                                ${isUnlocked ? 'Order confirmed ‚úÖ' : `If no one joins, you will pay ‚Çπ${p.price1}/kg.`}
                            </p>
                            ${!isUnlocked ? '<p class="text-[11px] text-gray-500 mt-1">This is today‚Äôs shop price.<br><span class="opacity-90 font-normal">(‡∞é‡∞µ‡∞∞‡±Ç ‡∞∞‡∞æ‡∞ï‡∞™‡±ã‡∞§‡±á shop ‡∞ß‡∞∞)</span></p>' : ''}
                            ${timerCardHtml}
                        </div>` : ''}

                        ${isMember ? `
                        <div class="bg-white border rounded-xl p-4 mb-6 shadow-sm ${isUnlocked ? 'border-green-100' : 'border-red-100 bg-gray-50'}">
                            <div class="space-y-4 mb-6">
                                ${!isUnlocked ? `
                                <div class="transition-all p-4 -mx-3 rounded-lg border border-red-100 bg-red-50 flex flex-col items-center justify-center text-center gap-2 mb-2">
                                    <div class="w-10 h-10 rounded-full bg-white text-red-500 flex items-center justify-center shadow-sm mb-1">
                                        <i data-lucide="alert-triangle" size="20"></i>
                                    </div>
                                    <div>
                                        <div class="text-red-700 font-bold text-sm leading-tight">Your order will be cancelled</div>
                                        <div class="text-red-400 text-[10px] font-medium mt-1 uppercase tracking-wide">If no one else joins</div>
                                    </div>
                                </div>
                                ` : `
                                <div class="flex justify-between items-center transition-all p-3 -mx-3 rounded-lg bg-green-50 border border-green-100">
                                    <div class="flex items-center gap-3">
                                        <div class="w-8 h-8 rounded-full bg-green-600 text-white flex items-center justify-center text-xs font-bold"><i data-lucide="check" size="14"></i></div>
                                        <span class="text-sm font-bold text-green-800">Order confirmed ‚úÖ</span>
                                    </div>
                                </div>
                                `}
                            </div>
                        </div>
                        ` : ''} 
                        
                        <!-- Note: Non-members now see renderJoinGate -->

                        ${isMember ? `
                        
                        <!-- FIX 3: Group Quantity Summary -->
                        ${qtySummaryHtml}

                        <div class="space-y-4 mb-8">
                            <div class="flex justify-between items-end mb-4">
                                <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest">${isCreator ? 'People in Your Group' : 'People Joined'}</h3>
                                <div class="flex flex-col items-end">
                                    ${!isUnlocked ? `<span class="text-xs font-bold text-red-500 animate-pulse">Group incomplete</span>` : '<span class="text-xs font-bold text-green-600">Confirmed</span>'}
                                </div>
                            </div>
                            
                            <!-- SOCIAL PRESSURE TEXT -->
                            <div class="text-[10px] text-gray-400 mb-3 text-center italic">People in this group can see who joined.</div>

                            ${members.map((member) => {
                                const isMe = JOIN_SESSION_PHONE === member.phone;
                                const weight = member.quantity; // FIX 4: Simplified Math
                                const weightLabel = weight < 1 ? (weight * 1000).toFixed(0) + 'g' : weight + 'kg';
                                
                                // GHOST LOGIC: If Locked, hide details, gray out
                                // FIX 1 & 2: Show Quantity in Locked State
                                if (!isUnlocked) {
                                     return `<div class="bg-white border border-gray-100 p-3 rounded-xl mb-2 flex items-center justify-between opacity-80 grayscale">
                                          <div class="flex items-center gap-3">
                                              <div class="w-8 h-8 rounded-full bg-gray-100 text-gray-400 flex items-center justify-center font-bold text-xs border border-white">${member.name[0]}</div>
                                              <div>
                                                <div class="text-sm font-bold text-gray-700">
                                                    ${isMe ? 'You' : member.name} 
                                                    <span class="text-xs font-medium text-gray-400 ml-1">(${weightLabel})</span>
                                                </div>
                                              </div>
                                          </div>
                                          <span class="text-xs font-bold text-gray-500 bg-gray-100 px-2 py-1 rounded">${weightLabel}</span>
                                      </div>`;
                                }

                                // REVEALED LOGIC: Unlocked
                                let t = Math.round(g.groupPrice * member.quantity);
                                // weight/weightLabel already calculated above
                                const priceDisplay = '‚Çπ'+t;

                                if (member.isLeader) {
                                    return `<div class="bg-green-50 border border-green-200 p-4 rounded-xl shadow-sm mb-3 transition-all relative overflow-hidden">
                                            <div class="absolute top-0 right-0 bg-green-200 text-green-800 text-[9px] font-bold px-2 py-0.5 rounded-bl-lg uppercase tracking-wide">Host</div>
                                            <div class="flex items-center justify-between mb-2">
                                                <div class="flex items-center gap-3">
                                                    <div class="w-10 h-10 rounded-full bg-green-600 text-white flex items-center justify-center font-bold text-sm shadow-sm shrink-0 border-2 border-white ring-2 ring-green-100">
                                                        <i data-lucide="crown" size="16"></i>
                                                    </div>
                                                    <div>
                                                        <div class="text-sm font-bold text-gray-900 flex items-center gap-2">${isMe ? 'You (Host)' : member.name}</div>
                                                        <div class="text-xs text-green-700 font-medium">${weightLabel}</div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="flex justify-between items-center pt-2 border-t border-green-200/60">
                                                <span class="text-[10px] font-medium text-green-700 uppercase">Total</span>
                                                <span class="text-sm font-bold text-green-800">${priceDisplay}</span>
                                            </div>
                                    </div>`;
                                }

                                return `<div class="bg-white border border-gray-100 p-3 rounded-xl shadow-[0_1px_2px_rgba(0,0,0,0.03)] mb-2 transition-all cursor-default">
                                    <div class="flex items-center justify-between mb-2">
                                        <div class="flex items-center gap-3">
                                            <div class="w-8 h-8 rounded-full ${isMe ? 'bg-gray-800 text-white' : 'bg-gray-100 text-gray-500'} flex items-center justify-center font-bold text-xs border border-white shadow-sm shrink-0">${member.name[0]}</div>
                                            <div><div class="text-sm font-bold text-gray-800 flex items-center gap-2">${isMe ? 'You' : member.name}</div><div class="text-xs text-gray-400 font-medium">${weightLabel}</div></div>
                                        </div>
                                    </div>
                                    <div class="flex justify-between items-center pt-2 border-t border-gray-5">
                                        <span class="text-[10px] font-medium text-gray-400 uppercase">Total</span>
                                        <span class="text-sm font-bold text-gray-900">${priceDisplay}</span>
                                    </div>
                                </div>`;
                            }).join('')}
                        </div>` : ''}
                    </div>

                    <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 p-4 pb-safe z-50 shadow-[0_-4px_20px_rgba(0,0,0,0.03)]">
                        <div class="max-w-md mx-auto pt-2 pb-2">
                            ${(() => {
                                if (isCreator || (hasJoinedThisGroup && !isUnlocked)) {
                                    return `
                                    <div class="text-center text-[10px] text-gray-400 font-medium mb-1">${!isUnlocked ? 'If you don‚Äôt send, order fails' : 'Share deal with more people'}</div>
                                    <a href="${inviteLink}" target="_blank" onclick="logShare('${g.id}')" class="block w-full bg-jodo-ctaPrimary text-white h-[56px] flex items-center justify-center rounded-xl font-bold text-lg text-center shadow-sm btn-press gap-2 transition-all">
                                        <i data-lucide="share-2" size="20"></i>
                                        <div class="flex flex-col items-center leading-none">
                                            <span>${!isUnlocked ? 'Share Now' : 'Share Link'}</span>
                                        </div>
                                    </a>`;
                                }
                                return ''; 
                            })()}
                        </div>
                    </div>
                </div>
            `;
            if (window.lucide) window.lucide.createIcons();
            if (!isUnlocked) startPenaltyTimer(); // START TIMER IF NOT UNLOCKED
        }

        function render() {
            const app = document.getElementById('app');
            if (!app) return;
            if (state.view === 'home') renderHome(app);
            else renderGroup(app);
            if (window.lucide) window.lucide.createIcons();
        }
        
        function safeRender() {
            if (renderScheduled) return;
            renderScheduled = true;
            requestAnimationFrame(() => { render(); renderScheduled = false; });
        }

        function listenToGroupForHome(gid) {
            if (!window.fs || !window.db) return;
            const unsubG = window.fs.onSnapshot(window.fs.doc(window.db, "groups", gid), (doc) => { if (doc.exists()) { state.groups[gid] = doc.data(); safeRender(); } });
            state.homeListeners.push(unsubG);
            const unsubM = window.fs.onSnapshot(window.fs.collection(window.db, "groups", gid, "members"), (snap) => {
                const m = []; snap.forEach(d => m.push({ ...d.data(), id: d.id })); m.sort((a, b) => a.joinedAt - b.joinedAt); state.members[gid] = m; safeRender();
            });
            state.homeListeners.push(unsubM);
        }

        function initHomeListeners() {
            state.homeListeners.forEach(u => u()); state.homeListeners = [];
            state.user.joinedGroupIds.forEach(gid => listenToGroupForHome(gid));
        }

        window.openGroup = function(gid) { 
            if (!gid || typeof gid !== 'string') { window.goHome(); return; }
            try { if (window.location.protocol !== 'blob:') history.pushState({}, '', `${BASE_URL}?group=${gid}`); } catch(e) {} 
            state.currentGroupId = gid; state.view = 'group';
            if (state.unsubGroup) { state.unsubGroup(); state.unsubGroup = null; }
            if (state.unsubMembers) { state.unsubMembers(); state.unsubMembers = null; }
            safeRender(); 
            if (window.fs && window.db) {
                state.unsubGroup = window.fs.onSnapshot(window.fs.doc(window.db, "groups", gid), (doc) => { if (doc.exists()) { state.groups[gid] = doc.data(); safeRender(); } else { window.goHome(); } });
                state.unsubMembers = window.fs.onSnapshot(window.fs.collection(window.db, "groups", gid, "members"), (snapshot) => {
                    const members = []; snapshot.forEach((doc) => { members.push({ ...doc.data(), id: doc.id }); });
                    members.sort((a, b) => a.joinedAt - b.joinedAt); state.members[gid] = members; safeRender();
                });
            }
        };

        window.goHome = function() { 
            if (state.unsubGroup) { state.unsubGroup(); state.unsubGroup = null; }
            if (state.unsubMembers) { state.unsubMembers(); state.unsubMembers = null; }
            if (state.timerInterval) { clearInterval(state.timerInterval); state.timerInterval = null; }
            try { if (window.location.protocol !== 'blob:') history.pushState({}, '', BASE_URL); } catch(e) {} 
            AUTO_JOIN_TRIGGERED = false; state.view = 'home'; state.currentGroupId = null; safeRender(); 
        };

        function init() {
            if (JODO_INITIALIZED) return; JODO_INITIALIZED = true;
            const params = new URLSearchParams(window.location.search);
            const gid = params.get('group');
            if (gid) { IS_JOIN_LINK = true; state.user = { name: '', phone: '', joinedGroupIds: [] }; JOIN_SESSION_PHONE = null; state.view = 'group'; state.currentGroupId = gid; } else { loadData(); IS_JOIN_LINK = false; state.view = 'home'; }
            const startApp = () => { if (IS_JOIN_LINK && state.currentGroupId) { safeRender(); window.openGroup(state.currentGroupId); } else { initHomeListeners(); safeRender(); } };
            if (window.db) startApp(); else window.addEventListener('firebase-ready', startApp);
            window.addEventListener('popstate', () => { const params = new URLSearchParams(location.search); const gid = params.get('group'); if (gid) window.openGroup(gid); else window.goHome(); });
        }
        
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
