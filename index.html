<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />

    <title>‚ö°Ô∏è JODO - LOCK PRICE</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>‚ö°Ô∏è</text></svg>">
    
    <!-- ‚úÖ 1. GLOBAL ERROR HANDLER FIRST -->
    <script>
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            if (msg.includes("ResizeObserver")) return;
            console.error("Global Error:", msg);
            return false;
        };
    </script>

    <!-- ‚úÖ 2. TAILWIND & CONFIG -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // SAFEGUARD: Wait for Tailwind
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof tailwind !== 'undefined') {
                tailwind.config = { 
                    theme: { 
                        extend: { 
                            colors: { 
                                jodo: { 
                                    urgent: '#E02E24', // Pinduoduo Red
                                    risk: '#FF5722',   // Risk Orange
                                    bg: '#FFF5F5',     // Dirty White
                                    text: '#1A1A1A'    // Hard Black
                                } 
                            }, 
                            animation: { 
                                'pulse-fast': 'pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                                'shake': 'shake 0.5s cubic-bezier(.36,.07,.19,.97) both'
                            },
                            spacing: {
                                'dense': '0.35rem'
                            }
                        } 
                    } 
                }
            } else {
                console.warn("Tailwind CSS not loaded - offline or blocked.");
            }
        });
    </script>

    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    
    <!-- ‚úÖ 3. FIREBASE -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import {
        getFirestore, doc, setDoc, getDoc, getDocs, updateDoc, onSnapshot,
        collection, runTransaction, serverTimestamp, query, where, increment, Timestamp
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyAHsRiYhNea5tFpKVSU7YA9nsR6qINtQdA",
        authDomain: "jodo-prod-v2.firebaseapp.com",
        projectId: "jodo-prod-v2",
        storageBucket: "jodo-prod-v2.firebasestorage.app",
        messagingSenderId: "577075664016",
        appId: "1:577075664016:web:dcf613e7650217cc94b415"
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      window.db = db;
      window.auth = auth;
      window.appId = "jodo-prod-v2"; 
      window.signInAnonymously = signInAnonymously; 
      
      window.fs = {
        doc, setDoc, getDoc, getDocs, updateDoc, onSnapshot,
        collection, runTransaction, serverTimestamp, query, where, increment, Timestamp
      };
      
      console.log("üöÄ JODO PRESSURE SYSTEM v1.0 - NO MERCY MODE");

      const initAuth = async () => {
        try {
            await signInAnonymously(auth);
        } catch (e) {
            console.error("Auth failed", e);
        }
      };
      initAuth();
    </script>
    
    <style>
        body { background: #FFF5F5; color: #1A1A1A; -webkit-tap-highlight-color: transparent; min-height: 100dvh; display: flex; justify-content: center; margin: 0; overscroll-behavior-y: none; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        #app { width: 100%; max-width: 448px; background: #FFFFFF; min-height: 100dvh; position: relative; overflow-y: auto; display: flex; flex-direction: column; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
        
        /* üî¥ AGGRESSIVE BUTTONS */
        .btn-press { transition: transform 0.05s; cursor: pointer; user-select: none; }
        .btn-press:active:not(:disabled) { transform: scale(0.96); opacity: 0.9; }
        
        .glass-header { background: #FFF5F5; border-bottom: 2px solid #FFE4E6; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .pt-safe { padding-top: env(safe-area-inset-top); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* üî¥ URGENCY ANIMATIONS */
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-4px); } 75% { transform: translateX(4px); } }
        .animate-shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        
        .skeleton { background: #E5E7EB; background: linear-gradient(110deg, #ececec 8%, #f5f5f5 18%, #ececec 33%); border-radius: 4px; background-size: 200% 100%; animation: 1.5s shine linear infinite; }
        @keyframes shine { to { background-position-x: -200%; } }
    </style>
</head>
<body class="antialiased">

    <div id="app">
        <div style="height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #FFF5F5; color: #E02E24;">
            <div class="animate-bounce text-4xl mb-4">‚ö°Ô∏è</div>
            <div class="font-black text-xl uppercase tracking-tighter">Loading Market...</div>
        </div>
    </div>

    <!-- MODAL -->
    <div id="modal-overlay" class="fixed inset-0 bg-black/90 hidden z-[60] flex items-end justify-center backdrop-blur-sm transition-opacity duration-200">
        <div id="modal-content" class="bg-white w-full max-w-[448px] rounded-t-xl shadow-2xl transform transition-transform duration-200 translate-y-full max-h-[95dvh] flex flex-col overflow-hidden pb-safe"></div>
    </div>

    <!-- TOAST (URGENT STYLE) -->
    <div id="toast" class="fixed top-20 left-1/2 -translate-x-1/2 bg-gray-900 text-white px-6 py-3 rounded shadow-2xl hidden z-[90] flex items-center gap-3 pointer-events-none pt-safe text-center w-[90%] font-bold text-sm border-l-4 border-jodo-urgent"></div>

    <!-- FAILURE OVERLAY (SCAR) -->
    <div id="failure-overlay" class="fixed inset-0 bg-red-900 z-[100] hidden flex flex-col items-center justify-center text-white p-6 text-center">
        <div class="text-6xl mb-4">‚ùå</div>
        <h1 class="text-3xl font-black uppercase tracking-tighter mb-2">Group Failed</h1>
        <p class="text-lg font-bold text-red-200 mb-6">You paid ‚Çπ40/kg instead of ‚Çπ30/kg.</p>
        <div class="bg-red-950/50 p-4 rounded-lg border border-red-800 mb-8 max-w-xs">
            <div class="text-[10px] uppercase font-bold text-red-400 mb-1">Reason</div>
            <div class="text-sm font-bold">Group did not complete in time.</div>
        </div>
        <div class="text-xs font-black uppercase tracking-widest text-red-400 mb-2">Redirecting...</div>
    </div>

    <script type="module">
        // ==========================================
        // 1. CONSTANTS & CONFIG
        // ==========================================
        const CONSTANTS = {
            PUBLIC_SHARE_URL: "https://satyanarayanagaraga.github.io/jodo-mvp/",
            ANCHOR_TARGET_KG: 15, 
            CUTOFF_HOUR: 23, 
            GROUPS_STORAGE_KEY: 'jodo_groups_joined_v16',
            PRODUCTS: [
                { 
                    id: 'tomato', 
                    name: 'Hybrid Tomato', 
                    nameTe: '‡∞ü‡∞Æ‡∞æ‡∞ü‡∞æ‡∞≤‡±Å', 
                    unit: '1kg', 
                    step: 1, 
                    anchor: true, 
                    imageSrc: 'https://images.unsplash.com/photo-1592924357228-91a4daadcfea?auto=format&fit=crop&w=400&q=80' // Smaller image load
                },
                { 
                    id: 'potato', 
                    name: 'Potato', 
                    nameTe: '‡∞¨‡∞Ç‡∞ó‡∞æ‡∞≥‡∞æ‡∞¶‡±Å‡∞Ç‡∞™', 
                    unit: '1kg', 
                    step: 1, 
                    anchor: false, 
                    imageSrc: 'https://images.unsplash.com/photo-1518977676601-b53f82a6b696?auto=format&fit=crop&w=400&q=80' 
                },
                { 
                    id: 'chilli', 
                    name: 'Green Chilli', 
                    nameTe: '‡∞™‡∞ö‡±ç‡∞ö‡∞ø‡∞Æ‡∞ø‡∞∞‡±ç‡∞ö‡∞ø', 
                    unit: '250g', 
                    step: 0.25, 
                    anchor: false, 
                    imageSrc: 'https://images.unsplash.com/photo-1588879468533-9505f3dcaa23?auto=format&fit=crop&w=400&q=80' 
                }
            ],
            PRODUCT_LIMITS: { tomato: 50, potato: 20, chilli: 5 },
            PRICE_TIERS: {
                tomato: { base: 40, target: 30 } 
            }
        };

        // ==========================================
        // 2. STORE
        // ==========================================
        const Store = {
            state: {
                view: null, 
                currentGroupId: null,
                isInviteOnly: false,
                groups: {},
                members: {},
                user: { name: '', phone: '', address: '', joinedGroupIds: [] }, 
                cart: {},
                isAppInitialized: false,
                authReady: false,
                isOffline: !navigator.onLine,
                hasSharedGroups: {} // ‚úÖ LOGIC FIX 1: Per-group timestamps
            },
            update(key, value) {
                this.state[key] = value;
                if(['view', 'groups', 'members', 'cart', 'isOffline', 'hasSharedGroups'].includes(key)) UI.scheduleRender();
            },
            updateUser(field, value) {
                this.state.user[field] = value;
                if (field === 'joinedGroupIds') localStorage.setItem(CONSTANTS.GROUPS_STORAGE_KEY, JSON.stringify(value));
                else localStorage.setItem(`jodo_user_${field}`, value);
            },
            loadFromStorage() {
                try {
                    this.state.user.name = localStorage.getItem('jodo_user_name') || '';
                    this.state.user.phone = localStorage.getItem('jodo_user_phone') || '';
                    this.state.user.address = localStorage.getItem('jodo_user_address') || '';
                    const savedGroups = localStorage.getItem(CONSTANTS.GROUPS_STORAGE_KEY);
                    this.state.user.joinedGroupIds = savedGroups ? JSON.parse(savedGroups) : [];
                    
                    const savedShares = localStorage.getItem('jodo_shared_groups');
                    this.state.hasSharedGroups = savedShares ? JSON.parse(savedShares) : {};
                    
                    // Migration check: if values are boolean, convert to old timestamp (or ignore)
                    for (let k in this.state.hasSharedGroups) {
                        if (typeof this.state.hasSharedGroups[k] === 'boolean') {
                            this.state.hasSharedGroups[k] = Date.now() - 1000 * 60 * 5; // Default to 5 mins ago
                        }
                    }
                } catch(e) { console.error("Storage Error", e); }
            }
        };

        // ==========================================
        // 3. UTILITIES
        // ==========================================
        const Utils = {
            Time: {
                getCutoffTimestamp() {
                    const now = new Date();
                    const istOffset = 5.5 * 60 * 60 * 1000;
                    const istTime = new Date(now.getTime() + istOffset);
                    istTime.setUTCHours(CONSTANTS.CUTOFF_HOUR, 59, 59, 999);
                    return istTime.getTime() - istOffset;
                },
                isTimestampPast(ts) {
                    if (!ts) return false;
                    const millis = ts.seconds ? ts.seconds * 1000 : (typeof ts === 'number' ? ts : 0);
                    return Date.now() > millis;
                },
                calculateInitialCutoff() {
                    return window.fs.Timestamp.fromMillis(this.getCutoffTimestamp());
                }
            },
            Pricing: {
                formatQty(qty) {
                    if (qty < 1) {
                        return (qty * 1000).toFixed(0) + 'g';
                    }
                    return qty + 'kg';
                }
            }
        };

        // ==========================================
        // 4. BACKEND ACTIONS
        // ==========================================
        const Backend = {
            async joinGroup({ name, phone, address, cart, joinGroupId, isManual }) {
                if (!window.auth.currentUser) {
                    try { await window.signInAnonymously(window.auth); }
                    catch(e) { throw new Error("Net Fail. Retry."); }
                }

                if (!name || !phone) throw new Error("Name/Phone Missing.");
                
                if (!joinGroupId) {
                    const q = window.fs.query(
                        window.fs.collection(window.db, 'artifacts', window.appId, 'public', 'data', "groups"),
                        window.fs.where('ownerPhone', '==', phone),
                        window.fs.where('status', 'in', ['FORMING', 'VALID'])
                    );
                    const snap = await window.fs.getDocs(q);
                    if (!snap.empty) {
                        const existing = snap.docs[0].data();
                        if (!Utils.Time.isTimestampPast(existing.expiresAt)) {
                             return { success: true, groupId: existing.id };
                        }
                    }
                }

                const groupId = joinGroupId || window.fs.doc(window.fs.collection(window.db, 'artifacts', window.appId, 'public', 'data', "groups")).id;
                const groupRef = window.fs.doc(window.db, 'artifacts', window.appId, 'public', 'data', "groups", groupId);
                const memberRef = window.fs.doc(window.db, 'artifacts', window.appId, 'public', 'data', "groups", groupId, "members", phone);
                const userUid = window.auth.currentUser.uid;

                await window.fs.runTransaction(window.db, async (transaction) => {
                    const groupSnap = await transaction.get(groupRef);
                    const memberSnap = await transaction.get(memberRef);

                    let gData;
                    if (!groupSnap.exists()) {
                        gData = { 
                            id: groupId, ownerName: name, ownerPhone: phone, ownerId: userUid,
                            expiresAt: Utils.Time.calculateInitialCutoff(),
                            createdAt: window.fs.serverTimestamp(),
                            status: 'FORMING', 
                            memberCount: 0
                        };
                        transaction.set(groupRef, gData);
                    } else { 
                        gData = groupSnap.data();
                        if (gData.status === 'CANCELLED') throw "Deal Dead.";
                        if (Utils.Time.isTimestampPast(gData.expiresAt)) throw "Too Late.";
                    }

                    if (isManual && memberSnap.exists()) {
                         throw "Already added. Cannot edit.";
                    }

                    if (!memberSnap.exists()) {
                        transaction.update(groupRef, { memberCount: window.fs.increment(1) });
                    }

                    transaction.set(memberRef, { 
                        memberId: phone, name, phone, address, cart,
                        joinedAt: memberSnap.exists() ? memberSnap.data().joinedAt : window.fs.serverTimestamp(),
                        updatedAt: window.fs.serverTimestamp(),
                        isLeader: (!joinGroupId && !memberSnap.exists()) || (gData.ownerPhone === phone),
                        isManualEntry: isManual
                    }, { merge: true });
                });

                return { success: true, groupId };
            }
        };

        // ==========================================
        // 5. CLIENT SERVICES
        // ==========================================
        const Services = {
            Data: {
                listenToGroup(gid) {
                    window.fs.onSnapshot(window.fs.doc(window.db, 'artifacts', window.appId, 'public', 'data', "groups", gid), (snap) => {
                        if (snap.exists()) Store.update('groups', { ...Store.state.groups, [gid]: snap.data() });
                    }, (err) => console.warn("Group Listen Error", err));

                    window.fs.onSnapshot(window.fs.collection(window.db, 'artifacts', window.appId, 'public', 'data', "groups", gid, "members"), (snap) => {
                        const mList = [];
                        snap.forEach(d => mList.push({ ...d.data(), id: d.id }));
                        mList.sort((a,b) => (b.isLeader?1:0) - (a.isLeader?1:0));
                        Store.update('members', { ...Store.state.members, [gid]: mList });
                    }, (err) => console.warn("Member Listen Error", err));
                }
            }
        };

        // ==========================================
        // 6. ACTIONS & ROUTING
        // ==========================================
        const Actions = {
            initApp() {
                Store.loadFromStorage();
                window.addEventListener('online', () => { Store.update('isOffline', false); UI.toast("Back online", "wifi"); });
                window.addEventListener('offline', () => { Store.update('isOffline', true); UI.toast("OFFLINE", "wifi-off"); });

                const params = new URLSearchParams(window.location.search);
                const gid = params.get('group');
                Store.state.user.joinedGroupIds.forEach(id => Services.Data.listenToGroup(id));

                if (gid) {
                    Store.update('isInviteOnly', true);
                    Store.update('currentGroupId', gid);
                    Services.Data.listenToGroup(gid);
                    Store.update('view', 'group');

                    // ‚úÖ BLOCKER #5: FAILURE SCAR (CHECK ON LOAD)
                    setTimeout(() => {
                        const g = Store.state.groups[gid];
                        if (g && Utils.Time.isTimestampPast(g.expiresAt)) {
                            UI.showFailureScar();
                        }
                    }, 1500);

                } else {
                    Store.update('view', 'home');
                }
                Store.update('isAppInitialized', true);
                window.addEventListener('popstate', () => {
                    const p = new URLSearchParams(location.search);
                    const g = p.get('group');
                    if (g) { Store.update('currentGroupId', g); Store.update('view', 'group'); } 
                    else { Store.update('currentGroupId', null); Store.update('view', 'home'); }
                });
            },

            getActiveOwnedGroup() {
                const { user, groups } = Store.state;
                if (!user.phone) return null;
                return Object.values(groups).find(g => 
                    g.ownerPhone === user.phone && 
                    ['FORMING', 'VALID'].includes(g.status) &&
                    !Utils.Time.isTimestampPast(g.expiresAt)
                ) || null;
            },

            joinTodaysDeal() {
                const active = this.getActiveOwnedGroup();
                if (active) {
                    this.navigateToGroup(active.id);
                    return;
                }
                UI.openCheckoutModal(null);
            },

            updateCart(productId, delta) {
                if (Store.state.isOffline) { UI.toast("Offline!", "wifi-off"); return; }
                const currentQty = Store.state.cart[productId] || 0;
                let newQty = Math.round((currentQty + delta) * 100) / 100;
                if (newQty < 0) newQty = 0;
                const limit = CONSTANTS.PRODUCT_LIMITS[productId] || 20;
                if (newQty > limit) { UI.toast("Limit reached", "alert-circle"); return; }
                const newCart = { ...Store.state.cart };
                if (newQty === 0) delete newCart[productId]; else newCart[productId] = newQty;
                Store.update('cart', newCart);
                UI.triggerVibration();
            },

            navigateToGroup(gid) {
                try { history.pushState({}, '', `?group=${gid}`); } catch(e) {}
                Store.update('currentGroupId', gid);
                Store.update('view', 'group');
                Services.Data.listenToGroup(gid);
            },

            navigateToHome() {
                if (Store.state.isInviteOnly) return; 
                try { history.pushState({}, '', window.location.pathname); } catch(e) {}
                Store.update('currentGroupId', null);
                Store.update('view', 'home');
            },

            async submitOrder(name, phone, address, joinGroupId, isManual = false) {
                if (isManual) {
                    const currentUid = window.auth.currentUser?.uid;
                    const activeGroup = Actions.getActiveOwnedGroup();
                    if (!activeGroup || activeGroup.ownerId !== currentUid) {
                         UI.toast("Leader Only", "alert-circle");
                         return false;
                    }
                }

                if (!name || !/^[6-9]\d{9}$/.test(phone)) { UI.toast('Check Name/Phone', 'alert-circle'); return false; }
                if (!isManual && (!address || address.length < 3)) { UI.toast('Address needed', 'map-pin'); return false; }
                
                if (!isManual) { Store.updateUser('name', name); Store.updateUser('phone', phone); Store.updateUser('address', address); }

                try {
                    const resultGroupId = joinGroupId || 'pending-temp-id'; 
                    if (joinGroupId) {
                        const optimisticMembers = [...(Store.state.members[joinGroupId] || [])];
                        const existingIdx = isManual ? -1 : optimisticMembers.findIndex(m => m.phone === phone);
                        
                        const newMemberData = {
                            phone, name, address, 
                            cart: { ...Store.state.cart }, 
                            isLeader: existingIdx === -1 && optimisticMembers.length === 0, 
                            joinedAt: { seconds: Date.now()/1000 },
                            isManualEntry: isManual
                        };
                        
                        if (existingIdx > -1) {
                            optimisticMembers[existingIdx] = { ...optimisticMembers[existingIdx], ...newMemberData };
                        } else {
                            optimisticMembers.push(newMemberData);
                        }
                        
                        Store.update('members', {
                            ...Store.state.members,
                            [joinGroupId]: optimisticMembers
                        });
                    }

                    const result = await Backend.joinGroup({ name, phone, address, cart: Store.state.cart, joinGroupId, isManual });
                    const finalGroupId = result.groupId;
                    
                    if (!isManual) {
                        const joined = [...Store.state.user.joinedGroupIds];
                        if(!joined.includes(finalGroupId)) { joined.push(finalGroupId); Store.updateUser('joinedGroupIds', joined); }
                        Store.update('cart', {});
                        this.navigateToGroup(finalGroupId);
                        
                        // ‚úÖ LOGIC FIX 2: NO EMOTIONAL CLOSURE
                        setTimeout(() => {
                            UI.toast("PRICE NOT LOCKED. SHARE NOW.", "alert-triangle");
                            const btn = document.querySelector('.fixed.bottom-0 button');
                            if(btn) btn.classList.add('animate-shake');
                        }, 500);
                        
                    } else { 
                        UI.toast("Added", "user-plus");
                        Store.update('cart', {}); 
                        if (resultGroupId) UI.closeModal(); 
                    }
                    return true;
                } catch (e) {
                    console.error(e);
                    UI.toast("Fail: " + e, "alert-triangle");
                    return false;
                }
            }
        };

        // ==========================================
        // 7. UI RENDERER (DENSITY EXTREME)
        // ==========================================
        const UI = {
            renderScheduled: false,
            scheduleRender() {
                if (this.renderScheduled) return;
                this.renderScheduled = true;
                requestAnimationFrame(() => { this.render(); this.renderScheduled = false; });
            },
            render() {
                const app = document.getElementById('app');
                if (!app) return;
                
                if (Store.state.isOffline) {
                    const banner = document.getElementById('offline-banner');
                    if(!banner) {
                        const b = document.createElement('div');
                        b.id = 'offline-banner';
                        b.className = 'bg-gray-900 text-white text-[10px] font-black tracking-widest text-center py-1 fixed top-0 w-full z-[100]';
                        b.innerText = 'OFFLINE - RECONNECTING';
                        document.body.appendChild(b);
                    }
                } else {
                    const banner = document.getElementById('offline-banner');
                    if(banner) banner.remove();
                }

                const { view } = Store.state;
                if (view === 'home') this.renderHome(app);
                else if (view === 'group') this.renderGroup(app);
                if (window.lucide) window.lucide.createIcons();
            },

            // --- VIEW: HOME (PRESSURE COOKER) ---
            renderHome(container) {
                if (Store.state.isInviteOnly) { this.renderGroup(container); return; }

                const { user, groups } = Store.state;
                const anchorP = CONSTANTS.PRODUCTS.find(p => p.anchor);
                const targetPrice = CONSTANTS.PRICE_TIERS.tomato.target;
                
                // üî¥ AGGRESSIVE HOME COPY & DENSITY
                let content = `
                <div class="bg-jodo-bg min-h-screen pb-20 flex flex-col font-sans">
                    <div class="glass-header sticky top-0 z-40 px-3 pt-safe pb-2 flex justify-between items-center shadow-sm">
                        <div class="font-black text-xl text-jodo-urgent tracking-tighter italic">‚ö°Ô∏èJODO</div>
                        <div class="bg-red-100 text-jodo-urgent px-2 py-0.5 rounded-sm text-[10px] font-black border border-red-200 flex items-center gap-1 uppercase tracking-tight">
                            <i data-lucide="clock" size="10"></i> Expires Tonight
                        </div>
                    </div>

                    <div class="flex-1 flex flex-col px-3 mt-4">
                        <!-- HERO PRICE TAG -->
                        <div class="bg-white rounded-lg shadow-sm border border-red-100 overflow-hidden mb-4">
                            <div class="bg-red-50 p-3 flex justify-between items-center border-b border-red-100">
                                <div class="font-black text-red-600 text-sm uppercase tracking-tighter">Today Only</div>
                                <div class="text-[10px] font-bold text-red-400 line-through">Market Price ‚Çπ${CONSTANTS.PRICE_TIERS.tomato.base}</div>
                            </div>
                            <div class="p-4 flex items-center gap-4">
                                <div class="w-24 h-24 bg-gray-100 rounded-sm shrink-0">
                                    <img src="${anchorP.imageSrc}" class="w-full h-full object-cover grayscale-[20%] contrast-125">
                                </div>
                                <div class="flex flex-col">
                                    <h1 class="text-xl font-black text-gray-900 leading-none mb-1">${anchorP.name}</h1>
                                    <div class="flex items-baseline gap-1">
                                        <span class="text-4xl font-black text-jodo-urgent tracking-tighter">‚Çπ${targetPrice}</span>
                                        <span class="text-sm font-bold text-gray-500">/kg</span>
                                    </div>
                                    <div class="text-[10px] font-bold text-orange-600 mt-1 bg-orange-50 inline-block px-1 rounded">
                                        ‚ö†Ô∏è Price increases if group fails
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- CTA BUTTON -->
                        <button onclick="window.JodoApp.Actions.joinTodaysDeal()" class="w-full bg-jodo-urgent text-white rounded-lg p-4 shadow-lg btn-press text-center relative overflow-hidden group mb-4 border-b-4 border-red-800">
                             <div class="absolute inset-0 bg-white/10 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                             <div class="relative z-10 flex flex-col items-center">
                                <h2 class="text-xl font-black mb-0 uppercase tracking-tighter leading-none">Start Group & Lock Price</h2>
                             </div>
                        </button>
                        
                        <!-- PSYCHOLOGICAL TRIGGER (AMBIGUOUS PROOF) -->
                        <div class="text-center">
                             <div class="inline-flex items-center gap-2 bg-gray-200 rounded-full px-3 py-1">
                                <span class="relative flex h-2 w-2">
                                  <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                                  <span class="relative inline-flex rounded-full h-2 w-2 bg-red-600"></span>
                                </span>
                                <span class="text-[10px] font-bold text-gray-600 uppercase tracking-tight">People nearby are joining today</span>
                             </div>
                        </div>
                    </div>
                </div>`;
                container.innerHTML = content;
            },

            // --- VIEW: GROUP (PRESSURE CHAMBER) ---
            renderGroup(container) {
                const { currentGroupId, groups, members, user } = Store.state;
                const g = groups[currentGroupId];
                
                if (!g) {
                    setTimeout(() => {
                        if (!Store.state.groups[currentGroupId]) {
                            try { history.replaceState({}, '', window.location.pathname); } catch(e) {}
                            Store.update('isInviteOnly', false);
                            Store.update('currentGroupId', null);
                            Store.update('view', 'home');
                        }
                    }, 1500);

                    container.innerHTML = `
                    <div class="h-screen flex flex-col items-center justify-center text-center p-6 bg-jodo-bg">
                        <div class="animate-spin w-8 h-8 border-4 border-jodo-urgent rounded-full border-t-transparent mb-4"></div>
                        <div class="text-xs font-black text-jodo-urgent uppercase">Loading Status...</div>
                    </div>`;
                    return;
                }

                // ‚úÖ BLOCKER #5: CHECK EXPIRED AGAIN ON RENDER
                if (Utils.Time.isTimestampPast(g.expiresAt)) {
                    this.showFailureScar();
                    return;
                }

                const memberList = members[currentGroupId] || [];
                const isMember = memberList.some(m => m.phone === user.phone);
                const anchorP = CONSTANTS.PRODUCTS.find(p => p.anchor);
                
                const totalAnchorKg = memberList.reduce((sum, m) => sum + (m.cart?.[anchorP.id] || 0), 0);
                const percent = Math.min(100, (totalAnchorKg / CONSTANTS.ANCHOR_TARGET_KG) * 100);
                const isTargetMet = totalAnchorKg >= CONSTANTS.ANCHOR_TARGET_KG;
                const remaining = Math.max(0, CONSTANTS.ANCHOR_TARGET_KG - totalAnchorKg);
                
                // ‚úÖ ISSUE #3: CLAMP MATH TO AVOID MANUAL ENTRY INFLATION
                const rawAvg = memberList.length > 0 ? (totalAnchorKg / memberList.length) : 0;
                // Cap avg at 5kg so a leader buying 50kg doesn't make people count drop to zero
                const avgOrderSize = Math.min(rawAvg, 5); 
                // Fallback to 2.5kg base
                const peopleNeeded = Math.ceil(remaining / Math.max(avgOrderSize, 2.5));

                const myMember = memberList.find(m => m.phone === user.phone);
                const myCart = myMember?.cart || {};
                
                const currentUid = window.auth.currentUser?.uid;
                // ‚úÖ LOGIC FIX 3: STRICT LEADERSHIP (UID ONLY)
                const isLeader = g.ownerId === currentUid;
                const manualMembers = memberList.filter(m => m.isManualEntry);

                // üî¥ ZONE 1: STATUS (THREAT BAR)
                // Red background if failing. Green only if success.
                const statusBg = isTargetMet ? 'bg-green-600' : 'bg-jodo-urgent';
                const statusText = isTargetMet ? 'PRICE LOCKED ‚úÖ' : `‚ö†Ô∏è ${remaining}kg LEFT ‚Äî PRICE NOT LOCKED`;
                
                const statusHtml = `
                <div class="${statusBg} p-4 pb-6 text-center text-white relative overflow-hidden transition-colors duration-500">
                    <div class="relative z-10">
                        <div class="text-2xl font-black mb-1 tracking-tighter leading-none animate-shake">
                            ${statusText}
                        </div>
                        ${!isTargetMet ? `
                        <div class="text-[10px] font-bold text-red-100 uppercase tracking-widest bg-black/20 inline-block px-2 py-0.5 rounded">
                            ‚âà ${peopleNeeded} more people needed
                        </div>` : ''}
                    </div>
                    <!-- PROGRESS BAR -->
                    <div class="w-full bg-black/20 h-3 rounded-full overflow-hidden mt-3 relative max-w-[240px] mx-auto border border-white/20">
                        <div class="bg-yellow-400 h-full transition-all duration-700 relative" style="width: ${percent}%"></div>
                    </div>
                </div>`;

                // üî¥ ZONE 2: MIDDLE (RISK REMINDER)
                let middleZoneHtml = '';
                if (isMember) {
                    const addOnEntries = Object.entries(myCart).filter(([id]) => id !== anchorP.id);
                    
                    // IF NOT MET, SHOW "AT RISK" BADGE
                    const riskBadge = !isTargetMet ? 
                        `<div class="absolute top-0 right-0 bg-orange-500 text-white text-[9px] font-black px-2 py-1 uppercase tracking-wider rounded-bl-lg z-20">At Risk</div>` : 
                        `<div class="absolute top-0 right-0 bg-green-500 text-white text-[9px] font-black px-2 py-1 uppercase tracking-wider rounded-bl-lg z-20">Safe</div>`;

                    middleZoneHtml = `
                    <div class="mx-3 -mt-4 p-4 bg-white rounded-lg shadow-lg border border-gray-200 text-center relative overflow-hidden mb-3" onclick="window.JodoApp.UI.openCheckoutModal('${g.id}')">
                        ${riskBadge}
                        <div class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1">My Order</div>
                        <div class="flex items-center justify-center gap-2">
                             <div class="text-3xl font-black text-gray-900 leading-none">${Utils.Pricing.formatQty(myCart[anchorP.id] || 0)}</div>
                             <div class="text-sm font-bold text-gray-600">${anchorP.name}</div>
                        </div>
                        
                        ${addOnEntries.length > 0 ? `<div class="text-[10px] text-gray-500 font-bold mt-2">+ Add-ons included</div>` : ''}
                        
                        <div class="mt-3 border-t border-gray-100 pt-2">
                             <span class="text-[10px] font-bold text-blue-600 underline uppercase">Edit Order</span>
                        </div>
                    </div>`;
                } else {
                    // Non-member: Urgent Pitch
                    middleZoneHtml = `
                    <div class="mx-3 -mt-4 p-4 bg-white rounded-lg shadow-lg border border-red-100 flex items-center gap-3 relative overflow-hidden">
                        <div class="w-16 h-16 bg-gray-100 rounded shrink-0"><img src="${anchorP.imageSrc}" class="w-full h-full object-cover"></div>
                        <div>
                             <h2 class="text-lg font-black text-gray-900 leading-tight">${anchorP.name}</h2>
                             <div class="text-xs font-bold text-red-500 bg-red-50 inline-block px-1 rounded">Wholesale Price Risk</div>
                        </div>
                    </div>`;
                }

                const myOrderSummaryHtml = isMember ? middleZoneHtml : '';

                const header = `
                <div class="sticky top-0 z-30 bg-jodo-bg/95 backdrop-blur border-b border-red-100 px-3 pt-safe pb-2 flex items-center gap-3">
                    ${!Store.state.isInviteOnly ? `<button onclick="window.JodoApp.Actions.navigateToHome()" class="p-1 -ml-1 text-gray-500"><i data-lucide="arrow-left" size="20"></i></button>` : ''}
                    <div class="flex-1 text-center font-black text-gray-900 uppercase tracking-tight text-sm">Target: ${CONSTANTS.ANCHOR_TARGET_KG}kg</div>
                    <div class="w-5"></div>
                </div>`;

                let leaderTools = '';
                
                // ‚úÖ BLOCKER #3: LEADER SHAME COPY
                if (isLeader) {
                     leaderTools = `
                    <div class="mx-3 mt-4 bg-red-50 rounded border border-red-200 shadow-sm overflow-hidden mb-4">
                         <div class="p-3 text-center border-b border-red-100">
                             <div class="text-[10px] font-black text-red-600 uppercase tracking-widest">üëë You started this group</div>
                             <div class="text-xs font-bold text-red-800 leading-tight mt-1">If it fails, everyone remembers you.</div>
                         </div>
                        ${manualMembers.length > 0 ? `
                        <div class="px-3 py-1 bg-white border-b border-gray-100 text-[9px] font-bold text-gray-500 uppercase tracking-widest">
                            Offline Orders
                        </div>
                        <div class="divide-y divide-gray-100 bg-white">
                            ${manualMembers.map(m => `
                                <div class="flex items-center justify-between px-3 py-2">
                                    <div class="font-bold text-gray-900 text-xs">${m.name}</div>
                                    <div class="font-black text-gray-900 text-xs">${Utils.Pricing.formatQty(m.cart?.[anchorP.id] || 0)}</div>
                                </div>`).join('')}
                        </div>` : ''}
                    </div>`;
                }

                // üî¥ ZONE 3: ACTION (PRESSURE)
                let mainAction = `window.JodoApp.UI.openCheckoutModal('${g.id}')`;
                let mainText = "JOIN RISK & LOCK PRICE";
                let mainClass = "bg-jodo-urgent text-white animate-pulse-fast"; // Default urgent
                let manualAddBtn = isLeader ? `<button onclick="window.JodoApp.UI.openCheckoutModal('${g.id}', true)" class="block w-full text-center text-[10px] font-bold text-gray-400 mb-2 uppercase">+ Add offline</button>` : '';
                let successThreat = '';

                if (isMember) {
                    const sharedTimestamp = Store.state.hasSharedGroups[g.id];
                    
                    if (!isTargetMet) {
                        mainAction = `window.JodoApp.UI.shareGroup('${g.id}', false, ${remaining})`;
                        
                        // ‚úÖ BLOCKER #1: ESCALATING PRESSURE
                        if (sharedTimestamp) {
                             const minsPassed = (Date.now() - sharedTimestamp) / 60000;
                             
                             if (minsPassed < 3) {
                                  mainText = `WAITING FOR OTHERS...`;
                                  mainClass = "bg-gray-800 text-white"; // Passive
                             } else if (minsPassed >= 3 && minsPassed < 10) {
                                  mainText = `NO ONE JOINED YET. PRICE AT RISK.`;
                                  mainClass = "bg-orange-600 text-white animate-pulse"; // Warning
                             } else {
                                  mainText = `GROUP LIKELY TO FAIL. SHARE AGAIN.`;
                                  mainClass = "bg-red-700 text-white animate-shake"; // Panic
                             }
                        } else {
                            // üî¥ THE GUILT BUTTON
                            mainText = `SHARE NOW (OR LOSE ‚Çπ10/KG)`;
                            mainClass = "bg-green-600 text-white shadow-lg shadow-green-200"; // Fake hope green
                        }
                    } else {
                        // ‚úÖ BLOCKER #4: POST-SUCCESS THREAT
                        mainText = "HELP OTHERS SAVE TOO";
                        mainAction = `window.JodoApp.UI.shareGroup('${g.id}', true, 0)`;
                        mainClass = "bg-blue-600 text-white";
                        successThreat = `<div class="text-[9px] text-center text-red-600 font-bold mt-1 uppercase bg-red-50 p-1 rounded">Orders close at 11:59 PM. Late joiners pay more.</div>`;
                    }
                }

                const footer = `
                <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 p-2 pb-safe z-40 shadow-[0_-5px_15px_rgba(0,0,0,0.05)]">
                      ${manualAddBtn}
                      <button onclick="${mainAction}" ${!mainAction ? 'disabled' : ''} class="w-full ${mainClass} h-12 rounded font-black text-base flex items-center justify-center gap-2 btn-press uppercase tracking-tighter disabled:opacity-50 disabled:cursor-not-allowed border-b-4 border-black/20">
                        ${mainText}
                      </button>
                      ${isMember && !isTargetMet ? `
                        <div class="text-[9px] text-center text-red-500 font-bold mt-1 uppercase">You are blocking the discount</div>
                        <div class="text-[9px] text-center text-red-600 font-black uppercase mt-0.5">Your order is at risk until YOU bring someone</div>
                      ` : ''}
                      ${successThreat}
                </div>`;

                const middleContent = isMember ? myOrderSummaryHtml : middleZoneHtml;

                container.innerHTML = `<div class="bg-jodo-bg min-h-screen pb-24">
                    ${header}
                    ${statusHtml}
                    ${middleContent}
                    ${leaderTools}
                </div>${footer}`;
            },

            // --- CHECKOUT MODAL (LOSS AVERSION) ---
            openCheckoutModal(groupId, isManual = false, editTargetPhone = null) {
                if (!groupId && !isManual) {
                    const active = Actions.getActiveOwnedGroup();
                    if (active) { Actions.navigateToGroup(active.id); return; }
                }

                const { user, cart, members } = Store.state;
                let activeCart = isManual ? {} : { ...cart };
                let activeName = isManual ? '' : user.name;
                let activePhone = isManual ? '' : user.phone;
                let activeAddress = isManual ? '' : user.address;

                if (groupId && !isManual) {
                    const groupMembers = members[groupId] || [];
                    const me = groupMembers.find(m => m.phone === user.phone);
                    if (me) {
                        activeCart = { ...(me.cart || {}) };
                        Store.update('cart', activeCart);
                        if (me.address) activeAddress = me.address;
                    }
                }

                const anchorP = CONSTANTS.PRODUCTS.find(p => p.anchor);
                const addOnPs = CONSTANTS.PRODUCTS.filter(p => !p.anchor);
                
                if (Object.keys(activeCart).length === 0) {
                      activeCart[anchorP.id] = 5; 
                      Store.update('cart', activeCart);
                }

                const node = document.createElement('div');
                node.className = "flex flex-col h-[85vh] bg-white font-sans relative";
                
                const renderItem = (p, isHero) => {
                    const qty = activeCart[p.id] || 0;
                    return `
                    <div class="flex items-center justify-between py-2 ${isHero ? 'bg-red-50 -mx-4 px-4 border-b border-red-100' : 'border-b border-gray-100 last:border-0'}">
                        <div class="flex items-center gap-2">
                            <div class="${isHero ? 'w-16 h-16' : 'w-10 h-10'} bg-white rounded border border-gray-200 overflow-hidden shrink-0"><img src="${p.imageSrc}" class="w-full h-full object-cover"></div>
                            <div>
                                <div class="${isHero ? 'font-black text-lg text-gray-900 leading-none' : 'font-bold text-gray-700 text-sm'}">${p.name}</div>
                                <div class="text-[10px] text-gray-500 font-bold uppercase">${p.unit}</div>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <button class="w-8 h-8 bg-white border border-gray-300 rounded flex items-center justify-center font-bold text-gray-600 shadow-sm" onclick="window.JodoApp.Actions.updateCart('${p.id}', -${p.step}); window.JodoApp.UI.refreshModalQty('${p.id}')">-</button>
                            <div class="min-w-[2.5rem] text-center font-black text-gray-900 text-sm" id="qty-${p.id}">${Utils.Pricing.formatQty(qty)}</div>
                            <button class="w-8 h-8 ${isHero ? 'bg-jodo-urgent text-white' : 'bg-gray-800 text-white'} rounded flex items-center justify-center font-bold shadow-md" onclick="window.JodoApp.Actions.updateCart('${p.id}', ${p.step}); window.JodoApp.UI.refreshModalQty('${p.id}')">+</button>
                        </div>
                    </div>`;
                };

                const anchorHtml = renderItem(anchorP, true);
                const addonsHtml = addOnPs.map(p => renderItem(p, false)).join('');

                // üî¥ LOSS BOX
                let lossBox = '';
                if (!isManual) {
                    const savingsPerKg = CONSTANTS.PRICE_TIERS.tomato.base - CONSTANTS.PRICE_TIERS.tomato.target;
                    const myAnchorQty = activeCart[anchorP.id] || 0;
                    if (myAnchorQty > 0) {
                        lossBox = `
                        <div class="bg-red-100 border-l-4 border-red-600 p-3 mb-4 rounded-r-md">
                            <div class="text-[10px] font-black text-red-600 uppercase tracking-widest mb-1">Warning: Price Risk</div>
                            <div class="text-xs font-bold text-red-900 leading-tight">
                                If group fails, you pay <span class="underline decoration-red-400">‚Çπ${CONSTANTS.PRICE_TIERS.tomato.base}/kg</span> instead of ‚Çπ${CONSTANTS.PRICE_TIERS.tomato.target}/kg.
                            </div>
                        </div>`;
                    }
                }

                const modalTitle = isManual ? 'ADD OFFLINE' : 'CONFIRM ORDER';
                const btnText = isManual ? 'ADD MANUAL' : 'JOIN RISK & LOCK PRICE';

                node.innerHTML = `
                    <div class="bg-white px-4 py-3 border-b border-gray-100 flex justify-between items-center shrink-0 shadow-sm z-10">
                        <h3 class="font-black text-base text-gray-900 tracking-tight">${modalTitle}</h3>
                        <button id="close-modal" class="p-1 bg-gray-100 rounded-full text-gray-500"><i data-lucide="x" size="18"></i></button>
                    </div>
                    
                    <div class="flex-1 overflow-y-auto p-4 bg-white">
                        <div class="bg-red-50 text-red-600 text-[10px] font-black uppercase text-center py-1 mb-2 border border-red-100 rounded">‚ö†Ô∏è This price is NOT guaranteed</div>
                        
                        <div class="mb-2">${anchorHtml}</div>
                        ${lossBox}

                        ${addOnPs.length > 0 ? `
                        <div class="mt-4 mb-1 text-[9px] font-black text-gray-400 uppercase tracking-widest">Optional Add-ons</div>
                        <div class="bg-gray-50 rounded px-3 border border-gray-100">${addonsHtml}</div>` : ''}

                        <div class="space-y-2 mt-6">
                            <input id="inp-name" value="${activeName}" placeholder="Name" class="w-full p-3 bg-gray-50 rounded font-bold text-gray-900 border border-gray-200 text-sm focus:border-black outline-none">
                            <input id="inp-phone" value="${activePhone}" type="tel" placeholder="Phone" class="w-full p-3 bg-gray-50 rounded font-bold text-gray-900 border border-gray-200 text-sm focus:border-black outline-none">
                            <textarea id="inp-addr" rows="2" placeholder="${isManual ? 'Address' : 'Full Address Required'}" class="w-full p-3 bg-gray-50 rounded font-bold text-gray-900 border border-gray-200 text-sm focus:border-black outline-none resize-none">${activeAddress}</textarea>
                        </div>
                    </div>

                    <div class="p-3 bg-white border-t border-gray-100 shrink-0">
                         <div class="mb-3 flex items-start gap-2">
                            <input type="checkbox" id="chk-terms" class="mt-0.5 w-4 h-4 text-jodo-urgent rounded border-gray-300 focus:ring-red-500">
                            <label for="chk-terms" class="text-[10px] text-gray-600 leading-tight font-bold">
                                I accept that my price depends on others. If group fails, price goes up.
                            </label>
                         </div>
                         <button id="btn-confirm" disabled class="w-full bg-gray-300 text-white h-12 rounded font-black text-base shadow-none flex items-center justify-center gap-2 cursor-not-allowed uppercase tracking-tight">
                            ${btnText}
                         </button>
                    </div>
                `;
                
                this.showModal(node);
                
                const btnConfirm = node.querySelector('#btn-confirm');
                const chkTerms = node.querySelector('#chk-terms');
                const inpName = node.querySelector('#inp-name');
                const inpPhone = node.querySelector('#inp-phone');
                const inpAddr = node.querySelector('#inp-addr');

                chkTerms.onchange = () => {
                    if(chkTerms.checked) {
                        btnConfirm.disabled = false;
                        btnConfirm.classList.replace('bg-gray-300', 'bg-jodo-urgent');
                        btnConfirm.classList.replace('shadow-none', 'shadow-xl');
                        btnConfirm.classList.replace('cursor-not-allowed', 'btn-press');
                    } else {
                        btnConfirm.disabled = true;
                        btnConfirm.classList.replace('bg-jodo-urgent', 'bg-gray-300');
                        btnConfirm.classList.replace('shadow-xl', 'shadow-none');
                        btnConfirm.classList.replace('btn-press', 'cursor-not-allowed');
                    }
                };

                btnConfirm.onclick = async () => {
                    btnConfirm.disabled = true;
                    btnConfirm.innerText = "LOCKING...";
                    const success = await Actions.submitOrder(
                        inpName.value.trim(),
                        inpPhone.value.trim(),
                        inpAddr.value.trim(),
                        groupId,
                        isManual
                    );
                    if(!success) { btnConfirm.disabled = false; btnConfirm.innerText = "TRY AGAIN"; } 
                    else if (!isManual) { this.closeModal(); }
                };

                this.refreshModalQty = (pid) => {
                    const q = Store.state.cart[pid] || 0;
                    const el = document.getElementById(`qty-${pid}`);
                    if(el) el.innerText = Utils.Pricing.formatQty(q);
                };

                node.querySelector('#close-modal').onclick = () => this.closeModal();
            },

            toast(msg, icon) {
                const t = document.getElementById('toast');
                t.innerText = msg.toUpperCase();
                t.classList.remove('hidden');
                setTimeout(() => t.classList.add('hidden'), 2500);
            },
            showModal(node) {
                const o = document.getElementById('modal-overlay'), c = document.getElementById('modal-content');
                c.innerHTML=''; c.appendChild(node); o.classList.remove('hidden');
                setTimeout(()=> { o.classList.remove('opacity-0'); c.classList.remove('translate-y-full'); }, 10);
                if(window.lucide) window.lucide.createIcons();
            },
            closeModal() {
                const o = document.getElementById('modal-overlay'), c = document.getElementById('modal-content');
                c.classList.add('translate-y-full'); o.classList.add('opacity-0');
                setTimeout(()=> { o.classList.add('hidden'); c.innerHTML=''; }, 200);
            },
            triggerVibration() { if (navigator.vibrate) navigator.vibrate(10); },
            
            // ‚úÖ BLOCKER #5: FAILURE SCAR
            // ‚úÖ ISSUE #1: TRACK SEEN SCARS TO PREVENT ANNOYANCE
            showFailureScar() {
                const { currentGroupId } = Store.state;
                if (!currentGroupId) return;
                
                if (localStorage.getItem('jodo_failed_seen_' + currentGroupId)) {
                    // Silently redirect if seen
                    this.handleFailureRedirect();
                    return;
                }

                const overlay = document.getElementById('failure-overlay');
                overlay.classList.remove('hidden');
                
                // Force user to look at it for 5s
                setTimeout(() => {
                    localStorage.setItem('jodo_failed_seen_' + currentGroupId, 'true');
                    this.handleFailureRedirect();
                    overlay.classList.add('hidden');
                }, 5000);
            },
            
            handleFailureRedirect() {
                try { history.replaceState({}, '', window.location.pathname); } catch(e) {}
                Store.update('isInviteOnly', false);
                Store.update('currentGroupId', null);
                Store.update('view', 'home');
            },

            // üî¥ AGGRESSIVE SHARE COPY (ROTATING)
            shareGroup(gid, isTargetMet, remaining) {
                const url = `${CONSTANTS.PUBLIC_SHARE_URL}?group=${gid}`;
                
                // ‚úÖ COPY FIX: ROTATION
                const messages = [
                    `‚ö°Ô∏è If you don't join, I lose ‚Çπ10/kg today. Help me lock Tomato price at ‚Çπ30/kg.`,
                    `‚ö†Ô∏è This group fails without you. Need ${remaining}kg more to lock ‚Çπ30/kg price.`,
                    `‚è≥ Order closes tonight. Don't delay. Join my Tomato group for ‚Çπ30/kg.`
                ];
                let text = messages[Math.floor(Math.random() * messages.length)];
                
                if (isTargetMet) {
                    text = `‚úÖ PRICE UNLOCKED: Tomatoes at ‚Çπ30/kg (Wholesale). Grab before expires:`;
                }
                
                // ‚úÖ LOGIC FIX 1: Per-group share state (Timestamp)
                const newShared = { ...Store.state.hasSharedGroups, [gid]: Date.now() };
                Store.update('hasSharedGroups', newShared);
                localStorage.setItem('jodo_shared_groups', JSON.stringify(newShared));
                
                window.open(`https://wa.me/?text=${encodeURIComponent(text + " " + url)}`, '_blank');
            }
        };

        window.JodoApp = { Actions, UI };
        document.addEventListener('DOMContentLoaded', Actions.initApp);
    </script>
</body>
</html>
