<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover" />
    <title>JODO - Group Buying</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üçÖ</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import {
        getFirestore,
        doc,
        setDoc,
        getDoc,
        getDocs,
        updateDoc,
        onSnapshot,
        collection,
        runTransaction,
        serverTimestamp,
        query,
        where
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

      // --- ENVIRONMENT SETUP ---
      const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "demo", authDomain: "demo" };
      
      // LOGIC: Use the secure ID in Canvas, but fallback to 'jodo-prod-v2' on GitHub so your paths are stable.
      const envAppId = typeof __app_id !== 'undefined' ? __app_id : null;
      const staticAppId = "jodo-prod-v2"; // Your Real Project ID
      const appId = envAppId || staticAppId;

      // 1. INITIALIZE FIREBASE
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      // 2. EXPOSE GLOBALS
      window.db = db;
      window.auth = auth;
      window.appId = appId; 
      
      // Namespace for Firestore functions
      window.fs = {
        doc, setDoc, getDoc, getDocs, updateDoc, onSnapshot,
        collection, runTransaction, serverTimestamp, query, where
      };
      
      console.log("üöÄ JODO Initialized", { appId });

      // 3. AUTH & BOOTSTRAP
      // We wrap this in an async function to ensure Auth is ready before App logic starts
      async function initAuth() {
        try {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
            // Once auth is done, signal the app to start
            if (window.JodoApp && window.JodoApp.Actions) {
                window.JodoApp.Actions.initApp();
            }
        } catch (error) {
            console.error("Auth Failed:", error);
            document.getElementById('app').innerHTML = `<div class="p-4 text-center text-red-600 font-bold">Authentication failed. Please refresh.</div>`;
        }
      }

      initAuth();
    </script>

    <script>
        // --- GLOBAL ERROR HANDLER ---
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            if (msg.includes("ResizeObserver")) return;
            console.error("Global Error:", msg, error);
            return false;
        };

        // --- TAILWIND CONFIG ---
        tailwind.config = {
            theme: {
                extend: {
                    colors: { jodo: { ctaPrimary: '#15803D' } },
                    fontFamily: { sans: ['-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'sans-serif'] },
                    animation: {
                        'fade-in-up': 'fadeInUp 0.5s ease-out',
                        'slide-up': 'slideUp 0.3s ease-out forwards',
                        'pop': 'popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)'
                    },
                    keyframes: {
                        fadeInUp: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
                        slideUp: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
                        popIn: { '0%': { opacity: '0', transform: 'scale(0.9)' }, '100%': { opacity: '1', transform: 'scale(1)' } }
                    }
                }
            }
        }
    </script>
    
    <style>
        body { background: #FFFFFF; color: #111827; -webkit-tap-highlight-color: transparent; min-height: 100dvh; display: flex; justify-content: center; margin: 0; overscroll-behavior-y: none; }
        #app { width: 100%; max-width: 448px; background: #FFFFFF; min-height: 100dvh; position: relative; overflow-y: auto; display: flex; flex-direction: column; box-shadow: 0 0 20px rgba(0,0,0,0.05); }
        .btn-press { transition: opacity 0.1s; cursor: pointer; user-select: none; }
        .btn-press:active:not(:disabled) { opacity: 0.8; }
        .card-modern { background: #FFFFFF; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: 1px solid #E5E7EB; }
        .glass-header { background: rgba(255, 255, 255, 0.98); border-bottom: 1px solid #E5E7EB; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .pt-safe { padding-top: env(safe-area-inset-top); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        .spinner-fallback {
            width: 32px; height: 32px; border: 3px solid #E5E7EB; border-top: 3px solid #15803D; border-radius: 50%; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="antialiased">

    <div id="app">
        <div style="height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #fff; color: #333;">
            <div class="spinner-fallback"></div>
            <div style="margin-top: 16px; font-family: sans-serif; font-size: 14px; font-weight: 600;">Connecting...</div>
        </div>
    </div>

    <!-- MODAL -->
    <div id="modal-overlay" class="fixed inset-0 bg-black/60 hidden z-[60] flex items-end justify-center backdrop-blur-sm transition-opacity duration-300">
        <div id="modal-content" class="bg-white w-full max-w-[448px] rounded-t-[1.5rem] shadow-2xl transform transition-transform duration-300 translate-y-full max-h-[95dvh] flex flex-col overflow-hidden pb-safe"></div>
    </div>

    <!-- TOAST -->
    <div id="toast" class="fixed top-24 left-1/2 -translate-x-1/2 bg-gray-900 text-white px-6 py-3 rounded-full text-sm font-medium shadow-xl hidden z-[90] flex items-center gap-2 pointer-events-none pt-safe text-center w-max max-w-[90%]"></div>

    <script type="module">
        /*
         * JODO APP ARCHITECTURE v5.2
         */

        // ==========================================
        // 1. CONSTANTS
        // ==========================================
        const CONSTANTS = {
            // ‚úÖ HARDCODED GITHUB URL FOR PRODUCTION
            PUBLIC_SHARE_URL: "https://satyanarayanagaraga.github.io/jodo-mvp/",
            MIN_GROUP_SIZE: 2,
            GROUP_MAX_KG: 20,
            GROUPS_STORAGE_KEY: 'jodo_groups_joined_v1',
            CUTOFF_HOUR: 22, // 10 PM
            PRODUCTS: [
                { 
                    id: 'tomato', name: 'Fresh Tomatoes', nameTe: '‡∞ü‡∞Æ‡∞æ‡∞ü‡∞æ‡∞≤‡±Å', unit: '1kg', baseWeight: 1, step: 0.25, weightUnit: 'kg', 
                    icon: 'circle-dot', imageSrc: 'https://images.unsplash.com/photo-1592924357228-91a4daadcfea?auto=format&fit=crop&w=800&q=80',
                    tiers: [ { minMembers: 1, price: 40 }, { minMembers: 2, price: 20 } ]
                },
                { 
                    id: 'onion', name: 'Red Onions', nameTe: '‡∞â‡∞≤‡±ç‡∞≤‡∞ø‡∞™‡∞æ‡∞Ø‡∞≤‡±Å', unit: '1kg', baseWeight: 1, step: 0.25, weightUnit: 'kg', 
                    icon: 'layers', imageSrc: 'https://images.unsplash.com/photo-1618512496248-a07fe83aa8cb?auto=format&fit=crop&w=800&q=80',
                    tiers: [ { minMembers: 1, price: 60 }, { minMembers: 2, price: 35 } ]
                },
                { 
                    id: 'chilli', name: 'Green Chillies', nameTe: '‡∞™‡∞ö‡±ç‡∞ö‡∞ø ‡∞Æ‡∞ø‡∞∞‡∞™‡∞ï‡∞æ‡∞Ø‡∞≤‡±Å', unit: '250g', baseWeight: 0.25, step: 0.25, weightUnit: 'g', 
                    icon: 'zap', imageSrc: 'https://images.unsplash.com/photo-1577218349272-37eb645284eb?auto=format&fit=crop&w=800&q=80',
                    tiers: [ { minMembers: 1, price: 80 }, { minMembers: 2, price: 50 } ]
                }
            ],
            PRODUCT_LIMITS: { tomato: 10, onion: 10, chilli: 2 }
        };

        // ==========================================
        // 2. STORE (Central State)
        // ==========================================
        const Store = {
            state: {
                view: 'home',
                mode: 'HOME',
                currentGroupId: null,
                groups: {},       // Cache for group data
                members: {},      // Cache for member lists
                user: { name: '', phone: '', joinedGroupIds: [] },
                cart: {},         // Local cart state
                invitingGroup: null,
                pendingJoinId: null,
                isAppInitialized: false
            },
            
            // Centralized state updater to prevent direct mutations
            update(key, value) {
                this.state[key] = value;
                if(key === 'view' || key === 'groups' || key === 'members' || key === 'cart') {
                    UI.scheduleRender();
                }
            },

            // Specific updater for deeply nested user data
            updateUser(field, value) {
                this.state.user[field] = value;
                if (field === 'joinedGroupIds') {
                    localStorage.setItem(CONSTANTS.GROUPS_STORAGE_KEY, JSON.stringify(value));
                } else if (field === 'name') {
                    localStorage.setItem('jodo_user_name', value);
                } else if (field === 'phone') {
                    localStorage.setItem('jodo_user_phone', value);
                }
            },

            // Load initial data from LocalStorage
            loadFromStorage() {
                try {
                    this.state.user.name = localStorage.getItem('jodo_user_name') || '';
                    this.state.user.phone = localStorage.getItem('jodo_user_phone') || '';
                    const savedGroups = localStorage.getItem(CONSTANTS.GROUPS_STORAGE_KEY);
                    this.state.user.joinedGroupIds = savedGroups ? JSON.parse(savedGroups) : [];
                } catch(e) { console.error("Storage Error", e); }
            }
        };

        // ==========================================
        // 3. SERVICES (Business Logic & Firebase)
        // ==========================================
        const Services = {
            // Subscription Manager to prevent listener leaks
            Subscriptions: {
                active: {}, 
                
                add(key, unsubscribeFn) {
                    if (this.active[key]) {
                        return; // Listener already active
                    }
                    this.active[key] = unsubscribeFn;
                },

                remove(key) {
                    if (this.active[key]) {
                        this.active[key]();
                        delete this.active[key];
                    }
                },

                clearAll() {
                    Object.keys(this.active).forEach(k => this.active[k]());
                    this.active = {};
                }
            },

            Time: {
                getCutoffTimestamp() {
                    const now = new Date();
                    now.setHours(CONSTANTS.CUTOFF_HOUR, 0, 0, 0); 
                    return now.getTime();
                },
                isPastCutoff() {
                    return Date.now() > this.getCutoffTimestamp();
                },
                getMillis(ts) {
                    if (!ts) return 0;
                    if (typeof ts === 'number') return ts;
                    if (ts.toMillis) return ts.toMillis();
                    return 0;
                }
            },

            Pricing: {
                // Determine price based on member count tiers
                getPrice(product, memberCount = 1) {
                    const validTiers = product.tiers.filter(t => memberCount >= t.minMembers);
                    if (validTiers.length === 0) return product.tiers[0].price;
                    validTiers.sort((a,b) => b.minMembers - a.minMembers);
                    return validTiers[0].price;
                },
                
                formatQty(qty) {
                    return qty < 1 ? (qty * 1000).toFixed(0) + 'g' : qty + 'kg';
                }
            },

            Data: {
                // Strict path construction
                getGroupsCol() {
                    return window.fs.collection(window.db, 'artifacts', window.appId, 'public', 'data', 'groups');
                },
                getGroupRef(gid) {
                    return window.fs.doc(window.db, 'artifacts', window.appId, 'public', 'data', "groups", gid);
                },
                getMembersCol(gid) {
                    return window.fs.collection(window.db, 'artifacts', window.appId, 'public', 'data', "groups", gid, "members");
                },
                
                listenToGroup(gid) {
                    if (!gid) return;
                    const keyG = `group_${gid}`;
                    const keyM = `members_${gid}`;

                    if (!Services.Subscriptions.active[keyG]) {
                        const unsubG = window.fs.onSnapshot(this.getGroupRef(gid), (snap) => {
                            if (snap.exists()) {
                                const newGroups = { ...Store.state.groups, [gid]: snap.data() };
                                Store.update('groups', newGroups);
                            }
                        }, err => console.error("Group listen error", err));
                        Services.Subscriptions.add(keyG, unsubG);
                    }

                    if (!Services.Subscriptions.active[keyM]) {
                        const unsubM = window.fs.onSnapshot(this.getMembersCol(gid), (snap) => {
                            const mList = [];
                            snap.forEach(d => mList.push({ ...d.data(), id: d.id }));
                            mList.sort((a,b) => Services.Time.getMillis(a.joinedAt) - Services.Time.getMillis(b.joinedAt));
                            const newMembers = { ...Store.state.members, [gid]: mList };
                            Store.update('members', newMembers);
                        }, err => console.error("Member listen error", err));
                        Services.Subscriptions.add(keyM, unsubM);
                    }
                }
            }
        };

        // ==========================================
        // 4. ACTIONS (State Mutators)
        // ==========================================
        const Actions = {
            initApp() {
                if (Store.state.isAppInitialized) return;
                Store.update('isAppInitialized', true);
                
                Store.loadFromStorage();
                
                // Route handling
                const params = new URLSearchParams(window.location.search);
                const gid = params.get('group');
                
                // Initialize listeners for known groups
                Store.state.user.joinedGroupIds.forEach(id => Services.Data.listenToGroup(id));

                if (gid) {
                    Store.update('view', 'home');
                    Store.update('pendingJoinId', gid);
                    this.fetchInviteGroup(gid);
                } else {
                    Store.update('view', 'home');
                }

                // History listener
                window.addEventListener('popstate', () => {
                    const p = new URLSearchParams(location.search);
                    const g = p.get('group');
                    if (g) this.navigateToGroup(g); else this.navigateToHome();
                });
            },

            async fetchInviteGroup(gid) {
                try {
                    console.log("üîç Fetching Invite for:", gid);
                    const ref = Services.Data.getGroupRef(gid);
                    const snap = await window.fs.getDoc(ref);
                    
                    if (snap.exists()) {
                        console.log("‚úÖ Group Found:", snap.data());
                        Store.update('invitingGroup', snap.data());
                        // Add to cache so it renders immediately
                        const newGroups = { ...Store.state.groups, [gid]: snap.data() };
                        Store.update('groups', newGroups);
                        Services.Data.listenToGroup(gid);
                    } else {
                        console.warn("‚ùå Group not found at path:", ref.path);
                        UI.toast("Group link is invalid or expired", "alert-circle");
                        this.navigateToHome();
                    }
                } catch(e) { 
                    console.error("üî• Fetch Error:", e); 
                    UI.toast("Connection error", "wifi-off");
                    this.navigateToHome(); 
                }
            },

            updateCart(productId, delta) {
                if (Services.Time.isPastCutoff()) { UI.toast("Orders closed for today", "clock"); return; }
                
                const currentQty = Store.state.cart[productId] || 0;
                let newQty = currentQty + delta;
                newQty = Math.round(newQty * 100) / 100;
                if (newQty < 0) newQty = 0;
                
                const limit = CONSTANTS.PRODUCT_LIMITS[productId] || 99;
                if (newQty > limit) { UI.toast(`Limit ${limit}kg`, "alert-circle"); return; }

                const newCart = { ...Store.state.cart };
                if (newQty === 0) delete newCart[productId];
                else newCart[productId] = newQty;

                Store.update('cart', newCart);
                UI.triggerVibration();
            },

            navigateToGroup(gid) {
                if (!gid) return;
                try { history.pushState({}, '', `?group=${gid}`); } catch(e) {}
                Store.update('currentGroupId', gid);
                Store.update('view', 'group');
                Services.Data.listenToGroup(gid);
            },

            navigateToHome() {
                try { history.pushState({}, '', window.location.pathname); } catch(e) {}
                Store.update('currentGroupId', null);
                Store.update('view', 'home');
                Store.update('invitingGroup', null);
            },

            async submitOrder(name, phone, joinGroupId) {
                const user = Store.state.user;
                if (!name || !/^[6-9]\d{9}$/.test(phone)) {
                    UI.toast('Enter valid name & mobile', 'alert-circle');
                    return false;
                }

                if (!window.auth.currentUser) {
                    UI.toast("Connecting to network... please retry.", "wifi");
                    return false;
                }

                Store.updateUser('name', name);
                Store.updateUser('phone', phone);
                
                const cart = { ...Store.state.cart };
                const groupsCol = Services.Data.getGroupsCol();
                const finalGroupId = joinGroupId || window.fs.doc(groupsCol).id;

                try {
                    // Create group doc if new
                    if (!joinGroupId) {
                        const groupData = { 
                            id: finalGroupId, 
                            ownerName: name, 
                            ownerPhone: phone, 
                            expiresAt: Services.Time.getCutoffTimestamp(), 
                            createdAt: window.fs.serverTimestamp(), 
                            type: 'multi', 
                            maxKg: CONSTANTS.GROUP_MAX_KG, 
                            pendingKg: 0, 
                            usedKg: 0, 
                            memberCount: 0, 
                            unlockedAt: null 
                        };
                        await window.fs.setDoc(Services.Data.getGroupRef(finalGroupId), groupData);
                    }

                    let didUnlock = false;
                    
                    await window.fs.runTransaction(window.db, async (transaction) => {
                        const groupRef = Services.Data.getGroupRef(finalGroupId);
                        const groupSnap = await transaction.get(groupRef);
                        if (!groupSnap.exists()) throw "GROUP_NOT_FOUND";
                        
                        const gData = groupSnap.data();
                        const memberRef = window.fs.doc(Services.Data.getMembersCol(finalGroupId), phone);
                        const memberSnap = await transaction.get(memberRef);

                        const isNewMember = !memberSnap.exists();
                        const currentCartQty = Object.values(cart).reduce((a,b) => a+b, 0);
                        
                        // --- MEMBER COUNT ---
                        let newMemberCount = gData.memberCount || 0;
                        if (isNewMember) newMemberCount += 1;

                        // --- INVENTORY ---
                        let newPending = gData.pendingKg || 0;
                        let newUsed = gData.usedKg || 0;
                        let newUnlockedAt = gData.unlockedAt;

                        // --- QUANTITY CHANGE ---
                        let oldQty = 0;
                        if (memberSnap.exists()) {
                            const oldData = memberSnap.data();
                            oldQty = Object.values(oldData.cart || {}).reduce((a,b)=>a+b, 0);
                        }
                        const qtyChange = currentCartQty - oldQty;

                        // capacity check
                        const maxKg = gData.maxKg || CONSTANTS.GROUP_MAX_KG;
                        if (qtyChange > 0 && (newPending + newUsed + qtyChange) > maxKg) {
                            throw `Sold Out! Only ${Math.max(0, maxKg - (newPending + newUsed)).toFixed(2)}kg left.`;
                        }

                        // apply qty
                        if (newUnlockedAt) newUsed += qtyChange;
                        else newPending += qtyChange;

                        // üîì UNLOCK = MEMBER COUNT ONLY
                        if (!newUnlockedAt && newMemberCount >= CONSTANTS.MIN_GROUP_SIZE) {
                            didUnlock = true;
                            newUnlockedAt = window.fs.serverTimestamp();
                            newUsed += newPending;
                            newPending = 0;
                        }

                        transaction.update(groupRef, { 
                            pendingKg: parseFloat(newPending.toFixed(2)), 
                            usedKg: parseFloat(newUsed.toFixed(2)), 
                            memberCount: newMemberCount, 
                            totalQty: parseFloat((newPending + newUsed).toFixed(2)), 
                            unlockedAt: newUnlockedAt 
                        });

                        transaction.set(memberRef, { 
                            memberId: phone, 
                            name, 
                            phone, 
                            cart, 
                            joinedAt: window.fs.serverTimestamp(), 
                            isLeader: (!joinGroupId && isNewMember) || (gData.ownerPhone === phone) 
                        });
                    });

                    // Success handling
                    if (joinGroupId) {
                        Store.update('pendingJoinId', null);
                        Store.update('invitingGroup', null);
                    }
                    
                    // Add to local list
                    const joined = [...Store.state.user.joinedGroupIds];
                    if(!joined.includes(finalGroupId)) {
                        joined.push(finalGroupId);
                        Store.updateUser('joinedGroupIds', joined);
                    }
                    
                    // Clear cart
                    Store.update('cart', {});
                    
                    // Navigate
                    Actions.navigateToGroup(finalGroupId);
                    
                    // User feedback
                    if (didUnlock) UI.toast("Deal Unlocked! üéâ", "check-circle");
                    else UI.toast("Joined successfully!", "check-circle");

                    return true;

                } catch (e) {
                    console.error("Order Error", e);
                    UI.toast(typeof e === 'string' ? e : "Transaction failed. Try again.", "alert-triangle");
                    return false;
                }
            }
        };

        // ==========================================
        // 5. UI (Rendering & Interactions)
        // ==========================================
        const UI = {
            renderScheduled: false,
            
            scheduleRender() {
                if (this.renderScheduled) return;
                this.renderScheduled = true;
                requestAnimationFrame(() => {
                    this.render();
                    this.renderScheduled = false;
                });
            },

            render() {
                const app = document.getElementById('app');
                if (!app) return;
                
                const { view } = Store.state;
                if (view === 'home') this.renderHome(app);
                else if (view === 'group') this.renderGroup(app);
                
                if (window.lucide) window.lucide.createIcons();
            },

            // --- COMPONENTS ---

            renderHome(container) {
                const { user, groups, invitingGroup, cart } = Store.state;
                const isClosed = Services.Time.isPastCutoff();

                // Sort groups by time
                const activeGroups = user.joinedGroupIds
                    .map(gid => groups[gid])
                    .filter(Boolean)
                    .sort((a,b) => Services.Time.getMillis(b.createdAt) - Services.Time.getMillis(a.createdAt));

                // Cart summary
                let cartCount = 0; let cartTotal = 0;
                Object.keys(cart).forEach(pid => {
                    const qty = cart[pid]; 
                    if (qty > 0) { 
                        cartCount++; 
                        // Base price for cart preview (using Best Price for estimation)
                        cartTotal += qty * CONSTANTS.PRODUCTS.find(p => p.id === pid).tiers[1].price; 
                    }
                });

                // Header HTML
                let headerHtml = `
                    <div class="glass-header sticky top-0 z-40 px-4 pt-safe pb-3 flex justify-between items-end min-h-[88px]">
                        <div class="flex flex-col justify-end pb-0.5 w-full">
                            <h1 class="font-black text-2xl tracking-tight text-jodo-ctaPrimary leading-none mb-1">JODO</h1>
                            <span class="text-[10px] text-gray-500 font-bold tracking-wide">Group orders for ${new Date().toLocaleDateString('en-US', {weekday:'long'})}</span>
                            <div id="home-timer" class="text-[10px] font-bold text-red-600 mt-1">Loading‚Ä¶</div>
                        </div>
                    </div>
                `;
                
                // Invite HTML
                let inviteHtml = '';
                if (invitingGroup) {
                     headerHtml = `
                        <div class="glass-header sticky top-0 z-40 px-4 pt-safe pb-3 flex justify-between items-end min-h-[88px]">
                            <div class="flex flex-col justify-end pb-0.5 w-full">
                                <h1 class="font-black text-2xl tracking-tight text-jodo-ctaPrimary leading-none mb-1">JODO x ${invitingGroup.ownerName}</h1>
                                <span class="text-[10px] text-green-700 font-bold tracking-wide bg-green-50 px-2 py-0.5 rounded-full w-fit">Special Invitation</span>
                            </div>
                        </div>`;

                     inviteHtml = `
                        <div class="px-4 mb-6 mt-4 animate-pop">
                            <div class="bg-indigo-50 border border-indigo-100 rounded-2xl p-5 shadow-sm">
                                <div class="flex items-start gap-4">
                                    <div class="w-12 h-12 bg-white rounded-full flex items-center justify-center text-indigo-600 shadow-sm shrink-0"><i data-lucide="users" size="24"></i></div>
                                    <div class="flex-1">
                                        <h3 class="font-bold text-lg text-gray-900 leading-tight mb-2">Accept Invite</h3>
                                        <p class="text-xs text-gray-600 mb-3">Join this group to unlock wholesale prices.</p>
                                        <button onclick="window.JodoApp.UI.openCheckoutModal('${Store.state.pendingJoinId}')" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-xl shadow-md active:scale-95 transition-transform flex items-center justify-center gap-2">Join Group</button>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                }

                // Active Groups HTML
                let groupsHtml = '';
                if (activeGroups.length > 0) {
                    groupsHtml = `
                        <div class="mt-6 mb-4">
                            <div class="px-4 flex gap-3 overflow-x-auto no-scrollbar">
                                ${activeGroups.map(g => `
                                    <div onclick="window.JodoApp.Actions.navigateToGroup('${g.id}')" class="shrink-0 w-[80%] card-modern p-4 btn-press">
                                        <div class="flex items-center gap-3">
                                            <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center text-green-700"><i data-lucide="shopping-bag" size="20"></i></div>
                                            <div>
                                                <div class="font-bold text-gray-900">Your Group</div>
                                                <div class="text-[10px] font-bold px-2 py-0.5 rounded border inline-block mt-1">${g.unlockedAt ? 'Unlocked' : `${g.memberCount}/${CONSTANTS.MIN_GROUP_SIZE} joined`}</div>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>`;
                }

                // Products HTML
                const productsHtml = CONSTANTS.PRODUCTS.map(p => {
                    const qty = cart[p.id] || 0;
                    // Always show best price for attraction
                    const bestPrice = p.tiers[p.tiers.length-1].price;
                    
                    let displayLabel = `Best Price / ${p.unit}`;
                    let displayValue = bestPrice;
                    
                    if (qty > 0) {
                        displayLabel = "Item Total";
                        displayValue = Math.round(qty * bestPrice);
                    }
                    
                    return `
                    <div class="bg-white p-4 rounded-2xl shadow-[0_2px_12px_rgba(0,0,0,0.04)] border border-gray-100 flex gap-4 ${isClosed ? 'opacity-70' : ''}">
                        <div class="w-20 h-20 bg-gray-50 rounded-xl shrink-0 overflow-hidden border border-gray-100"><img src="${p.imageSrc}" class="w-full h-full object-cover"></div>
                        <div class="flex-1 flex flex-col justify-between py-1">
                                <div><h3 class="font-bold text-lg text-gray-900 leading-tight">${p.name}</h3><p class="text-sm text-gray-500">${p.nameTe}</p></div>
                                <div class="mt-2 flex items-center justify-between">
                                <div class="bg-green-50 rounded-lg px-2 py-1 border border-green-100 flex flex-col"><span class="text-[10px] font-bold text-green-700 uppercase">${displayLabel}</span><span class="text-lg font-bold text-green-700">‚Çπ${displayValue}</span></div>
                                ${qty === 0 ? `<button onclick="window.JodoApp.Actions.updateCart('${p.id}', ${p.step})" class="bg-white border border-gray-300 text-gray-700 font-bold px-4 py-2 rounded-xl text-sm shadow-sm active:bg-gray-50">Add</button>` : `<div class="flex items-center bg-gray-900 rounded-xl px-1 py-1"><button onclick="window.JodoApp.Actions.updateCart('${p.id}', -${p.step})" class="w-8 h-8 text-white"><i data-lucide="minus" size="14"></i></button><div class="w-12 text-center text-sm font-bold text-white">${Services.Pricing.formatQty(qty)}</div><button onclick="window.JodoApp.Actions.updateCart('${p.id}', ${p.step})" class="w-8 h-8 text-white"><i data-lucide="plus" size="14"></i></button></div>`}
                                </div>
                        </div>
                    </div>`;
                }).join('');

                container.innerHTML = `
                    <div class="pb-32 fade-in bg-white min-h-screen">
                        ${headerHtml}
                        ${inviteHtml}
                        ${groupsHtml}
                        <div class="px-4 space-y-3 mt-6">
                            ${productsHtml}
                        </div>
                        ${cartCount > 0 ? `<div class="fixed bottom-4 left-4 right-4 z-50 animate-slide-up"><button onclick="window.JodoApp.UI.openCheckoutModal(${Store.state.pendingJoinId ? `'${Store.state.pendingJoinId}'` : 'null'})" class="w-full bg-jodo-ctaPrimary text-white h-[60px] rounded-xl font-bold text-lg shadow-xl flex items-center justify-between px-6 btn-press ring-2 ring-white/50"><div><span class="text-xs font-medium opacity-90">${cartCount} Items</span><br><span class="text-lg leading-none">~‚Çπ${Math.round(cartTotal)}</span></div><div class="flex items-center gap-2">Checkout <i data-lucide="arrow-right" size="20"></i></div></button></div>` : ''}
                    </div>
                `;

                this.initTilt();
                this.startTimer(document.getElementById('home-timer'));
            },

            renderGroup(container) {
                const { currentGroupId, groups, members } = Store.state;
                const g = groups[currentGroupId];
                if (!g) return;
                
                const memberList = members[currentGroupId] || [];
                const isUnlocked = !!g.unlockedAt;
                const myPhone = Store.state.user.phone;
                const hasJoined = myPhone && memberList.some(m => m.phone === myPhone);
                
                const memberHtml = memberList.map(m => {
                    const isMe = myPhone === m.phone;
                    let totalVal = 0;
                    const parts = Object.entries(m.cart || {}).map(([pid, qty]) => {
                        const p = CONSTANTS.PRODUCTS.find(x => x.id === pid); 
                        if(!p || qty <= 0) return null;
                        const price = Services.Pricing.getPrice(p, g.memberCount); // Dynamic!
                        const itemCost = qty * price;
                        totalVal += itemCost;
                        // Added item price display
                        return `<div class="flex justify-between w-full max-w-[200px]"><span class="mr-2">${Services.Pricing.formatQty(qty)} ${p.name}</span> <span class="text-gray-400 font-medium">‚Çπ${Math.round(itemCost)}</span></div>`;
                    }).filter(Boolean);
                    
                    // Added Edit Interaction for "Me"
                    return `
                    <div ${isMe ? `onclick="window.JodoApp.UI.openCheckoutModal('${g.id}')"` : ''} class="bg-white border ${isMe ? 'border-green-600 border-2 cursor-pointer relative shadow-sm' : 'border-gray-100'} p-3 rounded-xl flex justify-between items-start transition-all active:scale-[0.98]">
                        ${isMe ? '<div class="absolute top-0 right-0 bg-green-600 text-white text-[9px] px-2 py-0.5 rounded-bl-lg font-bold uppercase tracking-wider">Tap to Edit</div>' : ''}
                        <div class="flex-1">
                            <div class="text-sm font-bold text-gray-800 flex items-center gap-1 mb-1">${isMe ? 'You' : m.name} ${m.isLeader ? 'üëë' : ''}</div>
                            <div class="text-xs text-gray-500 flex flex-col gap-0.5">${parts.length > 0 ? parts.join("") : "Joined"}</div>
                        </div>
                        <div class="font-bold text-sm mt-1 pl-2">‚Çπ${Math.round(totalVal)}</div>
                    </div>`;
                }).join('');

                container.innerHTML = `
                <div class="fade-in bg-white min-h-screen pb-40 font-sans pt-safe">
                    <div class="p-4">
                        <div class="w-full h-40 rounded-2xl bg-gray-100 overflow-hidden mb-4 border border-gray-200 relative"><img src="https://images.unsplash.com/photo-1610348725531-843dff563e2c?auto=format&fit=crop&w=800&q=80" class="w-full h-full object-cover"><div class="absolute inset-0 bg-black/40 flex items-center justify-center"><h1 class="text-3xl font-black text-white">Group Order</h1></div></div>
                        <div class="text-center mb-2"><span class="text-sm font-medium text-gray-500">Host: <span class="font-bold text-gray-900">${g.ownerName}</span></span></div>
                        <div id="cutoff-timer" class="text-xs font-bold text-red-600 text-center mb-6">Loading‚Ä¶</div>
                        <div class="space-y-3">
                            <div class="flex justify-between items-end mb-4"><h3 class="text-xs font-bold text-gray-400 uppercase">People Joined</h3><div class="text-right">${!isUnlocked ? `<span class="text-xs font-bold text-orange-800 bg-orange-100 px-2 py-0.5 rounded animate-pulse">Need ${Math.max(0, CONSTANTS.MIN_GROUP_SIZE - g.memberCount)} more</span>` : '<span class="text-xs font-bold text-green-800 bg-green-100 px-2 py-0.5 rounded">Unlocked!</span>'}</div></div>
                            ${memberHtml}
                        </div>
                    </div>
                    <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 p-4 pb-safe z-50 shadow-lg">
                        ${hasJoined ? `<button onclick="window.JodoApp.UI.shareGroup('${g.id}', ${isUnlocked})" class="w-full bg-jodo-ctaPrimary text-white h-[56px] flex items-center justify-center rounded-xl font-bold gap-2"><i data-lucide="share-2" size="20"></i> Share Deal</button>` : `<button onclick="window.JodoApp.UI.openCheckoutModal('${g.id}')" class="w-full bg-jodo-ctaPrimary text-white h-[56px] rounded-xl font-bold">Join Group</button>`}
                    </div>
                </div>`;
                
                this.startTimer(document.getElementById('cutoff-timer'));
            },

            openCheckoutModal(joinGroupId = null) {
                const isClosed = Services.Time.isPastCutoff();
                if (isClosed) { this.toast("Orders closed.", "clock"); return; }

                const { user, members, cart } = Store.state;
                // Determine logic for pre-fill
                let activeCart = { ...cart };
                let isEditing = false;

                if (joinGroupId) {
                     const mList = members[joinGroupId] || [];
                     const me = mList.find(m => m.phone === user.phone);
                     if (me) {
                         activeCart = { ...(me.cart || {}) };
                         isEditing = true;
                         // Sync to store for reactive updates
                         Store.update('cart', activeCart);
                     } else {
                         if (Object.keys(Store.state.cart).length === 0) {
                             this.toast("Please select items before joining", "shopping-bag");
                             return;
                         }
                     }
                } else if (Object.keys(cart).length === 0) {
                     this.toast("Please select items first", "shopping-bag");
                     return;
                }

                const btnText = isEditing ? "Update Order" : (joinGroupId ? "Join Group" : "Start saving today");
                
                // RENDER MODAL CONTENT
                const modalHtml = `
                <div class="flex flex-col h-[90vh] bg-white relative rounded-t-[1.5rem] overflow-hidden font-sans">
                    <div class="bg-white px-5 py-4 flex items-center justify-between border-b border-gray-100 shrink-0 z-20">
                        <div class="flex items-center gap-2 text-green-700">
                            <i data-lucide="sparkles" size="20"></i>
                            <h3 class="font-black text-xl tracking-tight">Smart Choice</h3>
                        </div>
                        <button id="close-modal" class="p-2 bg-gray-50 rounded-full text-gray-500 hover:bg-gray-100 transition-colors"><i data-lucide="x" size="20"></i></button>
                    </div>
                    <div class="p-5 overflow-y-auto flex-1 relative bg-gray-50/30">
                        <div class="bg-white border border-green-200 rounded-xl p-6 mb-6 shadow-sm text-center relative" id="savings-banner">
                            <div class="text-gray-500 text-xs font-bold uppercase tracking-wider mb-2">Total Savings</div>
                            <div class="text-6xl font-black text-green-600 tracking-tighter mb-3 leading-none" id="summary-savings">...</div>
                            <div class="bg-gray-50 rounded-lg py-2 px-3 border border-gray-100 inline-block mt-2">
                                <div class="text-xs text-gray-500 font-medium">Estimated savings vs market price</div>
                            </div>
                        </div>
                        <div class="bg-white border border-gray-200 rounded-xl p-4 mb-6 shadow-sm">
                            <div class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Select Items</div>
                            <div id="modal-items-container"></div>
                            <div class="flex justify-between items-center pt-3 mt-2 border-t border-gray-100">
                                <span class="font-bold text-gray-900">Total To Pay</span>
                                <span class="font-black text-xl text-gray-900" id="checkout-total">...</span>
                            </div>
                        </div>
                        <div class="space-y-4 mb-4">
                            <div class="relative"><div class="absolute inset-y-0 left-0 pl-4 flex items-center text-gray-400"><i data-lucide="user" size="18"></i></div><input id="inp-name" value="${user.name}" class="w-full bg-white border border-gray-300 py-3 pl-12 pr-4 rounded-lg outline-none focus:border-green-600 focus:ring-1 focus:ring-green-600" placeholder="Your Name"></div>
                            <div class="relative"><div class="absolute inset-y-0 left-0 pl-4 flex items-center text-gray-400"><i data-lucide="phone" size="18"></i></div><input id="inp-phone" value="${user.phone}" type="tel" class="w-full bg-white border border-gray-300 py-3 pl-12 pr-4 rounded-lg outline-none focus:border-green-600 focus:ring-1 focus:ring-green-600" placeholder="Mobile Number"></div>
                        </div>
                    </div>
                    <div class="bg-white border-t border-gray-100 p-4 shrink-0 pb-safe z-20">
                        <div class="text-center text-[11px] text-gray-500 font-medium mb-2">Pay on delivery ‚Ä¢ Cash or UPI</div>
                        <button id="action-btn" class="w-full bg-jodo-ctaPrimary text-white h-[56px] rounded-xl font-bold text-lg shadow-sm flex items-center justify-center gap-2 active:scale-[0.99] transition-all btn-press">
                            <span>${btnText}</span>
                        </button>
                    </div>
                </div>`;

                const node = this.createNode(modalHtml);
                this.showModal(node);

                // Re-render function for modal
                const updateModalUI = () => {
                    const currentCart = Store.state.cart;
                    let totalJodo = 0; let totalMarket = 0;
                    
                    const itemsHtml = CONSTANTS.PRODUCTS.map(p => {
                        const qty = currentCart[p.id] || 0;
                        const marketPrice = p.tiers[0].price; // Tier 0 is market
                        const jodoPrice = p.tiers[p.tiers.length-1].price; // Best price
                        
                        if (qty > 0) { 
                            totalJodo += Math.round(qty * jodoPrice); 
                            totalMarket += Math.round(qty * marketPrice); 
                        }
                        const isSelected = qty > 0;

                        return `
                        <div class="flex items-center justify-between py-3 border-b border-gray-50 last:border-0">
                            <div class="flex items-center gap-3">
                                <div class="w-12 h-12 bg-gray-50 rounded-lg overflow-hidden border border-gray-200 shrink-0 relative transition-all ${isSelected ? '' : 'opacity-60 grayscale'}">
                                    <img src="${p.imageSrc}" class="w-full h-full object-cover">
                                </div>
                                <div class="flex flex-col">
                                    <div class="font-bold text-gray-800 text-sm">${p.name}</div>
                                    <div class="text-xs text-gray-500 font-medium">
                                        ${isSelected ? `<span class="text-green-700 font-bold">‚Çπ${Math.round(qty*jodoPrice)}</span> <span class="line-through text-gray-300 text-[10px]">‚Çπ${Math.round(qty*marketPrice)}</span>` : `Rate: ‚Çπ${jodoPrice}/kg`}
                                    </div>
                                </div>
                            </div>
                            <div class="flex items-center gap-3 bg-white border border-gray-200 rounded-lg p-1 shadow-sm">
                                <button class="btn-minus w-8 h-8 flex items-center justify-center bg-white rounded-md text-gray-600" data-id="${p.id}" data-delta="-${p.step}"><i data-lucide="minus" size="14"></i></button>
                                <span class="w-10 text-center text-sm font-bold text-gray-800 tabular-nums">${qty > 0 ? Services.Pricing.formatQty(qty) : '0'}</span>
                                <button class="btn-plus w-8 h-8 flex items-center justify-center bg-jodo-ctaPrimary text-white rounded-md shadow-sm" data-id="${p.id}" data-delta="${p.step}"><i data-lucide="plus" size="14"></i></button>
                            </div>
                        </div>`;
                    }).join('');

                    node.querySelector('#modal-items-container').innerHTML = itemsHtml;
                    node.querySelector('#summary-savings').innerText = `‚Çπ${Math.round(totalMarket - totalJodo)}`;
                    node.querySelector('#checkout-total').innerText = `‚Çπ${Math.round(totalJodo)}`;
                    
                    if(window.lucide) window.lucide.createIcons();

                    // Re-attach listeners inside modal
                    node.querySelectorAll('.btn-minus, .btn-plus').forEach(btn => {
                        btn.onclick = () => {
                            Actions.updateCart(btn.dataset.id, parseFloat(btn.dataset.delta));
                            updateModalUI();
                        }
                    });
                };

                updateModalUI();

                // Bind Main Actions
                node.querySelector('#close-modal').onclick = this.closeModal;
                const actionBtn = node.querySelector('#action-btn');
                
                actionBtn.onclick = async () => {
                    const name = node.querySelector('#inp-name').value.trim();
                    const phone = node.querySelector('#inp-phone').value.trim();
                    
                    if(actionBtn.disabled) return;
                    actionBtn.disabled = true;
                    actionBtn.innerHTML = '<div class="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>';

                    const success = await Actions.submitOrder(name, phone, joinGroupId);
                    if (success) {
                        this.closeModal();
                    } else {
                        actionBtn.disabled = false;
                        actionBtn.innerHTML = `<span>${btnText}</span>`;
                    }
                };
            },

            // --- UTILITIES ---

            toast(msg, icon) {
                const t = document.getElementById('toast');
                t.innerHTML = `<i data-lucide="${icon}" size="16" class="${icon === 'share-2' ? 'text-white' : 'text-green-400'}"></i> ${msg}`;
                t.classList.remove('hidden');
                if(window.lucide) window.lucide.createIcons();
                setTimeout(() => t.classList.add('hidden'), 4000);
            },

            shareGroup(groupId, isUnlocked) {
                const currentUrl = `${CONSTANTS.PUBLIC_SHARE_URL}?group=${groupId}`;
                const text = isUnlocked 
                    ? `‡∞à‡∞∞‡±ã‡∞ú‡±Å ‡∞ó‡±ç‡∞∞‡±Ç‡∞™‡±ç ‡∞°‡±Ä‡∞≤‡±ç ‡∞Ö‡∞®‡±ç‚Äå‡∞≤‡∞æ‡∞ï‡±ç ‡∞Ö‡∞Ø‡±ç‡∞Ø‡∞ø‡∞Ç‡∞¶‡∞ø ‚úÖ\n\n‡∞Æ‡∞æ ‡∞ó‡±ç‡∞∞‡±Ç‡∞™‡±ç‚Äå‡∞≤‡±ã ‡∞Ö‡∞Ç‡∞¶‡∞∞‡±Ç ‡∞§‡∞ï‡±ç‡∞ï‡±Å‡∞µ ‡∞ß‡∞∞‡∞ï‡±á ‡∞ï‡±ä‡∞Ç‡∞ü‡±Å‡∞®‡±ç‡∞®‡∞æ‡∞∞‡±Å\n‡∞á‡∞™‡±ç‡∞™‡±Å‡∞°‡±á ‡∞ú‡∞æ‡∞Ø‡∞ø‡∞®‡±ç ‡∞Ö‡∞Ø‡∞ø‡∞§‡±á ‡∞®‡±Ä‡∞ï‡±Ç ‡∞Ö‡∞¶‡±á ‡∞∞‡±á‡∞ü‡±ç`
                    : `‡∞à‡∞∞‡±ã‡∞ú‡±Å ‡∞Ü‡∞∞‡±ç‡∞°‡∞∞‡±ç ‡∞Æ‡±ä‡∞¶‡∞≤‡±à‡∞Ç‡∞¶‡∞ø\n\n‡∞á‡∞¶‡∞ø ‡∞Ü‡∞ó‡∞ø‡∞™‡±ã‡∞§‡±á ‡∞Ö‡∞Ç‡∞¶‡∞∞‡∞Ç ‡∞∑‡∞æ‡∞™‡±Å ‡∞ß‡∞∞‡∞ï‡±á ‡∞ï‡±ä‡∞®‡∞æ‡∞≤‡∞ø\n‡∞®‡±á‡∞®‡±á ‡∞Æ‡±ä‡∞¶‡∞≤‡±Å‡∞™‡±Ü‡∞ü‡±ç‡∞ü‡∞æ‡∞®‡±Å, ‡∞®‡±Å‡∞µ‡±ç‡∞µ‡±á ‡∞ö‡∞ø‡∞µ‡∞∞‡∞ø‡∞µ‡∞æ‡∞°‡±Å`;
                window.open(`https://wa.me/?text=${encodeURIComponent(text + "\n\nüëâ " + currentUrl)}`, '_blank');
            },

            createNode(html) {
                const t = document.createElement('template');
                t.innerHTML = html.trim();
                return t.content.firstElementChild;
            },

            showModal(node) {
                const overlay = document.getElementById('modal-overlay');
                const content = document.getElementById('modal-content');
                content.innerHTML = '';
                content.appendChild(node);
                overlay.classList.remove('hidden');
                setTimeout(() => {
                    overlay.classList.remove('opacity-0');
                    content.classList.remove('translate-y-full');
                }, 10);
            },

            closeModal() {
                const overlay = document.getElementById('modal-overlay');
                const content = document.getElementById('modal-content');
                content.classList.add('translate-y-full');
                overlay.classList.add('opacity-0');
                setTimeout(() => {
                    overlay.classList.add('hidden');
                    content.innerHTML = '';
                }, 300);
            },

            triggerVibration() {
                if (navigator.vibrate) navigator.vibrate(10);
            },

            initTilt() {
                if (window.matchMedia("(pointer: coarse)").matches) return;
                document.querySelectorAll('.tilt-card').forEach(card => {
                    card.addEventListener('mousemove', (e) => {
                        const rect = card.getBoundingClientRect();
                        const x = e.clientX - rect.left - rect.width/2;
                        const y = e.clientY - rect.top - rect.height/2;
                        card.style.transform = `perspective(1000px) rotateX(${y * -0.05}deg) rotateY(${x * 0.05}deg) scale3d(1.01, 1.01, 1.01)`;
                    });
                    card.addEventListener('mouseleave', () => {
                        card.style.transform = `perspective(1000px) rotateX(0deg) rotateY(0deg) scale3d(1, 1, 1)`;
                    });
                });
            },
            
            _timerInterval: null,
            startTimer(el) {
                if (!el) return;
                if (this._timerInterval) clearInterval(this._timerInterval);
                const tick = () => {
                    const rem = Services.Time.getCutoffTimestamp() - Date.now();
                    el.textContent = rem > 0 ? `‚è∞ ${Services.Time.isPastCutoff() ? "Closed" : Services.Pricing.formatQty(rem/3600000).replace('kg','h') + " left"}` : "‚õî Today's orders closed"; 
                    
                    if (rem > 0) {
                        const h = Math.floor(rem/3600000);
                        const m = Math.floor((rem%3600000)/60000);
                        el.textContent = `‚è∞ ${h}h ${m}m left`;
                    }
                };
                tick();
                this._timerInterval = setInterval(tick, 1000);
            }
        };

        // ==========================================
        // EXPOSE
        // ==========================================
        
        window.JodoApp = { Actions, UI };

    </script>
</body>
</html>
