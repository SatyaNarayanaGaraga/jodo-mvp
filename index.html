<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover" />
    <title>JODO - Village Order</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üçÖ</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        jodo: {
                            base: '#FFFFFF',
                            textPrimary: '#111827',
                            ctaPrimary: '#000000', 
                            error: '#DC2626',
                        }
                    },
                    fontFamily: {
                        sans: ['-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'sans-serif'],
                        mono: ['ui-monospace', 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'monospace'],
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>
    <style>
        body { 
            background: #F3F4F6; 
            color: #111827; 
            -webkit-tap-highlight-color: transparent; 
            min-height: 100dvh; 
            display: flex; 
            justify-content: center; 
            margin: 0; 
            overscroll-behavior-y: contain;
            line-height: 1.45;
            letter-spacing: -0.01em; 
        }
        #app { width: 100%; max-width: 448px; background: #FFFFFF; min-height: 100dvh; position: relative; overflow-y: auto; display: flex; flex-direction: column; box-shadow: 0 0 20px rgba(0,0,0,0.05); }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .pt-safe { padding-top: env(safe-area-inset-top); }
        
        /* Pinduoduo-style Progress Bar */
        .progress-strip {
            background-image: linear-gradient(45deg,rgba(255,255,255,.15) 25%,transparent 25%,transparent 50%,rgba(255,255,255,.15) 50%,rgba(255,255,255,.15) 75%,transparent 75%,transparent);
            background-size: 1rem 1rem;
        }

        /* Fear Ticker (Premium, Colorful, Continuous) */
        .jodo-fear-ticker {
            background: linear-gradient(90deg, #7C2D12, #B91C1C, #7C2D12);
            color: #FFF7ED;
            overflow: hidden;
            padding: 10px 0;
            border-radius: 14px;
            box-shadow: inset 0 0 0 1px rgba(255,255,255,0.15);
        }

        .jodo-fear-track {
            display: inline-flex;
            white-space: nowrap;
            animation: jodo-marquee 30s linear infinite;
            padding-left: 100%;
            font-weight: 900;
            font-size: 14px;
            letter-spacing: 0.2px;
        }

        .jodo-fear-track .gap {
            width: 48px;
            display: inline-block;
        }

        @keyframes jodo-marquee {
            from { transform: translateX(0); }
            to { transform: translateX(-100%); }
        }
    </style>
</head>
<body class="antialiased">

    <div id="app"></div>

    <div id="modal-overlay" class="fixed inset-0 bg-black/80 hidden z-[60] flex items-end justify-center backdrop-blur-sm transition-opacity duration-300">
        <div id="modal-content" class="bg-gray-50 w-full max-w-[448px] rounded-t-2xl shadow-2xl transform transition-transform duration-300 translate-y-full max-h-[95dvh] overflow-y-auto pb-safe"></div>
    </div>

    <div id="toast" class="fixed top-12 left-1/2 -translate-x-1/2 bg-gray-900 text-white px-6 py-3 text-sm font-bold shadow-xl hidden z-[90] flex items-center gap-2 pointer-events-none text-center w-max max-w-[90%] rounded-full transition-all transform duration-200"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, runTransaction, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "", // TODO: Add your real API Key here for production deployment
            authDomain: "jodo-prod-e7788.firebaseapp.com",
            projectId: "jodo-prod-e7788",
            storageBucket: "jodo-prod-e7788.firebasestorage.app",
            messagingSenderId: "535883967600",
            appId: "1:535883967600:web:aa0b73a70ca506ad4fd8b5"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        window.db = db;
        window.fs = { doc, getDoc, setDoc, onSnapshot, collection, runTransaction, serverTimestamp, updateDoc };
        
        window.dispatchEvent(new Event('firebase-ready'));
    </script>
    
    <script>
        const BASE_URL = 'https://satyanarayanagaraga.github.io/jodo-mvp'; 
        const DELIVERY_FEE = 10;
        const FORCE_OPEN_FOR_TESTING = false; 
        const OPEN_HOUR = 6;
        const CLOSE_HOUR = 21; 
        
        // Tier based pricing logic
        function calculateFinalPrice(totalKg, product) {
          if (totalKg >= 100) return product.priceMin;
          if (totalKg >= product.target) return product.priceMin; // Simplified for visual clarity
          return product.priceMax;
        }

        const PRODUCTS = [
            { 
                id: 'tomato', 
                name: '‡∞ü‡∞Æ‡∞æ‡∞ü‡∞æ‡∞≤‡±Å (Tomato)', 
                target: 25, 
                priceMin: 38,       
                priceMax: 42,       
                step: 0.5, 
                min: 0.5,
                unit: 'kg',
                img: 'https://images.unsplash.com/photo-1592924357228-91a4daadcfea?auto=format&fit=crop&w=150&q=80',
                quantityOptions: [0.5, 1, 1.5, 2],
                lastShop: 60,
                lastJodo: 40
            },
            { 
                id: 'onion', 
                name: '‡∞â‡∞≤‡±ç‡∞≤‡∞ø‡∞™‡∞æ‡∞Ø‡∞≤‡±Å (Onion)', 
                target: 15, 
                priceMin: 27,
                priceMax: 32,
                step: 0.5, 
                min: 0.5,
                unit: 'kg',
                img: 'https://images.unsplash.com/photo-1508747703725-7197771e445d?auto=format&fit=crop&w=150&q=80',
                quantityOptions: [0.5, 1, 2, 3]
            }
        ];

        const PICKUP_POINTS = [
            {
                id: "duvva_main",
                name: "Duvva Main Road",
                clue: "SBI Bank tree",
                img: "https://images.unsplash.com/photo-1544620347-c4fd4a3d5957?auto=format&fit=crop&w=400&q=80",
                mapLink: "https://maps.google.com/?q=Duvva+Main+Road"
            },
            {
                id: "temple",
                name: "Near Temple",
                clue: "Temple gate",
                img: "https://images.unsplash.com/photo-1563499118-8f830d93708e?auto=format&fit=crop&w=400&q=80",
                mapLink: "https://maps.google.com/?q=Hanuman+Temple+Duvva"
            }
        ];

        const state = { 
            view: 'home', 
            groups: {}, 
            members: {}, 
            user: { name: '', phone: '' },
            cart: {}, 
            listeners: [],
            modalStep: 0,
            deliveryMethod: 'pickup',
            cycleId: null,
            deliveryLocation: null,
            selectedPickupId: null, 
            extraHouseholds: [], 
            isCollectorMode: false 
        };
        
        function getISTDate() {
            return new Date(new Date().toLocaleString("en-US", { timeZone: "Asia/Kolkata" }));
        }

        function getISTDateStr() {
            const d = getISTDate();
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${y}-${m}-${day}`;
        }

        function getCycleGroupId() {
            const d = getISTDate();
            const days = ['SUN','MON','TUE','WED','THU','FRI','SAT'];
            const y = d.getFullYear();
            const m = String(d.getMonth()+1).padStart(2,'0');
            const da = String(d.getDate()).padStart(2,'0');
            return `duvva_${days[d.getDay()]}_${y}_${m}_${da}`;
        }

        function isOrderWindowOpen() {
            if (FORCE_OPEN_FOR_TESTING) return true;
            const d = getISTDate();
            const hour = d.getHours();
            if (hour < OPEN_HOUR || hour >= CLOSE_HOUR) return false;
            return true;
        }
        
        function isViewingTodayCycle(groupId) {
            const d = getISTDate();
            const days = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            const dayStr = days[d.getDay()];
            const todayId = `duvva_${dayStr}_${year}_${month}_${day}`;
            return groupId === todayId;
        }

        function getCutoffRemaining() {
            const now = getISTDate();
            const cutoff = new Date(now);
            cutoff.setHours(CLOSE_HOUR, 0, 0, 0);
            const diff = cutoff - now;
            if (diff <= 0) return "Closed";
            
            const totalSeconds = Math.floor(diff / 1000);
            const hrs = Math.floor(totalSeconds / 3600);
            const mins = Math.floor((totalSeconds % 3600) / 60);
            
            const pMins = String(mins).padStart(2, '0');

            return hrs > 0 ? `${hrs}h ${pMins}m` : `${mins}m`;
        }

        function getCutoffMinutes() {
            const now = getISTDate();
            const cutoff = new Date(now);
            cutoff.setHours(CLOSE_HOUR, 0, 0, 0);
            return Math.floor((cutoff - now) / 60000);
        }

        function getProductStats(members, prodId) {
            const gid = getCycleGroupId();
            const group = state.groups[gid];
            
            let total = 0;
            let peopleCount = 0;

            if (group && group.totals && group.totals[prodId] !== undefined) {
                 total = group.totals[prodId];
            } else {
                members.forEach(m => {
                    if (m.items && m.items[prodId]) {
                        total += parseFloat(m.items[prodId]);
                        peopleCount++;
                    }
                });
            }

            const p = PRODUCTS.find(x => x.id === prodId);
            return {
                total: parseFloat(total.toFixed(2)),
                target: p.target,
                isRunning: total >= p.target,
                remaining: Math.max(0, p.target - total),
                peopleCount: peopleCount 
            };
        }
        
        function toast(msg, type = 'normal') { 
            const t = document.getElementById('toast'); 
            t.innerHTML = msg; 
            if(type === 'error') {
                t.className = "fixed top-12 left-1/2 -translate-x-1/2 bg-red-600 text-white px-6 py-3 rounded-full text-sm font-bold shadow-2xl z-[90] scale-100";
            } else {
                t.className = "fixed top-12 left-1/2 -translate-x-1/2 bg-black text-white px-6 py-3 font-bold shadow-2xl z-[90] rounded-full scale-100";
            }
            t.classList.remove('hidden'); 
            setTimeout(() => {
                t.classList.add('hidden');
            }, 3000); 
        }

        function loadUser() {
            state.user.name = localStorage.getItem('jodo_name') || '';
            state.user.phone = localStorage.getItem('jodo_phone') || '';
        }

        function saveUser(name, phone) {
            state.user.name = name;
            state.user.phone = phone;
            localStorage.setItem('jodo_name', name);
            localStorage.setItem('jodo_phone', phone);
        }

        function listenToCycleGroup() {
            const gid = getCycleGroupId();
            state.cycleId = gid;
            if (!window.fs) return;
            state.listeners.forEach(u => u()); state.listeners = [];
            const unsubG = window.fs.onSnapshot(window.fs.doc(window.db, "groups", gid), (doc) => {
                state.groups[gid] = doc.exists() ? doc.data() : null;
                render();
            });
            const unsubM = window.fs.onSnapshot(window.fs.collection(window.db, "groups", gid, "members"), (snap) => {
                const m = [];
                snap.forEach(d => m.push({ ...d.data(), id: d.id }));
                m.sort((a, b) => (a.joinedAt?.seconds || 0) - (b.joinedAt?.seconds || 0));
                state.members[gid] = m;
                render();
                if (state.modalStep === 2) renderDetailsStep();
            });
            state.listeners.push(unsubG, unsubM);
        }

        function setCartQuantity(prodId, qty) {
            if (!isOrderWindowOpen()) {
                toast('JODO Closed', 'error');
                return;
            }
            if (qty === 0) {
                delete state.cart[prodId];
            } else {
                state.cart[prodId] = qty;
            }
            // Minimal toast, systems > words
            toast(qty === 0 ? 'Removed' : 'Updated');
            render();
        }
        window.setCartQuantity = setCartQuantity;
        window.updateCart = setCartQuantity;

        window.addExtraHousehold = function() {
            if (state.extraHouseholds.length >= 3) {
                toast('Max 3 families', 'error');
                return;
            }
            state.extraHouseholds.push({ name: '', phone: '', items: {} });
            renderDetailsStep();
        };

        window.removeExtraHousehold = function(idx) {
            state.extraHouseholds.splice(idx, 1);
            renderDetailsStep();
        };

        window.updateExtraHouseholdField = function(idx, field, value) {
            state.extraHouseholds[idx][field] = value;
        };

        window.updateExtraHouseholdItem = function(idx, prodId, qty) {
            if (qty === 0) {
                delete state.extraHouseholds[idx].items[prodId];
            } else {
                state.extraHouseholds[idx].items[prodId] = qty;
            }
            renderDetailsStep();
        };

        window.useMyLocation = async function() {
            if (!navigator.geolocation) { toast('GPS not supported', 'error'); return; }
            toast('Getting GPS...', 'normal');
            navigator.geolocation.getCurrentPosition(async (pos) => {
                const lat = pos.coords.latitude;
                const lng = pos.coords.longitude; 
                const accuracy = pos.coords.accuracy;
                state.deliveryLocation = { lat, lng, accuracy };
                const btn = document.getElementById('btn-use-location');
                if(btn) {
                    btn.innerHTML = `‚úÖ GPS Captured`;
                    btn.classList.remove('border-dashed', 'border-gray-300', 'text-gray-700');
                    btn.classList.add('border-solid', 'border-black', 'text-black', 'bg-gray-50');
                }
                toast('Location set ‚úÖ', 'normal');
            }, (err) => {
                toast('Please allow GPS permission', 'error');
            }, { enableHighAccuracy: true, timeout: 10000 });
        }

        window.selectPickupPoint = function(pickupId) {
            const point = PICKUP_POINTS.find(p => p.id === pickupId);
            if (!point) return;
            state.selectedPickupId = pickupId;
            renderDetailsStep();
        };

        window.openCollectorMode = function() {
            if (!isOrderWindowOpen()) { toast('Closed', 'error'); return; }
            const gid = getCycleGroupId();
            const members = state.members[gid] || [];
            const myMember = state.user.phone ? members.find(m => m.phone === state.user.phone) : null;
            if (!myMember) {
                toast('Order needed to collect', 'error');
                return;
            }
            state.cart = { ...myMember.items }; 
            state.deliveryMethod = myMember.delivery?.method || 'pickup';
            state.deliveryLocation = myMember.delivery?.location || null;
            if (myMember.delivery?.pickupPoint) {
                const point = PICKUP_POINTS.find(p => p.name === myMember.delivery.pickupPoint);
                if (point) state.selectedPickupId = point.id;
            }
            state.extraHouseholds = [{ name: '', phone: '', items: {} }];
            state.modalStep = 2;
            state.isCollectorMode = true; 
            renderDetailsStep();
            document.getElementById('modal-overlay').classList.remove('hidden');
            setTimeout(() => { 
                document.getElementById('modal-overlay').classList.remove('opacity-0'); 
                document.getElementById('modal-content').classList.remove('translate-y-full'); 
            }, 10);
        }

        function openModalFlow() {
            if (!isOrderWindowOpen()) { toast('Closed', 'error'); return; }
            if (Object.keys(state.cart).length === 0) { toast('Select items first', 'error'); return; }
            state.deliveryMethod = 'pickup';
            state.deliveryLocation = null;
            state.selectedPickupId = null; 
            state.extraHouseholds = []; 
            state.modalStep = 2; 
            state.isCollectorMode = false;
            renderDetailsStep();
            document.getElementById('modal-overlay').classList.remove('hidden');
            setTimeout(() => { 
                document.getElementById('modal-overlay').classList.remove('opacity-0'); 
                document.getElementById('modal-content').classList.remove('translate-y-full'); 
            }, 10);
        }

        function closeModal() {
            const overlay = document.getElementById('modal-overlay');
            const content = document.getElementById('modal-content');
            content.classList.add('translate-y-full');
            overlay.classList.add('opacity-0');
            setTimeout(() => { overlay.classList.add('hidden'); state.modalStep = 0; }, 300);
        }

        function renderDetailsStep() {
            const container = document.getElementById('modal-content');
            const gid = getCycleGroupId(); 
            const members = state.members[gid] || [];
            
            let minTotal = 0;
            let maxTotal = 0;

            Object.entries(state.cart).forEach(([pid, qty]) => {
                const p = PRODUCTS.find(x => x.id === pid);
                if (p) {
                    minTotal += qty * p.priceMin;
                    maxTotal += qty * p.priceMax;
                }
            });

            state.extraHouseholds.forEach(h => {
                Object.entries(h.items).forEach(([pid, qty]) => {
                    const p = PRODUCTS.find(x => x.id === pid);
                    if (p) {
                        minTotal += qty * p.priceMin;
                        maxTotal += qty * p.priceMax;
                    }
                });
            });

            const isHome = state.deliveryMethod === 'home';
            const deliveryCharge = isHome ? DELIVERY_FEE : 0;
            const finalMin = minTotal + deliveryCharge;
            const finalMax = maxTotal + deliveryCharge;
            
            // --- CEO CHANGE: Simple Range (Stable) ---
            // Just Estimated Total: Min - Max
            const summaryHtml = `
                <div class="flex justify-between items-center border-t border-gray-100 mt-3 pt-3">
                    <div class="text-xs font-bold text-gray-500 uppercase">Estimated Total</div>
                    <div class="text-2xl font-black text-gray-900">‚Çπ${finalMin.toFixed(0)} - ‚Çπ${finalMax.toFixed(0)}</div>
                </div>
            `;

            let listHtml = '';
            Object.entries(state.cart).forEach(([pid, qty]) => {
                const p = PRODUCTS.find(x => x.id === pid);
                if (!p) return;
                
                // Item level: Simple Range
                listHtml += `
                    <div class="flex justify-between items-center py-2 border-b border-gray-100 last:border-0">
                        <div><div class="font-bold text-gray-900">${p.name} <span class="text-gray-500 font-medium">x ${qty < 1 ? qty*1000 + 'g' : qty + 'kg'}</span></div></div>
                        <div class="text-right">
                             <div class="text-sm font-bold text-gray-900">‚Çπ${(qty * p.priceMin).toFixed(0)} - ‚Çπ${(qty * p.priceMax).toFixed(0)}</div>
                        </div>
                    </div>
                `;
            });

            const extraHouseholdsHtml = state.extraHouseholds.map((h, idx) => {
                const productSelectors = PRODUCTS.map(p => {
                    const currentQty = h.items[p.id] || 0;
                    return `
                        <div class="mt-2">
                            <div class="text-xs font-bold text-gray-700 mb-1">${p.name.split('(')[0]} (kg)</div>
                            <div class="flex gap-2">
                                <button onclick="window.updateExtraHouseholdItem(${idx}, '${p.id}', 0.5)" class="flex-1 py-1 text-xs border rounded ${currentQty === 0.5 ? 'bg-black text-white border-black' : 'bg-white border-gray-300 text-gray-700'}">0.5</button>
                                <button onclick="window.updateExtraHouseholdItem(${idx}, '${p.id}', 1)" class="flex-1 py-1 text-xs border rounded ${currentQty === 1 ? 'bg-black text-white border-black' : 'bg-white border-gray-300 text-gray-700'}">1</button>
                                <button onclick="window.updateExtraHouseholdItem(${idx}, '${p.id}', 1.5)" class="flex-1 py-1 text-xs border rounded ${currentQty === 1.5 ? 'bg-black text-white border-black' : 'bg-white border-gray-300 text-gray-700'}">1.5</button>
                            </div>
                        </div>
                    `;
                }).join('');

                return `
                    <div class="bg-gray-50 border border-gray-200 rounded-xl p-4 mb-3 relative">
                        <div class="absolute top-2 right-2"><button onclick="window.removeExtraHousehold(${idx})" class="text-xs font-bold text-red-500">Remove</button></div>
                        <div class="text-sm font-black text-gray-900 mb-3">Family ${idx + 1}</div>
                        <div class="space-y-3">
                            <input placeholder="Name" value="${h.name}" oninput="window.updateExtraHouseholdField(${idx}, 'name', this.value)" class="w-full p-2 text-sm border border-gray-300 rounded focus:border-black focus:outline-none">
                            <input placeholder="Phone" type="tel" value="${h.phone}" oninput="window.updateExtraHouseholdField(${idx}, 'phone', this.value)" class="w-full p-2 text-sm border border-gray-300 rounded focus:border-black focus:outline-none">
                            ${productSelectors}
                        </div>
                    </div>
                `;
            }).join('');

            let extraSection = '';
            if (state.isCollectorMode || state.extraHouseholds.length > 0) {
                // Calculate price range for display (using first product for now as per prompt example)
                const pRef = PRODUCTS[0];
                const priceRangeTxt = `‚Çπ${pRef.priceMin} ‚Äì ‚Çπ${pRef.priceMax} / kg`;
                const groupLink = `${BASE_URL}?group=${gid}`;
                const waText = `JODO Group Order\n\nCurrent price: ${priceRangeTxt}\nMore people = lower price\n\nJoin here:\n${groupLink}`;
                const waLink = `https://wa.me/?text=${encodeURIComponent(waText)}`;

                extraSection = `
                    <div class="bg-white rounded-2xl shadow-sm p-5 mb-4">
                        ${state.isCollectorMode ? `
                            <div class="mb-4">
                                <div class="text-lg font-black text-gray-900 leading-none">Group Order</div>
                                <div class="text-xs font-bold text-gray-400 mt-1">Price depends on total group quantity</div>
                            </div>
                            
                            <!-- Price Impact Card -->
                            <div class="bg-gray-50 rounded-xl p-3 mb-4 border border-gray-100 text-center">
                                <div class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-1">Current Price Range</div>
                                <div class="text-xl font-black text-gray-900">${priceRangeTxt}</div>
                            </div>
                        ` : ''}
                        
                        <div id="extra-households" class="space-y-2 mb-3">${extraHouseholdsHtml}</div>
                        
                        ${state.extraHouseholds.length < 3 ? `
                            <button onclick="window.addExtraHousehold()" class="w-full bg-black text-white rounded-xl py-3 text-sm font-black shadow-sm flex flex-col items-center justify-center leading-tight hover:bg-gray-900 active:scale-[0.98]">
                                <span>Add Neighbors</span>
                                <span class="text-[10px] font-medium opacity-80 mt-0.5">Adds kg to this group</span>
                            </button>
                        ` : ''}

                        ${state.isCollectorMode ? `
                            <a href="${waLink}" target="_blank" class="block w-full border border-gray-200 text-gray-600 rounded-xl py-3 text-sm font-bold text-center mt-3 hover:bg-gray-50 active:scale-[0.98]">
                                Share Group on WhatsApp
                            </a>
                        ` : ''}
                    </div>
                `;
            }
            
            const pickupCards = PICKUP_POINTS.map(p => {
                const selected = state.selectedPickupId === p.id;
                return `
                    <div onclick="window.selectPickupPoint('${p.id}')" class="border-2 rounded-xl overflow-hidden cursor-pointer transition relative ${selected ? 'border-black ring-1 ring-black' : 'border-gray-200 hover:border-gray-400'}">
                        <img src="${p.img}" class="w-full h-24 object-cover">
                        ${selected ? '<div class="absolute top-2 right-2 bg-black text-white rounded-full p-1"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg></div>' : ''}
                        <div class="p-2 bg-white">
                            <div class="font-black text-sm text-gray-900 leading-tight">${p.clue}</div>
                        </div>
                    </div>
                `;
            }).join('');

            const headerTitle = state.isCollectorMode ? 'Group Order' : 'Confirm';
            const ctaText = state.isCollectorMode ? 'Confirm Group' : 'Confirm Order';
            
            container.innerHTML = `
                <div class="bg-gray-50 relative font-sans">
                    <div class="px-6 py-4 bg-white shadow-sm flex justify-between items-center z-10 sticky top-0">
                        <div><h3 class="font-black text-xl text-gray-900 leading-none">${headerTitle}</h3></div>
                        <button onclick="window.closeModal()" class="p-2 bg-gray-100 hover:bg-gray-200 rounded-full"><i data-lucide="x" size="20"></i></button>
                    </div>
                    <div class="p-4 space-y-4">
                        ${!state.isCollectorMode ? `
                        <div class="bg-white rounded-2xl shadow-sm p-5">
                            <h4 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-3">Order Summary</h4>
                            ${listHtml}
                            ${summaryHtml}
                            ${isHome ? `<div class="text-[11px] text-gray-500 mt-2 text-right">Home Delivery: +‚Çπ${DELIVERY_FEE} (Included)</div>` : ''}
                        </div>
                        ` : ''}
                        ${extraSection}
                        ${!state.isCollectorMode ? `
                        <div class="bg-white rounded-2xl shadow-sm p-5">
                            <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-3">Delivery</label>
                            <div class="grid grid-cols-2 gap-3 mb-4">
                                <label class="cursor-pointer" onclick="window.setDelivery('pickup')"><input type="radio" class="peer hidden" ${state.deliveryMethod === 'pickup' ? 'checked' : ''}><div class="border-2 rounded-xl p-4 text-center transition-all ${state.deliveryMethod === 'pickup' ? 'border-black bg-gray-50' : 'border-gray-200'}"><div class="font-bold text-sm text-gray-900 flex items-center justify-center gap-1">üö∂ Pickup</div></div></label>
                                <label class="cursor-pointer" onclick="window.setDelivery('home')"><input type="radio" class="peer hidden" ${state.deliveryMethod === 'home' ? 'checked' : ''}><div class="border-2 rounded-xl p-4 text-center transition-all ${state.deliveryMethod === 'home' ? 'border-black bg-gray-50' : 'border-gray-200'}"><div class="font-bold text-sm text-gray-900 flex items-center justify-center gap-1">üöö Home</div><div class="text-[10px] text-gray-600 font-bold mt-1">+‚Çπ10</div></div></label>
                            </div>
                            <div id="pickup-container" class="mb-4" style="display: ${isHome ? 'none' : 'block'};"><div class="text-xs font-bold text-gray-500 mb-2 flex items-center gap-1">üìç Select Location</div><div class="grid grid-cols-2 gap-3">${pickupCards}</div></div>
                            <div id="home-address-container" style="display: ${isHome ? 'block' : 'none'};"><button id="btn-use-location" type="button" onclick="window.useMyLocation()" class="mb-4 w-full border border-dashed border-gray-400 rounded-xl py-3 text-sm font-bold text-gray-700 flex items-center justify-center gap-2 active:scale-[0.98]">üìç Use My Location</button><input id="inp-landmark" placeholder="Landmark (e.g. Near Temple)" class="w-full border border-gray-200 p-3 rounded-xl font-bold text-gray-900 focus:border-black focus:outline-none"></div>
                        </div>
                        <div class="bg-white rounded-2xl shadow-sm p-5">
                            <div class="space-y-4">
                                <div><label class="block text-xs font-bold text-gray-500 uppercase mb-2">Name</label><input id="inp-name" value="${state.user.name}" class="w-full border border-gray-200 p-3 rounded-xl font-bold focus:border-black focus:outline-none"></div>
                                <div><label class="block text-xs font-bold text-gray-500 uppercase mb-2">Mobile</label><input id="inp-phone" type="tel" value="${state.user.phone}" class="w-full border border-gray-200 p-3 rounded-xl font-bold focus:border-black focus:outline-none"></div>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                    <div class="p-4 bg-white border-t border-gray-200 pb-safe sticky bottom-0">
                         <button id="btn-submit-order" class="w-full bg-black text-white font-black text-xl h-[64px] rounded-2xl shadow-lg flex flex-col items-center justify-center leading-tight active:scale-[0.98]">${ctaText}</button>
                    </div>
                </div>
            `;
            if(window.lucide) window.lucide.createIcons();

            if (isHome && state.deliveryLocation) {
                 const btn = document.getElementById('btn-use-location');
                 if(btn) {
                    btn.innerHTML = `‚úÖ GPS Captured`;
                    btn.classList.remove('border-dashed', 'border-gray-400', 'text-gray-700');
                    btn.classList.add('border-solid', 'border-black', 'text-black', 'bg-gray-50');
                 }
            }

            document.getElementById('btn-submit-order').onclick = async () => {
                let name = '', phone = '', pickupPoint = null, landmark = null;
                if (!state.isCollectorMode) {
                    name = document.getElementById('inp-name').value.trim();
                    phone = document.getElementById('inp-phone').value.trim();
                    if (state.deliveryMethod === 'pickup') {
                        if(!state.selectedPickupId) { toast('Select pickup point', 'error'); return; }
                        const pointObj = PICKUP_POINTS.find(p => p.id === state.selectedPickupId);
                        pickupPoint = pointObj.name; 
                    } else {
                        if(!state.deliveryLocation) { toast('GPS required', 'error'); return; }
                        landmark = document.getElementById('inp-landmark').value.trim();
                    }
                    if(!name || phone.length < 10) { toast('Invalid details', 'error'); return; }
                } else {
                    for (let h of state.extraHouseholds) {
                        if (!h.name || h.phone.length < 10) { toast('Details missing for families', 'error'); return; }
                        if (Object.keys(h.items).length === 0) { toast('Items missing for families', 'error'); return; }
                    }
                    name = state.user.name;
                    phone = state.user.phone;
                }
                document.getElementById('btn-submit-order').innerText = '...';
                document.getElementById('btn-submit-order').disabled = true;
                await submitOrder(name, phone, pickupPoint, landmark, 0);
            };
        }

        window.setDelivery = (val) => { state.deliveryMethod = val; renderDetailsStep(); }

        async function submitOrder(name, phone, pickupPoint, landmark, amountPayable) {
            saveUser(name, phone);
            const gid = state.cycleId;
            const normalizedPhone = phone.replace(/\D/g, '').slice(-10);

            try {
                if (state.isCollectorMode) {
                    await window.fs.runTransaction(window.db, async (transaction) => {
                        const groupRef = window.fs.doc(window.db, "groups", gid);
                        const groupSnap = await transaction.get(groupRef);
                        let groupData = { id: gid, date: getISTDateStr(), createdAt: window.fs.serverTimestamp(), expiresAt: Date.now() + 43200000 };
                        let currentTotals = {};
                        let currentMemberCount = 0;
                        if (groupSnap.exists()) {
                             groupData = groupSnap.data();
                             currentTotals = groupData.totals || {};
                             currentMemberCount = groupData.memberCount || 0;
                        } else { transaction.set(groupRef, groupData); }

                        let addedFamiliesCount = 0;
                        state.extraHouseholds.forEach(h => {
                            addedFamiliesCount++;
                            Object.entries(h.items).forEach(([prodId, qty]) => { currentTotals[prodId] = (currentTotals[prodId] || 0) + qty; });
                            const memberId = crypto.randomUUID();
                            const memberRef = window.fs.doc(window.db, "groups", gid, "members", memberId);
                            const deliveryData = {
                                method: state.deliveryMethod,
                                pickupPoint: state.selectedPickupId ? (PICKUP_POINTS.find(p => p.id === state.selectedPickupId)?.name || null) : null,
                                location: state.deliveryLocation || null, 
                                landmark: state.deliveryLocation ? null : (landmark || null), 
                                mapsLink: state.deliveryLocation ? `https://maps.google.com/?q=${state.deliveryLocation.lat},${state.deliveryLocation.lng}` : null
                            };
                            transaction.set(memberRef, { 
                                name: h.name, phone: h.phone, items: h.items, collectorPhone: normalizedPhone, delivery: deliveryData, paymentStatus: "pending_manual", futurePaymentMethod: "UPI", amountPayable: 0, isCollectorOrder: true, joinedAt: window.fs.serverTimestamp() 
                            });
                        });
                        transaction.update(groupRef, { totals: currentTotals, memberCount: currentMemberCount + addedFamiliesCount });
                    });
                    const count = state.extraHouseholds.length;
                    closeModal(); 
                    toast(`${count} Families Added`, 'normal');
                } else {
                    const memberId = crypto.randomUUID();
                    await window.fs.runTransaction(window.db, async (transaction) => {
                        const groupRef = window.fs.doc(window.db, "groups", gid);
                        const groupSnap = await transaction.get(groupRef);
                        let groupData = { id: gid, date: getISTDateStr(), createdAt: window.fs.serverTimestamp(), expiresAt: Date.now() + 43200000 };
                        let currentTotals = {};
                        let currentMemberCount = 0;
                        if (groupSnap.exists()) {
                             groupData = groupSnap.data();
                             currentTotals = groupData.totals || {};
                             currentMemberCount = groupData.memberCount || 0;
                        } else { transaction.set(groupRef, groupData); }
                        Object.entries(state.cart).forEach(([prodId, qty]) => { currentTotals[prodId] = (currentTotals[prodId] || 0) + qty; });
                        transaction.update(groupRef, { totals: currentTotals, memberCount: currentMemberCount + 1 });
                        const memberRef = window.fs.doc(window.db, "groups", gid, "members", memberId);
                        const deliveryData = {
                            method: state.deliveryMethod,
                            pickupPoint: state.selectedPickupId ? (PICKUP_POINTS.find(p => p.id === state.selectedPickupId)?.name || null) : null,
                            location: state.deliveryLocation || null, 
                            landmark: landmark || null,
                            mapsLink: state.deliveryLocation ? `https://maps.google.com/?q=${state.deliveryLocation.lat},${state.deliveryLocation.lng}` : null
                        };
                        transaction.set(memberRef, { name, phone: normalizedPhone, items: state.cart, delivery: deliveryData, paymentStatus: "pending_manual", futurePaymentMethod: "UPI", amountPayable: amountPayable, joinedAt: window.fs.serverTimestamp() });
                    });
                    closeModal(); 
                    toast('Joined', 'normal');
                }
            } catch(e) { console.error(e); toast('Error', 'error'); document.getElementById('btn-submit-order').disabled = false; }
        }

        // Ticker Logic - Fear-Based (Pinduoduo Style)
        function getTickerHtml() {
            // Dynamic Ticker Text
            const tomato = PRODUCTS.find(p => p.id === 'tomato');
            const jodoPrice = tomato?.lastJodo || 40;
            const shopPrice = tomato?.lastShop || 60;

            const content = `<span>‡∞à ‡∞∞‡±ã‡∞ú‡±Å ‡∞Æ‡∞ø‡∞∏‡±ç ‡∞Ö‡∞Ø‡∞ø‡∞§‡±á ‚Äî ‡∞Æ‡∞Ç‡∞ó‡∞≥‡∞µ‡∞æ‡∞∞‡∞Ç ‡∞µ‡∞∞‡∞ï‡±Å ‡∞¶‡±Å‡∞ï‡∞æ‡∞£‡∞Ç ‡∞ß‡∞∞‡±á. ‡∞ú‡±ã‡∞°‡±ã‡∞≤‡±ã ‚Çπ${jodoPrice} | ‡∞¶‡±Å‡∞µ‡±ç‡∞µ ‡∞∑‡∞æ‡∞™‡±Å‡∞≤‡±ã ‚Çπ${shopPrice}.</span>`;
            
            return `
                <div style="padding: 0 16px; margin-top: 10px;">
                    <div class="jodo-fear-ticker">
                      <div class="jodo-fear-track">
                        ${content}
                        <span class="gap"></span>
                        ${content}
                      </div>
                    </div>
                </div>
            `;
        }

        function getHomeHtml() {
            const gid = getCycleGroupId();
            const isOpen = isOrderWindowOpen();
            const viewingToday = isViewingTodayCycle(gid);
            const group = state.groups[gid];

            if (group && group.status === 'cancelled') {
                 return `<div class="min-h-screen bg-white flex flex-col items-center justify-center p-8 text-center font-sans"><h2 class="text-2xl font-black text-gray-900 mb-2">Cancelled</h2></div>`;
            }
            
            if (!isOpen && !viewingToday) {
                return `<div class="min-h-screen bg-white flex flex-col items-center justify-center p-8 text-center font-sans"><h2 class="text-2xl font-black text-gray-900 mb-2">Closed</h2><p class="text-gray-500 font-bold">Opens 6 AM</p></div>`;
            }

            const members = state.members[gid] || [];
            const myMember = state.user.phone ? members.find(m => m.phone === state.user.phone) : null;
            
            if (myMember) return getStatusScreenHtml(state.groups[gid], members, myMember);
            else return getSelectionScreenHtml(members, isOpen);
        }

        function getSelectionScreenHtml(members, isOpen) {
            if (!isOpen) return `<div class="p-10 text-center text-gray-500 font-bold">Time Up</div>`;

            const hasItems = Object.keys(state.cart).length > 0;
            const remainingTime = getCutoffRemaining();
            
            // Psychology: No moral headers. Just time urgency.
            // Structure: Price Ladder Hero

            let productsHtml = PRODUCTS.map(p => {
                const qty = state.cart[p.id] || 0;
                const isSelected = qty > 0;
                const stats = getProductStats(members, p.id);
                const progressPct = Math.min(100, (stats.total / p.target) * 100);
                
                // --- CEO CHANGE: Boring, Stable, Trustworthy Range ---
                // Replaced visual ladder/arrows with explicit text range
                let priceText = '';
                if (qty > 0) {
                  const minTotal = qty * p.priceMin;
                  const maxTotal = qty * p.priceMax;
                  priceText = `‚Çπ${minTotal.toFixed(0)} - ‚Çπ${maxTotal.toFixed(0)}`;
                } else {
                  priceText = `‚Çπ${p.priceMin} - ‚Çπ${p.priceMax} <span class="text-sm font-medium text-gray-500">/ kg</span>`;
                }

                const priceHtml = `
                    <div class="mt-1 mb-2">
                        <div class="text-xl font-black text-gray-900">${priceText}</div>
                        <div class="text-[11px] text-gray-500 font-medium mt-0.5">
                            *‡∞à ‡∞ß‡∞∞ ‡∞Æ‡±ä‡∞§‡±ç‡∞§‡∞Ç ‡∞Ü‡∞∞‡±ç‡∞°‡∞∞‡±ç‡∞≤‡∞™‡±à ‡∞Ü‡∞ß‡∞æ‡∞∞‡∞™‡∞°‡∞ø ‡∞Æ‡∞æ‡∞∞‡±Å‡∞§‡±Å‡∞Ç‡∞¶‡∞ø
                        </div>
                    </div>
                `;

                // --- PROGRESS SURGE ---
                // Decoupled from price logic completely. Just shows progress.
                const progressHtml = `
                    <div class="mt-3">
                         <div class="flex justify-between text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1">
                            <span>Progress</span>
                            <span>${stats.total} / ${p.target} kg</span>
                         </div>
                         <div class="w-full bg-gray-200 h-2.5 rounded-full overflow-hidden">
                            <div class="h-full bg-black rounded-full transition-all duration-700 progress-strip" style="width: ${progressPct}%"></div>
                         </div>
                    </div>
                `;

                const qtyButtons = p.quantityOptions.map(q => {
                  const active = qty === q;
                  const label = q < 1 ? (q*1000 + 'g') : (q + 'kg');
                  return `<button onclick="window.setCartQuantity('${p.id}', ${q}); event.stopPropagation();" class="flex-1 py-3 rounded-xl text-sm font-bold transition border ${active ? 'bg-black text-white border-black shadow-lg transform scale-105' : 'bg-white text-gray-900 border-gray-200'}">${label}</button>`;
                }).join('');

                return `
                    <div class="bg-white rounded-2xl shadow-sm p-4 mb-4 border border-gray-100 relative overflow-hidden transition-all ${isSelected ? 'ring-2 ring-black' : ''}">
                        <div class="flex gap-4 mb-2">
                            <div class="w-20 h-20 rounded-xl overflow-hidden bg-gray-100 shrink-0"><img src="${p.img}" class="w-full h-full object-cover" onclick="window.setCartQuantity('${p.id}', ${p.quantityOptions[0]})"></div>
                            <div class="flex-1">
                                <h3 class="text-lg font-black text-gray-900 leading-tight">${p.name}</h3>
                                ${priceHtml}
                            </div>
                        </div>
                        ${progressHtml}
                        <div class="mt-4 pt-4 border-t border-gray-100">
                             <div class="flex gap-2">${qtyButtons}</div>
                             <div class="text-[11px] text-gray-500 font-medium mt-2 text-center leading-snug">
                                *‡∞§‡∞¶‡±Å‡∞™‡∞∞‡∞ø ‡∞Ü‡∞∞‡±ç‡∞°‡∞∞‡±ç ‡∞Æ‡∞Ç‡∞ó‡∞≥‡∞µ‡∞æ‡∞∞‡∞Ç. ‡∞Æ‡±Ä‡∞∞‡±Å ‡∞é‡∞Ç‡∞ö‡±Å‡∞ï‡±Å‡∞®‡±ç‡∞® ‡∞™‡∞∞‡∞ø‡∞Æ‡∞æ‡∞£‡∞Ç 3‚Äì4 ‡∞∞‡±ã‡∞ú‡±Å‡∞≤‡∞ï‡±Å ‡∞∏‡∞∞‡∞ø‡∞™‡∞°‡±á‡∞≤‡∞æ ‡∞â‡∞Ç‡∞°‡∞æ‡∞≤‡∞ø
                             </div>
                             ${isSelected ? `<button onclick="window.setCartQuantity('${p.id}', 0); event.stopPropagation();" class="w-full mt-2 py-2 text-xs font-bold text-gray-400">Remove Item</button>` : ''}
                        </div>
                    </div>
                `;
            }).join('');

            // --- DYNAMIC CTA (Structure > Words) ---
            let ctaMain = "Select Items";
            let ctaSub = "";
            let btnBg = "bg-gray-900";

            if (hasItems) {
                // Boring CTA logic
                ctaMain = "Confirm Order";
                ctaSub = "Payment after delivery";
                btnBg = "bg-black";
            } else {
                ctaMain = "Pick Items to Start";
                btnBg = "bg-gray-300 text-gray-500 cursor-not-allowed";
            }

            return `
                <div class="min-h-screen bg-gray-50 flex flex-col font-sans pb-safe">
                    <div class="bg-white px-6 py-4 sticky top-0 z-20 shadow-sm border-b border-gray-100">
                        <div class="flex justify-between items-center">
                            <div>
                                <div class="text-2xl font-black tracking-tight">JODO</div>
                            </div>
                            <div class="text-right">
                                <div class="text-xs font-bold text-gray-400 uppercase tracking-widest">Ends In</div>
                                <div id="cutoff-timer" class="text-xl font-mono font-black text-gray-900 bg-gray-100 px-2 py-0.5 rounded">${remainingTime}</div>
                            </div>
                        </div>
                    </div>
                    ${getTickerHtml()}
                    <div class="p-4 pb-32">
                        ${productsHtml}
                    </div>

                    <div class="fixed bottom-0 left-0 right-0 bg-white p-4 pb-safe border-t border-gray-100 z-50">
                         <button onclick="window.openModalFlow()" ${!hasItems ? 'disabled' : ''} class="w-full h-[64px] ${btnBg} text-white text-lg font-black rounded-xl shadow-lg active:scale-[0.98] transition-all flex flex-col items-center justify-center leading-tight">
                            <span>${ctaMain}</span>
                            ${ctaSub ? `<span class="text-[10px] opacity-80 font-medium">${ctaSub}</span>` : ''}
                         </button>
                    </div>
                </div>
            `;
        }

        function getStatusScreenHtml(group, members, myMember) {
            const productStats = PRODUCTS.map(p => {
                const stats = getProductStats(members, p.id);
                return { ...p, ...stats };
            });

            const isPostCutoff = !isOrderWindowOpen(); 
            let failingItems = [], runningItems = [], cancelledItems = [];

            if (!isPostCutoff) {
                failingItems = productStats.filter(p => !p.isRunning); 
                runningItems = productStats.filter(p => p.isRunning); 
            } else {
                runningItems = productStats.filter(p => p.total >= p.target); 
                cancelledItems = productStats.filter(p => p.total < p.target); 
            }
            
            // Psychology: Neutral Success/Failure. No "You".
            const headerTitle = isPostCutoff ? "Final Results" : "Live Status";
            
            let contentHtml = `
                <div class="bg-white px-6 py-4 border-b border-gray-100 sticky top-0 z-20 shadow-sm flex justify-between items-center">
                    <div><div class="text-xl font-black text-gray-900">${headerTitle}</div></div>
                </div>
            `;
            
            contentHtml += getTickerHtml();
            contentHtml += `<div class="p-4 space-y-4">`;

            if (isPostCutoff) {
                if (runningItems.length > 0) {
                    contentHtml += `
                        <div class="bg-white rounded-2xl shadow-sm border border-green-100 p-6 text-center">
                            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4 text-green-600"><i data-lucide="check" size="32"></i></div>
                            <h2 class="text-2xl font-black text-gray-900 mb-1">Target Reached</h2>
                            <div class="text-sm text-gray-500 mb-6 font-medium">Delivery tomorrow morning.</div>
                            ${runningItems.map(p => `<div class="flex justify-between items-center py-3 border-t border-gray-50"><span class="font-bold text-gray-900">${p.name}</span><span class="font-mono font-bold text-green-600">‚Çπ${p.priceMin} Locked</span></div>`).join('')}
                        </div>
                    `;
                }
                if (cancelledItems.length > 0) {
                     contentHtml += `
                        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 text-center opacity-70 grayscale">
                            <h2 class="text-lg font-black text-gray-900 mb-1">Missed Targets</h2>
                            ${cancelledItems.map(p => `<div class="flex justify-between items-center py-2 border-b border-gray-50"><span class="font-medium text-gray-900">${p.name}</span><span class="text-xs text-gray-500">${p.total}/${p.target}kg</span></div>`).join('')}
                        </div>
                    `;
                }
            } else {
                // LIVE STATUS
                if (failingItems.length > 0) {
                    const totalRemainingFamilies = failingItems.reduce((acc, i) => acc + Math.ceil(i.remaining), 0);
                    const shareText = `Current Status: Need ${totalRemainingFamilies} more to unlock best price.\nCheck here: ${BASE_URL}?group=${group.id}`;
                    const waLink = `https://wa.me/?text=${encodeURIComponent(shareText)}`;

                    contentHtml += `
                        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                             <div class="bg-gray-50 p-4 border-b border-gray-100 text-center">
                                <div class="text-xl font-black text-gray-900 leading-tight">Live Group Status</div>
                                <div class="text-xs font-bold text-gray-500 mt-1">Final price depends on today‚Äôs total</div>
                             </div>
                             <div class="p-4">
                                ${failingItems.map(p => `
                                    <div class="mb-5 last:mb-0">
                                        <div class="flex justify-between items-end mb-1">
                                            <span class="font-bold text-gray-900 text-lg">${p.name}</span>
                                        </div>
                                        <div class="flex justify-between items-center mb-2">
                                             <div class="text-gray-900 font-bold text-sm">${Math.ceil(p.remaining)} kg short</div>
                                             <div class="text-xs font-bold text-gray-400">${p.total} / ${p.target} kg</div>
                                        </div>
                                        <div class="w-full bg-gray-100 h-1.5 rounded-full overflow-hidden relative">
                                            <div class="h-full bg-gray-600 rounded-full" style="width: ${(p.total/p.target)*100}%"></div>
                                        </div>
                                    </div>
                                `).join('')}
                             </div>
                             
                             <!-- Pinduoduo: Structure for ownership -->
                             <div class="p-4 bg-gray-50 border-t border-gray-100">
                                <a href="${waLink}" target="_blank" class="block text-center text-sm font-bold text-gray-500 hover:text-black transition-colors">
                                    Share status on WhatsApp
                                </a>
                             </div>
                        </div>
                    `;
                } else {
                    // Success State (Live)
                    contentHtml += `
                        <div class="bg-green-50 rounded-2xl p-8 text-center border border-green-100">
                            <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4 text-green-600"><i data-lucide="lock" size="32"></i></div>
                            <h2 class="text-3xl font-black text-green-800 mb-2">Price Locked</h2>
                            <p class="text-green-700 font-medium">Target reached. Lowest price secured for everyone.</p>
                        </div>
                    `;
                }
            }
            contentHtml += `</div>`;
            return `<div class="min-h-screen bg-gray-50 flex flex-col font-sans pb-safe">${contentHtml}</div>`;
        }

        let lastRenderedHTML = '';
        function render() {
            const app = document.getElementById('app');
            const savedScroll = app.scrollTop;
            let content = '';
            if (state.view === 'home') {
                content = getHomeHtml();
            }
            if (content !== lastRenderedHTML) {
                app.innerHTML = content;
                lastRenderedHTML = content;
                if(window.lucide) window.lucide.createIcons();
                // requestAnimationFrame(() => { app.scrollTop = savedScroll; }); // Optional: maintain scroll
            }
        }

        function updateTimerUI() {
            const el = document.getElementById('cutoff-timer');
            if (el) {
                el.innerText = getCutoffRemaining();
            }
        }

        function init() {
            loadUser();
            listenToCycleGroup();
            render();
            // Critical Fix 3: Optimize performance by only updating the timer text, not full re-render
            setInterval(updateTimerUI, 1000);
        }

        if (window.db) init();
        else window.addEventListener('firebase-ready', init);

    </script>
</body>
</html>
