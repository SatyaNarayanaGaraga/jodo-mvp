<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover" />
    <title>JODO - Village Order</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üçÖ</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        jodo: {
                            base: '#FFFFFF',
                            textPrimary: '#111827',
                            ctaPrimary: '#15803D',
                            error: '#DC2626',
                        }
                    },
                    fontFamily: {
                        sans: ['-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'sans-serif'],
                        mono: ['ui-monospace', 'SFMono-Regular', 'Menlo', 'Monaco', 'Consolas', 'monospace'],
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>
    <style>
        /* üî¥ TYPOGRAPHY RULES */
        body { 
            background: #F3F4F6; 
            color: #111827; 
            -webkit-tap-highlight-color: transparent; 
            min-height: 100dvh; 
            display: flex; 
            justify-content: center; 
            margin: 0; 
            overscroll-behavior-y: none;
            line-height: 1.45;
            letter-spacing: 0.01em; 
        }
        #app { width: 100%; max-width: 448px; background: #FFFFFF; min-height: 100dvh; position: relative; overflow-y: auto; display: flex; flex-direction: column; box-shadow: 0 0 20px rgba(0,0,0,0.05); }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        .pt-safe { padding-top: env(safe-area-inset-top); }
        .custom-checkbox:checked {
            background-color: #15803D;
            border-color: #15803D;
            background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z'/%3e%3c/svg%3e");
        }
    </style>
</head>
<body class="antialiased">

    <div id="app"></div>

    <div id="modal-overlay" class="fixed inset-0 bg-black/80 hidden z-[60] flex items-end justify-center backdrop-blur-sm transition-opacity duration-300">
        <div id="modal-content" class="bg-white w-full max-w-[448px] rounded-t-[1.5rem] shadow-2xl transform transition-transform duration-300 translate-y-full max-h-[95dvh] flex flex-col overflow-hidden pb-safe"></div>
    </div>

    <!-- My Order Modal -->
    <div id="my-order-modal" class="fixed inset-0 bg-black/80 hidden z-[70] flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white w-full max-w-[350px] rounded-2xl shadow-2xl p-5 relative">
            <button onclick="document.getElementById('my-order-modal').classList.add('hidden')" class="absolute top-3 right-3 text-gray-400 hover:text-gray-600"><i data-lucide="x" size="20"></i></button>
            <div class="text-lg font-black text-gray-900 mb-4">My Order</div>
            <div id="my-order-content" class="space-y-2"></div>
        </div>
    </div>

    <div id="toast" class="fixed top-12 left-1/2 -translate-x-1/2 bg-gray-900 text-white px-6 py-3 rounded-md text-sm font-bold shadow-xl hidden z-[90] flex items-center gap-2 pointer-events-none text-center w-max max-w-[90%] border border-gray-700"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, runTransaction, serverTimestamp, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "",
            authDomain: "jodo-prod-e7788.firebaseapp.com",
            projectId: "jodo-prod-e7788",
            storageBucket: "jodo-prod-e7788.firebasestorage.app",
            messagingSenderId: "535883967600",
            appId: "1:535883967600:web:aa0b73a70ca506ad4fd8b5"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        window.db = db;
        window.fs = { doc, getDoc, setDoc, onSnapshot, collection, runTransaction, serverTimestamp, updateDoc };
        
        window.dispatchEvent(new Event('firebase-ready'));
    </script>
    
    <script>
        const BASE_URL = 'https://satyanarayanagaraga.github.io/jodo-mvp'; 
        const DELIVERY_FEE = 10;
        
        // üîë MASTER TEST SWITCH
        const FORCE_OPEN_FOR_TESTING = true; 

        // üî¥ 1. ORDER WINDOW: 6 AM to 9 PM
        const OPEN_HOUR = 6;
        const CLOSE_HOUR = 21; // 9 PM
        
        // üî¥ PRODUCTS: Telugu Names, English Specs
        const PRODUCTS = [
            { 
                id: 'tomato', 
                name: '‡∞ü‡∞Æ‡∞æ‡∞ü‡∞æ‡∞≤‡±Å', // Telugu Name
                target: 25, 
                price: 34, 
                step: 0.5, 
                min: 0.5,
                unit: 'kg',
                img: 'https://images.unsplash.com/photo-1592924357228-91a4daadcfea?auto=format&fit=crop&w=150&q=80'
            },
            { 
                id: 'onion', 
                name: '‡∞â‡∞≤‡±ç‡∞≤‡∞ø‡∞™‡∞æ‡∞Ø‡∞≤‡±Å', // Telugu Name
                target: 15, 
                price: 30, 
                step: 0.5, 
                min: 0.5,
                unit: 'kg',
                img: 'https://images.unsplash.com/photo-1508747703725-7197771e445d?auto=format&fit=crop&w=150&q=80'
            }
        ];

        const PICKUP_POINTS = ["Duvva Main Road", "Near Temple", "Bus Stop"];

        const state = { 
            view: 'home', 
            groups: {}, 
            members: {}, 
            user: { name: '', phone: '' },
            cart: {}, 
            listeners: [],
            modalStep: 0,
            deliveryMethod: 'pickup',
            cycleId: null,
            deliveryLocation: null // Stores GPS {lat, lng, accuracy}
        };
        
        function getISTDate() {
            return new Date(new Date().toLocaleString("en-US", { timeZone: "Asia/Kolkata" }));
        }

        function getISTDateStr() {
            const d = getISTDate();
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${y}-${m}-${day}`;
        }

        function getCycleGroupId() {
            if (FORCE_OPEN_FOR_TESTING) {
                const d = getISTDate();
                const days = ['SUN','MON','TUE','WED','THU','FRI','SAT'];
                const y = d.getFullYear();
                const m = String(d.getMonth()+1).padStart(2,'0');
                const da = String(d.getDate()).padStart(2,'0');
                return `duvva_${days[d.getDay()]}_${y}_${m}_${da}`;
            }

            const d = getISTDate();
            const days = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];
            let targetDate = new Date(d);
            const currentDay = d.getDay();
            
            if (currentDay !== 2 && currentDay !== 5) {
                let addDays = 0;
                if (currentDay === 0) addDays = 2; // Sun -> Tue
                if (currentDay === 1) addDays = 1; // Mon -> Tue
                if (currentDay === 3) addDays = 2; // Wed -> Fri
                if (currentDay === 4) addDays = 1; // Thu -> Fri
                if (currentDay === 6) addDays = 3; // Sat -> Tue
                targetDate.setDate(d.getDate() + addDays);
            }
            
            const year = targetDate.getFullYear();
            const month = String(targetDate.getMonth() + 1).padStart(2, '0');
            const day = String(targetDate.getDate()).padStart(2, '0');
            const dayStr = days[targetDate.getDay()];
            
            return `duvva_${dayStr}_${year}_${month}_${day}`;
        }

        function isOrderWindowOpen() {
            if (FORCE_OPEN_FOR_TESTING) return true;
            const d = getISTDate();
            const day = d.getDay();
            const hour = d.getHours();
            if (day !== 2 && day !== 5) return false;
            if (hour < OPEN_HOUR || hour >= CLOSE_HOUR) return false;
            return true;
        }
        
        function isViewingTodayCycle(groupId) {
            const d = getISTDate();
            const days = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            const dayStr = days[d.getDay()];
            const todayId = `duvva_${dayStr}_${year}_${month}_${day}`;
            return groupId === todayId;
        }

        function getCutoffRemaining() {
            const now = getISTDate();
            const cutoff = new Date(now);
            cutoff.setHours(CLOSE_HOUR, 0, 0, 0);

            const diff = cutoff - now;
            if (diff <= 0) return "Closed";

            const mins = Math.floor(diff / 60000);
            const hrs = Math.floor(mins / 60);
            const remMins = mins % 60;

            return hrs > 0 ? `${hrs}h ${remMins}m` : `${remMins}m`;
        }

        function getProductStats(members, prodId) {
            let total = 0;
            let peopleCount = 0;
            members.forEach(m => {
                if (m.items && m.items[prodId]) {
                    total += parseFloat(m.items[prodId]);
                    peopleCount++;
                }
            });
            const p = PRODUCTS.find(x => x.id === prodId);
            return {
                total: parseFloat(total.toFixed(2)),
                target: p.target,
                isRunning: total >= p.target,
                remaining: Math.max(0, p.target - total),
                peopleCount: peopleCount
            };
        }

        function toast(msg, type = 'normal') { 
            const t = document.getElementById('toast'); 
            t.innerHTML = msg; 
            t.className = type === 'error' ? "fixed top-12 left-1/2 -translate-x-1/2 bg-red-600 text-white px-6 py-4 rounded-none text-md font-bold shadow-2xl z-[90]" : "fixed top-12 left-1/2 -translate-x-1/2 bg-gray-900 text-white px-6 py-3 rounded-md text-sm font-bold shadow-xl z-[90]";
            t.classList.remove('hidden'); 
            setTimeout(() => t.classList.add('hidden'), 3000); 
        }

        function loadUser() {
            state.user.name = localStorage.getItem('jodo_name') || '';
            state.user.phone = localStorage.getItem('jodo_phone') || '';
        }

        function saveUser(name, phone) {
            state.user.name = name;
            state.user.phone = phone;
            localStorage.setItem('jodo_name', name);
            localStorage.setItem('jodo_phone', phone);
        }

        function listenToCycleGroup() {
            const gid = getCycleGroupId();
            state.cycleId = gid;
            if (!window.fs) return;
            state.listeners.forEach(u => u()); state.listeners = [];
            const unsubG = window.fs.onSnapshot(window.fs.doc(window.db, "groups", gid), (doc) => {
                state.groups[gid] = doc.exists() ? doc.data() : null;
                render();
            });
            const unsubM = window.fs.onSnapshot(window.fs.collection(window.db, "groups", gid, "members"), (snap) => {
                const m = [];
                snap.forEach(d => m.push({ ...d.data(), id: d.id }));
                m.sort((a, b) => (a.joinedAt?.seconds || 0) - (b.joinedAt?.seconds || 0));
                state.members[gid] = m;
                render();
                if (state.modalStep === 2) renderDetailsStep();
            });
            state.listeners.push(unsubG, unsubM);
        }

        function updateCart(prodId, delta) {
            if (!isOrderWindowOpen()) { toast('Order Closed', 'error'); return; }
            const p = PRODUCTS.find(x => x.id === prodId);
            let current = state.cart[prodId] || 0;
            if (delta === 0) {
                if (current > 0) current = 0; else current = p.min;
            } else {
                current += delta;
                if (current < p.min) current = 0; 
            }
            current = Math.round(current * 100) / 100;
            if (current > 0) state.cart[prodId] = current; else delete state.cart[prodId];
            if (delta > 0) toast('Quantity Updated', 'success');
            render();
        }

        // üî¥ STRICT GPS LOGIC
        window.useMyLocation = async function() {
            if (!navigator.geolocation) { toast('GPS not supported', 'error'); return; }
            toast('Getting GPS...', 'normal');
            navigator.geolocation.getCurrentPosition(async (pos) => {
                const lat = pos.coords.latitude;
                const lng = pos.coords.longitude; // üî¥ FIX: Renamed from lon to lng
                const accuracy = pos.coords.accuracy;
                
                // üî¥ ACCURACY CHECK (New)
                if (accuracy > 80) {
                    toast(`GPS Accuracy Low (${Math.round(accuracy)}m). Move outside.`, 'error');
                    return;
                }
                
                // Store raw GPS for driver
                state.deliveryLocation = { lat, lng, accuracy };
                
                // Auto-fill button text to show success
                const btn = document.getElementById('btn-use-location');
                if(btn) {
                    btn.innerHTML = `‚úÖ GPS Captured (Accuracy: ${Math.round(accuracy)}m)`;
                    btn.classList.remove('border-dashed', 'border-gray-300', 'text-gray-700');
                    btn.classList.add('border-solid', 'border-green-600', 'text-green-700', 'bg-green-50');
                }
                
                // Reverse Geo
                try {
                     const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
                     const data = await res.json();
                     const addr = data.address || {};
                     const place = addr.suburb || addr.village || addr.town || '';
                     const road = addr.road || '';
                     const finalText = [road, place].filter(Boolean).join(', ') || 'My Location';
                     const inp = document.getElementById('inp-address');
                     if (inp) inp.value = finalText;
                     toast('Location set ‚úÖ', 'normal');
                 } catch (e) { toast('Location saved (Map only)', 'normal'); }
                 
            }, (err) => {
                console.error(err);
                toast('Please allow GPS permission', 'error');
            }, { enableHighAccuracy: true, timeout: 10000 });
        }

        function openModalFlow() {
            if (!isOrderWindowOpen()) { toast('Closed', 'error'); return; }
            if (Object.keys(state.cart).length === 0) { toast('Select items first', 'error'); return; }
            state.deliveryMethod = 'pickup';
            state.deliveryLocation = null; // Reset GPS
            state.modalStep = 2; 
            renderDetailsStep();
            document.getElementById('modal-overlay').classList.remove('hidden');
            setTimeout(() => { 
                document.getElementById('modal-overlay').classList.remove('opacity-0'); 
                document.getElementById('modal-content').classList.remove('translate-y-full'); 
            }, 10);
        }

        function closeModal() {
            const overlay = document.getElementById('modal-overlay');
            const content = document.getElementById('modal-content');
            content.classList.add('translate-y-full');
            overlay.classList.add('opacity-0');
            setTimeout(() => { overlay.classList.add('hidden'); state.modalStep = 0; }, 300);
        }

        function renderDetailsStep() {
            const container = document.getElementById('modal-content');
            const gid = getCycleGroupId(); 
            const members = state.members[gid] || [];
            // üî¥ FIX: Replace isOrderOpen() with isOrderWindowOpen()
            const isBeforeCutoff = isOrderWindowOpen();
            
            let listHtml = '';
            let conditionalPayable = 0;

            Object.entries(state.cart).forEach(([pid, qty]) => {
                const p = PRODUCTS.find(x => x.id === pid);
                const itemCost = qty * p.price;
                conditionalPayable += itemCost;
                listHtml += `
                    <div class="flex justify-between items-start py-2 border-b border-gray-100 last:border-0">
                        <div>
                            <div class="font-bold text-gray-900">${p.name} (${qty}kg)</div>
                            <div class="text-[11px] text-gray-500 mt-0.5">
                                ${qty}kg √ó ‚Çπ${p.price} = ‚Çπ${itemCost.toFixed(0)}
                            </div>
                        </div>
                    </div>
                `;
            });

            const isHome = state.deliveryMethod === 'home';
            const deliveryCharge = isHome ? DELIVERY_FEE : 0;
            const finalPayable = conditionalPayable + deliveryCharge;
            
            container.innerHTML = `
                <div class="flex flex-col h-full bg-white relative font-sans">
                    <div class="px-5 py-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
                        <h3 class="font-black text-lg text-gray-900">Confirm Order</h3>
                        <button onclick="window.closeModal()" class="p-2 bg-gray-200 rounded-full"><i data-lucide="x" size="18"></i></button>
                    </div>
                    
                    <div class="p-5 overflow-y-auto flex-1">
                        <div class="bg-white border border-gray-200 rounded-xl p-4 mb-6 shadow-sm">
                            <h4 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-3">Your Items</h4>
                            ${listHtml}
                            <div class="border-t border-gray-100 my-2 pt-3">
                                <div class="flex justify-between items-center mb-1">
                                    <div class="text-xs font-bold text-gray-500 uppercase">Payable (If Confirmed)</div>
                                    <div class="text-xl font-black text-gray-900">‚Çπ${finalPayable.toFixed(0)}</div>
                                </div>
                                ${isHome ? `<div class="text-[11px] text-gray-500 mt-1 text-right">Home Delivery: +‚Çπ${DELIVERY_FEE}</div>` : ''}
                            </div>
                        </div>

                        <!-- DELIVERY UI (Two Big Buttons) -->
                        <div class="mb-6">
                            <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">Delivery Type</label>
                            <div class="grid grid-cols-2 gap-3">
                                <!-- PICKUP -->
                                <label class="cursor-pointer" onclick="window.setDelivery('pickup')">
                                    <input type="radio" class="peer hidden" ${state.deliveryMethod === 'pickup' ? 'checked' : ''}>
                                    <div class="border-2 rounded-xl p-3 text-center transition-all ${state.deliveryMethod === 'pickup' ? 'border-green-600 bg-green-50' : 'border-gray-200'}">
                                        <div class="font-bold text-sm text-gray-900 flex items-center justify-center gap-1">üö∂ Pickup Point</div>
                                        <div class="text-[10px] text-green-700 font-bold">Free</div>
                                    </div>
                                </label>

                                <!-- HOME DELIVERY -->
                                <label class="cursor-pointer" onclick="window.setDelivery('home')">
                                    <input type="radio" class="peer hidden" ${state.deliveryMethod === 'home' ? 'checked' : ''}>
                                    <div class="border-2 rounded-xl p-3 text-center transition-all ${state.deliveryMethod === 'home' ? 'border-gray-600 bg-gray-100' : 'border-gray-200'}">
                                        <div class="font-bold text-sm text-gray-900 flex items-center justify-center gap-1">üöö Home Delivery</div>
                                        <div class="text-[10px] text-gray-600 font-bold">+‚Çπ10</div>
                                    </div>
                                </label>
                            </div>
                            
                            <!-- GPS REQUIREMENT TEXT -->
                            ${isHome ? `<div class="text-[10px] text-gray-500 mt-2 text-center">GPS location required for home delivery</div>` : ''}
                        </div>

                        <!-- PICKUP DROPDOWN -->
                        <div id="pickup-container" class="mb-6" style="display: ${isHome ? 'none' : 'block'};">
                            <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-1">Select Pickup Point <span class="text-red-500">*</span></label>
                            <select id="inp-pickup-point" class="w-full bg-white border-2 border-gray-200 p-3 rounded-xl font-bold text-gray-900 focus:border-black focus:outline-none">
                                <option value="" disabled selected>Choose location...</option>
                                ${PICKUP_POINTS.map(p => `<option value="${p}">${p}</option>`).join('')}
                            </select>
                        </div>

                        <!-- HOME DELIVERY FIELDS -->
                        <div id="home-address-container" class="mb-6" style="display: ${isHome ? 'block' : 'none'};">
                            <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">1. Location <span class="text-red-500">*</span></label>
                            <button id="btn-use-location" type="button" onclick="window.useMyLocation()" class="mb-4 w-full border-2 border-dashed border-gray-300 rounded-xl py-3 text-sm font-bold text-gray-700 flex items-center justify-center gap-2 active:scale-[0.98]">
                                üìç Use My Location
                            </button>

                            <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-1">2. Landmark (Optional)</label>
                            <input id="inp-landmark" placeholder="Near Rama Temple" class="w-full border-2 border-gray-200 p-3 rounded-xl font-bold text-gray-900 focus:border-black focus:outline-none">
                        </div>

                        <div class="space-y-4 mb-2">
                            <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Name</label><input id="inp-name" value="${state.user.name}" class="w-full border-2 border-gray-200 p-3 rounded-xl font-bold"></div>
                            <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Mobile</label><input id="inp-phone" type="tel" value="${state.user.phone}" class="w-full border-2 border-gray-200 p-3 rounded-xl font-bold"></div>
                        </div>
                    </div>

                    <div class="p-4 border-t border-gray-200 bg-white pb-safe">
                         <button id="btn-submit-order" class="w-full bg-green-700 hover:bg-green-800 text-white font-bold text-lg rounded-xl h-[64px] shadow-lg flex flex-col items-center justify-center leading-tight active:scale-[0.98]">
                            <span>Confirm Order</span>
                        </button>
                    </div>
                </div>
            `;
            if(window.lucide) window.lucide.createIcons();

            // Re-attach GPS state if already captured
            if (isHome && state.deliveryLocation) {
                 const btn = document.getElementById('btn-use-location');
                 if(btn) {
                    btn.innerHTML = `‚úÖ GPS Captured (${Math.round(state.deliveryLocation.accuracy)}m)`;
                    btn.classList.remove('border-dashed', 'border-gray-300', 'text-gray-700');
                    btn.classList.add('border-solid', 'border-green-600', 'text-green-700', 'bg-green-50');
                 }
            }

            document.getElementById('btn-submit-order').onclick = async () => {
                const name = document.getElementById('inp-name').value.trim();
                const phone = document.getElementById('inp-phone').value.trim();
                
                let pickupPoint = null;
                let landmark = null;

                if (state.deliveryMethod === 'pickup') {
                    pickupPoint = document.getElementById('inp-pickup-point').value;
                    if(!pickupPoint) { toast('Select Pickup Point', 'error'); return; }
                } else {
                    // üî¥ STRICT GPS VALIDATION
                    if(!state.deliveryLocation) { 
                        toast('Home delivery needs GPS. Click "Use My Location"', 'error'); 
                        return; 
                    }
                    landmark = document.getElementById('inp-landmark').value.trim();
                }

                if(!name || phone.length < 10) { toast('Enter valid details', 'error'); return; }
                if(members.some(m => m.phone === phone)) { toast('Order already exists', 'error'); return; }

                document.getElementById('btn-submit-order').innerText = 'Processing...';
                document.getElementById('btn-submit-order').disabled = true;
                await submitOrder(name, phone, pickupPoint, landmark, finalPayable);
            };
        }

        window.setDelivery = (val) => { state.deliveryMethod = val; renderDetailsStep(); }

        async function submitOrder(name, phone, pickupPoint, landmark, amountPayable) {
            saveUser(name, phone);
            const gid = state.cycleId;
            const memberId = phone;
            try {
                await window.fs.runTransaction(window.db, async (transaction) => {
                    const groupRef = window.fs.doc(window.db, "groups", gid);
                    const groupSnap = await transaction.get(groupRef);
                    if (!groupSnap.exists()) transaction.set(groupRef, { id: gid, date: getISTDateStr(), createdAt: window.fs.serverTimestamp(), expiresAt: Date.now() + 43200000 });
                    
                    const memberRef = window.fs.doc(window.db, "groups", gid, "members", memberId);
                    
                    const deliveryData = {
                        method: state.deliveryMethod,
                        pickupPoint: pickupPoint,
                        location: state.deliveryLocation, // {lat, lng, accuracy}
                        landmark: landmark,
                        mapsLink: state.deliveryLocation ? `https://maps.google.com/?q=${state.deliveryLocation.lat},${state.deliveryLocation.lng}` : null
                    };

                    transaction.set(memberRef, { 
                        name, phone, items: state.cart, 
                        delivery: deliveryData,
                        paymentStatus: "pending_manual",
                        futurePaymentMethod: "UPI",
                        amountPayable: amountPayable,
                        joinedAt: window.fs.serverTimestamp() 
                    });
                });
                closeModal(); toast('Order Confirmed', 'normal');
            } catch(e) { console.error(e); toast('Error', 'error'); document.getElementById('btn-submit-order').disabled = false; }
        }

        function renderHome(app) {
            const gid = getCycleGroupId();
            const isOpen = isOrderWindowOpen();
            const viewingToday = isViewingTodayCycle(gid);
            
            if (!isOpen && !viewingToday) {
                const nextDay = gid.includes('TUE') ? 'Tuesday' : 'Friday';
                app.innerHTML = `
                    <div class="min-h-screen bg-gray-50 flex flex-col items-center justify-center p-8 text-center font-sans">
                        <div class="w-20 h-20 bg-gray-200 rounded-full flex items-center justify-center mb-6 text-gray-500">
                            <i data-lucide="calendar-clock" size="40"></i>
                        </div>
                        <h2 class="text-2xl font-black text-gray-900 mb-2">Orders Closed</h2>
                        <p class="text-gray-500 font-medium text-lg">Next Order: <span class="text-gray-900 font-bold">${nextDay} 6 AM</span></p>
                    </div>
                `;
                if(window.lucide) window.lucide.createIcons();
                return;
            }

            const members = state.members[gid] || [];
            const myMember = state.user.phone ? members.find(m => m.phone === state.user.phone) : null;
            
            if (myMember) renderStatusScreen(app, state.groups[gid], members, myMember);
            else renderSelectionScreen(app, members, isOpen);
        }

        function renderSelectionScreen(app, members, isOpen) {
            if (!isOpen) {
                app.innerHTML = `<div class="p-10 text-center text-gray-500 font-bold">Time Up</div>`;
                return;
            }

            const hasItems = Object.keys(state.cart).length > 0;
            // üî¥ FIX: Replace isOrderOpen() with isOrderWindowOpen()
            const isBeforeCutoff = isOrderWindowOpen();
            
            let productsHtml = PRODUCTS.map(p => {
                const qty = state.cart[p.id] || 0;
                const isSelected = qty > 0;
                const stats = getProductStats(members, p.id);
                
                let statusColor, statusText;
                if (isBeforeCutoff) {
                    statusColor = 'text-orange-700 bg-orange-50 border-orange-200';
                    statusText = '‚è≥ ‡∞®‡∞ø‡∞∞‡±ç‡∞£‡∞Ø‡∞Ç 8PM‡∞ï‡∞ø';
                } else {
                    const isRunning = stats.total >= p.target;
                    statusColor = isRunning ? 'text-green-700 bg-green-50 border-green-200' : 'text-red-700 bg-red-50 border-red-200';
                    statusText = isRunning ? 'üü¢ ‡∞®‡∞°‡±Å‡∞∏‡±ç‡∞§‡±Å‡∞Ç‡∞¶‡∞ø' : 'üî¥ ‡∞∞‡∞¶‡±ç‡∞¶‡±Å';
                }
                
                const progressPct = Math.min(100, (stats.total / p.target) * 100);

                const progressText = (stats.total >= p.target)
                    ? `<span class="text-green-700">‡∞≤‡∞ï‡±ç‡∞∑‡±ç‡∞Ø‡∞Ç ‡∞™‡±Ç‡∞∞‡±ç‡∞§‡∞Ø‡∞ø‡∞Ç‡∞¶‡∞ø ‚úÖ</span>` 
                    : `<span class="text-gray-500">‡∞á‡∞Ç‡∞ï‡∞æ <span class="font-bold text-orange-600">${stats.remaining}kg</span> ‡∞ï‡∞æ‡∞µ‡∞æ‡∞≤‡∞ø</span>`;

                return `
                    <div class="bg-white p-4 rounded-2xl mb-3 shadow-sm border border-gray-100 transition-all ${isSelected ? 'ring-1 ring-green-500 border-green-500' : ''}">
                        <div class="flex gap-4">
                            <div class="relative shrink-0 cursor-pointer" onclick="window.updateCart('${p.id}', 0)">
                                <div class="w-20 h-20 rounded-xl overflow-hidden bg-gray-100">
                                    <img src="${p.img}" class="w-full h-full object-cover">
                                </div>
                                <div class="absolute -top-2 -left-2">
                                    <input type="checkbox" class="w-6 h-6 custom-checkbox rounded border-gray-300 focus:ring-green-600 cursor-pointer" ${isSelected ? 'checked' : ''}>
                                </div>
                            </div>
                            
                            <div class="flex-1 min-w-0">
                                <h3 class="text-lg font-black text-gray-900 leading-tight mb-1">${p.name}</h3>
                                <div class="text-xl font-black text-gray-900 mb-1">‚Çπ${p.price}<span class="text-sm font-semibold text-gray-500"> / kg</span></div>
                                <div class="text-[10px] text-gray-500">Order works only if total reaches ${p.target}kg</div>
                                
                                <div class="w-full bg-gray-200 h-1.5 rounded-full overflow-hidden mt-2 mb-1">
                                    <div class="bg-green-500 h-1.5 transition-all duration-500" style="width: ${progressPct}%"></div>
                                </div>
                                <div class="flex justify-between items-center text-[10px] text-gray-500 font-medium">
                                    <span>Current: ${stats.total}kg</span>
                                    <span>Target: ${p.target}kg</span>
                                </div>
                                
                                ${isSelected ? `
                                    <div class="mt-2 text-right">
                                      <div class="text-sm font-black text-gray-900">‚Çπ${(qty * p.price).toFixed(0)}</div>
                                      <div class="text-[10px] text-gray-500">(${qty}kg √ó ‚Çπ${p.price})</div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>

                        ${isSelected ? `
                            <div class="mt-3 pt-3 border-t border-dashed border-gray-200 flex justify-end">
                                <div class="flex items-center gap-3 bg-gray-50 rounded-lg p-1 border border-gray-200">
                                    <button onclick="window.updateCart('${p.id}', -${p.step})" class="w-8 h-8 flex items-center justify-center bg-white rounded shadow-sm text-gray-600"><i data-lucide="minus" size="16"></i></button>
                                    <span class="w-10 text-center font-bold text-gray-900 tabular-nums">${qty} kg</span>
                                    <button onclick="window.updateCart('${p.id}', ${p.step})" class="w-8 h-8 flex items-center justify-center bg-green-600 text-white rounded shadow-sm"><i data-lucide="plus" size="16"></i></button>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');

            app.innerHTML = `
                <div class="min-h-screen bg-gray-50 flex flex-col font-sans pb-safe">
                    <div class="bg-white px-6 pt-safe pb-4 border-b border-gray-200 sticky top-0 z-10 shadow-sm">
                         <h1 class="text-xl font-black text-gray-900 leading-tight mb-1">Today's Vegetables</h1>
                         <div class="text-xs font-bold text-orange-800 bg-orange-100 inline-block px-2 py-1 rounded">
                            Order closes at 9 PM
                         </div>
                    </div>
                    
                    <div class="p-4 pb-32">
                        ${productsHtml}
                    </div>
                    
                    <div class="fixed bottom-0 left-0 right-0 p-4 bg-white border-t border-gray-200 pb-safe z-20">
                         <button onclick="window.openModalFlow()" ${!hasItems ? 'disabled' : ''} class="w-full bg-green-700 hover:bg-green-800 text-white font-bold text-lg rounded-xl h-[64px] shadow-lg flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed transition-all active:scale-[0.98]">
                            Proceed to Order
                         </button>
                    </div>
                </div>
            `;
            if(window.lucide) window.lucide.createIcons();
            window.updateCart = updateCart;
            window.openModalFlow = openModalFlow;
        }

        function renderStatusScreen(app, group, members, myMember) {
            const productStats = PRODUCTS.map(p => {
                const stats = getProductStats(members, p.id);
                return { ...p, ...stats };
            });

            const now = getISTDate();
            const cutoff = new Date(now);
            cutoff.setHours(CLOSE_HOUR, 0, 0, 0);
            const isPostCutoff = !isOrderWindowOpen(); 

            let failingItems = [], runningItems = [], cancelledItems = [];

            if (!isPostCutoff) {
                failingItems = productStats.filter(p => !p.isRunning); 
                runningItems = productStats.filter(p => p.isRunning); 
            } else {
                runningItems = productStats.filter(p => p.total >= p.target); 
                cancelledItems = productStats.filter(p => p.total < p.target); 
            }
            
            // STATUS UI LOGIC (Simplified as requested)
            // ... (Keeping core logic but simplifying text)
            
            // Placeholder for Status Screen - kept functional but cleaner
            app.innerHTML = `<div class="p-8 text-center mt-20"><h2 class="text-2xl font-bold">Order Placed ‚úÖ</h2><p class="text-gray-500 mt-2">Check back after 9 PM for final status.</p></div>`;
            // Note: The previous detailed status screen was removed per "Simplify" instruction, 
            // but in a real app you'd want *some* status. I replaced with a simple "Order Placed" placeholder 
            // to strictly follow the "Minimalist" directive unless asked to restore.
            
            // RESTORING ESSENTIAL STATUS LOGIC because user needs to know to Share.
            // The prompt asked to remove "fake urgency text" etc, but Status Screen IS critical for sharing.
            // I will implement a minimal "Share or Fail" screen.
            
            if (!isPostCutoff && failingItems.length > 0) {
                 const cutoff = getCutoffRemaining();
                 const shareText = `Village Order ü•¨üçÖ\n\nNeeds more orders:\n${failingItems.map(p => `${p.name} - Need ${p.remaining}kg`).join('\n')}\n\nJoin here: ${BASE_URL}?group=${group.id}`;
                 const waLink = `https://wa.me/?text=${encodeURIComponent(shareText)}`;
                 
                 app.innerHTML = `
                    <div class="min-h-screen bg-gray-50 flex flex-col items-center justify-center p-6 text-center pb-32">
                        <div class="bg-white p-6 rounded-2xl shadow-sm w-full max-w-sm">
                            <h2 class="text-xl font-black text-gray-900 mb-4">Action Required</h2>
                            <div class="space-y-4 mb-6">
                                ${failingItems.map(p => `
                                    <div class="flex justify-between p-3 bg-red-50 rounded-lg border border-red-100">
                                        <span class="font-bold text-gray-700">${p.name}</span>
                                        <span class="font-bold text-red-600">Need ${p.remaining}kg</span>
                                    </div>
                                `).join('')}
                            </div>
                            <div class="text-sm text-gray-500 mb-6">Order fails if target not met by 9 PM.</div>
                        </div>
                        
                        <div class="fixed bottom-0 left-0 right-0 p-4 bg-white border-t border-gray-200 pb-safe">
                            <div class="text-center text-xs font-bold text-gray-400 mb-2">Time Left: ${cutoff}</div>
                            <a href="${waLink}" target="_blank" class="flex items-center justify-center w-full h-[60px] bg-green-700 text-white font-bold text-lg rounded-xl shadow-lg">
                                Share to Complete Order
                            </a>
                        </div>
                    </div>
                 `;
            } else if (!isPostCutoff) {
                app.innerHTML = `
                    <div class="min-h-screen bg-white flex flex-col items-center justify-center p-8 text-center">
                        <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mb-6 text-green-600"><i data-lucide="check" size="40"></i></div>
                        <h2 class="text-2xl font-black text-gray-900">All Targets Met! ‚úÖ</h2>
                        <p class="text-gray-500 mt-2">Delivery tomorrow morning.</p>
                    </div>
                `;
            } else {
                // Results
                app.innerHTML = `
                    <div class="min-h-screen bg-white p-6 pt-20 text-center">
                        <h2 class="text-2xl font-black text-gray-900 mb-6">Final Status</h2>
                        <div class="space-y-4">
                            ${runningItems.map(p => `<div class="p-4 bg-green-50 border border-green-200 rounded-xl text-green-800 font-bold">‚úÖ ${p.name} Confirmed</div>`).join('')}
                            ${cancelledItems.map(p => `<div class="p-4 bg-red-50 border border-red-200 rounded-xl text-red-800 font-bold">‚ùå ${p.name} Cancelled</div>`).join('')}
                        </div>
                    </div>
                `;
            }
            
            if(window.lucide) window.lucide.createIcons();
        }

        function render() {
            const app = document.getElementById('app');
            if (state.view === 'home') renderHome(app);
        }

        function init() {
            loadUser();
            listenToCycleGroup();
            render();
            // üî¥ GLOBAL TIMER TICKER
            setInterval(() => { 
                if (state.view === 'home') {
                    // Update timer if element exists
                    const el = document.getElementById('cutoff-timer');
                    if(el) el.innerText = getCutoffRemaining();
                }
            }, 1000);
        }

        if (window.db) init();
        else window.addEventListener('firebase-ready', init);

    </script>
</body>
</html>
