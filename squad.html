<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>JODO â€” Squad</title>
  <meta name="theme-color" content="#059669" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>body{font-family:'Poppins',sans-serif} .pill{border-radius:999px}</style>
</head>
<body class="bg-slate-50 min-h-screen">

<header class="bg-white sticky top-0 z-30 border-b">
  <div class="max-w-md mx-auto px-4 py-3 flex items-center justify-between">
    <div class="font-black text-lg">JODO Squad</div>
    <a href="index.html" class="text-sm text-slate-500">Products</a>
  </div>
</header>

<main class="max-w-md mx-auto p-4 pb-36">

  <div id="squadWrap" class="bg-white rounded-2xl p-4 shadow-sm">
    <div id="prodTitle" class="font-bold text-xl"></div>
    <div id="subInfo" class="text-sm text-slate-500 mt-1"></div>

    <div class="mt-4">
      <div class="w-full bg-slate-100 h-3 rounded-full overflow-hidden">
        <div id="progressBar" class="h-3 bg-green-500 w-0 transition-all"></div>
      </div>
      <div class="mt-2 flex items-center justify-between text-sm">
        <div id="membersText" class="font-bold">0 / 5 joined</div>
        <div id="priceText" class="font-bold text-green-700">â‚¹0</div>
      </div>
    </div>

    <div id="membersList" class="mt-4 space-y-2"></div>

    <div class="mt-4 flex gap-2">
      <input id="joinName" class="flex-1 p-3 border rounded-lg" placeholder="Your name"/>
      <button id="joinBtn" class="px-4 py-3 bg-green-600 text-white rounded-lg font-bold">JOIN</button>
    </div>

    <div class="mt-3 flex gap-2">
      <button id="shareBtn" class="flex-1 py-3 border rounded-lg font-semibold">Share Latest Link</button>
      <button id="confirmBtn" class="flex-1 py-3 bg-slate-900 text-white rounded-lg font-bold">Confirm Order</button>
    </div>

    <div class="mt-3 text-xs text-slate-500">Final price is determined when the timer ends.</div>

    <div class="mt-4 text-sm text-slate-600">Time left: <span id="timeLeft">--:--:--</span></div>
  </div>

</main>

<script>
/* ---------- CONFIG ---------- */
const SQUAD_DURATION_MS = 2 * 60 * 60 * 1000; // 2 hours consistent with index
const STORAGE_KEY = 'jodo_squads_v1';
const PRODUCTS = {
  tomato: { name:'Tomato', p1:43, p2:39, p5:33 },
  onion:  { name:'Onion',  p1:30, p2:26, p5:22 },
  potato: { name:'Potato', p1:36, p2:32, p5:28 }
};

/* ---------- utils ---------- */
function getParam(name){
  const u = new URL(location.href);
  return u.searchParams.get(name);
}
function enc(obj){ return btoa(encodeURIComponent(JSON.stringify(obj))); }
function dec(s){ try{ return JSON.parse(decodeURIComponent(atob(s))); }catch(e){ return null; } }
function saveSquadToStorage(id, squad){
  const all = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
  all[id] = squad;
  localStorage.setItem(STORAGE_KEY, JSON.stringify(all));
}
function loadSquadFromStorage(id){ const all = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}'); return all[id] || null; }
function mkLink(id, squad){ const payload = enc(squad); return `${location.origin}${location.pathname.replace(/squad\\.html$/,'')}squad.html?g=${id}&d=${payload}`; }
function uid(prefix='G'){ return prefix + '-' + Math.random().toString(36).slice(2,9).toUpperCase(); }

/* ---------- read URL ---------- */
const g = getParam('g');
const d = getParam('d'); // encoded payload
let squad = null;

if(d){
  squad = dec(d);
  if(squad && squad.id !== g){
    // if mismatch, ensure id aligns
    squad.id = g || squad.id || uid('JODO');
  }
  saveSquadToStorage(squad.id, squad);
} else if(g){
  squad = loadSquadFromStorage(g);
}

// if still no squad -> show error
if(!squad){
  document.getElementById('squadWrap').innerHTML = '<div class="text-red-600 font-bold p-6 text-center">Invalid or expired squad link. Please ask the squad starter to share the latest link.</div>';
  throw new Error('No squad');
}

/* ---------- UI refs ---------- */
const prodTitle = document.getElementById('prodTitle');
const subInfo = document.getElementById('subInfo');
const progressBar = document.getElementById('progressBar');
const membersText = document.getElementById('membersText');
const membersList = document.getElementById('membersList');
const priceText = document.getElementById('priceText');
const timeLeftEl = document.getElementById('timeLeft');

const joinName = document.getElementById('joinName');
const joinBtn = document.getElementById('joinBtn');
const shareBtn = document.getElementById('shareBtn');
const confirmBtn = document.getElementById('confirmBtn');

/* ---------- Logic ---------- */
function priceForCount(count){
  const p = PRODUCTS[squad.productId];
  if(count >= 5) return p.p5;
  if(count >= 2) return p.p2;
  return p.p1;
}

function render(){
  const product = PRODUCTS[squad.productId];
  prodTitle.textContent = product.name;
  subInfo.textContent = `Started: ${new Date(squad.createdAt).toLocaleString()}`;

  const count = squad.members.length;
  const percent = Math.min(100, Math.round((count/5)*100));
  progressBar.style.width = percent + '%';
  membersText.textContent = `${count} / 5 joined`;
  priceText.textContent = `Current: â‚¹${priceForCount(count)} / unit`;

  // members list
  membersList.innerHTML = '';
  squad.members.forEach(m=>{
    const div = document.createElement('div');
    div.className = 'flex items-center justify-between p-2 bg-slate-50 rounded-lg';
    div.innerHTML = `<div class="font-semibold">${m.name}</div><div class="text-sm text-slate-500">${m.qty} pack(s)</div>`;
    membersList.appendChild(div);
  });
  // update storage (so future visitors who open link w/out payload still get latest from their own link if they save it)
  saveSquadToStorage(squad.id, squad);
}

/* ---------- timer ---------- */
let timerInterval = null;
function startTimer(){
  function tick(){
    const t = Math.max(0, squad.expiresAt - Date.now());
    if(t <= 0){
      timeLeftEl.textContent = 'Expired';
      clearInterval(timerInterval);
      // final price locked
      const final = priceForCount(squad.members.length);
      priceText.textContent = `Final: â‚¹${final} / unit`;
      confirmBtn.disabled = false;
      joinBtn.disabled = true;
      shareBtn.disabled = true;
      return;
    }
    const hrs = String(Math.floor(t/3600000)).padStart(2,'0');
    const mins = String(Math.floor((t%3600000)/60000)).padStart(2,'0');
    const secs = String(Math.floor((t%60000)/1000)).padStart(2,'0');
    timeLeftEl.textContent = `${hrs}:${mins}:${secs}`;
  }
  tick();
  timerInterval = setInterval(tick,1000);
}

/* ---------- join flow ---------- */
joinBtn.onclick = ()=>{
  const name = (joinName.value || '').trim();
  if(!name){ alert('Enter name'); joinName.focus(); return; }
  // prevent duplicate by name for simplicity
  if(squad.members.some(m => m.name === name)){
    alert('You already joined this squad on this device');
    return;
  }
  squad.members.push({ name, qty: 1 }); // single pack by default â€” you can extend
  // update expires? keep original
  render();
  // create updated link and auto-open WhatsApp share prompt with the updated link so the new link propagates
  const link = mkLink(squad.id, squad);
  const msg = `I joined JODO squad for *${PRODUCTS[squad.productId].name}*.\nCurrent: ${squad.members.length}/5 joined.\nJoin here: ${link}`;
  try{ navigator.clipboard.writeText(link); }catch(e){}
  window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`,'_blank');
  joinName.value = '';
};

/* ---------- share latest ---------- */
shareBtn.onclick = ()=>{
  const link = mkLink(squad.id, squad);
  const msg = `Join my JODO squad for *${PRODUCTS[squad.productId].name}*! ${squad.members.length}/5 joined. Time left: ${timeLeftEl.textContent}\n${link}`;
  try{ navigator.clipboard.writeText(link); }catch(e){}
  window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`,'_blank');
};

/* ---------- confirm order (WhatsApp checkout) ---------- */
confirmBtn.onclick = ()=>{
  // final price is determined at expiry. For now send a message with group info and current state.
  const finalPrice = priceForCount(squad.members.length);
  const orderId = 'JODO-' + Math.random().toString(36).slice(2,8).toUpperCase();
  let msg = `ðŸŒ¿ JODO GROUP CHECKOUT\nOrder ID: ${orderId}\nGroup: ${squad.id}\nProduct: ${PRODUCTS[squad.productId].name}\nMembers: ${squad.members.length}/5\nPrice (current): â‚¹${finalPrice}\n\nNote: Final price will be locked at squad expiry.\n`;
  if (confirm('This will open WhatsApp to confirm the order message. Proceed?')) {
    window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`,'_blank');
  }
};

/* ---------- init ---------- */
render();
startTimer();

</script>
</body>
</html>
